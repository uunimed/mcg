<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=yes" />
<title>UniMed ·É¢·Éî·É°·É¢·Éî·Éë·Éò</title>
<style>
:root{
  --bg:#f6f8fb; --muted:#6b7280; --accent:#0ea5a4;
  --success:#16a34a; --danger:#dc2626;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
html,body{
  height:100%;
  font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: #f8fafc;
}
body{
  display: flex;
  flex-direction: column;
  padding: 20px;
  position: relative;
}

/* ==================== TOPIC DROPDOWN STYLES ==================== */
.topic-dropdown-wrapper {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  margin-bottom: 20px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.topic-select {
  width: 100%;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 14px;
  font-family: inherit;
  background: white;
  color: #334155;
  outline: none;
  transition: border-color 0.2s;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 36px;
}

.topic-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.1);
}

/* ==================== AUTH MODAL - ENHANCED ==================== */
.auth-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(5px);
}

.auth-modal {
  background: white;
  border-radius: 16px;
  width: 90%;
  max-width: 600px;  /* ·É®·Éî·É™·Éï·Éê·Éö·Éî 50% ‚Üí 600px */
  max-height: 90vh;  /* ·Éì·Éê·Éê·Éõ·Éê·É¢·Éî ·Éõ·Éê·É•·É°·Éò·Éõ·Éê·Éö·É£·É†·Éò ·É°·Éò·Éõ·Éê·É¶·Éö·Éî */
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
  animation: modalAppear 0.4s ease;
}

@keyframes modalAppear {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.auth-header {
  background: linear-gradient(135deg, var(--accent), #0891b2);
  color: white;
  padding: 10px 30px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.auth-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
  animation: shimmer 8s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-30%) translateY(-30%) rotate(0deg); opacity: 0.3; }
  50% { transform: translateX(30%) translateY(30%) rotate(10deg); opacity: 0.6; }
  100% { transform: translateX(-30%) translateY(-30%) rotate(0deg); opacity: 0.3; }
}

.auth-header h2 {
  font-size: 42px;
  font-weight: 900;
  letter-spacing: -1px;
  text-transform: uppercase;
  margin: 0;
  padding: 0;
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(145deg, 
    #ffffff 0%,
    #f0f9ff 25%,
    #b8e1ff 50%,
    #f0f9ff 75%,
    #ffffff 100%
  );
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 
    0 1px 0 rgba(255,255,255,0.4),
    0 2px 0 rgba(14,165,164,0.1),
    0 3px 0 rgba(14,165,164,0.1),
    0 4px 0 rgba(14,165,164,0.1),
    0 5px 10px rgba(0,0,0,0.3),
    0 8px 20px rgba(14,165,164,0.3),
    0 12px 30px rgba(0,0,0,0.2);
  transition: letter-spacing 0.3s ease, text-shadow 0.3s ease;
}

.auth-header h2:hover {
  letter-spacing: 2px;
  text-shadow: 
    0 1px 0 rgba(255,255,255,0.4),
    0 2px 0 rgba(14,165,164,0.15),
    0 3px 0 rgba(14,165,164,0.15),
    0 4px 0 rgba(14,165,164,0.15),
    0 6px 15px rgba(0,0,0,0.4),
    0 10px 25px rgba(14,165,164,0.4),
    0 15px 35px rgba(0,0,0,0.25);
}

.auth-header h2::before {
  content: 'UniMed';
  position: absolute;
  top: 0;
  left: 0;
  z-index: -1;
  background: linear-gradient(145deg, #0ea5a4, #0284c7);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: blur(12px);
  opacity: 0.5;
  animation: glowPulse 3s infinite;
}

@keyframes glowPulse {
  0% { opacity: 0.4; filter: blur(10px); }
  50% { opacity: 0.7; filter: blur(15px); }
  100% { opacity: 0.4; filter: blur(10px); }
}

.auth-header h2 .medical-symbol {
  font-size: 42px;
  font-weight: 400;
  background: linear-gradient(135deg, #ffffff, #b8e1ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  display: inline-block;
  animation: pulseSymbol 2s infinite;
  text-shadow: 0 0 15px rgba(14,165,164,0.5);
  line-height: 1;
  margin-left: 4px;
}

@keyframes pulseSymbol {
  0% { transform: scale(1); opacity: 0.8; }
  50% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); opacity: 0.8; }
}

.auth-tabs {
  display: flex;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
}

.auth-tab {
  flex: 1;
  padding: 11px;
  background: none;
  border: none;
  font-size: 15px;
  font-weight: bold;
  color: #64748b;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.auth-tab::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 0;
  height: 3px;
  background: var(--accent);
  transition: all 0.3s;
  transform: translateX(-50%);
}

.auth-tab.active {
  color: var(--accent);
  background: white;
}

.auth-tab.active::after {
  width: 100%;
}

.auth-tab:hover:not(.active) {
  background: #f1f5f9;
  color: #475569;
}

.auth-content {
  flex: 1;
  overflow-y: auto;
  padding: 30px;
  min-height: 0;  /* ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò·Éê flex-·Éò·É°·Éó·Éï·Éò·É° */
}

.auth-tab-content {
  display: none;
}

.auth-tab-content.active {
  display: block;
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 0px;
}

#signupTab .auth-form {
  gap: 20px;
}

#loginTab .auth-form {
  gap: 15px;
}

#loginTab .form-group {
  position: relative;
  display: block;
  width: 100%;
  margin-bottom: 0;
}

#signupTab .form-group {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
}

#signupTab .form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 6px;
  margin-left: 2px;
  width: 100%;
}

#signupTab .auth-input {
  width: 100%;
  padding: 14px 16px;
  padding-right: 45px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

#signupTab .form-error {
  margin-top: 4px;
  margin-bottom: 0;
  padding-left: 2px;
  display: none;
  width: 100%;
}

#loginTab .form-group {
  position: relative;
  display: block;
  width: 100%;
  margin-bottom: 0;
}

#loginTab .auth-input {
  width: 100%;
  padding: 14px 45px 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

#loginTab .form-error {
  color: var(--danger);
  font-size: 13px;
  margin-top: 5px;
  margin-bottom: 0;
  padding-left: 2px;
  display: none;
  width: 100%;
}

#loginTab .password-toggle {
  position: absolute;
  right: 12px;
  top: 14px;
  transform: none;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  opacity: 0.7;
  transition: opacity 0.2s;
}

#signupTab .form-group {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
}

#signupTab .form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 6px;
  margin-left: 2px;
  width: 100%;
}

#signupTab .auth-input {
  width: 100%;
  padding: 14px 45px 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

#signupTab .password-toggle {
  position: absolute;
  right: 12px;
  top: 42px;
  transform: none;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  opacity: 0.7;
  transition: opacity 0.2s;
}

#signupTab .form-error {
  margin-top: 4px;
  margin-bottom: 0;
  padding-left: 2px;
  display: none;
  width: 100%;
}

#guestTab .auth-form {
  gap: 15px;
}

.auth-input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  font-family: inherit;
  transition: all 0.3s;
  background: #f8fafc;
}

.auth-input:focus {
  outline: none;
  border-color: var(--accent);
  background: white;
  box-shadow: 0 0 0 4px rgba(14, 165, 164, 0.15);
}

.auth-btn {
  padding: 16px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 10px;
}

#loginTab .auth-input {
  width: 100%;
  padding: 14px 45px 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

#loginTab .form-error {
  color: var(--danger);
  font-size: 13px;
  margin-top: 5px;
  margin-bottom: 0;
  padding-left: 2px;
  display: none;
  width: 100%;
  position: relative;
  top: 0;
}

#signupTab .auth-form {
  gap: 20px;
}

#signupTab .form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 6px;
  margin-left: 2px;
  width: 100%;
}

#signupTab .auth-input {
  width: 100%;
  padding: 14px 45px 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

.guest-btn {
  background: linear-gradient(135deg, var(--accent), #0891b2);
  color: white;
}

.guest-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(14, 165, 164, 0.3);
}

.login-btn {
  background: linear-gradient(135deg, var(--success), #059669);
  color: white;
}

.login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(22, 163, 74, 0.3);
}

.signup-btn {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
}

.signup-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
}

.auth-divider {
  text-align: center;
  margin: 25px 0;
  position: relative;
}

.auth-divider::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 1px;
  background: #e2e8f0;
}

.auth-divider span {
  background: white;
  padding: 0 15px;
  color: #64748b;
  font-size: 14px;
  position: relative;
  z-index: 1;
}

.auth-switch-btn {
  background: none;
  border: none;
  color: var(--accent);
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  text-decoration: underline;
  margin-top: 20px;
  width: 100%;
  padding: 12px;
  transition: color 0.3s;
}

.auth-switch-btn:hover {
  color: #0891b2;
}

.form-error {
  color: var(--danger);
  font-size: 13px;
  margin-top: 5px;
  display: none;
}

/* ==================== TIMER & USER INFO - AT VERY TOP EDGE ==================== */
.timer-user-container {
  position: fixed;
  top: 2px;
  right: 10px;
  z-index: 999;
  display: flex;
  align-items: center;
  gap: 15px;
  font-family: inherit;
  background: transparent;
  padding: 0;
  margin: 0;
  line-height: 1;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
  padding: 0;
}

.username-text {
  font-size: 13px;
  font-weight: 700;
  color: var(--accent);
  cursor: pointer;
  padding: 2px 0;
  margin: 0;
  display: inline-block;
  direction: rtl;
  text-align: right;
}

#timer {
  font-size: 13px;
  font-weight: 500;
  color: var(--muted);
  background: transparent;
  padding: 0;
  margin: 0;
  text-align: right;
  line-height: 1;
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}

.timer-time {
  font-family: inherit;
  font-weight: 600;
  color: inherit;
  margin: 0;
  padding: 0;
}

.timer-separator {
  color: #cbd5e1;
  margin: 0;
  padding: 0;
  font-size: 13px;
}

/* ==================== SETTINGS PAGE - FIXED: 80% WIDTH, 90% HEIGHT, VECTOR CLOSE ==================== */
.settings-page {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100vw;
  height: 100vh;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  box-sizing: border-box;
  animation: fadeIn 0.3s ease;
}

.settings-container {
  max-width: 1100px;
  width: 100%;
  max-height: 90vh;  /* ·É®·Éî·É™·Éï·Éê·Éö·Éî height ‚Üí max-height */
  height: auto;
  background: white;
  border-radius: 24px;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: slideScale 0.25s ease;
}

@keyframes slideScale {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 24px 28px;
  border-bottom: 1px solid #e2e8f0;
  flex-shrink: 0;
}

.settings-header h2 {
  font-size: 28px;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
  background: linear-gradient(135deg, var(--accent), #0891b2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* VECTOR CLOSE BUTTON - FIXED */
.settings-close-btn {
  background: none;
  border: none;
  padding: 8px;
  cursor: pointer;
  color: #64748b;
  transition: color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.settings-close-btn:hover {
  color: var(--danger);
}

.settings-close-btn svg {
  width: 28px;
  height: 28px;
  stroke-width: 2;
}

#settingsContent {
  flex: 1;
  overflow-y: auto;
  padding: 28px;
  min-height: 0;  /* ·Éì·Éê·Éê·Éõ·Éê·É¢·Éî ·Éî·É° */
}

.settings-section {
  margin-bottom: 30px;
  padding-bottom: 30px;
  border-bottom: 1px solid #e2e8f0;
}

.settings-section:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.settings-section-title {
  font-size: 18px;
  font-weight: 600;
  color: #334155;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.settings-field {
  margin-bottom: 20px;
}

.settings-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 8px;
}

.settings-input-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

.settings-input {
  flex: 1;
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

.settings-input:focus {
  outline: none;
  border-color: var(--accent);
  background: white;
  box-shadow: 0 0 0 4px rgba(14, 165, 164, 0.15);
}

.settings-input:disabled {
  background: #f1f5f9;
  color: #64748b;
}

.settings-eye-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #64748b;
  transition: color 0.2s;
}

.settings-eye-btn:hover {
  color: var(--accent);
}

.settings-edit-btn {
  background: none;
  border: none;
  color: var(--accent);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 6px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
}

.settings-edit-btn:hover {
  background: #f0f9ff;
}

.settings-edit-btn svg {
  width: 16px;
  height: 16px;
}

.settings-actions {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  margin-top: 30px;
}

.settings-save-btn {
  padding: 12px 24px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.settings-save-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(14, 165, 164, 0.25);
}

.settings-cancel-btn {
  padding: 12px 24px;
  background: #f1f5f9;
  color: #475569;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.settings-cancel-btn:hover {
  background: #e2e8f0;
}

.mistakes-container {
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
  background: #f8fafc;
  border-radius: 12px;
  margin-top: 15px;
}

.mistake-item {
  padding: 16px;
  background: white;
  border-radius: 8px;
  margin-bottom: 12px;
  border-left: 4px solid var(--danger);
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.mistake-question {
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 8px;
  font-size: 15px;
}

.mistake-answers {
  display: flex;
  gap: 15px;
  font-size: 13px;
}

.mistake-user-answer {
  color: var(--danger);
}

/* Auth modal scrollbar */
.auth-content::-webkit-scrollbar,
#settingsContent::-webkit-scrollbar {
  width: 6px;
}

.auth-content::-webkit-scrollbar-track,
#settingsContent::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 10px;
}

.auth-content::-webkit-scrollbar-thumb,
#settingsContent::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 10px;
}

/* Messenger-style chat notification */
.chat-notification {
  position: absolute;
  top: -6px;
  right: -6px;
  background-color: #f02849;
  color: white;
  font-size: 12px;
  font-weight: 600;
  min-width: 20px;
  height: 20px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
  box-sizing: border-box;
  border: 2px solid white;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  line-height: 1;
  z-index: 10;
  pointer-events: none;
}

/* When there are 3 or more digits (100+) */
.chat-notification[data-count="many"] {
  font-size: 10px;
  padding: 0 3px;
}

/* For 1 digit - perfect circle */
.chat-notification:not([data-count="many"]) {
  min-width: 20px;
}
.mistake-correct-answer {
  color: var(--success);
}

.settings-print-btn {
  padding: 12px 24px;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 15px;
}

.settings-print-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(16, 185, 129, 0.25);
}

.settings-back-btn {
  padding: 12px 24px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 20px auto 0;
}

.settings-back-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(14, 165, 164, 0.25);
}

/* ==================== MOVE QUESTIONS 2CM FROM TOP ==================== */
.normal-mode-container {
  margin-top: 0.5cm !important;
  padding-top: 0 !important;
}

.question-text {
  margin-top: 0 !important;
}

.exam-question-text {
  margin-top: 0.5cm !important;
}

.options-screen {
  margin-top: 2cm;
}

.exam-countdown {
  margin-top: 0.7cm !important;
  margin-bottom: 15px;
}

.exam-right-panel {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-left: 20px;
  border-left: 1px solid #e2e8f0;
  height: 100%;
  flex-shrink: 0;
}

.exam-test-boxes {
  margin-top: 10px;
}

.container {
  margin-top: 0;
  padding-top: 0;
}

.test-screen.active {
  margin-top: 0;
  padding-top: 0;
}

body {
  padding-top: 0 !important;
}

.user-menu {
  position: relative;
}

.username-btn {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 10px 18px;
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.username-btn:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(14, 165, 164, 0.15);
}

.user-dropdown {
  position: absolute;
  top: calc(100% + 10px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.15);
  min-width: 220px;
  display: none;
  z-index: 1001;
  overflow: hidden;
  border: 1px solid #e2e8f0;
}

.user-dropdown.show {
  display: block;
  animation: dropdownAppear 0.3s ease;
}

@keyframes dropdownAppear {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.user-dropdown-item {
  width: 100%;
  padding: 14px 20px;
  text-align: left;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  color: #334155;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #f1f5f9;
}

.user-dropdown-item:last-child {
  border-bottom: none;
  color: var(--danger);
}

.user-dropdown-item:hover {
  background: #f8fafc;
}

.user-dropdown-item i {
  font-size: 16px;
  width: 20px;
  text-align: center;
}

#timer {
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  background: transparent;
  padding: 0;
  box-shadow: none;
  text-align: right;
  line-height: 1.4;
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
  font-family: inherit;
}

.timer-time {
  font-family: inherit;
  font-weight: 600;
  color: inherit;
}

.timer-topic {
  font-size: 14px;
  color: var(--accent);
  font-weight: 600;
  display: inline-block;
}

.timer-separator {
  color: #cbd5e1;
  margin: 0 5px;
}

#timer.hidden {
  display: none;
}

/* ==================== TWO-COLUMN LAYOUT FOR OPTIONS ==================== */
.option-row {
  display: flex;
  gap: 15px;
  margin-bottom: 18px;
  width: 100%;
}

.option-item-half {
  flex: 1;
  min-width: 0;
  margin-bottom: 0 !important;
  
  /* üî• ·Éê·ÉÆ·Éê·Éö·Éò ·É°·É¢·Éò·Éö·Éò */
  position: relative;
}

/* ==================== MOBILE VERSION - FULLY FIXED ==================== */
@media (max-width: 768px) {
  body {
    padding: 5px !important;
  }
  
  .auth-modal {
    max-width: 95%;
  }
  
  /* Options screen - prevent bottom panel overlap */
  .options-screen {
    padding: 15px !important;
    margin-bottom: 80px !important; /* Space for bottom panel */
  }
  
  .option-row {
    flex-direction: column;
    gap: 12px;
  }
  
  .option-item-half {
    width: 100%;
  }
  
  .option-item {
    padding: 12px 16px !important;
    min-height: 44px !important;
    margin-bottom: 8px !important;
  }
  
  .start-btn {
    width: 100% !important;
    max-width: 100%;
    padding: 14px !important;
    font-size: 16px !important;
    margin: 20px auto 0 !important;
  }
  
  .mode-label {
    font-size: 22px !important;
    margin-bottom: 20px !important;
  }
  
  /* Timer & user */
  .timer-user-container {
    top: 5px !important;
    right: 8px !important;
    gap: 8px !important;
  }
  
  .username-text {
    font-size: 14px !important;
  }
  
  #timer {
    font-size: 13px !important;
  }
  
  /* SETTINGS PAGE - FIXED: 99% WIDTH WITH 0.1CM MARGINS */
  .settings-page {
    position: fixed !important;
    top: 0.1cm !important;
    left: 0.1cm !important;
    right: 0.1cm !important;
    bottom: 0.1cm !important;
    width: auto !important;
    height: auto !important;
    transform: none !important;
    z-index: 10000 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 !important;
    animation: fadeIn 0.3s ease !important;
  }
  
  .settings-container {
    max-width: none !important;
    width: 100% !important;
    height: 100% !important;
    background: white !important;
    border-radius: 24px !important;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3) !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
  }
  
  .settings-header {
    padding: 16px 20px !important;
  }
  
  .settings-header h2 {
    font-size: 24px !important;
  }
  
  #settingsContent {
    padding: 15px !important;
    overflow-y: auto !important;
  }
  
  .settings-field {
    margin-bottom: 15px !important;
  }
  
  .settings-input {
    font-size: 14px !important;
    padding: 10px 12px !important;
  }
  
  .settings-section-title {
    font-size: 16px !important;
    margin-bottom: 15px !important;
  }
  
  .mistake-item {
    padding: 12px !important;
  }
  
  .mistake-question {
    font-size: 14px !important;
  }
  
  .mistake-answers {
    flex-direction: column !important;
    gap: 5px !important;
  }
  
  /* Progress resume modal - buttons in one line */
  .modal[style*="max-width: 500px"] .modal-buttons,
  .modal-overlay[data-type="progress-resume"] .modal-buttons {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
    justify-content: center !important;
  }
  
  .modal[style*="max-width: 500px"] .modal-buttons button,
  .modal-overlay[data-type="progress-resume"] .modal-buttons button {
    flex: 1 1 auto !important;
    min-width: 100px !important;
    padding: 10px 12px !important;
    font-size: 14px !important;
  }
  
  .modal-content p {
    font-size: 14px !important;
  }
  
  /* ----- NORMAL MODE MOBILE - COMPLETE RESTRUCTURE ----- */
  .normal-mode-container {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .question-text {
    font-size: 17px !important;
    margin-top: 0 !important;
  }
  
  .answers-container{
    display: flex;
    flex-direction: column;
    gap: 5px;
    width: 100%;
    margin-bottom: 25px;
    flex: 1;
  }
  
  .answer-item {
    padding: 8px 12px !important;
    font-size: 15px !important;
    margin-bottom: 0px !important;
  }
  
  
  .normal-mode-container .nav-center {
    display: flex !important;
    gap: 6px !important;
    width: 100% !important;
  }
  
  .normal-mode-container .nav-btn {
    flex: 1 !important;
    padding: 10px 8px !important;
    font-size: 14px !important;
    border-radius: 30px !important;
    min-width: 0 !important;
    height: 40px !important;
  }
  
  /* Hide finish button in normal mode */
  .normal-mode-container #examFinishBtn,
  .normal-mode-container .exam-finish-btn,
  .normal-mode-container [id*="Finish"],
  .normal-mode-container .nav-btn:contains("·Éì·Éê·É°·É†·É£·Éö·Éî·Éë·Éê") {
    display: none !important;
  }
  
/* Add this CSS rule to your styles */
.normal-mode-container .exam-countdown,
.normal-mode-container #examCountdown,
#examCountdown {
    display: none !important;
}
  
  /* Bottom panel with chat, counter, online */
  .bottom-left-container {
    position: fixed !important;
    bottom: 20px !important;
    left: 10px !important;
    right: 10px !important;
    z-index: 1001 !important;
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: space-between !important;
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(12px) !important;
    padding: 8px 12px !important;
    border-radius: 40px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    width: calc(100% - 20px) !important;
    margin: 0 auto !important;
  }
  
  .chat-button {
    background: linear-gradient(135deg, var(--accent), #0891b2) !important;
    color: white !important;
    border: none !important;
    border-radius: 30px !important;
    padding: 8px 16px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
    position: relative !important;
    margin: 0 !important;
    box-shadow: 0 2px 8px rgba(14, 165, 164, 0.3) !important;
    transition: transform 0.2s, box-shadow 0.2s !important;
    flex: 1 !important;
    max-width: 100px !important;
  }
  
  .chat-button:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(14, 165, 164, 0.4) !important;
  }
  
  /* Hide question counter by default (before test starts) */
  .question-counter {
    display: none !important;
  }
  
  /* Show only when test is active */
  .test-screen.active .question-counter:not(.hidden) {
    display: flex !important;
    position: static !important;
    align-items: center !important;
    gap: 2px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    color: var(--accent) !important;
    background: transparent !important;
    padding: 0 !important;
    margin: 0 !important;
    flex: 1 !important;
    justify-content: center !important;
  }
  
  .test-screen.active .question-counter .current-question,
  .test-screen.active .question-counter .counter-separator,
  .test-screen.active .question-counter .total-questions {
    font-size: 16px !important;  /* SAME SIZE FOR BOTH NUMBERS */
    font-weight: 600 !important;
  }
  
  .test-screen.active .question-counter .current-question {
    color: var(--accent) !important;
  }
  
  .test-screen.active .question-counter .counter-separator,
  .test-screen.active .question-counter .total-questions {
    color: #64748b !important;
  }
  
  .online-status {
    display: flex !important;
    align-items: center !important;
    gap: 4px !important;
    padding: 0 !important;
    background: transparent !important;
    backdrop-filter: none !important;
    border: none !important;
    flex: 1 !important;
    justify-content: flex-end !important;
  }
  
  .online-dot {
    width: 8px !important;
    height: 8px !important;
    background: var(--success) !important;
    border-radius: 50% !important;
    animation: pulse-online 2s infinite !important;
  }
  
  .online-text {
    font-size: 13px !important;
    color: #64748b !important;
  }
  
  #onlineCount {
    font-weight: 600 !important;
    color: var(--accent) !important;
  }
  
  /* Chat window - positioned near button */
  .chat-window {
    position: fixed !important;
    bottom: 90px !important;
    left: 10px !important;
    right: 10px !important;
    width: calc(100% - 20px) !important;
    height: 60vh !important;
    max-height: 500px !important;
    background: white !important;
    border-radius: 16px !important;
    box-shadow: 0 8px 30px rgba(0,0,0,0.2) !important;
    display: none !important;
    flex-direction: column !important;
    overflow: hidden !important;
    z-index: 1002 !important;
  }
  
  .chat-window.active {
    display: flex !important;
  }
  
  .chat-header {
    padding: 10px 12px !important;
    background: var(--accent) !important;
    color: white !important;
    font-weight: 600 !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    font-size: 14px !important;
  }
  
  .close-chat {
    background: none !important;
    border: none !important;
    color: white !important;
    font-size: 18px !important;
    cursor: pointer !important;
    padding: 0 !important;
    width: 24px !important;
    height: 24px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .chat-messages {
    flex: 1 !important;
    padding: 12px !important;
    overflow-y: auto !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
    min-height: 0 !important;
  }
  
  .message {
    max-width: 85% !important;
  }
  
  .message-content {
    padding: 8px 12px !important;
    font-size: 13px !important;
  }
  
  .chat-input-area {
    padding: 10px !important;
    gap: 6px !important;
  }
  
  .chat-input {
    padding: 8px 12px !important;
    font-size: 13px !important;
  }
  
  .send-btn {
    width: 36px !important;
    height: 36px !important;
  }
  
  /* ----- EXAM MODE MOBILE - COMPLETE RESTRUCTURE ----- */
  .exam-mode-container {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    padding-bottom: 150px !important;
    overflow-y: auto !important;
  }
  
  .question-left-panel {
    width: 100% !important;
    padding: 10px !important;
    order: 1 !important;
    display: flex !important;
    flex-direction: column !important;
  }
  
  .exam-question-text {
    font-size: 18px !important;
    line-height: 1.4 !important;
    margin-bottom: 10px !important;
    text-align: left !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
    max-height: none !important;
    height: auto !important;
  }
  
  .exam-answers-container {
    margin-bottom: 10px !important;
  }
  
  .exam-answer-item {
    padding: 10px 12px !important;
    font-size: 15px !important;
    margin-bottom: 6px !important;
  }
  
  .exam-countdown {
    font-size: 20px !important;
    font-weight: 700 !important;
    color: var(--danger) !important;
    margin: 5px 0 10px 0 !important;
    padding: 8px !important;
    background: #fee2e2 !important;
    border-radius: 8px !important;
    text-align: center !important;
  }
  
  .exam-right-panel {
    width: 100% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    border-left: none !important;
    margin: 0 !important;
    padding: 5px 10px 10px 10px !important;
    order: 2 !important;
    display: block !important;
  }
  
  .exam-test-boxes {
    display: grid !important;
    grid-template-columns: repeat(8, 1fr) !important;
    gap: 4px !important;
    max-height: none !important;
    overflow-y: visible !important;
    padding: 5px 0 !important;
    background: transparent !important;
  }
  
  .test-box {
    width: 100% !important;
    height: 40px !important;
    font-size: 13px !important;
    border-radius: 4px !important;
  }
  
/* Exam mode navigation - ·É¨·Éò·Éú·Éê ·Éì·Éê·É°·É†·É£·Éö·Éî·Éë·Éê ·É®·Éî·Éõ·Éì·Éî·Éí·Éò Auto */
.exam-mode-container .exam-navigation-container {
    position: fixed !important;
    bottom: 20px !important;  /* ·É®·Éî·É™·Éï·Éö·Éò·Éö·Éò·Éê 80px ‚Üí 20px */
    left: 10px !important;
    right: 10px !important;
    width: auto !important;
    padding: 8px 10px !important;
    background: rgba(255,255,255,0.9) !important;
    backdrop-filter: blur(8px) !important;
    border-radius: 40px !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    z-index: 1000 !important;
}

/* Normal mode navigation - ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·É¨·Éò·Éú·Éê ·É®·Éî·Éõ·Éì·Éî·Éí·Éò Auto */
.normal-mode-container .navigation {
    position: fixed !important;
    bottom: 20px !important;  /* ·É®·Éî·É™·Éï·Éö·Éò·Éö·Éò·Éê 80px ‚Üí 20px */
    left: 10px !important;
    right: 10px !important;
    width: auto !important;
    padding: 8px 10px !important;
    background: rgba(255,255,255,0.9) !important;
    backdrop-filter: blur(8px) !important;
    border-radius: 40px !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    z-index: 1000 !important;
}

.nav-center {
    display: flex !important;
    gap: 6px !important;
    width: 100% !important;
}

.nav-btn {
    flex: 1 !important;
    padding: 10px 8px !important;
    font-size: 14px !important;
    border-radius: 30px !important;
    min-width: 0 !important;
    height: 40px !important;
}
  
  .exam-mode-container .nav-center {
    display: flex !important;
    gap: 6px !important;
    width: 100% !important;
  }
  
  .exam-mode-container .nav-btn {
    flex: 1 !important;
    padding: 8px 4px !important;
    font-size: 13px !important;
    border-radius: 30px !important;
    min-width: 0 !important;
    height: 36px !important;
    background: rgba(14, 165, 164, 0.8) !important;
    color: white !important;
  }
  
  .exam-mode-container .nav-btn.auto-btn {
    background: rgba(245, 158, 11, 0.8) !important;
  }
  
  #examFinishBtn {
    background: rgba(220, 38, 38, 0.9) !important;
    color: white !important;
    display: flex !important;
  }
  
  /* FORCE SHOW FINISH BUTTON IN EXAM MODE */
  .exam-mode-container #examFinishBtn {
    display: flex !important;
  }
  
  /* Bottom panel for exam mode - second panel */
  .exam-mode-container .bottom-left-container,
  .normal-mode-container .bottom-left-container {
    position: fixed !important;
    bottom: 70px !important;  /* ·É®·Éî·É™·Éï·Éö·Éò·Éö·Éò·Éê 20px ‚Üí 70px */
    left: 10px !important;
    right: 10px !important;
    z-index: 1001 !important;
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: space-between !important;
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(12px) !important;
    padding: 8px 16px !important;
    border-radius: 40px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    width: calc(100% - 20px) !important;
    margin: 0 auto !important;
  }
  
    /* Chat button on left */
  .bottom-left-container .chat-button {
    flex: 0 0 auto !important;
    margin: 0 !important;
    min-width: 70px !important;
  }
  
  /* Question counter in the middle */
  .bottom-left-container .question-counter {
    display: flex !important;
    position: static !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 2px !important;
    font-size: 18px !important;
    font-weight: 700 !important;
    color: var(--accent) !important;
    background: transparent !important;
    padding: 0 !important;
    margin: 0 !important;
    flex: 1 1 auto !important;
    text-align: center !important;
  }
  
  /* Online status on right */
  .bottom-left-container .online-status {
    flex: 0 0 auto !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
    margin: 0 !important;
  }
  
    /* Counter numbers styling */
  .bottom-left-container .question-counter .current-question {
    font-size: 22px !important;
    font-weight: 700 !important;
    color: var(--accent) !important;
    min-width: 30px !important;
    text-align: center !important;
  }
  
  .bottom-left-container .question-counter .counter-separator,
  .bottom-left-container .question-counter .total-questions {
    font-size: 22px !important;
    font-weight: 700 !important;
    color: #64748b !important;
  }
    .question-counter:not(.in-panel) {
    display: none !important;
  }
  
  /* Hide question counter in exam mode since it's in the navigation */
  .exam-mode-container .question-counter {
    display: none !important;
  }
}

@media (max-width: 480px) {
  .exam-test-boxes {
    grid-template-columns: repeat(6, 1fr) !important;
  }
  
  .nav-btn {
    font-size: 12px !important;
    padding: 6px 2px !important;
  }
  
  .test-box {
    height: 36px !important;
  }
  
  .chat-button {
    padding: 6px 12px !important;
    font-size: 13px !important;
    max-width: 80px !important;
  }
  
  .online-text {
    font-size: 12px !important;
  }
  
  .test-screen.active .question-counter .current-question,
  .test-screen.active .question-counter .counter-separator,
  .test-screen.active .question-counter .total-questions {
    font-size: 14px !important;
  }
}

/* ==================== PRINT STYLES - FIXED: 1cm MARGINS ==================== */
@media print {
  body {
    padding: 0 !important;
    margin: 0 !important;
    background: white !important;
  }
  
  .settings-page {
    position: relative !important;
    display: block !important;
    width: 100% !important;
    height: auto !important;
    transform: none !important;
    top: 0 !important;
    left: 0 !important;
    background: white !important;
    backdrop-filter: none !important;
    padding: 0 !important;
  }
  
  .settings-container {
    max-width: 100% !important;
    width: 100% !important;
    height: auto !important;
    margin: 0 1cm !important;
    padding: 0.5cm 0 !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    background: white !important;
  }
  
  .mistake-item {
    page-break-inside: avoid;
    margin-bottom: 0.5cm !important;
    border-left: 2px solid #dc2626 !important;
    padding-left: 0.3cm !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
  
  .settings-print-btn,
  .settings-back-btn,
  .settings-close-btn,
  .settings-eye-btn,
  .settings-edit-btn,
  #saveUsernameBtn {
    display: none !important;
  }
  
  .settings-header h2 {
    -webkit-text-fill-color: #0ea5a4 !important;
    color: #0ea5a4 !important;
    text-shadow: none !important;
  }
  
  .settings-section-title svg {
    display: none !important;
  }
  
  .settings-container * {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
  
  .mistake-question,
  .mistake-answers,
  .settings-label,
  .settings-section-title {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
}

.notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--danger);
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
  z-index: 1000;
  animation: slideIn 0.3s ease, fadeOut 0.3s ease 3.7s;
  max-width: 600px;
  text-align: center;
}

@keyframes slideIn {
  from {
    top: -60px;
    opacity: 0;
  }
  to {
    top: 20px;
    opacity: 1;
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
    visibility: hidden;
  }
}

.container{
  width: 100%;
  margin: 0 auto;
  flex: 1;
}

.options-screen {
  background: white;
  border-radius: 10px;
  padding: 30px 40px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.06);
  margin: 0.8cm auto 0;
  width: 100%;
  max-width: 800px;
  position: relative;
}

.loader-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10;
  border-radius: 10px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #e2e8f0;
  border-top: 4px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loader-text {
  color: var(--muted);
  font-size: 14px;
  font-weight: 500;
}

.start-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.start-btn:disabled:hover {
  transform: none;
  box-shadow: none;
}

.mode-label{
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 30px;
  text-align: center;
  color: #1e293b;
}
.option-item{
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 14px 18px;
  border-radius: 8px;
  transition: all 0.2s;
  cursor: pointer;
  border: 1px solid #e2e8f0;
}
.option-item:hover{
  background-color: #f1f5f9;
  border-color: var(--accent);
  transform: translateY(-2px);
}
.option-item input[type="checkbox"]{
  width: 18px;
  height: 18px;
  cursor: pointer;
}
.option-item span{
  font-size: 16px;
  color: #334155;
  flex: 1;
}
.mode-separator {
  text-align: center;
  margin: 30px 0;
  color: var(--muted);
  font-weight: 600;
  position: relative;
}
.mode-separator::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 1px;
  background: #e2e8f0;
  z-index: 1;
}
.mode-separator span {
  background: white;
  padding: 0 20px;
  position: relative;
  z-index: 2;
}
.start-btn{
  display: block;
  width: 180px;
  margin: 35px auto 0;
  padding: 14px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.start-btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(14, 165, 164, 0.25);
}

.test-screen{
  display: none;
  width: 100%;
  height: 100%;
}
.test-screen.active{
  display: flex;
  flex-direction: column;
}

.vector-arrow {
  display: inline-block;
  vertical-align: middle;
  transition: transform 0.2s;
}

.vector-arrow.prev {
  margin-right: 8px;
}

.vector-arrow.next {
  margin-left: 8px;
}

.nav-btn:hover .vector-arrow.prev {
  transform: translateX(-3px);
}

.nav-btn:hover .vector-arrow.next {
  transform: translateX(3px);
}

@keyframes vanish {
  0% {
    opacity: 1;
    transform: translateX(0);
  }
  100% {
    opacity: 0;
    transform: translateX(100px);
  }
}

.vanish-effect {
  animation: vanish 0.5s ease forwards !important;
}

.question-counter {
  position: fixed;
  bottom: 20px;
  right: 20px;
  font-size: 28px;
  font-weight: 600;
  color: var(--accent);
  z-index: 998;
  display: flex;
  align-items: baseline;
  gap: 2px;
  background: transparent;
  padding: 0;
  cursor: pointer;
}

.question-counter .counter-separator {
  font-size: 28px;
  color: #64748b;
  font-weight: 600;
  margin: 0 2px;
}

.question-counter .total-questions {
  font-size: 28px;
  color: #64748b;
  font-weight: 600;
}

.question-counter .current-question {
  font-size: 28px;
  font-weight: 600;
  color: var(--accent);
  transition: all 0.2s;
  min-width: 50px;
  text-align: center;
}

.question-counter .current-question:hover {
  color: var(--success);
  transform: scale(1.05);
}

.question-counter .current-question.editing {
  color: var(--success);
  transform: scale(1.3);
  font-weight: 700;
  animation: pulse 0.3s ease;
}

.question-counter .counter-separator,
.question-counter .total-questions {
  transform: none !important;
  font-size: 28px !important;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.4); }
  100% { transform: scale(1.3); }
}

.question-container{
  width: 100%;
  flex: 1;
}

.normal-mode-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.question-text{
  font-size: 25px;
  font-weight: 600;
  line-height: 1.5;
  color: #0f172a;
  text-align: center;
  margin-bottom: 25px;
  padding: 0;
  width: 100%;
  margin-top: 0;
}

.username-text {
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
  cursor: pointer;
  padding: 5px 8px;
  transition: all 0.2s;
  display: inline-block;
}

.username-text:hover {
  color: #0891b2;
  text-decoration: underline;
}

.username-btn {
  display: none;
}

.answers-container{
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
  margin-bottom: 25px;
  flex: 1;
}

.answer-item{
  padding: 16px 20px;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #e2e8f0;
  font-size: 16px;
  line-height: 1.5;
  width: 100%;
}

.answer-item:hover{
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border-color: var(--accent);
  background-color: #f8fafc;
}

.answer-item.correct{
  background: linear-gradient(135deg, #d1fae5, #f0fdf4);
  border-color: var(--success);
  color: #065f46;
}

.answer-item.incorrect{
  background: linear-gradient(135deg, #fee2e2, #fef2f2);
  border-color: var(--danger);
  color: #991b1b;
}

.answer-item.selected {
  background-color: #677588;
  border-color: #474E57;
}

.answer-item.correct:hover,
.answer-item.incorrect:hover,
.answer-item.selected:hover {
  transform: none;
  cursor: default;
}

.answer-number{
  font-weight: 600;
  margin-right: 10px;
  color: var(--accent);
  font-size: 16px;
}

.feedback{
  padding: 0 10px;
  margin-bottom: 20px;
  text-align: center;
  min-height: 30px;
}

.navigation {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 15px 10px;
  border-top: 1px solid #e2e8f0;
  width: 100%;
  margin-top: auto;
}

.nav-center {
  display: flex;
  gap: 12px;
}

.nav-btn {
  padding: 10px 24px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 100px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.auto-btn{
  background: #f59e0b;
}

.auto-btn:hover{
  background: #d97706;
}

.nav-btn:disabled{
  opacity: 0.5;
  cursor: not-allowed;
}

.nav-btn:hover:not(:disabled){
  opacity: 0.9;
  transform: translateY(-2px);
}

.exam-mode-container {
  width: 100%;
  flex: 1;
  display: flex;
  overflow: hidden;
}

.question-left-panel {
  flex: 1;
  min-width: 0;
  padding-right: 20px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.exam-question-text{
  font-size: 20px;
  font-weight: 600;
  line-height: 1.4;
  color: #0f172a;
  margin-bottom: 15px;
  padding: 0;
  width: 100%;
  max-height: none;
  overflow-y: auto;
}

.exam-answers-container{
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
  margin-bottom: 10px;
  flex: 1;
}

.exam-answer-item{
  padding: 12px 16px;
  border-radius: 6px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #e2e8f0;
  font-size: 15px;
  line-height: 1.4;
  width: 100%;
  min-height: 50px;
  display: flex;
  align-items: center;
}

.exam-answer-item:hover{
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-color: var(--accent);
  background-color: #f8fafc;
}

.exam-answer-item.selected {
  background-color: #CFD8E0;
  border-color: #5B6777;
}

.exam-answer-number{
  font-weight: 600;
  margin-right: 10px;
  color: var(--accent);
  font-size: 15px;
  min-width: 25px;
}

.exam-feedback{
  padding: 0 10px;
  margin-bottom: 15px;
  text-align: center;
  min-height: 25px;
}

.exam-right-panel {
  width: 25%;
  min-width: 300px;
  max-width: 350px;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-left: 20px;
  border-left: 1px solid #e2e8f0;
  height: 100%;
  flex-shrink: 0;
}

.exam-countdown {
  width: 100%;
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: var(--danger);
  margin-bottom: 15px;
  padding: 8px;
  background: #fee2e2;
  border-radius: 6px;
}

.exam-test-boxes {
  display: grid;
  grid-template-columns: repeat(5, 45px);
  justify-content: center;
  gap: 8px;
  width: 100%;
  max-height: calc(100vh - 150px);
  padding: 15px 0;
  overflow-y: auto;
  background: #f8fafc;
  border-radius: 8px;
  grid-auto-rows: 45px;
}

.test-box {
  width: 45px;
  height: 45px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
  background: white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  flex-shrink: 0;
}

.test-box:hover {
  transform: scale(1.1);
  border-color: var(--accent);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.test-box.answered {
  background: #BEEDCF;
  color: #64748b;
  border-color: #94a3b8;
}

.test-box.current {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
  transform: scale(1.1);
}

.exam-navigation-container {
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: auto;
  padding: 15px 0;
  border-top: 1px solid #e2e8f0;
}

.results-history {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 20px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  max-height: 400px;
  overflow-y: auto;
}

.result-item {
  padding: 15px;
  border-radius: 6px;
  border-left: 4px solid;
  background: #f8fafc;
}

.result-item.correct {
  border-left-color: var(--success);
}

.result-item.incorrect {
  border-left-color: var(--danger);
}

.timer-user-container {
  display: flex;
  align-items: center;
  gap: 2px;
}

.user-info {
  margin-right: 0;
}

.username-text {
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
  cursor: pointer;
  padding: 5px 0 5px 0;
  display: inline-block;
  direction: rtl;
  text-align: right;
}

#timer {
  display: flex;
  align-items: center;
  gap: 2px;
  margin-left: 0;
}

.timer-separator {
  color: #cbd5e1;
  margin: 0;
  padding: 0;
}

.timer-time {
  margin-left: 0;
}

.result-question {
  font-weight: 600;
  margin-bottom: 8px;
  font-size: 14px;
}

.result-answer {
  font-size: 13px;
  color: #64748b;
  margin-bottom: 5px;
}

.result-status {
  font-size: 12px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 4px;
  display: inline-block;
}

.result-status.correct {
  background: #d1fae5;
  color: #065f46;
}

.result-status.incorrect {
  background: #fee2e2;
  color: #991b1b;
}

.bottom-left-container {
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 15px;
}

.bottom-left-container .question-counter {
  display: none;
}

#questionCounter:not(.hidden) {
  display: flex !important;
}

.online-status {
  display: flex;
  align-items: center;
  gap: 8px;
}

.online-dot {
  width: 8px;
  height: 8px;
  background: var(--success);
  border-radius: 50%;
  animation: pulse-online 2s infinite;
}

.online-text {
  font-size: 14px;
  color: #64748b;
}

#onlineCount {
  font-weight: 600;
  color: var(--accent);
}

@keyframes pulse-online {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.chat-button {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(14, 165, 164, 0.3);
  transition: all 0.3s;
  position: relative;
}

.chat-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(14, 165, 164, 0.4);
}

.chat-window {
  position: absolute;
  bottom: 70px;
  left: 0;
  width: 600px;
  height: 80vh;
  max-height: 800px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  display: none;
  flex-direction: column;
  overflow: hidden;
}

.chat-window.active {
  display: flex;
}

.chat-header {
  padding: 12px 16px;
  background: var(--accent);
  color: white;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  flex-shrink: 0;
}

.close-chat {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-messages {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-height: 0;
}

.message {
  max-width: 85%;
  display: flex;
  flex-direction: column;
}

.message.received {
  align-self: flex-start;
}

.message.sent {
  align-self: flex-end;
}

.message-author {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 2px;
  padding: 0 4px;
}

.message-time {
  font-size: 10px;
  color: #94a3b8;
  margin-bottom: 4px;
  padding: 0 4px;
}

.message-content {
  padding: 10px 12px;
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.4;
}

.message.received .message-content {
  background: #f1f5f9;
  color: #1e293b;
}

.message.sent .message-content {
  background: var(--accent);
  color: white;
}

.chat-input-area {
  padding: 12px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

.chat-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #e2e8f0;
  border-radius: 20px;
  font-size: 13px;
}

.send-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: white;
  border-radius: 12px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}

.modal-header {
  font-size: 20px;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 20px;
  text-align: center;
}

.modal-content {
  font-size: 16px;
  color: #64748b;
  margin-bottom: 30px;
  text-align: center;
}

.modal-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.modal-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  min-width: 120px;
}

.modal-btn.confirm {
  background: var(--success);
  color: white;
}

.modal-btn.cancel {
  background: var(--danger);
  color: white;
}

.modal-overlay.active {
  display: flex !important;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 10001;
  align-items: center;
  justify-content: center;
}

.modal {
  background: white;
  border-radius: 16px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: modalAppear 0.3s ease;
}

#modulesContainer {
  display: none;
  flex-direction: column;
  gap: 6px;
  max-height: 300px;
  overflow-y: auto;
  padding: 8px;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  background: white;
  
  /* üî• ·Éê·ÉÆ·Éê·Éö·Éò ·É°·É¢·Éò·Éö·Éî·Éë·Éò - ·Éê·É† ·É©·Éê·É¨·Éî·Éï·É° ·Éì·Éê·Éë·Éö·Éê */
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  margin-top: 4px;
}

@keyframes modalAppear {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.hidden{
  display: none;
}
</style>
</head>
<body>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
<!-- Enhanced Login/Signup Modal -->
<div id="authModal" class="auth-modal-overlay">
  <div class="auth-modal">
<div class="auth-header">
  <h2>
    UniMed
    <span class="medical-symbol">‚öï</span>
  </h2>
</div>
    
    <div id="authTabs" class="auth-tabs">
      <button class="auth-tab active" data-tab="guest">·É°·É¢·É£·Éõ·Éê·É†·Éò</button>
      <button class="auth-tab" data-tab="login">·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éê</button>
      <button class="auth-tab" data-tab="signup">·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê</button>
    </div>
    
    <div id="authContent" class="auth-content">
      <!-- Guest Tab (Default) -->
      <div id="guestTab" class="auth-tab-content active">
        <div class="auth-form">
          <div class="form-group">
          </div>
<button id="continueAsGuest" class="auth-btn guest-btn" style="display: flex; align-items: center; justify-content: center;">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="white"/>
  </svg>
  ·Éí·Éê·Éí·É†·É´·Éî·Éö·Éî·Éë·Éê, ·É†·Éù·Éí·Éù·É†·É™ ·É°·É¢·É£·Éõ·Éê·É†·Éò
</button>
          <div class="auth-divider">
            <span>·Éê·Éú</span>
          </div>
          <button id="showLoginFromGuest" class="auth-switch-btn" style="text-decoration: none;">·É®·Éî·É°·Éï·Éö·Éê</button>
        </div>
      </div>
      
      <!-- Login Tab -->
      <div id="loginTab" class="auth-tab-content">
        <div class="auth-form">
          <div class="form-group">
            <input type="text" id="loginUsername" class="auth-input" placeholder="·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò">
            <div id="loginUsernameError" class="form-error"></div>
          </div>
          <div class="form-group">
            <input type="password" id="loginPassword" class="auth-input" placeholder="·Éû·Éê·É†·Éù·Éö·Éò">
            <button type="button" class="password-toggle" data-target="loginPassword">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="loginPasswordError" class="form-error"></div>
          </div>
<button id="loginBtn" class="auth-btn login-btn" style="display: flex; align-items: center; justify-content: center;">
  ·É®·Éî·É°·Éï·Éö·Éê
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-left: 8px; display: block;">
    <path d="M13 16l4-4m0 0l-4-4m4 4H3m5 4v1a3 3 0 003 3h7a3 3 0 003-3V7a3 3 0 00-3-3h-7a3 3 0 00-3 3v1" stroke="white" stroke-width="2"/>
  </svg>
</button>
          <button id="showSignupFromLogin" class="auth-switch-btn" style="text-decoration: none;">·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê</button>
        </div>
      </div>
      
      <!-- Signup Tab -->
      <div id="signupTab" class="auth-tab-content">
        <div class="auth-form">
          <div class="form-group">
            <label class="form-label">·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò</label>
            <input type="text" id="signupUsername" class="auth-input" placeholder="·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éì·Éê ·Éí·Éï·Éê·É†·Éò">
            <div id="signupUsernameError" class="form-error"></div>
          </div>
          <div class="form-group">
            <label class="form-label">·Éû·Éê·É†·Éù·Éö·Éò (·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù)</label>
            <input type="password" id="signupPassword" class="auth-input" placeholder="·É®·Éî·Éò·É¢·Éê·Éú·Éî·Éó ·Éû·Éê·É†·Éù·Éö·Éò">
            <button type="button" class="password-toggle" data-target="signupPassword">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="signupPasswordError" class="form-error"></div>
          </div>
          <div class="form-group">
            <label class="form-label">·Éí·Éê·Éò·Éõ·Éî·Éù·É†·Éî·Éó ·Éû·Éê·É†·Éù·Éö·Éò</label>
            <input type="password" id="signupConfirmPassword" class="auth-input" placeholder="·Éû·Éê·É†·Éù·Éö·Éò">
            <button type="button" class="password-toggle" data-target="signupConfirmPassword">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="signupConfirmError" class="form-error"></div>
          </div>
<button id="signupBtn" class="auth-btn signup-btn" style="display: flex; align-items: center; justify-content: center;">
  ·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-left: 8px; display: block;">
    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke="white" stroke-width="2"/>
  </svg>
</button>
          <button id="showLoginFromSignup" class="auth-switch-btn" style="text-decoration: none;">·É®·Éî·É°·Éï·Éö·Éê</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Timer and User Info Container -->
<div class="timer-user-container">
  <div id="userInfo" class="user-info" style="display: none;">
    <div class="user-menu">
      <span id="usernameBtn" class="username-text">
        <span id="usernameDisplay"></span>
      </span>
      <div id="userDropdown" class="user-dropdown">
        <button class="user-dropdown-item" id="settingsBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
            <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
          </svg>
          ·Éû·Éê·É†·Éê·Éõ·Éî·É¢·É†·Éî·Éë·Éò
        </button>
        <button class="user-dropdown-item" id="wrongQuestionsBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò·É° ·Éí·Éê·Éô·Éî·Éó·Éî·Éë·Éê
        </button>
        <button class="user-dropdown-item" id="signOutBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ·Éí·Éê·É°·Éï·Éö·Éê
        </button>
      </div>
    </div>
  </div>
  
  <div id="timer"></div>
</div>

<!-- Chat and Online Status Container -->
<div class="bottom-left-container">
  <!-- Chat Button -->
<button id="chatButton" class="chat-button">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="white"/>
  </svg>
  ·É©·Éê·É¢·Éò
  <div id="chatNotification" class="chat-notification" style="display: none;"></div>
</button>
  
  <!-- Question Counter - Bottom Right Corner (Visible in normal mode) -->
<div id="questionCounter" class="question-counter hidden">
  <div id="currentQuestion" class="current-question">1</div>
  <div class="counter-separator">/</div>
  <div id="totalQuestions" class="total-questions">0</div>
</div>

  <!-- Online Status - Next to chat button -->
  <div class="online-status">
    <div class="online-dot"></div>
    <span class="online-text">·Éù·Éú·Éö·Éê·Éò·Éú: <span id="onlineCount">1</span></span>
  </div>
  
  <!-- Chat Window - 80% height -->
  <div id="chatWindow" class="chat-window">
    <div class="chat-header">
      <span>·Éõ·Éò·Éõ·Éù·É¨·Éî·É†·Éî·Éë·Éò</span>
<button class="close-chat">
  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M18 6L6 18M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>
</div>
    <div id="chatMessages" class="chat-messages">
      <!-- Messages will be inserted here -->
    </div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" class="chat-input" placeholder="·Éì·Éê·É¨·Éî·É†·Éî·Éó...">
      <button id="sendBtn" class="send-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="white"/>
        </svg>
      </button>
    </div>
  </div>
</div>
  
  <!-- Modal for Detailed Results -->
  <div id="detailedResultsModal" class="modal-overlay">
    <div class="modal" style="max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header" style="margin-bottom: 20px;">·Éì·Éî·É¢·Éê·Éö·É£·É†·Éò ·É®·Éî·Éì·Éî·Éí·Éî·Éë·Éò</div>
      <div id="detailedResultsContent" style="flex: 1; overflow-y: auto; padding-right: 10px;">
        <!-- Detailed results will be inserted here -->
      </div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button id="closeDetailsBtn" class="modal-btn confirm">·Éì·Éê·ÉÆ·É£·É†·Éï·Éê</button>
      </div>
    </div>
  </div>
  
<div class="container">
    <!-- Options Screen -->
    <div id="optionsScreen" class="options-screen">
      <div class="mode-label">·Éê·Éò·É†·É©·Éò·Éî·Éó ·É†·Éî·Éü·Éò·Éõ·Éò:</div>
      
<div class="option-row">
  <div class="option-item-half" style="display: flex; flex-direction: column; position: relative;">

    <label style="font-size: 14px; color: #64748b; margin-bottom: 5px;">
      ·Éõ·Éù·Éì·É£·Éö·Éò:
    </label>

    <!-- Dropdown button -->
    <div id="testTypeSelect"
         onclick="toggleModules()"
         style="cursor: pointer; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
      ·Éê·Éò·É†·É©·Éò·Éî·Éó
    </div>

    <!-- Modules list (hidden by default) -->
    <div id="modulesContainer"
         style="display: none; flex-direction: column; gap: 6px; max-height: 300px; overflow-y: auto; margin-top: 6px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">

      <!-- ·É†·Éî·Éñ·Éò·Éì·Éî·Éú·É¢·É£·É†·Éê -->
      <div style="font-weight: bold; background: #f1f5f9; color: #0ea5a4; text-align: center; padding: 4px;">
        ·É†·Éî·Éñ·Éò·Éì·Éî·Éú·É¢·É£·É†·Éê
      </div>

      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="samkurnaloo"> ·É°·Éê·Éõ·Éô·É£·É†·Éú·Éê·Éö·Éù
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="stomatologia"> ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>

      <!-- ·É°·Éê·Éö·Éò·É™·Éî·Éú·Éñ·Éò·Éù -->
      <div style="font-weight: bold; background: #f1f5f9; color: #0ea5a4; text-align: center; padding: 4px; margin-top: 6px;">
        ·É°·Éê·Éö·Éò·É™·Éî·Éú·Éñ·Éò·Éù
      </div>

      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="alergologia"> ·Éê·Éö·Éî·É†·Éí·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="angiokirurgia"> ·Éê·Éú·Éí·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="anesteziologia"> ·Éê·Éú·Éî·É°·Éó·Éî·Éñ·Éò·Éù·Éö·Éù·Éí·Éò·Éê, ·É†·Éî·Éê·Éú·Éò·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="bavshvta_gadaudebeli"> ·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="bavshvta_kardiorevmatologia"> ·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éô·Éê·É†·Éì·Éò·Éù·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="bavshvta_nevrologia"> ·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="bavshvta_nevrologia2"> ·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="gadaudebeli_medicina"> ·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="gastroenterologia"> ·Éí·Éê·É°·É¢·É†·Éù·Éî·Éú·É¢·Éî·É†·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="ginekologia"> ·Éí·Éò·Éú·Éî·Éô·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="dermatologia"> ·Éì·Éî·É†·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="endokrinologia"> ·Éî·Éú·Éì·Éù·Éô·É†·Éò·Éú·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="zogadi_kirurgia"> ·Éñ·Éù·Éí·Éê·Éì·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="terapiuli_stomatologia"> ·Éó·Éî·É†·Éê·Éû·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="infekciuri"> ·Éò·Éú·É§·Éî·É•·É™·Éò·É£·É†·Éò
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="kardiologia"> ·Éô·Éê·É†·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="kardiokirurgia"> ·Éô·Éê·É†·Éì·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="laboratoriuli_medicina"> ·Éö·Éê·Éë·Éù·É†·Éê·É¢·Éù·É†·Éò·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="narkologia"> ·Éú·Éê·É†·Éô·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="nevrologia"> ·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="neonatologia"> ·Éú·Éî·Éù·Éú·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="nefrologia"> ·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="onkologia"> ·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="ortodontia"> ·Éù·É†·Éó·Éù·Éì·Éù·Éú·É¢·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="ortopedia_travmatologia"> ·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·Éê ·É¢·É†·Éê·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="ortopediuli_stomatologia"> ·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="otorinolaringologia"> ·Éù·É¢·Éù·É†·Éò·Éú·Éù·Éö·Éê·É†·Éò·Éú·Éí·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="oftalmologia"> ·Éù·É§·Éó·Éê·Éö·Éõ·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="patologia"> ·Éû·Éê·Éó·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="pediatria"> ·Éû·Éî·Éì·Éò·Éê·É¢·É†·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="plastikuri_kirurgia"> ·Éû·Éö·Éê·É°·É¢·Éò·Éô·É£·É†·Éò ·Éì·Éê ·É†·Éî·Éô·Éù·Éú·É°·É¢·É†·É£·É•·É™·Éò·É£·Éö·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="radiologia"> ·É†·Éê·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="radiacioni_onkologia"> ·É†·Éê·Éì·Éò·Éê·É™·Éò·É£·Éö·Éò ·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="reproduqtologia"> ·É†·Éî·Éû·É†·Éù·Éì·É£·É•·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="revmatologia"> ·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="saokjao_medicina"> ·É°·Éê·Éù·ÉØ·Éê·ÉÆ·Éù ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="sportuli_medicina"> ·É°·Éû·Éù·É†·É¢·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="toksikologia"> ·É¢·Éù·É•·É°·Éò·Éô·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="urologia"> ·É£·É†·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="ftiziatria_pulmonologia"> ·É§·Éó·Éò·Éñ·Éò·Éê·É¢·É†·Éò·Éê, ·Éû·É£·Éö·Éõ·Éù·Éú·Éù·Éö·Éù·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="psikiatria"> ·É§·É°·Éò·É•·Éò·Éê·É¢·É†·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="qba_saxis_kirurgia"> ·Éß·Éë·Éê-·É°·Éê·ÉÆ·Éò·É° ·É•·Éò·É†·É£·É†·Éí·Éò·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="shinagani_medicina"> ·É®·Éò·Éú·Éê·Éí·Éê·Éú·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" class="module-checkbox" value="hematologia"> ·É∞·Éî·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê
      </label>

    </div>

  </div>
</div>
      
      <!-- Two-column layout for sequential and topic filter -->
<div class="option-row">
  <label class="option-item option-item-half">
<input type="checkbox" id="modeSequential" checked>
<span>·É¢·Éî·É°·É¢·Éî·Éë·Éò·É° ·É©·Éï·Éî·Éú·Éî·Éë·Éê ·Éó·Éê·Éú·Éõ·Éò·Éõ·Éì·Éî·Éï·É†·Éù·Éë·Éò·Éó</span>
  </label>
  
  <div id="topicsDropdownContainer" class="option-item-half" style="display: flex; flex-direction: column;">
    <select id="topicsSelect" class="topic-select">
      <option value="all" selected>·É¢·Éî·É°·É¢·Éî·Éë·Éò ·Éó·Éî·Éõ·Éî·Éë·Éò·É° ·Éõ·Éò·ÉÆ·Éî·Éì·Éï·Éò·Éó</option>
    </select>
  </div>
</div>
      
      <label class="option-item">
        <input type="checkbox" id="modeShuffleQuestions">
        <span>·É¢·Éî·É°·É¢·Éî·Éë·Éò·É° ·Éê·É†·Éî·Éï·Éê</span>
      </label>
      
      <label class="option-item">
        <input type="checkbox" id="modeShuffleAnswers">
        <span>·Éû·Éê·É°·É£·ÉÆ·Éî·Éë·Éò·É° ·Éê·É†·Éî·Éï·Éê</span>
      </label>
      
      <div class="mode-separator">
        <span>·É°·Éê·Éí·Éê·Éõ·Éù·É™·Éì·Éù ·É†·Éî·Éü·Éò·Éõ·Éò</span>
      </div>
      
      <label class="option-item">
        <input type="checkbox" id="modeExam">
        <span>·É°·Éê·Éí·Éê·Éõ·Éù·É™·Éì·Éù ·É†·Éî·Éü·Éò·Éõ·Éò (200 ·É®·Éî·Éõ·Éó·ÉÆ·Éï·Éî·Éï·Éò·Éó·Éò ·É¢·Éî·É°·É¢·Éò, ·Éì·É†·Éù 3 ·É°·Éê·Éê·Éó·Éò)</span>
      </label>
      
      <div id="loaderOverlay" class="loader-overlay">
        <div class="spinner"></div>
        <div class="loader-text">·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê...</div>
      </div>
      
      <button id="startBtn" class="start-btn" disabled>·Éì·Éê·É¨·Éß·Éî·Éë·Éê</button>
    </div>

    <div id="testScreen" class="test-screen">
      <div id="normalModeContainer" class="normal-mode-container hidden">
        <div id="questionText" class="question-text">·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê...</div>
        
        <div id="answersContainer" class="answers-container"></div>
        
        <div id="feedback" class="feedback"></div>
        
        <div class="navigation">
          <div class="nav-center">
            <button id="prevBtn" class="nav-btn">
              <svg class="vector-arrow prev" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              ·É¨·Éò·Éú·Éê
            </button>
            <button id="nextBtn" class="nav-btn">
              ·É®·Éî·Éõ·Éì·Éî·Éí·Éò
              <svg class="vector-arrow next" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button id="autoBtn" class="nav-btn auto-btn">Auto</button>
          </div>
        </div>
      </div>
      
      <div id="examModeContainer" class="exam-mode-container hidden">
        <div class="question-left-panel">
          <div id="examQuestionText" class="exam-question-text">·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê...</div>
          
          <div id="examAnswersContainer" class="exam-answers-container"></div>
          
          <div id="examFeedback" class="exam-feedback"></div>
          
          <div class="exam-navigation-container">
            <div class="nav-center">
              <button id="examPrevBtn" class="nav-btn">
                <svg class="vector-arrow prev" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                ·É¨·Éò·Éú·Éê
              </button>
              <button id="examFinishBtn" class="nav-btn" style="background: var(--danger);">
              ·Éì·Éê·É°·É†·É£·Éö·Éî·Éë·Éê
              </button>
              <button id="examNextBtn" class="nav-btn">
                ·É®·Éî·Éõ·Éì·Éî·Éí·Éò
                <svg class="vector-arrow next" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button id="examAutoBtn" class="nav-btn auto-btn">Auto</button>
            </div>
          </div>
        </div>
        
        <div id="examRightPanel" class="exam-right-panel hidden">
          <div id="examCountdown" class="exam-countdown">03:00:00</div>
          
          <div id="examTestBoxes" class="exam-test-boxes"></div>
        </div>
      </div>
    </div>
  </div>

<script>
// ==================== FIREBASE INITIALIZATION ====================
let database = null;
let firebaseInitialized = false;
let firebaseSyncEnabled = false;

try {
  const firebaseConfig = {
    apiKey: "AIzaSyAOyV8LZWBkU5W8UbTF082l1ft1T2Rj1Yc",
    authDomain: "rezidentura-7bfd5.firebaseapp.com",
    databaseURL: "https://rezidentura-7bfd5-default-rtdb.firebaseio.com",
    projectId: "rezidentura-7bfd5",
    storageBucket: "rezidentura-7bfd5.firebasestorage.app",
    messagingSenderId: "1005787481414",
    appId: "1:1005787481414:web:7c5a31471a3d1c1a159147",
    measurementId: "G-VPECPS9CEP"
  };

  if (typeof firebase !== 'undefined') {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    database = firebase.database();
    firebaseInitialized = true;
    firebaseSyncEnabled = true;
    console.log("Firebase initialized successfully");
  }
} catch (error) {
  console.warn("Firebase initialization failed, chat will work in local mode:", error);
  firebaseSyncEnabled = false;
}

function saveUserToFirebase(username, userData) {
  if (!firebaseSyncEnabled || !database || !username) return Promise.resolve(false);
  
  // üî• ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò: ·Éì·Éê·Éï·É†·É¨·Éõ·É£·Éú·Éì·Éî·Éó, ·É†·Éù·Éõ ·Éõ·Éó·Éî·Éö·Éò ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò ·Éò·Éú·Éê·ÉÆ·Éî·Éë·Éê
  const dataToSave = {
    username: username,
    password: userData.password,
    progress: userData.progress || userProgress, // ·Éí·Éê·Éõ·Éù·Éï·Éò·Éß·Éî·Éú·Éù·Éó ·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò
    selectedModule: currentTestType || userData.selectedModule,
    lastUpdated: Date.now()
  };
  
  return database.ref('users/' + username.replace(/[.#$[\]]/g, '_')).set(dataToSave)
    .then(() => {
      console.log('User data saved to Firebase:', username);
      return true;
    })
    .catch(error => {
      console.error('Error saving user to Firebase:', error);
      return false;
    });
}

async function syncUserWithFirebase(username, localUserData) {
  if (!firebaseSyncEnabled || !database || !username) return localUserData;
  
  try {
    const firebaseUserData = await loadUserFromFirebase(username);
    
    if (!firebaseUserData) {
      await saveUserToFirebase(username, localUserData);
      return localUserData;
    }
    
    const localLastUpdated = localUserData.lastUpdated || 0;
    const firebaseLastUpdated = firebaseUserData.lastUpdated || 0;
    
    if (firebaseLastUpdated > localLastUpdated) {
      console.log('Using Firebase data (newer)');
      return firebaseUserData;
    } else {
      await saveUserToFirebase(username, localUserData);
      return localUserData;
    }
  } catch (error) {
    console.error('Error syncing user with Firebase:', error);
    return localUserData;
  }
}

// ==================== ENHANCED USER MANAGEMENT ====================
let currentUser = null;
let currentTestType = null;
let userProgress = {
  // ·É†·Éî·Éñ·Éò·Éì·Éî·Éú·É¢·É£·É†·Éê
  samkurnaloo: {
    normal: { answeredQuestions: {}, currentIndex: 0 },
    exam: { answeredQuestions: {}, currentIndex: 0 },
    wrongQuestions: []
  },
  stomatologia: {
    normal: { answeredQuestions: {}, currentIndex: 0 },
    exam: { answeredQuestions: {}, currentIndex: 0 },
    wrongQuestions: []
  },
  // ·É°·Éê·Éö·Éò·É™·Éî·Éú·Éñ·Éò·Éù - ·Éì·Éê·Éê·Éõ·Éê·É¢·Éî·Éó ·Éß·Éï·Éî·Éö·Éê ·Éõ·Éù·Éì·É£·Éö·Éò
  alergologia: {
    normal: { answeredQuestions: {}, currentIndex: 0 },
    exam: { answeredQuestions: {}, currentIndex: 0 },
    wrongQuestions: []
  },
  angiokirurgia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  anesteziologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  bavshvta_gadaudebeli: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  bavshvta_kardiorevmatologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  bavshvta_nevrologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  bavshvta_nevrologia2: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  gadaudebeli_medicina: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  gastroenterologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  ginekologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  dermatologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  endokrinologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  zogadi_kirurgia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  terapiuli_stomatologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  infekciuri: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  kardiologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  kardiokirurgia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  laboratoriuli_medicina: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  narkologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  nevrologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  neonatologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  nefrologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  onkologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  ortodontia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  ortopedia_travmatologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  ortopediuli_stomatologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  otorinolaringologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  oftalmologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  patologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  pediatria: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  plastikuri_kirurgia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  radiologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  radiacioni_onkologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  reproduqtologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  revmatologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  saokjao_medicina: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  sportuli_medicina: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  toksikologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  urologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  ftiziatria_pulmonologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  psikiatria: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  qba_saxis_kirurgia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  shinagani_medicina: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] },
  hematologia: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] }
};

// ==================== GLOBAL VARIABLES ====================
let allTests = [];
let sessionTests = [];
let currentIndex = 0;
let autoMode = false;
let examMode = false;
let examTimeRemaining = 3 * 60 * 60;
let examTimerInterval = null;
let isEditingQuestionNumber = false;
let allTestsWithTopics = [];
let availableTopics = new Set();
let selectedTopic = null;
let lastTimerUpdate = Date.now();
let isWrongQuestionsMode = false;
let progressModalShown = false;

// ==================== PROGRESS MODAL CONTROL ====================
let progressCheckTimeout = null;
let isProgressModalShowing = false;
let lastProgressCheckTime = 0;

// üî¥ ·Éê·ÉÆ·Éê·Éö·Éò ·É§·Éö·Éê·Éí·Éò ·É°·Éê·ÉÆ·Éî·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éò·É°·Éó·Éï·Éò·É°
window._isChangingUsername = false;

// ==================== CHAT FUNCTIONS ====================
let chatMessages = [];
let onlineUsers = 1;
let userName = localStorage.getItem('chatUserName') || ('·É°·É¢·É£·Éõ·Éê·É†·Éò N' + Math.floor(Math.random() * 1000));
let userId = localStorage.getItem('chatUserId');
let isOnline = false;
let displayedMessageKeys = new Set();
let unreadMessagesCount = 0;
let isChatOpen = false;
let lastSeenMessageTime = parseInt(localStorage.getItem('lastSeenMessageTime')) || Date.now();
let allMessagesLoaded = false;

if (!userId) {
  userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('chatUserId', userId);
}

if (!localStorage.getItem('chatUserName')) {
  localStorage.setItem('chatUserName', userName);
}

// ==================== DOM ELEMENTS ====================
const optionsScreen = document.getElementById('optionsScreen');
const testScreen = document.getElementById('testScreen');
const questionText = document.getElementById('questionText');
const answersContainer = document.getElementById('answersContainer');
const feedback = document.getElementById('feedback');
const startBtn = document.getElementById('startBtn');
const timerElement = document.getElementById('timer');
const examRightPanel = document.getElementById('examRightPanel');
const examCountdown = document.getElementById('examCountdown');
const examTestBoxes = document.getElementById('examTestBoxes');
const questionCounter = document.getElementById('questionCounter');
const currentQuestionEl = document.getElementById('currentQuestion');
const totalQuestionsEl = document.getElementById('totalQuestions');
const loaderOverlay = document.getElementById('loaderOverlay');

// Chat elements
let chatButton, chatWindow, closeChat, chatMessagesEl, onlineCount, chatInput, sendBtn;

const modeSequential = document.getElementById('modeSequential');
const modeShuffleQuestions = document.getElementById('modeShuffleQuestions');
const modeShuffleAnswers = document.getElementById('modeShuffleAnswers');
const modeExam = document.getElementById('modeExam');

const normalModeContainer = document.getElementById('normalModeContainer');
const examModeContainer = document.getElementById('examModeContainer');
const examQuestionText = document.getElementById('examQuestionText');
const examAnswersContainer = document.getElementById('examAnswersContainer');
const examFeedback = document.getElementById('examFeedback');

let prevBtn, nextBtn, autoBtn;
let examPrevBtn, examNextBtn, examAutoBtn, examFinishBtn;
let detailedResultsModal = document.getElementById('detailedResultsModal');
let detailedResultsContent = document.getElementById('detailedResultsContent');

async function saveUserProgress() {
  if (currentUser && currentUser.username && !currentUser.isGuest) {
    try {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (users[currentUser.username]) {
        users[currentUser.username].progress = userProgress;
        users[currentUser.username].lastUpdated = Date.now();
        localStorage.setItem('users', JSON.stringify(users));
        console.log('Progress saved locally for', currentUser.username);
        
        // üî• ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò: ·Éß·Éù·Éï·Éî·Éö·Éó·Éï·Éò·É° ·É®·Éî·Éï·Éò·Éú·Éê·ÉÆ·Éù·Éó Firebase-·É®·Éò
        if (firebaseSyncEnabled && database) {
          await saveUserToFirebase(currentUser.username, users[currentUser.username]);
          console.log('Progress synced to Firebase for', currentUser.username);
        }
      }
    } catch (error) {
      console.error('Error saving user progress:', error);
    }
  }
}

async function loadUserProgress() {
    if (!currentUser || !currentUser.username) {
        console.log("No current user, skipping progress load");
        return;
    }

    console.log("Loading progress for user:", currentUser.username);

    try {
        // ·Éû·Éò·É†·Éï·Éî·Éö ·É†·Éò·Éí·É®·Éò ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éî Firebase-·É®·Éò ·Éê·É†·É°·Éî·Éë·Éù·Éë·É° ·Éó·É£ ·Éê·É†·Éê ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò
        if (firebaseSyncEnabled && database) {
            const firebaseUserData = await loadUserFromFirebase(currentUser.username);
            
            // ·Éó·É£ Firebase-·É®·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éê·É† ·Éê·É†·É°·Éî·Éë·Éù·Éë·É° - ·Éê·Éú·Éí·Éê·É†·Éò·É®·Éò ·É¨·Éê·É®·Éö·Éò·Éö·Éò·Éê
            if (!firebaseUserData) {
                console.warn("User not found in Firebase - account was deleted");
                
                // ·É¨·Éê·Éï·É®·Éê·Éö·Éù·Éó localStorage-·Éì·Éê·Éú
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                if (users[currentUser.username]) {
                    delete users[currentUser.username];
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                // ·É¨·Éê·Éï·É®·Éê·Éö·Éù·Éó ·É©·Éê·É¢·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò
                localStorage.removeItem('chatUserName');
                localStorage.removeItem('chatUserId');
                
                // ·Éí·Éê·Éõ·Éù·Éï·Éê·É©·Éò·Éú·Éù·Éó ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê
                showNotification('·Éó·É•·Éï·Éî·Éú·Éò ·Éê·Éú·Éí·Éê·É†·Éò·É®·Éò ·É¨·Éê·Éò·É®·Éê·Éö·Éê. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éì·Éê·É†·Éî·Éí·Éò·É°·É¢·É†·Éò·É†·Éì·Éî·Éó ·Éó·Éê·Éï·Éò·Éì·Éê·Éú.', true);
                
                // ·Éí·Éê·Éï·Éê·É°·É£·É§·Éó·Éê·Éù·Éó currentUser
                currentUser = null;
                
                // ·Éì·Éê·Éï·Éõ·Éê·Éö·Éù·Éó ·Éò·É£·Éñ·Éî·É†·Éò·É° ·Éò·Éú·É§·Éù
                document.getElementById('userInfo').style.display = 'none';
                
                // ·Éí·Éê·Éõ·Éù·Éï·Éê·É©·Éò·Éú·Éù·Éó ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éò·É° ·Éõ·Éù·Éì·Éê·Éö·Éò
                setTimeout(() => {
                    document.getElementById('authModal').style.display = 'flex';
                }, 2000);
                
                return;
            }
            
            // ·Éó·É£ ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éõ·Éù·Éú·Éò·É®·Éú·É£·Éö·Éò·Éê ·É†·Éù·Éí·Éù·É†·É™ ·É¨·Éê·É®·Éö·Éò·Éö·Éò
            if (firebaseUserData.deleted === true) {
                console.warn("User account is marked as deleted");
                
                showNotification('·Éî·É° ·Éê·Éú·Éí·Éê·É†·Éò·É®·Éò ·Éí·Éê·É£·É•·Éõ·Éî·Éë·É£·Éö·Éò·Éê!', true);
                
                currentUser = null;
                document.getElementById('userInfo').style.display = 'none';
                
                setTimeout(() => {
                    document.getElementById('authModal').style.display = 'flex';
                }, 2000);
                
                return;
            }
            
            // üî• ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò: Firebase-·Éì·Éê·Éú ·É¨·Éê·Éõ·Éù·É¶·Éî·Éë·É£·Éö·Éò ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éí·Éê·Éõ·Éù·Éï·Éò·Éß·Éî·Éú·Éù·Éó
            console.log("Using Firebase data for user:", currentUser.username);
            
            // ·É®·Éî·Éï·É•·Éõ·Éú·Éê·Éó userProgress ·Éù·Éë·Éò·Éî·É•·É¢·Éò Firebase-·Éì·Éê·Éú
            if (firebaseUserData.progress) {
                userProgress = firebaseUserData.progress;
                console.log('Progress loaded from Firebase for', currentUser.username);
            }
            
            // ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó localStorage Firebase-·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·Éó
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            users[currentUser.username] = {
                password: firebaseUserData.password || '',
                progress: userProgress,
                lastUpdated: firebaseUserData.lastUpdated || Date.now()
            };
            localStorage.setItem('users', JSON.stringify(users));
            
        } else {
            // ·Éó·É£ Firebase ·Éê·É† ·Éõ·É£·É®·Éê·Éù·Éë·É°, ·Éí·Éê·Éõ·Éù·Éï·Éò·Éß·Éî·Éú·Éù·Éó localStorage
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            let localUserData = users[currentUser.username] || null;
            
            if (localUserData && localUserData.progress) {
                userProgress = localUserData.progress;
                console.log('Progress loaded locally for', currentUser.username);
            }
        }
        
        // ·Éì·Éê·Éê·Éß·Éî·Éú·Éî ·É†·Éî·Éê·Éö·É£·É† ·Éì·É†·Éù·É®·Éò ·Éõ·Éù·Éú·Éò·É¢·Éù·É†·Éò·Éú·Éí·Éò
        setupUserDeletionListener();
        
    } catch (error) {
        console.error('Error loading user progress:', error);
        showNotification('·É®·Éî·É™·Éì·Éù·Éõ·Éê ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É°·Éê·É°', true);
    }
}

// ==================== REAL-TIME DELETION LISTENER ====================
function setupUserDeletionListener() {
    if (!firebaseSyncEnabled || !database || !currentUser || !currentUser.username) return;
    
    console.log("Setting up real-time deletion listener for:", currentUser.username);
    
    const safeUsername = currentUser.username.replace(/[.#$[\]]/g, '_');
    const userRef = database.ref('users/' + safeUsername);
    
    // ·Éõ·Éù·Éï·É£·É°·Éõ·Éò·Éú·Éù·Éó ·É™·Éï·Éö·Éò·Éö·Éî·Éë·Éî·Éë·É° Firebase-·É®·Éò
    userRef.on('value', (snapshot) => {
        const userData = snapshot.val();
        
        // üî¥ ·Éó·É£ ·É°·Éê·ÉÆ·Éî·Éö·É° ·Éï·É™·Éï·Éö·Éò·Éó, ·Éê·É† ·Éí·Éê·Éï·É£·É®·Éï·Éê·Éó ·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éò ·Éí·Éê·É°·Éï·Éö·Éê
        if (window._isChangingUsername) {
            console.log("Username is being changed, ignoring deletion event");
            return;
        }
        
        // ·Éó·É£ ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·É¨·Éê·É®·Éö·Éò·Éö·Éò·Éê Firebase-·Éì·Éê·Éú
        if (!userData) {
            console.warn("User deleted from Firebase - forcing logout");
            handleAccountDeletion("·É¨·Éê·É®·Éö·Éò·Éö·Éò·Éê ·Éê·Éì·Éõ·Éò·Éú·Éò·É°·É¢·É†·Éê·É¢·Éù·É†·Éò·É° ·Éõ·Éò·Éî·É†");
        }
        // ·Éó·É£ ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éõ·Éù·Éú·Éò·É®·Éú·É£·Éö·Éò·Éê ·É†·Éù·Éí·Éù·É†·É™ ·É¨·Éê·É®·Éö·Éò·Éö·Éò
        else if (userData.deleted === true) {
            console.warn("User account is deleted - forcing logout");
            handleAccountDeletion("·Éì·Éê·Éë·Éö·Éù·Éô·Éò·Éö·Éò·Éê ·Éê·Éì·Éõ·Éò·Éú·Éò·É°·É¢·É†·Éê·É¢·Éù·É†·Éò·É° ·Éõ·Éò·Éî·É†");
        }
    }, (error) => {
        console.error("Error in user listener:", error);
    });
    
    // ·Éê·É°·Éî·Éï·Éî ·Éõ·Éù·Éï·É£·É°·Éõ·Éò·Éú·Éù·Éó ·É°·Éò·É°·É¢·Éî·Éõ·É£·É† ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éî·Éë·É°
    const forceLogoutRef = database.ref('system/forceLogout');
    forceLogoutRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        
        // üî¥ ·Éó·É£ ·É°·Éê·ÉÆ·Éî·Éö·É° ·Éï·É™·Éï·Éö·Éò·Éó, ·Éê·É† ·Éí·Éê·Éï·É£·É®·Éï·Éê·Éó ·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éò ·Éí·Éê·É°·Éï·Éö·Éê
        if (window._isChangingUsername) {
            console.log("Username is being changed, ignoring force logout");
            return;
        }
        
        // ·Éó·É£ ·Éî·É° ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê ·É©·Éï·Éî·Éú·É° ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·É° ·Éî·ÉÆ·Éî·Éë·Éê
        if (data.userId === currentUser.username || data.userId === safeUsername) {
            console.warn("Force logout message received");
            handleAccountDeletion(data.reason || '·Éê·Éì·Éõ·Éò·Éú·Éò·É°·É¢·É†·Éê·É¢·Éù·É†·Éò·É° ·Éõ·Éò·Éî·É†');
        }
    });
}

function handleAccountDeletion(reason = "·Éê·Éì·Éõ·Éò·Éú·Éò·É°·É¢·É†·Éê·É¢·Éù·É†·Éò·É° ·Éõ·Éò·Éî·É†") {
    // üî¥ ·Éó·É£ ·É°·Éê·ÉÆ·Éî·Éö·É° ·Éï·É™·Éï·Éö·Éò·Éó, ·Éê·É† ·Éí·Éê·Éï·É£·É®·Éï·Éê·Éó ·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éò ·Éí·Éê·É°·Éï·Éö·Éê
    if (window._isChangingUsername) {
        console.log("Username is being changed, skipping account deletion");
        return;
    }
    
    // ·Éí·Éê·Éï·Éê·É°·É£·É§·Éó·Éê·Éù·Éó localStorage ·Éõ·Éó·Éö·Éò·Éê·Éú·Éê·Éì
    localStorage.removeItem('users');
    localStorage.removeItem('currentUser');
    localStorage.removeItem('chatUserName');
    localStorage.removeItem('chatUserId');
    localStorage.removeItem('lastSeenMessageTime');
    
    // ·Éí·Éê·Éï·Éê·É°·É£·É§·Éó·Éê·Éù·Éó sessionStorage
    sessionStorage.clear();
    
    // ·Éí·Éê·Éï·Éê·É£·É•·Éõ·Éù·Éó currentUser
    currentUser = null;
    
    // ·Éì·Éê·Éï·Éõ·Éê·Éö·Éù·Éó ·Éò·É£·Éñ·Éî·É†·Éò·É° ·Éò·Éú·É§·Éù
    const userInfo = document.getElementById('userInfo');
    if (userInfo) userInfo.style.display = 'none';
    
    // ·Éì·Éê·Éï·Éõ·Éê·Éö·Éù·Éó ·É¢·Éê·Éò·Éõ·Éî·É†·Éò
    const timer = document.getElementById('timer');
    if (timer) timer.classList.add('hidden');
    
    // ·É¨·Éê·Éï·É®·Éê·Éö·Éù·Éó ·É©·Éê·É¢·Éò·É° ·É§·Éê·Éú·ÉØ·Éê·É†·Éê
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) chatWindow.classList.remove('active');
    
    // ·Éí·Éê·Éõ·Éù·Éï·Éê·É©·Éò·Éú·Éù·Éó ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê
    showNotification(`‚õî ·Éó·É•·Éï·Éî·Éú·Éò ·Éê·Éú·Éí·Éê·É†·Éò·É®·Éò ${reason}. ·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éì·Éê·É†·Éî·Éí·Éò·É°·É¢·É†·Éò·É†·Éì·Éî·Éó ·Éó·Éê·Éï·Éò·Éì·Éê·Éú.`, true);
    
    // ·Éí·Éê·Éì·Éê·Éï·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·Éõ·Éó·Éê·Éï·Éê·É† ·Éí·Éï·Éî·É†·Éì·Éñ·Éî
    if (testScreen && testScreen.classList.contains('active')) {
        testScreen.classList.remove('active');
        optionsScreen.style.display = 'block';
    }
    
    // ·Éí·Éê·Éõ·Éù·Éï·Éê·É©·Éò·Éú·Éù·Éó ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éò·É° ·Éõ·Éù·Éì·Éê·Éö·Éò
    setTimeout(() => {
        const authModal = document.getElementById('authModal');
        if (authModal) {
            authModal.style.display = 'flex';
            
            // ·Éí·Éê·Éì·Éê·Éï·É†·Éó·Éù·Éó ·É°·É¢·É£·Éõ·É†·Éò·É° ·É¢·Éê·Éë·Éñ·Éî
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
            
            const guestTab = document.querySelector('[data-tab="guest"]');
            if (guestTab) {
                guestTab.classList.add('active');
                document.getElementById('guestTab').classList.add('active');
            }
        }
    }, 2000);
}

// ==================== FIXED: HANDLE LOGIN WITH DELETION CHECK ====================
async function handleLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    document.getElementById('loginUsernameError').style.display = 'none';
    document.getElementById('loginPasswordError').style.display = 'none';
    
    if (!username) {
        document.getElementById('loginUsernameError').textContent = '·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éì·Éê ·Éí·Éï·Éê·É†·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê';
        document.getElementById('loginUsernameError').style.display = 'block';
        return;
    }
    
    const nameParts = username.split(/\s+/);
    if (nameParts.length < 2) {
        document.getElementById('loginUsernameError').textContent = '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·É°·Éê·ÉÆ·Éî·Éö·Éò·É™ ·Éì·Éê ·Éí·Éï·Éê·É†·Éò·É™';
        document.getElementById('loginUsernameError').style.display = 'block';
        return;
    }
    
    if (!password) {
        document.getElementById('loginPasswordError').textContent = '·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê';
        document.getElementById('loginPasswordError').style.display = 'block';
        return;
    }
    
    try {
        // ·Éû·Éò·É†·Éï·Éî·Éö ·É†·Éò·Éí·É®·Éò ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éî Firebase
        if (firebaseSyncEnabled && database) {
            const firebaseUser = await loadUserFromFirebase(username);
            
            // ·Éó·É£ Firebase-·É®·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éê·É† ·Éê·É†·É°·Éî·Éë·Éù·Éë·É°
            if (!firebaseUser) {
                document.getElementById('loginUsernameError').textContent = '·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éê·É† ·Éê·É†·É°·Éî·Éë·Éù·Éë·É° ·Éê·Éú ·É¨·Éê·É®·Éö·Éò·Éö·Éò·Éê';
                document.getElementById('loginUsernameError').style.display = 'block';
                return;
            }
            
            // ·Éó·É£ ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éõ·Éù·Éú·Éò·É®·Éú·É£·Éö·Éò·Éê ·É†·Éù·Éí·Éù·É†·É™ ·É¨·Éê·É®·Éö·Éò·Éö·Éò
            if (firebaseUser.deleted === true) {
                document.getElementById('loginUsernameError').textContent = '·Éî·É° ·Éê·Éú·Éí·Éê·É†·Éò·É®·Éò ·Éì·Éê·Éë·Éö·Éù·Éô·Éò·Éö·Éò·Éê ·Éê·Éì·Éõ·Éò·Éú·Éò·É°·É¢·É†·Éê·É¢·Éù·É†·Éò·É° ·Éõ·Éò·Éî·É†';
                document.getElementById('loginUsernameError').style.display = 'block';
                return;
            }
            
            // ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éî ·Éû·Éê·É†·Éù·Éö·Éò Firebase-·É®·Éò
            if (firebaseUser.password !== password) {
                document.getElementById('loginPasswordError').textContent = '·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É†·Éê·É°·É¨·Éù·É†·Éò·Éê';
                document.getElementById('loginPasswordError').style.display = 'block';
                return;
            }
        }
        
        // ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éî localStorage-·É®·Éò·É™
        let users = JSON.parse(localStorage.getItem('users') || '{}');
        let userFound = false;
        
        if (users[username] && users[username].password === password) {
            userFound = true;
        }
        
        if (!userFound && firebaseSyncEnabled && database) {
            // ·Éó·É£ Firebase-·É®·Éò ·Éê·É†·É°·Éî·Éë·Éù·Éë·É° ·Éõ·Éê·Éí·É†·Éê·Éõ localStorage-·É®·Éò ·Éê·É†·Éê, ·É®·Éî·Éï·É•·Éõ·Éú·Éê·Éó
            const firebaseUser = await loadUserFromFirebase(username);
            if (firebaseUser && firebaseUser.password === password && !firebaseUser.deleted) {
                users[username] = {
                    password: firebaseUser.password,
                    progress: firebaseUser.progress || {
                        rezidentura: {
                            normal: { answeredQuestions: {}, currentIndex: 0 },
                            exam: { answeredQuestions: {}, currentIndex: 0 },
                            wrongQuestions: []
                        }
                    },
                    lastUpdated: firebaseUser.lastUpdated || Date.now()
                };
                localStorage.setItem('users', JSON.stringify(users));
                userFound = true;
            }
        }
        
        if (!userFound) {
            document.getElementById('loginUsernameError').textContent = '·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éê·Éú ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É†·Éê·É°·É¨·Éù·É†·Éò·Éê';
            document.getElementById('loginUsernameError').style.display = 'block';
            return;
        }
        
// ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·É£·Éö·Éò ·É®·Éî·É°·Éï·Éö·Éê
// ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·É£·Éö·Éò ·É®·Éî·É°·Éï·Éö·Éê
currentUser = { 
    username: username, 
    isGuest: false
};

await loadUserProgress();

document.getElementById('loginUsername').value = '';
document.getElementById('loginPassword').value = '';

document.getElementById('authModal').style.display = 'none';
document.getElementById('userInfo').style.display = 'flex';
document.getElementById('usernameDisplay').textContent = currentUser.username;

userName = currentUser.username;
localStorage.setItem('chatUserName', userName);

showNotification('·Éõ·Éù·Éí·Éî·É°·Éê·Éö·Éõ·Éî·Éë·Éò·Éó!', false);

// ·Éí·Éê·É£·É®·Éï·Éò ·Éõ·Éù·Éú·Éò·É¢·Éù·É†·Éò·Éú·Éí·Éò
setupUserDeletionListener();

// ·Éõ·Éù·Éì·É£·Éö·Éò·É° Firebase listener
setupModuleListener();

initChat();
bindUserMenuEvents();
updateTimerDisplay();

// ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éî ·Éõ·Éù·Éì·É£·Éö·Éò Firebase-·Éì·Éê·Éú - ·Éî·É° ·É£·Éú·Éì·Éê ·Éò·Éß·Éù·É° ·Éë·Éù·Éö·Éù·É°
loadSelectedModule();

if (allTests.length === 0) {
    loadCSV();
} else {
    startBtn.disabled = false;
    setTimeout(() => {
        const examModeCheckbox = document.getElementById('modeExam');
        if (!examModeCheckbox || !examModeCheckbox.checked) {
            checkExistingProgress();
        }
    }, 500);
}
        
    } catch (error) {
        console.error('Login error:', error);
        showNotification('·É®·Éî·É™·Éì·Éù·Éõ·Éê ·É®·Éî·É°·Éï·Éö·Éò·É° ·Éì·É†·Éù·É°. ·É°·É™·Éê·Éì·Éî·Éó ·Éõ·Éù·Éí·Éï·Éò·Éê·Éú·Éî·Éë·Éò·Éó');
    }
}

function loadUserFromFirebase(username) {
    if (!firebaseSyncEnabled || !database || !username) return Promise.resolve(null);
    
    return database.ref('users/' + username.replace(/[.#$[\]]/g, '_')).once('value').then(snapshot => {
        if (snapshot.exists()) {
            const userData = snapshot.val();
            
            // üî¥ ·Éó·É£ ·É°·Éê·ÉÆ·Éî·Éö·É° ·Éï·É™·Éï·Éö·Éò·Éó, ·Éß·Éï·Éî·Éö·Éê·É§·Éî·É†·Éò ·Éú·Éù·É†·Éõ·Éê·Éö·É£·É†·Éê·Éì ·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî·Éù·Éë·É°
            if (window._isChangingUsername) {
                console.log("Username change in progress, returning user data");
                return userData;
            }
            
            // ·Éó·É£ ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éõ·Éù·Éú·Éò·É®·Éú·É£·Éö·Éò·Éê ·É†·Éù·Éí·Éù·É†·É™ ·É¨·Éê·É®·Éö·Éò·Éö·Éò, ·Éê·É† ·Éì·Éê·Éï·Éê·Éë·É†·É£·Éú·Éù·Éó
            if (userData.deleted === true) {
                console.log("User is marked as deleted in Firebase");
                return null;
            }
            
            console.log('User data loaded from Firebase:', username);
            return userData;
        }
        return null;
    }).catch(error => {
        console.error('Error loading user from Firebase:', error);
        return null;
    });
}

// ==================== FIXED: UPDATE USER PROGRESS ====================
function updateUserProgress(questionId, selectedAnswer, isCorrect, isExamMode = false) {
  if (!currentUser || currentUser.isGuest || !currentTestType) return;

  const mode = isExamMode ? 'exam' : 'normal';
  
  // 1. ·Éï·Éê·Éõ·Éù·É¨·Éõ·Éî·Éë·Éó, ·É†·Éù·Éõ ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·Éù·Éë·Éò·Éî·É•·É¢·Éò ·Éê·É†·É°·Éî·Éë·Éù·Éë·É°
  if (!userProgress[currentTestType]) {
    userProgress[currentTestType] = {
      normal: { answeredQuestions: {}, currentIndex: 0 },
      exam: { answeredQuestions: {}, currentIndex: 0 },
      wrongQuestions: []
    };
  }
  
  // 2. ·Éï·Éê·Éõ·Éù·É¨·Éõ·Éî·Éë·Éó, ·É†·Éù·Éõ ·É†·Éî·Éü·Éò·Éõ·Éò·É° (normal/exam) ·Éù·Éë·Éò·Éî·É•·É¢·Éò ·Éê·É†·É°·Éî·Éë·Éù·Éë·É°
  if (!userProgress[currentTestType][mode]) {
    userProgress[currentTestType][mode] = { answeredQuestions: {}, currentIndex: 0 };
  }

  // üî¥ ·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·É®·Éî·É°·É¨·Éù·É†·Éî·Éë·Éê #1: Firebase-·Éõ·Éê ·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê ·É¨·Éê·É®·Éê·Éö·Éù·É° answeredQuestions ·Éù·Éë·Éò·Éî·É•·É¢·Éò, ·Éó·É£ ·Éò·É° ·É™·Éê·É†·Éò·Éî·Éö·Éò ·Éò·Éß·Éù!
  if (!userProgress[currentTestType][mode].answeredQuestions) {
    userProgress[currentTestType][mode].answeredQuestions = {};
  }
  
  // üî¥ ·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·É®·Éî·É°·É¨·Éù·É†·Éî·Éë·Éê #2: Firebase-·Éõ·Éê ·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê ·Éõ·Éê·É°·Éò·Éï·Éò ·Éí·Éê·Éì·Éê·Éê·É•·É™·Éò·Éù·É° ·Éù·Éë·Éò·Éî·É•·É¢·Éê·Éì ·Éê·Éú ·É¨·Éê·É®·Éê·Éö·Éù·É°
  if (!Array.isArray(userProgress[currentTestType].wrongQuestions)) {
    if (userProgress[currentTestType].wrongQuestions) {
      userProgress[currentTestType].wrongQuestions = Object.values(userProgress[currentTestType].wrongQuestions);
    } else {
      userProgress[currentTestType].wrongQuestions = [];
    }
  }
  
  let globalQuestionId = questionId;
  
  if (sessionTests && sessionTests.length > 0 && sessionTests.length < allTestsWithTopics.length) {
    const currentQuestion = sessionTests[currentIndex];
    if (currentQuestion && currentQuestion.originalGlobalId !== undefined) {
      globalQuestionId = currentQuestion.originalGlobalId;
    } else {
      const matchingGlobalIndex = allTestsWithTopics.findIndex(
        (test, idx) => test.question === currentQuestion.question
      );
      if (matchingGlobalIndex !== -1) {
        globalQuestionId = matchingGlobalIndex.toString();
      }
    }
  }
  
  const previousAnswer = userProgress[currentTestType][mode].answeredQuestions[globalQuestionId];
  const hasPreviousAnswer = previousAnswer !== undefined;

  // ·Éê·ÉÆ·Éö·Éê ·É£·Éô·Éï·Éî ·É£·É°·Éê·É§·É†·Éó·ÉÆ·Éù·Éê ·Éû·Éê·É°·É£·ÉÆ·Éò·É° ·É©·Éê·É¨·Éî·É†·Éê
  userProgress[currentTestType][mode].answeredQuestions[globalQuestionId] = {
    selectedAnswer: selectedAnswer,
    isCorrect: isCorrect,
    timestamp: Date.now()
  };

  if (!isExamMode) {
    const wrongQuestions = userProgress[currentTestType].wrongQuestions;
    const questionIndex = wrongQuestions.indexOf(globalQuestionId);

    if (!isCorrect) {
      if (questionIndex === -1) {
        wrongQuestions.push(globalQuestionId);
        console.log(`Question ${globalQuestionId} added to wrong questions`);
      }
    } else {
      if (!hasPreviousAnswer) {
        if (questionIndex !== -1) {
          wrongQuestions.splice(questionIndex, 1);
        }
      } else {
        if (previousAnswer && !previousAnswer.isCorrect) {
          if (questionIndex === -1) {
            wrongQuestions.push(globalQuestionId);
          }
        } else if (questionIndex !== -1) {
          wrongQuestions.splice(questionIndex, 1);
        }
      }
    }
  }
  
  saveUserProgress();
  
  if (isWrongQuestionsMode && !isExamMode) {
    setTimeout(() => {
      if (sessionTests.length > 0 && getWrongQuestions().length === 0) {
        showWrongQuestionsExhaustedModal();
      }
    }, 100);
  }
}

function checkWrongQuestionsExhausted() {
  if (!currentUser || currentUser.isGuest || !currentTestType) return false;
  
  if (!isWrongQuestionsMode) return false;
  
  const wrongQuestions = getWrongQuestions();
  
  if (wrongQuestions.length === 0) {
    showWrongQuestionsExhaustedModal();
    return true;
  }
  
  return false;
}

function showWrongQuestionsExhaustedModal() {
  console.log("showWrongQuestionsExhaustedModal called!");
  
  showNotification('·Éô·Éò·Éó·ÉÆ·Éï·Éî·Éë·Éò ·Éê·Éõ·Éù·Éò·É¨·É£·É†·Éê. ·Éë·É†·É£·Éú·Éì·Éî·Éë·Éò·Éó ·Éõ·Éó·Éê·Éï·Éê·É† ·Éí·Éï·Éî·É†·Éì·Éñ·Éî!', false);
  
  setTimeout(() => {
    returnToMainPage();
  }, 1500);
}

function returnToMainPage() {
  console.log("Returning to main page...");
  
  sessionTests = [];
  currentIndex = 0;
  autoMode = false;
  examMode = false;
  isWrongQuestionsMode = false;
  
  testScreen.classList.remove('active');
  optionsScreen.style.display = 'block';
  
  normalModeContainer.classList.add('hidden');
  examModeContainer.classList.add('hidden');
  examRightPanel.classList.add('hidden');
  questionCounter.classList.add('hidden');
  
  timerElement.classList.remove('hidden');
  
  updateTimerDisplay();
  
  showNotification('·Éê·Éò·É†·É©·Éò·Éî·Éó ·Éõ·Éù·Éì·É£·Éö·Éò', false);
}

function getWrongQuestions() {
  if (!currentUser || currentUser.isGuest || !currentTestType) return [];
  return userProgress[currentTestType]?.wrongQuestions || [];
}

function startWrongQuestionsMode() {
  if (!currentUser || currentUser.isGuest) {
    showNotification('·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·É†·Éî·Éí·Éò·É°·É¢·É†·Éò·É†·Éî·Éë·É£·Éö ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éî·Éë·É° ·É®·Éî·É£·É´·Éö·Éò·Éê·Éó ·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò·É° ·Éí·Éê·Éô·Éî·Éó·Éî·Éë·Éê');
    return;
  }
  
  const wrongQuestions = getWrongQuestions();
  if (wrongQuestions.length === 0) {
    showNotification('·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê!', false);
    return;
  }
  
  const wrongTests = allTestsWithTopics.filter((test, index) => 
    wrongQuestions.includes(index.toString())
  );
  
  if (wrongTests.length === 0) {
    showNotification('·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê!');
    return;
  }
  
  isWrongQuestionsMode = true;
  
  sessionTests = wrongTests.map((t, idx) => ({ 
    id: wrongQuestions[idx],
    originalId: wrongQuestions[idx],
    question: t.question, 
    answers: t.answers.map(a => ({...a})),
    selectedAnswers: [],
    hasCorrectAnswer: false,
    isAnswerCorrect: null
  }));
  
  currentIndex = 0;
  examMode = false;
  
  optionsScreen.style.display = 'none';
  testScreen.classList.add('active');
  normalModeContainer.classList.remove('hidden');
  examModeContainer.classList.add('hidden');
  examRightPanel.classList.add('hidden');
  
  questionCounter.classList.remove('hidden');
  currentQuestionEl.textContent = currentIndex + 1;
  totalQuestionsEl.textContent = sessionTests.length;
  
  timerElement.classList.remove('hidden');
  
  showNotification(`·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò·É° ·É†·Éî·Éü·Éò·Éõ·Éò. ·É°·É£·Éö: ${wrongTests.length} ·É¢·Éî·É°·É¢·Éò`, false);
  
  renderCurrentQuestion();
}

// ==================== MODULE SELECTION FUNCTIONS ====================
function toggleModules() {
  const container = document.getElementById('modulesContainer');
  if (container) {
    // ·Éó·É£ ·É¶·Éò·Éê·Éê - ·Éì·Éê·ÉÆ·É£·É†·Éî, ·Éó·É£ ·Éì·Éê·ÉÆ·É£·É†·É£·Éö·Éò·Éê - ·Éí·Éê·ÉÆ·É°·Éî·Éú·Éò
    if (container.style.display === 'flex') {
      container.style.display = 'none';
    } else {
      container.style.display = 'flex';
    }
  }
}

function handleModuleCheckboxClick(clickedCheckbox) {
  const allCheckboxes = document.querySelectorAll('.module-checkbox');
  const container = document.getElementById('modulesContainer');
  
  if (clickedCheckbox.checked) {
    // ·Éß·Éï·Éî·Éö·Éê ·É°·ÉÆ·Éï·Éê ·Éõ·Éù·ÉÆ·É°·Éî·Éú·Éò
    allCheckboxes.forEach(cb => {
      if (cb !== clickedCheckbox) {
        cb.checked = false;
      }
    });
    
    // ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê ·Éì·Éê ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê
    const moduleValue = clickedCheckbox.value;
    saveSelectedModule(moduleValue); // ·Éî·É° ·É£·Éô·Éï·Éî ·É£·Éú·Éì·Éê ·Éí·É•·Éù·Éú·Éì·Éî·É°
    onModuleSelected(moduleValue);
    
    // ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò: ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éî currentTestType
    currentTestType = moduleValue;
    console.log("Module selected:", moduleValue);
    
    // ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éî CSV
    loadCSV();
    
    // üî• ·Éì·Éê·Éò·ÉÆ·É£·É†·Éù·É° ·Éì·É†·Éù·Éû·Éì·Éê·É£·Éú·Éò ·Éê·É†·É©·Éî·Éï·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí
    if (container) {
      container.style.display = 'none';
    }
    
  } else {
    // ·Éó·É£ ·Éõ·Éù·Éú·Éò·É®·Éï·Éú·Éê ·Éõ·Éù·Éò·ÉÆ·É°·Éú·Éê
    saveSelectedModule(null);
    updateDropdownText(null);
    
    // ·Éì·Éê·Éõ·Éê·Éö·Éî topics dropdown
    const topicsContainer = document.getElementById('topicsDropdownContainer');
    if (topicsContainer) topicsContainer.style.display = 'none';
    
    // ·Éí·Éê·Éê·É°·É£·É§·Éó·Éê·Éï·Éî ·É¢·Éî·É°·É¢·Éî·Éë·Éò
    allTestsWithTopics = [];
    allTests = [];
    totalQuestionsEl.textContent = '0';
    
    // ·Éí·Éê·Éê·É°·É£·É§·Éó·Éê·Éï·Éî currentTestType
    currentTestType = null;
    
    // üî• ·Éì·É†·Éù·Éû·Éì·Éê·É£·Éú·Éò ·Éõ·Éê·Éò·Éú·É™ ·Éì·Éê·Éò·ÉÆ·É£·É†·Éù·É°
    if (container) {
      container.style.display = 'none';
    }
  }
}

// Dropdown ·É¢·Éî·É•·É°·É¢·Éò·É° ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê
function updateDropdownText(moduleValue) {
  const dropdown = document.getElementById('testTypeSelect');
  const moduleNames = {
    'samkurnaloo': '·É°·Éê·Éõ·Éô·É£·É†·Éú·Éê·Éö·Éù',
    'stomatologia': '·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'alergologia': '·Éê·Éö·Éî·É†·Éí·Éù·Éö·Éù·Éí·Éò·Éê',
    'angiokirurgia': '·Éê·Éú·Éí·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'anesteziologia': '·Éê·Éú·Éî·É°·Éó·Éî·Éñ·Éò·Éù·Éö·Éù·Éí·Éò·Éê, ·É†·Éî·Éê·Éú·Éò·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_gadaudebeli': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò',
    'bavshvta_kardiorevmatologia': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éô·Éê·É†·Éì·Éò·Éù·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_nevrologia': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_nevrologia2': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'gadaudebeli_medicina': '·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'gastroenterologia': '·Éí·Éê·É°·É¢·É†·Éù·Éî·Éú·É¢·Éî·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'ginekologia': '·Éí·Éò·Éú·Éî·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'dermatologia': '·Éì·Éî·É†·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'endokrinologia': '·Éî·Éú·Éì·Éù·Éô·É†·Éò·Éú·Éù·Éö·Éù·Éí·Éò·Éê',
    'zogadi_kirurgia': '·Éñ·Éù·Éí·Éê·Éì·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'terapiuli_stomatologia': '·Éó·Éî·É†·Éê·Éû·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'infekciuri': '·Éò·Éú·É§·Éî·É•·É™·Éò·É£·É†·Éò',
    'kardiologia': '·Éô·Éê·É†·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê',
    'kardiokirurgia': '·Éô·Éê·É†·Éì·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'laboratoriuli_medicina': '·Éö·Éê·Éë·Éù·É†·Éê·É¢·Éù·É†·Éò·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'narkologia': '·Éú·Éê·É†·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'nevrologia': '·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'neonatologia': '·Éú·Éî·Éù·Éú·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'nefrologia': '·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'onkologia': '·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'ortodontia': '·Éù·É†·Éó·Éù·Éì·Éù·Éú·É¢·Éò·Éê',
    'ortopedia_travmatologia': '·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·Éê ·É¢·É†·Éê·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'ortopediuli_stomatologia': '·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'otorinolaringologia': '·Éù·É¢·Éù·É†·Éò·Éú·Éù·Éö·Éê·É†·Éò·Éú·Éí·Éù·Éö·Éù·Éí·Éò·Éê',
    'oftalmologia': '·Éù·É§·Éó·Éê·Éö·Éõ·Éù·Éö·Éù·Éí·Éò·Éê',
    'patologia': '·Éû·Éê·Éó·Éù·Éö·Éù·Éí·Éò·Éê',
    'pediatria': '·Éû·Éî·Éì·Éò·Éê·É¢·É†·Éò·Éê',
    'plastikuri_kirurgia': '·Éû·Éö·Éê·É°·É¢·Éò·Éô·É£·É†·Éò ·Éì·Éê ·É†·Éî·Éô·Éù·Éú·É°·É¢·É†·É£·É•·É™·Éò·É£·Éö·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'radiologia': '·É†·Éê·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê',
    'radiacioni_onkologia': '·É†·Éê·Éì·Éò·Éê·É™·Éò·É£·Éö·Éò ·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'reproduqtologia': '·É†·Éî·Éû·É†·Éù·Éì·É£·É•·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'revmatologia': '·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'saokjao_medicina': '·É°·Éê·Éù·ÉØ·Éê·ÉÆ·Éù ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'sportuli_medicina': '·É°·Éû·Éù·É†·É¢·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'toksikologia': '·É¢·Éù·É•·É°·Éò·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'urologia': '·É£·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'ftiziatria_pulmonologia': '·É§·Éó·Éò·Éñ·Éò·Éê·É¢·É†·Éò·Éê, ·Éû·É£·Éö·Éõ·Éù·Éú·Éù·Éö·Éù·Éí·Éò·Éê',
    'psikiatria': '·É§·É°·Éò·É•·Éò·Éê·É¢·É†·Éò·Éê',
    'qba_saxis_kirurgia': '·Éß·Éë·Éê-·É°·Éê·ÉÆ·Éò·É° ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'shinagani_medicina': '·É®·Éò·Éú·Éê·Éí·Éê·Éú·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'hematologia': '·É∞·Éî·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê'
  };
  
  if (moduleValue && moduleNames[moduleValue]) {
    dropdown.textContent = moduleNames[moduleValue];
  } else {
    dropdown.textContent = '·Éê·Éò·É†·É©·Éò·Éî·Éó';
  }
}

// Topics dropdown-·Éò·É° ·ÉÆ·Éò·Éö·Éï·Éê·Éì·Éù·Éë·Éò·É° ·Éõ·Éê·É†·Éó·Éï·Éê
function updateTopicsVisibility() {
  const selectedModule = getSelectedModule();
  const topicsContainer = document.getElementById('topicsDropdownContainer');
  
  if (selectedModule === 'samkurnaloo' && topicsContainer) {
    topicsContainer.style.display = 'flex';
  } else if (topicsContainer) {
    topicsContainer.style.display = 'none';
    const topicsSelect = document.getElementById('topicsSelect');
    if (topicsSelect) topicsSelect.value = 'all';
    selectedTopic = null;
  }
}

function getSelectedModule() {
  const checkedBox = document.querySelector('.module-checkbox:checked');
  return checkedBox ? checkedBox.value : null;
}
// ·Éê·É†·É©·Éî·É£·Éö·Éò ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê localStorage-·É°·Éê ·Éì·Éê Firebase-·É®·Éò
function saveSelectedModule(moduleValue) {
  if (!currentUser || currentUser.isGuest) return;
  
  try {
    // ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê localStorage-·É®·Éò
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    if (users[currentUser.username]) {
      if (!users[currentUser.username].selectedModules) {
        users[currentUser.username].selectedModules = {};
      }
      users[currentUser.username].selectedModules.selected = moduleValue;
      users[currentUser.username].lastUpdated = Date.now();
      localStorage.setItem('users', JSON.stringify(users));
    }
    
    // Firebase-·É®·Éò ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê (·Éó·É£ ·É®·Éî·É°·Éê·É´·Éö·Éî·Éë·Éî·Éö·Éò·Éê)
    if (firebaseSyncEnabled && database) {
      const userRef = database.ref('users/' + currentUser.username.replace(/[.#$[\]]/g, '_'));
      
      // ·É®·Éî·Éï·É•·Éõ·Éú·Éê·Éó ·Éù·Éë·Éò·Éî·É•·É¢·Éò, ·É†·Éù·Éõ·Éî·Éö·Éò·É™ ·É®·Éî·Éò·É™·Éê·Éï·É° ·Éõ·Éù·Éì·É£·Éö·É° ·Éì·Éê ·Éì·É†·Éù·É°
      const updateData = {
        selectedModule: moduleValue,
        lastModuleUpdate: Date.now(),
        lastUpdated: Date.now()
      };
      
      console.log("Saving to Firebase:", updateData);
      
      userRef.update(updateData)
        .then(() => {
          console.log(`Module ${moduleValue} saved to Firebase successfully`);
        })
        .catch(err => console.error('Firebase save error:', err));
    }
    
    // currentTestType-·Éò·É° ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê
    currentTestType = moduleValue;
    
  } catch (error) {
    console.error('Error saving selected module:', error);
  }
}

function loadSelectedModule() {
  if (!currentUser || currentUser.isGuest) {
    console.log("User is guest or not logged in, skipping module load");
    return;
  }
  
  console.log("Loading selected module for user:", currentUser.username);
  
  // ·Éû·Éò·É†·Éï·Éî·Éö ·É†·Éò·Éí·É®·Éò ·É®·Éî·Éï·Éê·Éõ·Éù·É¨·Éõ·Éù·Éó Firebase
  if (firebaseSyncEnabled && database) {
    const safeUsername = currentUser.username.replace(/[.#$[\]]/g, '_');
    console.log("Checking Firebase for module at path: users/" + safeUsername);
    
    database.ref('users/' + safeUsername).once('value')
      .then(snapshot => {
        if (snapshot.exists()) {
          const firebaseData = snapshot.val();
          console.log("Firebase user data:", firebaseData);
          
          // ·Éó·É£ Firebase-·É®·Éò ·Éê·É†·Éò·É° selectedModule, ·Éí·Éê·Éõ·Éù·Éï·Éò·Éß·Éî·Éú·Éù·Éó ·Éò·É°
          if (firebaseData.selectedModule) {
            const savedModule = firebaseData.selectedModule;
            console.log("Found module in Firebase:", savedModule);
            
            // ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó localStorage-·É™
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[currentUser.username]) {
              if (!users[currentUser.username].selectedModules) {
                users[currentUser.username].selectedModules = {};
              }
              users[currentUser.username].selectedModules.selected = savedModule;
              users[currentUser.username].lastUpdated = Date.now();
              localStorage.setItem('users', JSON.stringify(users));
            }
            
            // ·Éí·Éê·Éõ·Éù·Éï·Éò·Éß·Éî·Éú·Éù·Éó Firebase-·Éì·Éê·Éú ·É¨·Éê·Éõ·Éù·É¶·Éî·Éë·É£·Éö·Éò ·Éõ·Éù·Éì·É£·Éö·Éò
            applySelectedModule(savedModule, true); // ·Éõ·Éî·Éù·É†·Éî ·Éû·Éê·É†·Éê·Éõ·Éî·É¢·É†·Éò ·Éõ·Éò·É£·Éó·Éò·Éó·Éî·Éë·É° ·É†·Éù·Éõ Firebase-·Éì·Éê·Éú ·Éõ·Éù·Éì·Éò·É°
            
          } else {
            console.log("No selectedModule in Firebase, checking localStorage");
            // Firebase-·É®·Éò ·Éê·É† ·Éê·É†·Éò·É°, ·Éï·É™·Éê·Éì·Éù·Éó localStorage
            loadSelectedModuleFromLocal();
          }
        } else {
          console.log("User not found in Firebase, checking localStorage");
          // Firebase-·É®·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éê·É† ·Éê·É†·Éò·É°, ·Éï·É™·Éê·Éì·Éù·Éó localStorage
          loadSelectedModuleFromLocal();
        }
      })
      .catch(error => {
        console.error("Error loading module from Firebase:", error);
        loadSelectedModuleFromLocal();
      });
  } else {
    console.log("Firebase not available, checking localStorage");
    // Firebase ·Éê·É† ·Éê·É†·Éò·É° ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò, ·Éï·É™·Éê·Éì·Éù·Éó localStorage
    loadSelectedModuleFromLocal();
  }
}

// ·É™·Éê·Éö·Éô·Éî ·É§·É£·Éú·É•·É™·Éò·Éê localStorage-·Éì·Éê·Éú ·É©·Éê·É°·Éê·É¢·Éï·Éò·É†·Éó·Éê·Éì
function loadSelectedModuleFromLocal() {
  try {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    const savedModule = users[currentUser.username]?.selectedModules?.selected;
    
    if (savedModule) {
      console.log("Loading saved module from localStorage:", savedModule);
      applySelectedModule(savedModule, false);
    } else {
      console.log("No saved module found in localStorage");
      // ·Éó·É£ ·Éê·É†·É™ Firebase-·É®·Éò ·Éì·Éê ·Éê·É†·É™ localStorage-·É®·Éò ·Éê·É† ·Éê·É†·Éò·É° ·Éõ·Éù·Éì·É£·Éö·Éò, ·Éõ·Éê·É®·Éò·Éú ·Éû·Éò·É†·Éï·Éî·Éö·Éò ·É®·Éî·É°·Éï·Éö·Éê·Éê
      // ·Éê·É†·Éê·É§·Éî·É†·É° ·Éï·Éê·Éô·Éî·Éó·Éî·Éë·Éó, ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éõ·Éê ·Éó·Éê·Éï·Éê·Éì ·É£·Éú·Éì·Éê ·Éê·Éò·É†·É©·Éò·Éù·É°
    }
  } catch (error) {
    console.error('Error loading selected module from localStorage:', error);
  }
}

// ·É™·Éê·Éö·Éô·Éî ·É§·É£·Éú·É•·É™·Éò·Éê ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·Éí·Éê·Éõ·Éù·É°·Éê·Éß·Éî·Éú·Éî·Éë·Éö·Éê·Éì
function applySelectedModule(savedModule, fromFirebase = false) {
  console.log(`Applying module: ${savedModule} (fromFirebase: ${fromFirebase})`);
  
  // ·Éß·Éï·Éî·Éö·Éê checkbox-·Éò·É° ·Éõ·Éù·ÉÆ·É°·Éú·Éê
  document.querySelectorAll('.module-checkbox').forEach(cb => cb.checked = false);
  
  // ·É®·Éî·Éú·Éê·ÉÆ·É£·Éö·Éò·É° ·Éõ·Éù·Éú·Éò·É®·Éï·Éú·Éê
  const targetCheckbox = document.querySelector(`.module-checkbox[value="${savedModule}"]`);
  if (targetCheckbox) {
    targetCheckbox.checked = true;
    updateDropdownText(savedModule);
    currentTestType = savedModule;
    updateTopicsVisibility();
    
    // üî• ·Éì·Éê·ÉÆ·É£·É†·Éî ·Éõ·Éù·Éì·É£·Éö·Éî·Éë·Éò·É° ·É°·Éò·Éê
    const container = document.getElementById('modulesContainer');
    if (container) {
      container.style.display = 'none';
    }
    
    // ·Éí·Éê·Éê·É°·É£·É§·Éó·Éê·Éï·Éî ·É§·Éö·Éê·Éí·Éò, ·É†·Éù·Éõ ·Éê·ÉÆ·Éê·Éö·Éò ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É°·Éê·É° ·Éò·Éõ·É£·É®·Éê·Éù·É°
    window._progressCheckExecuted = false;
    
    // ·Éó·É£ ·É¢·Éî·É°·É¢·Éî·Éë·Éò ·ÉØ·Éî·É† ·Éê·É† ·Éê·É†·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·É£·Éö·Éò, ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éî
    if (allTestsWithTopics.length === 0) {
      console.log("Tests not loaded yet, loading CSV...");
      loadCSV();
    } else {
      console.log("Tests already loaded, skipping CSV load");
      // ·Éó·É£ ·É£·Éô·Éï·Éî ·É©·Éê·É¢·Éï·Éò·É†·Éó·É£·Éö·Éò·Éê, ·Éõ·Éê·Éò·Éú·É™ ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éî start ·É¶·Éò·Éö·Éê·Éô·Éò
      startBtn.disabled = false;
      
      // ·Éó·É£ Firebase-·Éì·Éê·Éú ·Éõ·Éù·Éï·Éò·Éì·Éê ·Éì·Éê ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·É†·Éî·Éí·Éò·É°·É¢·É†·Éò·É†·Éî·Éë·É£·Éö·Éò·Éê, ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éî ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò
      if (fromFirebase && currentUser && !currentUser.isGuest) {
        setTimeout(() => {
          const examModeCheckbox = document.getElementById('modeExam');
          if (!examModeCheckbox || !examModeCheckbox.checked) {
            console.log("Checking existing progress after module load from Firebase");
            checkExistingProgress();
          }
        }, 500);
      }
    }
    
    console.log("Module applied successfully:", savedModule);
    
    // ·Éê·É©·Éï·Éî·Éú·Éî ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éó·É£ Firebase-·Éì·Éê·Éú ·Éõ·Éù·Éì·Éò·É° ·Éì·Éê ·Éê·É† ·Éê·É†·Éò·É° ·Éû·Éò·É†·Éï·Éî·Éö·Éò ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê
    if (fromFirebase && document.getElementById('authModal').style.display === 'none') {
      const moduleGeoName = moduleNames[savedModule] || savedModule;
      showNotification(`·Éõ·Éù·Éì·É£·Éö·Éò: ${moduleGeoName}`, false);
    }
    
  } else {
    console.log("Target checkbox not found for module:", savedModule);
  }
}

function setupModuleListener() {
  if (!firebaseSyncEnabled || !database || !currentUser || currentUser.isGuest) {
    console.log("Cannot setup module listener:", {
      firebaseSyncEnabled,
      database: !!database,
      currentUser,
      isGuest: currentUser?.isGuest
    });
    return;
  }
  
  console.log("Setting up module listener for user:", currentUser.username);
  
  const safeUsername = currentUser.username.replace(/[.#$[\]]/g, '_');
  const userRef = database.ref('users/' + safeUsername);
  
  // ·Éõ·Éù·Éï·É£·É°·Éõ·Éò·Éú·Éù·Éó ·É™·Éï·Éö·Éò·Éö·Éî·Éë·Éî·Éë·É°
  userRef.on('value', (snapshot) => {
    console.log("Firebase value event triggered!");
    
    if (!snapshot.exists()) {
      console.log("Snapshot does not exist");
      return;
    }
    
    const data = snapshot.val();
    console.log("Firebase user data changed:", data);
    
    // üî• ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò: ·Éó·É£ ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê Firebase-·É®·Éò, ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó localStorage
    if (data.progress) {
      console.log("Progress changed in Firebase, updating local storage");
      
      // ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó userProgress
      userProgress = data.progress;
      
      // ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó localStorage
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (users[currentUser.username]) {
        users[currentUser.username].progress = data.progress;
        users[currentUser.username].lastUpdated = data.lastUpdated || Date.now();
        localStorage.setItem('users', JSON.stringify(users));
      }
      
      // ·Éó·É£ ·É¢·Éî·É°·É¢·Éò·É° ·Éî·Éô·É†·Éê·Éú·Éò ·Éê·É•·É¢·Éò·É£·É†·Éò·Éê, ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó ·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éô·Éò·Éó·ÉÆ·Éï·Éê
      if (testScreen.classList.contains('active') && sessionTests.length > 0) {
        console.log("Refreshing current question with updated progress");
        renderCurrentQuestion();
      }
    }
    
    // ·Éó·É£ ·Éõ·Éù·Éì·É£·Éö·Éò ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê ·Éì·Éê ·Éî·É° ·É™·Éï·Éö·Éò·Éö·Éî·Éë·Éê ·Éê·É† ·Éê·É†·Éò·É° ·É©·Éï·Éî·Éú·Éò ·Éõ·Éù·É¨·Éß·Éù·Éë·Éò·Éö·Éù·Éë·Éò·Éì·Éê·Éú
    if (data.selectedModule) {
      console.log(`Selected module in Firebase: ${data.selectedModule}, currentTestType: ${currentTestType}`);
      
      if (data.selectedModule !== currentTestType) {
        console.log(`Module changed in Firebase from ${currentTestType} to ${data.selectedModule}`);
        
        // ·Éí·Éê·Éõ·Éù·Éï·Éò·Éß·Éî·Éú·Éù·Éó ·Éê·ÉÆ·Éê·Éö·Éò ·Éõ·Éù·Éì·É£·Éö·Éò
        applySelectedModule(data.selectedModule, true);
        
        // ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·É•·Éê·É†·Éó·É£·Éö·Éò ·É°·Éê·ÉÆ·Éî·Éö·Éò
        const moduleGeoName = moduleNames[data.selectedModule] || data.selectedModule;
        
        // ·Éï·Éê·É©·Éï·Éî·Éú·Éù·Éó ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê ·É•·Éê·É†·Éó·É£·Éö·Éê·Éì
        showNotification(`·Éõ·Éù·Éì·É£·Éö·Éò ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê: ${moduleGeoName}`, false);
      } else {
        console.log("Module hasn't changed, skipping");
      }
    }
  }, (error) => {
    console.error("Error in module listener:", error);
  });
  
  console.log("Module listener setup complete");
}

// ·Éì·Éê·Éï·Éê·Éõ·Éê·É¢·Éù·Éó ·Éî·É° ·É§·É£·Éú·É•·É™·Éò·Éê Firebase-·Éì·Éê·Éú ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò·É° ·Éû·Éî·É†·Éò·Éù·Éì·É£·Éö·Éê·Éì ·É©·Éê·É°·Éê·É¢·Éï·Éò·É†·Éó·Éê·Éì
function startProgressSync() {
  if (!firebaseSyncEnabled || !database || !currentUser || currentUser.isGuest) return;
  
  console.log("Starting periodic progress sync");
  
  // ·Éß·Éù·Éï·Éî·Éö 30 ·É¨·Éê·Éõ·É®·Éò ·É®·Éî·Éï·Éê·Éõ·Éù·É¨·Éõ·Éù·Éó Firebase
  setInterval(() => {
    if (currentUser && !currentUser.isGuest) {
      console.log("Periodic progress check...");
      
      database.ref('users/' + currentUser.username.replace(/[.#$[\]]/g, '_')).once('value')
        .then(snapshot => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            
            if (data.progress) {
              // ·É®·Éî·Éï·Éê·Éì·Éê·É†·Éù·Éó localStorage-·Éò·É° ·Éì·Éê Firebase-·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò
              const users = JSON.parse(localStorage.getItem('users') || '{}');
              const localProgress = users[currentUser.username]?.progress;
              
              // ·Éó·É£ Firebase-·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·É£·É§·É†·Éù ·Éê·ÉÆ·Éê·Éö·Éò·Éê, ·Éí·Éê·Éõ·Éù·Éï·Éò·Éß·Éî·Éú·Éù·Éó ·Éò·É°·Éò·Éú·Éò
              if (data.lastUpdated > (users[currentUser.username]?.lastUpdated || 0)) {
                console.log("Firebase data is newer, updating local storage");
                userProgress = data.progress;
                
                users[currentUser.username].progress = data.progress;
                users[currentUser.username].lastUpdated = data.lastUpdated;
                localStorage.setItem('users', JSON.stringify(users));
                
                // ·Éó·É£ ·É¢·Éî·É°·É¢·Éò·É° ·Éî·Éô·É†·Éê·Éú·Éò ·Éê·É•·É¢·Éò·É£·É†·Éò·Éê, ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó
                if (testScreen.classList.contains('active') && sessionTests.length > 0) {
                  renderCurrentQuestion();
                }
              }
            }
          }
        })
        .catch(err => console.error("Periodic sync error:", err));
    }
  }, 30000); // 30 ·É¨·Éê·Éõ·Éò
}

// ==================== AUTH FUNCTIONS ====================
function initAuth() {
  document.getElementById('authModal').style.display = 'flex';
  
  document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      document.querySelectorAll('.auth-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + 'Tab').classList.add('active');
    });
  });
  
  document.querySelectorAll('.password-toggle').forEach(btn => {
    btn.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const input = document.getElementById(targetId);
      if (input.type === 'password') {
        input.type = 'text';
        this.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="1" y1="1" x2="23" y2="23" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
      } else {
        input.type = 'password';
        this.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
      }
    });
  });
  
  document.getElementById('continueAsGuest').addEventListener('click', () => {
    currentUser = { 
      username: '·É°·É¢·É£·Éõ·Éê·É†·Éò ' + Math.floor(Math.random() * 1000), 
      isGuest: true,
      progress: {}
    };
    
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('usernameDisplay').textContent = currentUser.username;
    
    userName = currentUser.username;
    localStorage.setItem('chatUserName', userName);
    
    loadCSV();
    initChat();
    updateTimerDisplay();
    
    showNotification('·Éõ·Éù·Éí·Éî·É°·Éê·Éö·Éõ·Éî·Éë·Éò·Éó!', false);
  });
  
  document.getElementById('showLoginFromGuest').addEventListener('click', () => {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
    
    const loginTab = document.querySelector('[data-tab="login"]');
    if (loginTab) {
      loginTab.classList.add('active');
      document.getElementById('loginTab').classList.add('active');
    }
  });
  
  document.getElementById('loginBtn').addEventListener('click', handleLogin);
  document.getElementById('signupBtn').addEventListener('click', handleSignup);
  
  document.getElementById('showSignupFromLogin').addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
    
    const signupTab = document.querySelector('[data-tab="signup"]');
    if (signupTab) {
      signupTab.classList.add('active');
      document.getElementById('signupTab').classList.add('active');
    }
  });
  
  document.getElementById('showLoginFromSignup').addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
    
    const loginTab = document.querySelector('[data-tab="login"]');
    if (loginTab) {
      loginTab.classList.add('active');
      document.getElementById('loginTab').classList.add('active');
    }
  });
}

async function handleSignup() {
  const username = document.getElementById('signupUsername').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupConfirmPassword').value;
  
  document.getElementById('signupUsernameError').style.display = 'none';
  document.getElementById('signupPasswordError').style.display = 'none';
  document.getElementById('signupConfirmError').style.display = 'none';
  
  if (!username) {
    document.getElementById('signupUsernameError').textContent = '·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éì·Éê ·Éí·Éï·Éê·É†·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê';
    document.getElementById('signupUsernameError').style.display = 'block';
    return;
  }
  
  const nameParts = username.split(/\s+/);
  if (nameParts.length < 2) {
    document.getElementById('signupUsernameError').textContent = '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éì·Éê ·Éí·Éï·Éê·É†·Éò';
    document.getElementById('signupUsernameError').style.display = 'block';
    return;
  }
  
  if (/[^a-zA-Z0-9·Éê-·É∞\s]/.test(username)) {
    document.getElementById('signupUsernameError').textContent = '·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éì·Éê ·Éí·Éï·Éê·É†·Éò ·É£·Éú·Éì·Éê ·É®·Éî·Éò·É™·Éê·Éï·Éì·Éî·É° ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éê·É°·Éù·Éî·Éë·É°, ·É™·Éò·É§·É†·Éî·Éë·É°, ·É•·Éê·É†·Éó·É£·Éö ·Éê·É°·Éù·Éî·Éë·É° ·Éì·Éê ·É°·É§·Éî·Éò·É°·Éî·Éë·É°';
    document.getElementById('signupUsernameError').style.display = 'block';
    return;
  }
  
  if (!password) {
    document.getElementById('signupPasswordError').textContent = '·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê';
    document.getElementById('signupPasswordError').style.display = 'block';
    return;
  }
  
  if (password.length < 6) {
    document.getElementById('signupPasswordError').textContent = '·Éû·Éê·É†·Éù·Éö·Éò ·É£·Éú·Éì·Éê ·Éò·Éß·Éù·É° ·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù';
    document.getElementById('signupPasswordError').style.display = 'block';
    return;
  }
  
  if (!confirmPassword) {
    document.getElementById('signupConfirmError').textContent = '·Éí·Éê·Éò·Éõ·Éî·Éù·É†·Éî·Éó ·Éû·Éê·É†·Éù·Éö·Éò!';
    document.getElementById('signupConfirmError').style.display = 'block';
    return;
  }
  
  if (password !== confirmPassword) {
    document.getElementById('signupConfirmError').textContent = '·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É† ·Éî·Éõ·Éó·ÉÆ·Éï·Éî·Éï·Éê';
    document.getElementById('signupConfirmError').style.display = 'block';
    return;
  }
  
  try {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    
    if (users[username]) {
      document.getElementById('signupUsernameError').textContent = '·Éõ·É°·Éí·Éê·Éï·É°·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·É£·Éô·Éï·Éî ·Éê·É†·É°·Éî·Éë·Éù·Éë·É°';
      document.getElementById('signupUsernameError').style.display = 'block';
      return;
    }
    
    if (firebaseSyncEnabled && database) {
      const firebaseUser = await loadUserFromFirebase(username);
      if (firebaseUser) {
        document.getElementById('signupUsernameError').textContent = '·Éõ·É°·Éí·Éê·Éï·É°·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·É£·Éô·Éï·Éî ·Éê·É†·É°·Éî·Éë·Éù·Éë·É°';
        document.getElementById('signupUsernameError').style.display = 'block';
        return;
      }
    }
    
    users[username] = {
      password: password,
      progress: {
        rezidentura: {
          normal: { answeredQuestions: {}, currentIndex: 0 },
          exam: { answeredQuestions: {}, currentIndex: 0 },
          wrongQuestions: []
        }
      },
      lastUpdated: Date.now()
    };
    
    localStorage.setItem('users', JSON.stringify(users));
    
    if (firebaseSyncEnabled && database) {
      await saveUserToFirebase(username, users[username]);
    }
    
    document.getElementById('signupUsername').value = '';
    document.getElementById('signupPassword').value = '';
    document.getElementById('signupConfirmPassword').value = '';
    
showNotification('·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·É£·Éö·Éò·Éê!', false);

// ·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éò ·É®·Éî·É°·Éï·Éö·Éê ·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí
currentUser = { 
  username: username, 
  isGuest: false 
};

// ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éî ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò
await loadUserProgress();

// ·Éì·Éê·ÉÆ·É£·É†·Éî ·Éõ·Éù·Éì·Éê·Éö·Éò
document.getElementById('authModal').style.display = 'none';
document.getElementById('userInfo').style.display = 'flex';
document.getElementById('usernameDisplay').textContent = currentUser.username;

// ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éî ·É©·Éê·É¢·Éò·É° ·É°·Éê·ÉÆ·Éî·Éö·Éò
userName = currentUser.username;
localStorage.setItem('chatUserName', userName);

showNotification('·Éõ·Éù·Éí·Éî·É°·Éê·Éö·Éõ·Éî·Éë·Éò·Éó!', false);

// ·Éí·Éê·É£·É®·Éï·Éò ·Éõ·Éù·Éú·Éò·É¢·Éù·É†·Éò·Éú·Éí·Éò
setupUserDeletionListener();

// ·Éõ·Éù·Éì·É£·Éö·Éò·É° Firebase listener
setupModuleListener();

// üî• ·Éì·Éê·Éê·Éõ·Éê·É¢·Éî ·Éî·É° ·ÉÆ·Éê·Éñ·Éò - ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò·É° ·É°·Éò·Éú·É•·É†·Éù·Éú·Éò·Éñ·Éê·É™·Éò·Éò·É° ·Éì·Éê·É¨·Éß·Éî·Éë·Éê
startProgressSync();

// ·É©·Éê·É¢·Éò·É° ·Éò·Éú·Éò·É™·Éò·Éê·Éö·Éò·Éñ·Éê·É™·Éò·Éê
initChat();
bindUserMenuEvents();
updateTimerDisplay();

// ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éî ·Éõ·Éù·Éì·É£·Éö·Éò Firebase-·Éì·Éê·Éú
loadSelectedModule();

// ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éî ·É¢·Éî·É°·É¢·Éî·Éë·Éò
if (allTests.length === 0) {
  loadCSV();
} else {
  startBtn.disabled = false;
  setTimeout(() => {
    const examModeCheckbox = document.getElementById('modeExam');
    if (!examModeCheckbox || !examModeCheckbox.checked) {
      checkExistingProgress();
    }
  }, 500);
}
    
  } catch (error) {
    console.error('Signup error:', error);
    showNotification('·É®·Éî·É™·Éì·Éù·Éõ·Éê ·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éò·É° ·Éì·É†·Éù·É°. ·É°·É™·Éê·Éì·Éî·Éó ·Éõ·Éù·Éí·Éï·Éò·Éê·Éú·Éî·Éë·Éò·Éó');
  }
}

// ==================== SHOW PASSWORD CHANGE MODAL ====================
function showPasswordChangeModal() {
  const existingModal = document.querySelector('.modal-overlay');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modalOverlay = document.createElement('div');
  modalOverlay.className = 'modal-overlay active';
  modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.cssText = 'background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
  
  const header = document.createElement('div');
  header.className = 'modal-header';
  header.style.cssText = 'font-size: 24px; font-weight: 600; color: #1e293b; margin-bottom: 20px; text-align: center;';
  header.textContent = '·Éû·Éê·É†·Éù·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê';
  
  const content = document.createElement('div');
  content.className = 'modal-content';
  content.style.cssText = 'margin-bottom: 20px;';
  
  const currentPassDiv = document.createElement('div');
  currentPassDiv.style.marginBottom = '20px';
  
  const currentPassInput = document.createElement('input');
  currentPassInput.type = 'password';
  currentPassInput.id = 'currentPassword';
  currentPassInput.placeholder = '·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éû·Éê·É†·Éù·Éö·Éò';
  currentPassInput.className = 'auth-input';
  currentPassInput.style.cssText = 'width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; margin-bottom: 5px;';
  
  const currentPassError = document.createElement('div');
  currentPassError.id = 'currentPasswordError';
  currentPassError.style.cssText = 'color: var(--danger); font-size: 13px; margin-top: 4px; display: none; text-align: left;';
  
  currentPassDiv.appendChild(currentPassInput);
  currentPassDiv.appendChild(currentPassError);
  
  const newPassDiv = document.createElement('div');
  newPassDiv.style.marginBottom = '20px';
  
  const newPassInput = document.createElement('input');
  newPassInput.type = 'password';
  newPassInput.id = 'newPassword';
  newPassInput.placeholder = '·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò (·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù)';
  newPassInput.className = 'auth-input';
  newPassInput.style.cssText = 'width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; margin-bottom: 5px;';
  
  const newPassError = document.createElement('div');
  newPassError.id = 'newPasswordError';
  newPassError.style.cssText = 'color: var(--danger); font-size: 13px; margin-top: 4px; display: none; text-align: left;';
  
  newPassDiv.appendChild(newPassInput);
  newPassDiv.appendChild(newPassError);
  
  const confirmPassDiv = document.createElement('div');
  confirmPassDiv.style.marginBottom = '20px';
  
  const confirmPassInput = document.createElement('input');
  confirmPassInput.type = 'password';
  confirmPassInput.id = 'confirmNewPassword';
  confirmPassInput.placeholder = '·Éí·Éê·Éò·Éõ·Éî·Éù·É†·Éî·Éó ·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò';
  confirmPassInput.className = 'auth-input';
  confirmPassInput.style.cssText = 'width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; margin-bottom: 5px;';
  
  const confirmPassError = document.createElement('div');
  confirmPassError.id = 'confirmPasswordError';
  confirmPassError.style.cssText = 'color: var(--danger); font-size: 13px; margin-top: 4px; display: none; text-align: left;';
  
  confirmPassDiv.appendChild(confirmPassInput);
  confirmPassDiv.appendChild(confirmPassError);
  
  content.appendChild(currentPassDiv);
  content.appendChild(newPassDiv);
  content.appendChild(confirmPassDiv);
  
  const buttons = document.createElement('div');
  buttons.className = 'modal-buttons';
  buttons.style.cssText = 'display: flex; gap: 15px; justify-content: center;';
  
  const saveBtn = document.createElement('button');
  saveBtn.id = 'savePasswordBtn';
  saveBtn.className = 'modal-btn confirm';
  saveBtn.style.cssText = 'padding: 12px 24px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;';
  saveBtn.textContent = '·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê';
  
  const cancelBtn = document.createElement('button');
  cancelBtn.id = 'cancelPasswordBtn';
  cancelBtn.className = 'modal-btn cancel';
  cancelBtn.style.cssText = 'padding: 12px 24px; background: var(--danger); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;';
  cancelBtn.textContent = '·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê';
  
  buttons.appendChild(saveBtn);
  buttons.appendChild(cancelBtn);
  
  modal.appendChild(header);
  modal.appendChild(content);
  modal.appendChild(buttons);
  modalOverlay.appendChild(modal);
  
  document.body.appendChild(modalOverlay);
  
  const hideAllErrors = () => {
    currentPassError.style.display = 'none';
    newPassError.style.display = 'none';
    confirmPassError.style.display = 'none';
  };
  
  saveBtn.addEventListener('click', () => {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;
    
    hideAllErrors();
    
    let hasError = false;
    
    if (!currentPassword) {
      currentPassError.textContent = '·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê';
      currentPassError.style.display = 'block';
      hasError = true;
    }
    
    if (!newPassword) {
      newPassError.textContent = '·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê';
      newPassError.style.display = 'block';
      hasError = true;
    } else if (newPassword.length < 6) {
      newPassError.textContent = '·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò ·É£·Éú·Éì·Éê ·Éò·Éß·Éù·É° ·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù';
      newPassError.style.display = 'block';
      hasError = true;
    }
    
    if (!confirmPassword) {
      confirmPassError.textContent = '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éí·Éê·Éò·Éõ·Éî·Éù·É†·Éù·Éó ·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò';
      confirmPassError.style.display = 'block';
      hasError = true;
    } else if (newPassword && newPassword !== confirmPassword) {
      confirmPassError.textContent = '·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É† ·Éî·Éõ·Éó·ÉÆ·Éï·Éî·Éï·Éê';
      confirmPassError.style.display = 'block';
      hasError = true;
    }
    
    if (hasError) return;
    
    try {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (users[currentUser.username]?.password !== currentPassword) {
        currentPassError.textContent = '·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É†·Éê·É°·É¨·Éù·É†·Éò·Éê';
        currentPassError.style.display = 'block';
        return;
      }
      
      users[currentUser.username].password = newPassword;
      localStorage.setItem('users', JSON.stringify(users));
      
      modalOverlay.remove();
      showNotification('·Éû·Éê·É†·Éù·Éö·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê', false);
    } catch (error) {
      console.error('Error changing password:', error);
      newPassError.textContent = '·É®·Éî·É™·Éì·Éù·Éõ·Éê ·Éû·Éê·É†·Éù·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éò·É°·Éê·É°';
      newPassError.style.display = 'block';
    }
  });
  
  cancelBtn.addEventListener('click', () => {
    modalOverlay.remove();
  });
  
  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) {
      modalOverlay.remove();
    }
  });
}

function showContinueOrRestartModal(progress) {
  const existingModal = document.querySelector('.modal-overlay[data-type="continue"]');
  if (existingModal) existingModal.remove();
  
  const hasNormal = progress.normal && Object.keys(progress.normal.answeredQuestions || {}).length > 0;
  const hasExam = progress.exam && Object.keys(progress.exam.answeredQuestions || {}).length > 0;
  
  let message = '';
  if (hasNormal && hasExam) {
    message = '·Éó·É•·Éï·Éî·Éú ·Éí·Éê·É•·Éï·Éó ·É®·Éî·Éú·Éê·ÉÆ·É£·Éö·Éò ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò ·É†·Éù·Éí·Éù·É†·É™ ·Éú·Éù·É†·Éõ·Éê·Éö·É£·É†, ·Éê·É°·Éî·Éï·Éî ·É°·Éê·Éí·Éê·Éõ·Éù·É™·Éì·Éù ·É†·Éî·Éü·Éò·Éõ·É®·Éò.';
  } else if (hasNormal) {
    message = '·Éó·É•·Éï·Éî·Éú ·Éí·Éê·É•·Éï·Éó ·É®·Éî·Éú·Éê·ÉÆ·É£·Éö·Éò ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò ·Éú·Éù·É†·Éõ·Éê·Éö·É£·É† ·É†·Éî·Éü·Éò·Éõ·É®·Éò.';
  } else if (hasExam) {
    message = '·Éó·É•·Éï·Éî·Éú ·Éí·Éê·É•·Éï·Éó ·É®·Éî·Éú·Éê·ÉÆ·É£·Éö·Éò ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò ·É°·Éê·Éí·Éê·Éõ·Éù·É™·Éì·Éù ·É†·Éî·Éü·Éò·Éõ·É®·Éò.';
  }
  
  const modalHTML = `
    <div class="modal-overlay active" data-type="continue" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;">
      <div class="modal" style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div class="modal-header" style="font-size: 24px; font-weight: 600; color: #1e293b; margin-bottom: 20px; text-align: center;">·Éí·É°·É£·É†·Éó ·Éí·Éê·Éí·É†·É´·Éî·Éö·Éî·Éë·Éê?</div>
        <div class="modal-content" style="margin-bottom: 30px;">
          <p style="margin-bottom: 15px; text-align: center;">${message}</p>
          <p style="margin-bottom: 20px; text-align: center; font-weight: 600;">·É†·Éù·Éí·Éù·É† ·Éí·É°·É£·É†·Éó ·Éí·Éê·Éê·Éí·É†·É´·Éî·Éö·Éù·Éó?</p>
          <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>·Éú·Éù·É†·Éõ·Éê·Éö·É£·É†·Éò ·É†·Éî·Éü·Éò·Éõ·Éò:</span>
              <span style="font-weight: 600;">${hasNormal ? Object.keys(progress.normal.answeredQuestions || {}).length + ' ·Éô·Éò·Éó·ÉÆ·Éï·Éê' : '·Éê·É† ·Éê·É†·Éò·É° ·Éì·Éê·É¨·Éß·Éî·Éë·É£·Éö·Éò'}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>·É°·Éê·Éí·Éê·Éõ·Éù·É™·Éì·Éù ·É†·Éî·Éü·Éò·Éõ·Éò:</span>
              <span style="font-weight: 600;">${hasExam ? Object.keys(progress.exam.answeredQuestions || {}).length + ' ·Éô·Éò·Éó·ÉÆ·Éï·Éê' : '·Éê·É† ·Éê·É†·Éò·É° ·Éì·Éê·É¨·Éß·Éî·Éë·É£·Éö·Éò'}</span>
            </div>
          </div>
        </div>
        <div class="modal-buttons" style="display: flex; gap: 15px; justify-content: center;">
          <button id="continueProgressBtn" class="modal-btn confirm" style="padding: 12px 24px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">·Éí·Éê·Éí·É†·É´·Éî·Éö·Éî·Éë·Éê</button>
          <button id="restartProgressBtn" class="modal-btn" style="padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">·ÉÆ·Éî·Éö·Éê·ÉÆ·Éö·Éê ·Éì·Éê·É¨·Éß·Éî·Éë·Éê</button>
          <button id="closeProgressBtn" class="modal-btn cancel" style="padding: 12px 24px; background: var(--danger); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">·Éì·Éê·ÉÆ·É£·É†·Éï·Éê</button>
        </div>
      </div>
    </div>
  `;
  
  const modalContainer = document.createElement('div');
  modalContainer.innerHTML = modalHTML;
  document.body.appendChild(modalContainer.firstChild);
  
  document.getElementById('continueProgressBtn').addEventListener('click', () => {
    modalContainer.remove();
    
    if (hasNormal && hasExam) {
      chooseModeToContinue(progress);
    } else if (hasNormal) {
      startSavedProgress('normal', progress);
    } else if (hasExam) {
      startSavedProgress('exam', progress);
    }
  });
  
  document.getElementById('restartProgressBtn').addEventListener('click', () => {
    if (currentUser && currentUser.username) {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (users[currentUser.username] && users[currentUser.username].progress) {
        users[currentUser.username].progress = {
          rezidentura: {
            normal: { answeredQuestions: {}, currentIndex: 0 },
            exam: { answeredQuestions: {}, currentIndex: 0 },
            wrongQuestions: []
          }
        };
        localStorage.setItem('users', JSON.stringify(users));
        userProgress = users[currentUser.username].progress;
      }
    }
    modalContainer.remove();
    showNotification('·Éû·É†·Éù·Éí·É†·Éî·É°·Éò ·É¨·Éê·Éò·É®·Éê·Éö·Éê. ·É®·Éî·Éí·Éò·É´·Éö·Éò·Éê·Éó ·Éó·Éê·Éï·Éò·Éì·Éê·Éú ·Éì·Éê·Éò·É¨·Éß·Éù·Éó.', false);
  });
  
  document.getElementById('closeProgressBtn').addEventListener('click', () => {
    modalContainer.remove();
  });
}

function chooseModeToContinue(progress) {
  const modalHTML = `
    <div class="modal-overlay active" data-type="mode-select" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10002;">
      <div class="modal" style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div class="modal-header" style="font-size: 24px; font-weight: 600; color: #1e293b; margin-bottom: 20px; text-align: center;">·Éê·Éò·É†·É©·Éò·Éî·Éó ·É†·Éî·Éü·Éò·Éõ·Éò</div>
        <div class="modal-content" style="margin-bottom: 30px;">
          <p style="margin-bottom: 20px; text-align: center;">·É†·Éù·Éõ·Éî·Éö·Éò ·É†·Éî·Éü·Éò·Éõ·Éò·É° ·Éí·Éê·Éí·É†·É´·Éî·Éö·Éî·Éë·Éê ·Éí·É°·É£·É†·Éó?</p>
          <div style="display: flex; gap: 15px; justify-content: center;">
            <button id="chooseNormalBtn" style="flex:1; padding: 20px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer;">
              <div style="font-size: 18px; font-weight: 600; color: var(--accent); margin-bottom: 8px;">·Éú·Éù·É†·Éõ·Éê·Éö·É£·É†·Éò</div>
              <div style="font-size: 14px; color: #64748b;">${Object.keys(progress.normal.answeredQuestions || {}).length} ·Éô·Éò·Éó·ÉÆ·Éï·Éê</div>
            </button>
            <button id="chooseExamBtn" style="flex:1; padding: 20px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer;">
              <div style="font-size: 18px; font-weight: 600; color: var(--danger); margin-bottom: 8px;">·É°·Éê·Éí·Éê·Éõ·Éù·É™·Éì·Éù</div>
              <div style="font-size: 14px; color: #64748b;">${Object.keys(progress.exam.answeredQuestions || {}).length} ·Éô·Éò·Éó·ÉÆ·Éï·Éê</div>
            </button>
          </div>
        </div>
        <div class="modal-buttons" style="display: flex; justify-content: center;">
          <button id="closeModeSelectBtn" class="modal-btn cancel" style="padding: 12px 24px; background: var(--danger); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê</button>
        </div>
      </div>
    </div>
  `;
  
  const modalContainer = document.createElement('div');
  modalContainer.innerHTML = modalHTML;
  document.body.appendChild(modalContainer.firstChild);
  
  document.getElementById('chooseNormalBtn').addEventListener('click', () => {
    startSavedProgress('normal', progress);
    modalContainer.remove();
  });
  
  document.getElementById('chooseExamBtn').addEventListener('click', () => {
    startSavedProgress('exam', progress);
    modalContainer.remove();
  });
  
  document.getElementById('closeModeSelectBtn').addEventListener('click', () => {
    modalContainer.remove();
  });
}

function startSavedProgress(mode, progress) {
  const modeExam = document.getElementById('modeExam');
  const modeSequential = document.getElementById('modeSequential');
  const modeShuffleQuestions = document.getElementById('modeShuffleQuestions');
  const modeShuffleAnswers = document.getElementById('modeShuffleAnswers');
  
  if (mode === 'exam') {
    if (modeExam) modeExam.checked = true;
    if (modeSequential) modeSequential.checked = false;
    if (modeShuffleQuestions) modeShuffleQuestions.checked = true;
    if (modeShuffleAnswers) modeShuffleAnswers.checked = false;
  } else {
    if (modeExam) modeExam.checked = false;
    if (modeSequential) modeSequential.checked = true;
  }
  
  const testTypeSelect = document.getElementById('testTypeSelect');
  if (testTypeSelect) {
    testTypeSelect.value = 'rezidentura';
    currentTestType = 'rezidentura';
    toggleTopicsDropdown();
  }
  
  const topicsSelect = document.getElementById('topicsSelect');
  if (topicsSelect) {
    topicsSelect.value = 'all';
    selectedTopic = null;
  }
  
  window.savedProgress = progress;
  
  setTimeout(() => {
    if (allTestsWithTopics.length > 0) {
      startTest();
    } else {
      loadCSV();
    }
  }, 300);
}

// ==================== CHAT FUNCTIONS ====================
function initChat() {
  console.log("Initializing chat...");
  
  if (!chatMessagesEl || !chatButton || !chatWindow) {
    console.error("Chat elements not initialized yet");
    return;
  }
  
  chatMessagesEl.innerHTML = '';
  onlineCount.textContent = '1';
  
  if (currentUser && currentUser.username) {
    userName = currentUser.username;
    localStorage.setItem('chatUserName', userName);
  }
  
  unreadMessagesCount = 0;
  updateChatNotification();
  
  if (firebaseSyncEnabled && database) {
    console.log("Setting up Firebase chat...");
    setupFirebaseListeners();
  } else {
    console.log("Using local chat mode");
    loadLocalMessagesAsFallback();
  }
  
  chatButton.replaceWith(chatButton.cloneNode(true));
  closeChat.replaceWith(closeChat.cloneNode(true));
  sendBtn.replaceWith(sendBtn.cloneNode(true));
  
  chatButton = document.getElementById('chatButton');
  closeChat = document.querySelector('.close-chat');
  sendBtn = document.getElementById('sendBtn');
  chatInput = document.getElementById('chatInput');
  
  chatButton.addEventListener('click', () => {
    chatWindow.classList.toggle('active');
    if (chatWindow.classList.contains('active')) {
      isChatOpen = true;
      markAllMessagesAsRead();
      chatInput.focus();
      
      setTimeout(() => {
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      }, 100);
    } else {
      isChatOpen = false;
    }
  });
  
  closeChat.addEventListener('click', () => {
    chatWindow.classList.remove('active');
    isChatOpen = false;
  });
  
  sendBtn.addEventListener('click', sendMessageToFirebase);
  
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessageToFirebase();
  });
}

function markAllMessagesAsRead() {
  unreadMessagesCount = 0;
  updateChatNotification();
  lastSeenMessageTime = Date.now();
  localStorage.setItem('lastSeenMessageTime', lastSeenMessageTime.toString());
}

function setupFirebaseListeners() {
  try {
    displayedMessageKeys.clear();
    
    database.ref('chat/messages').limitToLast(50).once('value').then((snapshot) => {
      if (snapshot.exists()) {
        const messages = [];
        
        snapshot.forEach((childSnapshot) => {
          const message = childSnapshot.val();
          const messageKey = childSnapshot.key;
          messages.push({ ...message, key: messageKey });
        });
        
        messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        
        messages.forEach(msg => {
          displayedMessageKeys.add(msg.key);
          const isMyMessage = msg.userId === userId;
          
          addMessageToChat(msg.author, msg.text, isMyMessage, new Date(msg.timestamp));
          
          if (!isMyMessage && msg.timestamp > lastSeenMessageTime) {
            unreadMessagesCount++;
          }
        });
        
        updateChatNotification();
        
        setTimeout(() => {
          if (isChatOpen) {
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
          }
        }, 200);
      }
      
      allMessagesLoaded = true;
    }).catch(error => {
      console.error('Error loading initial messages:', error);
      loadLocalMessagesAsFallback();
    });
    
    database.ref('chat/messages').orderByKey().limitToLast(1).on('child_added', (snapshot) => {
      const message = snapshot.val();
      const messageKey = snapshot.key;
      
      if (displayedMessageKeys.has(messageKey)) {
        return;
      }
      
      displayedMessageKeys.add(messageKey);
      const isMyMessage = message.userId === userId;
      
      if (!isMyMessage) {
        const messageTime = message.timestamp || Date.now();
        
        addMessageToChat(message.author, message.text, false, new Date(messageTime));
        
        if (!isChatOpen && messageTime > lastSeenMessageTime) {
          unreadMessagesCount++;
          updateChatNotification();
        }
        
        lastSeenMessageTime = Math.max(lastSeenMessageTime, messageTime);
      }
    });
    
    database.ref('chat/onlineUsers').on('value', (snapshot) => {
      if (snapshot.exists()) {
        const users = snapshot.val();
        const now = Date.now();
        let activeUsers = 1;
        
        Object.keys(users).forEach(key => {
          if (users[key]?.userId !== userId && 
              users[key]?.lastSeen && 
              (now - users[key].lastSeen) < 30000) {
            activeUsers++;
          }
        });
        
        onlineCount.textContent = activeUsers.toString();
      } else {
        onlineCount.textContent = '1';
      }
    });
    
    setUserOnline();
    
  } catch (error) {
    console.error("Firebase listener error:", error);
    loadLocalMessagesAsFallback();
  }
}

function loadLocalMessagesAsFallback() {
  console.log("Loading local messages as fallback...");
  try {
    let localMessages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
    
    localMessages.sort((a, b) => {
      const timeA = new Date(a.timestamp).getTime();
      const timeB = new Date(b.timestamp).getTime();
      return timeA - timeB;
    });
    
    if (localMessages.length > 0) {
      localMessages.forEach(msg => {
        const isSent = msg.userId === userId;
        addMessageToChat(msg.author, msg.text, isSent, new Date(msg.timestamp));
      });
    }
    addMessageToChat('·É°·Éò·É°·É¢·Éî·Éõ·Éê', '·Éô·Éî·Éó·Éò·Éö·Éò ·Éò·Éß·Éù·É° ·Éó·É•·Éï·Éî·Éú·Éò ·Éõ·Éù·Éë·É†·É´·Éê·Éú·Éî·Éë·Éê! (·Éö·Éù·Éô·Éê·Éö·É£·É†·Éò ·É†·Éî·Éü·Éò·Éõ·Éò)', false, new Date());
  } catch (e) {
    console.error('Error loading local messages:', e);
    addMessageToChat('·É°·Éò·É°·É¢·Éî·Éõ·Éê', '·Éô·Éî·Éó·Éò·Éö·Éò ·Éò·Éß·Éù·É° ·Éó·É•·Éï·Éî·Éú·Éò ·Éõ·Éù·Éë·É†·É´·Éê·Éú·Éî·Éë·Éê!', false, new Date());
  }
}

function setUserOnline() {
  if (!firebaseSyncEnabled || !database) return;
  
  try {
    const userRef = database.ref('chat/onlineUsers/' + userId);
    
    database.ref('chat/onlineUsers').once('value').then((snapshot) => {
      if (snapshot.exists()) {
        const users = snapshot.val();
        const now = Date.now();
        const updates = {};
        
        Object.keys(users).forEach(key => {
          if (users[key]?.lastSeen && (now - users[key].lastSeen) > 60000) {
            updates[key] = null;
          }
        });
        
        if (Object.keys(updates).length > 0) {
          database.ref('chat/onlineUsers').update(updates);
        }
      }
    });
    
    userRef.set({
      name: userName,
      userId: userId,
      lastSeen: Date.now()
    });
    
    isOnline = true;
    
    setInterval(() => {
      if (isOnline && firebaseSyncEnabled) {
        userRef.update({ lastSeen: Date.now() });
      }
    }, 10000);
    
    window.addEventListener('beforeunload', () => {
      if (firebaseSyncEnabled) {
        userRef.remove();
      }
      isOnline = false;
    });
  } catch (error) {
    console.error("Error setting user online:", error);
  }
}

function sendMessageToFirebase() {
  if (!chatInput) return;
  
  const message = chatInput.value.trim();
  if (!message) return;
  
  if (!userName) {
    if (currentUser && currentUser.username) {
      userName = currentUser.username;
    } else {
      userName = '·É°·É¢·É£·Éõ·Éê·É†·Éò N' + Math.floor(Math.random() * 1000);
    }
    localStorage.setItem('chatUserName', userName);
  }
  
  const messageData = {
    text: message,
    author: userName,
    userId: userId,
    timestamp: Date.now()
  };
  
  chatInput.value = '';
  
  addMessageToChat(userName, message, true, new Date());
  
  saveMessageToLocalStorage(messageData);
  
  if (firebaseSyncEnabled && database) {
    const newMessageRef = database.ref('chat/messages').push();
    const messageKey = newMessageRef.key;
    
    displayedMessageKeys.add(messageKey);
    
    newMessageRef.set(messageData)
      .catch((error) => {
        console.error('Error sending message to Firebase:', error);
        showNotification('·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê ·É®·Éî·Éú·Éê·ÉÆ·É£·Éö·Éò·Éê ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éö·Éù·Éô·Éê·Éö·É£·É†·Éê·Éì', false);
      });
  } else {
    showNotification('·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê ·É®·Éî·Éú·Éê·ÉÆ·É£·Éö·Éò·Éê ·Éö·Éù·Éô·Éê·Éö·É£·É†·Éê·Éì', false);
  }
}

function saveMessageToLocalStorage(messageData) {
  try {
    let localMessages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
    localMessages.push({
      ...messageData,
      timestamp: new Date().toISOString()
    });
    
    if (localMessages.length > 100) {
      localMessages = localMessages.slice(-100);
    }
    
    localStorage.setItem('chatMessages', JSON.stringify(localMessages));
  } catch (e) {
    console.error('Error saving to localStorage:', e);
  }
}

function addMessageToChat(author, message, isSent, timestamp) {
  if (!chatMessagesEl) return;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
  
  const time = timestamp.toLocaleTimeString('ka-GE', {
    hour: '2-digit',
    minute: '2-digit'
  });
  
  messageDiv.innerHTML = `
    <div class="message-author">${escapeHtml(author)}</div>
    <div class="message-time">${time}</div>
    <div class="message-content">${escapeHtml(message)}</div>
  `;
  
  chatMessagesEl.appendChild(messageDiv);
  
  if (isSent) {
    lastSeenMessageTime = Math.max(lastSeenMessageTime, timestamp.getTime());
    localStorage.setItem('lastSeenMessageTime', lastSeenMessageTime.toString());
  }
  
  if (isChatOpen) {
    setTimeout(() => {
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }, 100);
  }
}

function updateChatNotification() {
  const notification = document.getElementById('chatNotification');
  if (notification) {
    if (unreadMessagesCount > 0) {
      notification.style.display = 'flex';
      if (unreadMessagesCount > 99) {
        notification.textContent = '99+';
        notification.setAttribute('data-count', 'many');
      } else {
        notification.textContent = unreadMessagesCount.toString();
        notification.removeAttribute('data-count');
      }
    } else {
      notification.style.display = 'none';
    }
  }
}

// ==================== TOPIC FUNCTIONS ====================
function toggleTopicsDropdown() {
  const testTypeSelect = document.getElementById('testTypeSelect');
  const topicsContainer = document.getElementById('topicsDropdownContainer');
  
  if (!testTypeSelect || !topicsContainer) return;
  
if (testTypeSelect.value === 'samkurnaloo') {
    topicsContainer.style.display = 'flex';
  } else {
    topicsContainer.style.display = 'none';
    const topicsSelect = document.getElementById('topicsSelect');
    if (topicsSelect) topicsSelect.value = 'all';
    selectedTopic = null;
  }
}

function bindTestTypeEvents() {
  const testTypeSelect = document.getElementById('testTypeSelect');
  if (testTypeSelect) {
    testTypeSelect.addEventListener('change', function() {
      toggleTopicsDropdown();
      const startBtn = document.getElementById('startBtn');
      if (startBtn) {
        startBtn.disabled = !this.value;
      }
      if (this.value && allTests.length > 0) {
        loadCSV();
      }
    });
  }
}

// ==================== UTILITY FUNCTIONS ====================
function escapeHtml(s){ 
  if(!s) return ''; 
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#039;'
  }[m])); 
}

function shuffleArray(a){ 
  for(let i=a.length-1;i>0;i--){ 
    const j=Math.floor(Math.random()*(i+1)); 
    [a[i],a[j]]=[a[j],a[i]]; 
  } 
}

function showNotification(message, isError = true) {
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();
  
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.textContent = message;
  notification.style.background = isError ? 'var(--danger)' : 'var(--success)';
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 4000);
}

function resetLoader() {
  loaderOverlay.innerHTML = `
    <div class="spinner"></div>
    <div class="loader-text">·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê...</div>
  `;
}

function updateTimerDisplay() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('ka-GE');
  
  timerElement.innerHTML = `
    <span class="timer-separator">|</span>
    <span class="timer-time">${timeStr}</span>
  `;
}

function updateTimer() {
  updateTimerDisplay();
  if (examMode) {
    updateExamTimer();
  }
}

function updateExamTimer() {
  if (!examMode) return;
  
  const now = Date.now();
  const elapsed = Math.floor((now - lastTimerUpdate) / 1000);
  
  if (elapsed > 0) {
    examTimeRemaining = Math.max(0, examTimeRemaining - elapsed);
    lastTimerUpdate = now;
  }
  
  const hours = Math.floor(examTimeRemaining / 3600);
  const minutes = Math.floor((examTimeRemaining % 3600) / 60);
  const seconds = examTimeRemaining % 60;
  
  examCountdown.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  
  if (examTimeRemaining <= 0) {
    clearInterval(examTimerInterval);
    examTimerInterval = null;
    completeExam();
  }
}

// ==================== EXAM MODE FUNCTIONS ====================
function createExamTestBoxes() {
  if (!examTestBoxes) return;
  
  examTestBoxes.innerHTML = '';
  
  for (let i = 0; i < sessionTests.length; i++) {
    const testBox = document.createElement('div');
    testBox.className = 'test-box';
    testBox.textContent = i + 1;
    testBox.dataset.index = i;
    
    if (i === currentIndex) {
      testBox.classList.add('current');
    }
    
    if (sessionTests[i] && sessionTests[i].selectedAnswers && sessionTests[i].selectedAnswers.length > 0) {
      testBox.classList.add('answered');
    }
    
    testBox.addEventListener('click', () => {
      currentIndex = i;
      renderCurrentQuestion();
    });
    
    examTestBoxes.appendChild(testBox);
  }
}

function startExamMode() {
  examMode = true;
  
  if (!window.savedProgress || !window.savedProgress.exam?.examTimeRemaining) {
    examTimeRemaining = 3 * 60 * 60;
  }
  
  lastTimerUpdate = Date.now();
  
  timerElement.classList.add('hidden');
  normalModeContainer.classList.add('hidden');
  examModeContainer.classList.remove('hidden');
  examRightPanel.classList.remove('hidden');
  questionCounter.classList.add('hidden');
  
  createExamTestBoxes();
  
  if (examTimerInterval) {
    clearInterval(examTimerInterval);
    examTimerInterval = null;
  }
  
  examTimerInterval = setInterval(updateExamTimer, 1000);
  updateExamTimer();
  
  if (examFinishBtn) {
    examFinishBtn.style.display = 'flex';
  }
}

// ==================== SETTINGS PAGE FUNCTIONS ====================
function showSettingsPage() {
  if (!currentUser || currentUser.isGuest) {
    showNotification('·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·É†·Éî·Éí·Éò·É°·É¢·É†·Éò·É†·Éî·Éë·É£·Éö ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éî·Éë·É° ·É®·Éî·É£·É´·Éö·Éò·Éê·Éó ·Éû·Éê·É†·Éê·Éõ·Éî·É¢·É†·Éî·Éë·Éò·É° ·Éú·Éê·ÉÆ·Éï·Éê');
    return;
  }

  const settingsHTML = `
    <div id="settingsPage" class="settings-page">
      <div class="settings-container">
        <div class="settings-header">
          <h2>·Éû·Éê·É†·Éê·Éõ·Éî·É¢·É†·Éî·Éë·Éò</h2>
          <button class="settings-close-btn" id="vectorCloseSettings">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div id="settingsContent">
          <div class="settings-section">
            <div class="settings-section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="${currentUser ? '#0ea5a4' : '#64748b'}"/>
              </svg>
              ·Éû·Éò·É†·Éê·Éì·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê
            </div>
            
            <div class="settings-field">
              <label class="settings-label">·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò</label>
              <div class="settings-input-group">
                <input type="text" id="settingsUsername" class="settings-input" value="${escapeHtml(currentUser?.username || '')}" disabled>
                <button class="settings-edit-btn" onclick="enableUsernameEdit()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" stroke="currentColor" fill="currentColor"/>
                  </svg>
                    ·É®·Éî·É™·Éï·Éö·Éê
                </button>
              </div>
            </div>
            
            <div class="settings-field">
              <label class="settings-label">·Éû·Éê·É†·Éù·Éö·Éò</label>
              <div class="settings-input-group">
                <input type="password" id="settingsPassword" class="settings-input" value="${escapeHtml(getUserPassword(currentUser?.username) || '')}" disabled>
                <button class="settings-eye-btn" onclick="togglePasswordVisibility('settingsPassword', this)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </button>
                <button class="settings-edit-btn" onclick="showPasswordChangeFromSettings()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" stroke="currentColor" fill="currentColor"/>
                  </svg>
                  ·Éû·Éê·É†·Éù·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê
                </button>
              </div>
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M18 6L6 18M6 6l12 12" stroke="#dc2626" stroke-width="2" stroke-linecap="round"/>
              </svg>
              ·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò·É° ·Éò·É°·É¢·Éù·É†·Éò·Éê
            </div>
            
            <div id="mistakesList" class="mistakes-container">
              ${renderMistakesList()}
            </div>
            
            <button class="settings-print-btn" onclick="printMistakes()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M6 9V3h12v6m0 4h.01M6 15h12v6H6v-6z" stroke="white" stroke-width="2"/>
                <path d="M6 19v-4h12v4" stroke="white" stroke-width="2"/>
              </svg>
              ·Éë·Éî·É≠·Éì·Éï·Éê
            </button>
          </div>
          
          <div class="settings-actions">
            <button class="settings-back-btn" onclick="closeSettingsPage()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              ·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·Éí·Éï·Éî·É†·Éì·Éò
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

  const existingSettings = document.getElementById('settingsPage');
  if (existingSettings) {
    existingSettings.remove();
  }

  document.body.insertAdjacentHTML('beforeend', settingsHTML);
  
  document.getElementById('vectorCloseSettings').addEventListener('click', closeSettingsPage);
}

function getUserPassword(username) {
  try {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    return users[username]?.password || '';
  } catch (error) {
    console.error('Error getting user password:', error);
    return '';
  }
}

function togglePasswordVisibility(inputId, button) {
  const input = document.getElementById(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    button.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" stroke="currentColor" stroke-width="2"/>
      <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/>
    </svg>`;
  } else {
    input.type = 'password';
    button.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
      <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
    </svg>`;
  }
}

async function enableUsernameEdit() {
  const usernameInput = document.getElementById('settingsUsername');
  if (usernameInput) {
    usernameInput.disabled = false;
    usernameInput.focus();
    
    if (!document.getElementById('saveUsernameBtn')) {
      const saveBtn = document.createElement('button');
      saveBtn.id = 'saveUsernameBtn';
      saveBtn.className = 'settings-edit-btn';
      saveBtn.style.color = 'var(--success)';
      saveBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê
      `;
      saveBtn.onclick = saveUsername;
      usernameInput.parentElement.appendChild(saveBtn);
    }
  }
}

async function saveUsername() {
  const newUsername = document.getElementById('settingsUsername').value.trim();
  
  if (!newUsername) {
    showNotification('·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éì·Éê ·Éí·Éï·Éê·É†·Éò ·Éê·É† ·É®·Éî·Éò·É´·Éö·Éî·Éë·Éê ·Éò·Éß·Éù·É° ·É™·Éê·É†·Éò·Éî·Éö·Éò');
    return;
  }
  
  const nameParts = newUsername.split(/\s+/);
  if (nameParts.length < 2) {
    showNotification('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éì·Éê ·Éí·Éï·Éê·É†·Éò');
    return;
  }
  
  if (/[^a-zA-Z0-9·Éê-·É∞\s]/.test(newUsername)) {
    showNotification('·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éì·Éê ·Éí·Éï·Éê·É†·Éò ·É£·Éú·Éì·Éê ·É®·Éî·Éò·É™·Éê·Éï·Éì·Éî·É° ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éê·É°·Éù·Éî·Éë·É°, ·É™·Éò·É§·É†·Éî·Éë·É°, ·É•·Éê·É†·Éó·É£·Éö ·Éê·É°·Éù·Éî·Éë·É° ·Éì·Éê ·É°·É§·Éî·Éò·É°·Éî·Éë·É°');
    return;
  }
  
  if (newUsername === currentUser.username) {
    showNotification('·Éê·ÉÆ·Éê·Éö·Éò ·É°·Éê·ÉÆ·Éî·Éö·Éò ·Éî·Éõ·Éó·ÉÆ·Éï·Éî·Éï·Éê ·É´·Éï·Éî·Éö·É°', false);
    cancelUsernameEdit();
    return;
  }
  
  try {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    
    if (users[newUsername]) {
      showNotification('·Éî·É° ·É°·Éê·ÉÆ·Éî·Éö·Éò ·É£·Éô·Éï·Éî ·Éí·Éê·Éõ·Éù·Éß·Éî·Éú·Éî·Éë·É£·Éö·Éò·Éê');
      return;
    }
    
    if (firebaseSyncEnabled && database) {
      const firebaseUser = await loadUserFromFirebase(newUsername);
      if (firebaseUser) {
        showNotification('·Éî·É° ·É°·Éê·ÉÆ·Éî·Éö·Éò ·É£·Éô·Éï·Éî ·Éí·Éê·Éõ·Éù·Éß·Éî·Éú·Éî·Éë·É£·Éö·Éò·Éê (·Éí·Éö·Éù·Éë·Éê·Éö·É£·É†·Éê·Éì)');
        return;
      }
    }
    
    const oldUsername = currentUser.username;
    const oldUserData = users[oldUsername];
    
    // üî¥ ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éï·Éê·Éú·Éò: ·Éì·É†·Éù·Éî·Éë·Éò·Éó ·Éí·Éê·Éï·Éó·Éò·É®·Éù·Éó Firebase listener
    if (firebaseSyncEnabled && database) {
      const oldSafeUsername = oldUsername.replace(/[.#$[\]]/g, '_');
      database.ref('users/' + oldSafeUsername).off();
    }
    
    // üî¥ ·Éì·Éê·Éï·É°·Éî·É¢·Éù·Éó ·É§·Éö·Éê·Éí·Éò, ·É†·Éù·Éõ ·Éê·É† ·Éõ·Éù·ÉÆ·Éì·Éî·É° ·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éò ·Éí·Éê·É°·Éï·Éö·Éê
    window._isChangingUsername = true;
    
    // Firebase-·É®·Éò ·É´·Éï·Éî·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É° ·É¨·Éê·É®·Éö·Éê
    if (firebaseSyncEnabled && database) {
      await database.ref('users/' + oldUsername.replace(/[.#$[\]]/g, '_')).remove();
    }
    
    // ·Éê·ÉÆ·Éê·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É° ·É®·Éî·É•·Éõ·Éú·Éê
    users[newUsername] = oldUserData;
    delete users[oldUsername];
    
    localStorage.setItem('users', JSON.stringify(users));
    
    // Firebase-·É®·Éò ·Éê·ÉÆ·Éê·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É° ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê
    if (firebaseSyncEnabled && database) {
      await saveUserToFirebase(newUsername, users[newUsername]);
    }
    
    // ·É®·Éî·Éï·Éò·Éú·Éê·ÉÆ·Éù·Éó ·É´·Éï·Éî·Éö·Éò ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éë·Éî·Éë·Éò
    const oldProgress = userProgress;
    const oldTestType = currentTestType;
    const oldUserId = userId;
    
    // ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó currentUser
    currentUser = { 
      username: newUsername, 
      isGuest: false 
    };
    
    // ·Éê·É¶·Éï·Éê·Éì·Éí·Éò·Éú·Éù·Éó ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò ·Éê·ÉÆ·Éê·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É°·Éó·Éï·Éò·É°
    userProgress = oldProgress;
    
    // ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó UI
    document.getElementById('usernameDisplay').textContent = newUsername;
    userName = newUsername;
    localStorage.setItem('chatUserName', userName);
    localStorage.setItem('chatUserId', oldUserId);
    
    // ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó ·É©·Éê·É¢·Éò·É° ·Éê·Éò·Éì·Éò
    if (firebaseSyncEnabled && database) {
      // ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó ·Éù·Éú·Éö·Éê·Éò·Éú ·É°·É¢·Éê·É¢·É£·É°·Éò
      const userRef = database.ref('chat/onlineUsers/' + oldUserId);
      userRef.update({ name: newUsername });
    }
    
    // ·ÉÆ·Éî·Éö·Éê·ÉÆ·Éö·Éê ·Éì·Éê·Éï·Éê·Éß·Éî·Éú·Éù·Éó Firebase listener-·Éî·Éë·Éò
    if (firebaseSyncEnabled && database) {
      setupModuleListener();
      setupUserDeletionListener();
    }
    
    // üî¥ ·Éí·Éê·Éï·Éê·É£·É•·Éõ·Éù·Éó ·É§·Éö·Éê·Éí·Éò
    setTimeout(() => {
      window._isChangingUsername = false;
    }, 2000);
    
    showNotification('·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê', false);
    
    closeSettingsPage();
    
  } catch (error) {
    console.error('Error saving username:', error);
    showNotification('·É®·Éî·É™·Éì·Éù·Éõ·Éê ·É°·Éê·ÉÆ·Éî·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éò·É°·Éê·É°');
    window._isChangingUsername = false;
  }
}
function cancelUsernameEdit() {
  const usernameInput = document.getElementById('settingsUsername');
  if (usernameInput) {
    usernameInput.disabled = true;
    usernameInput.value = currentUser?.username || '';
    
    const saveBtn = document.getElementById('saveUsernameBtn');
    if (saveBtn) saveBtn.remove();
  }
}

function showPasswordChangeFromSettings() {
  console.log("Opening password change modal from settings");
  
  const modalOverlay = document.createElement('div');
  modalOverlay.className = 'modal-overlay active';
  modalOverlay.id = 'passwordModalOverlay';
  modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10002;';
  
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.cssText = 'background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
  
  const header = document.createElement('div');
  header.className = 'modal-header';
  header.style.cssText = 'font-size: 24px; font-weight: 600; color: #1e293b; margin-bottom: 20px; text-align: center;';
  header.textContent = '·Éû·Éê·É†·Éù·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê';
  
  const content = document.createElement('div');
  content.className = 'modal-content';
  content.style.cssText = 'margin-bottom: 20px;';
  
  const currentPassDiv = document.createElement('div');
  currentPassDiv.style.marginBottom = '20px';
  
  const currentPassInput = document.createElement('input');
  currentPassInput.type = 'password';
  currentPassInput.id = 'currentPassword';
  currentPassInput.placeholder = '·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éû·Éê·É†·Éù·Éö·Éò';
  currentPassInput.className = 'auth-input';
  currentPassInput.style.cssText = 'width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; margin-bottom: 5px;';
  
  const currentPassError = document.createElement('div');
  currentPassError.id = 'currentPasswordError';
  currentPassError.style.cssText = 'color: var(--danger); font-size: 13px; margin-top: 4px; display: none; text-align: left;';
  
  currentPassDiv.appendChild(currentPassInput);
  currentPassDiv.appendChild(currentPassError);
  
  const newPassDiv = document.createElement('div');
  newPassDiv.style.marginBottom = '20px';
  
  const newPassInput = document.createElement('input');
  newPassInput.type = 'password';
  newPassInput.id = 'newPassword';
  newPassInput.placeholder = '·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò (·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù)';
  newPassInput.className = 'auth-input';
  newPassInput.style.cssText = 'width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; margin-bottom: 5px;';
  
  const newPassError = document.createElement('div');
  newPassError.id = 'newPasswordError';
  newPassError.style.cssText = 'color: var(--danger); font-size: 13px; margin-top: 4px; display: none; text-align: left;';
  
  newPassDiv.appendChild(newPassInput);
  newPassDiv.appendChild(newPassError);
  
  const confirmPassDiv = document.createElement('div');
  confirmPassDiv.style.marginBottom = '20px';
  
  const confirmPassInput = document.createElement('input');
  confirmPassInput.type = 'password';
  confirmPassInput.id = 'confirmNewPassword';
  confirmPassInput.placeholder = '·Éí·Éê·Éò·Éõ·Éî·Éù·É†·Éî·Éó ·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò';
  confirmPassInput.className = 'auth-input';
  confirmPassInput.style.cssText = 'width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; margin-bottom: 5px;';
  
  const confirmPassError = document.createElement('div');
  confirmPassError.id = 'confirmPasswordError';
  confirmPassError.style.cssText = 'color: var(--danger); font-size: 13px; margin-top: 4px; display: none; text-align: left;';
  
  confirmPassDiv.appendChild(confirmPassInput);
  confirmPassDiv.appendChild(confirmPassError);
  
  content.appendChild(currentPassDiv);
  content.appendChild(newPassDiv);
  content.appendChild(confirmPassDiv);
  
  const buttons = document.createElement('div');
  buttons.className = 'modal-buttons';
  buttons.style.cssText = 'display: flex; gap: 15px; justify-content: center;';
  
  const saveBtn = document.createElement('button');
  saveBtn.id = 'savePasswordBtn';
  saveBtn.className = 'modal-btn confirm';
  saveBtn.style.cssText = 'padding: 12px 24px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;';
  saveBtn.textContent = '·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê';
  
  const cancelBtn = document.createElement('button');
  cancelBtn.id = 'cancelPasswordBtn';
  cancelBtn.className = 'modal-btn cancel';
  cancelBtn.style.cssText = 'padding: 12px 24px; background: var(--danger); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;';
  cancelBtn.textContent = '·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê';
  
  buttons.appendChild(saveBtn);
  buttons.appendChild(cancelBtn);
  
  modal.appendChild(header);
  modal.appendChild(content);
  modal.appendChild(buttons);
  modalOverlay.appendChild(modal);
  
  document.body.appendChild(modalOverlay);
  
  const hideAllErrors = () => {
    currentPassError.style.display = 'none';
    newPassError.style.display = 'none';
    confirmPassError.style.display = 'none';
  };
  
  saveBtn.addEventListener('click', async function() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;
    
    hideAllErrors();
    
    let hasError = false;
    
    if (!currentPassword) {
      currentPassError.textContent = '·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê';
      currentPassError.style.display = 'block';
      hasError = true;
    }
    
    if (!newPassword) {
      newPassError.textContent = '·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê';
      newPassError.style.display = 'block';
      hasError = true;
    } else if (newPassword.length < 6) {
      newPassError.textContent = '·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò ·É£·Éú·Éì·Éê ·Éò·Éß·Éù·É° ·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ 6 ·É°·Éò·Éõ·Éë·Éù·Éö·Éù';
      newPassError.style.display = 'block';
      hasError = true;
    }
    
    if (!confirmPassword) {
      confirmPassError.textContent = '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éí·Éê·Éò·Éõ·Éî·Éù·É†·Éù·Éó ·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò';
      confirmPassError.style.display = 'block';
      hasError = true;
    } else if (newPassword && newPassword !== confirmPassword) {
      confirmPassError.textContent = '·Éê·ÉÆ·Éê·Éö·Éò ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É† ·Éî·Éõ·Éó·ÉÆ·Éï·Éî·Éï·Éê';
      confirmPassError.style.display = 'block';
      hasError = true;
    }
    
    if (hasError) return;
    
    try {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      
      // ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éî·Éó ·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éû·Éê·É†·Éù·Éö·Éò
      if (users[currentUser.username]?.password !== currentPassword) {
        currentPassError.textContent = '·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éû·Éê·É†·Éù·Éö·Éò ·Éê·É†·Éê·É°·É¨·Éù·É†·Éò·Éê';
        currentPassError.style.display = 'block';
        return;
      }
      
      // ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éî·Éó ·Éû·Éê·É†·Éù·Éö·Éò localStorage-·É®·Éò
      users[currentUser.username].password = newPassword;
      users[currentUser.username].lastUpdated = Date.now();
      localStorage.setItem('users', JSON.stringify(users));
      
      // ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éî·Éó Firebase-·É®·Éò
      if (firebaseSyncEnabled && database) {
        await saveUserToFirebase(currentUser.username, users[currentUser.username]);
      }
      
      // ·Éê·É† ·É®·Éî·Éï·É™·Éï·Éê·Éö·Éù·Éó currentUser, ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éû·Éê·É†·Éù·Éö·Éò ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éì·Éê
      showNotification('·Éû·Éê·É†·Éù·Éö·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê', false);
      
      // ·Éì·Éê·Éï·ÉÆ·É£·É†·Éù·Éó ·Éõ·Éù·Éì·Éê·Éö·Éò
      document.getElementById('passwordModalOverlay').remove();
      
      // ·Éí·Éê·Éú·Éï·Éê·Éê·ÉÆ·Éö·Éù·Éó settings ·Éí·Éï·Éî·É†·Éì·Éò
      closeSettingsPage();
      setTimeout(() => showSettingsPage(), 300);
      
    } catch (error) {
      console.error('Error changing password:', error);
      newPassError.textContent = '·É®·Éî·É™·Éì·Éù·Éõ·Éê ·Éû·Éê·É†·Éù·Éö·Éò·É° ·É®·Éî·É™·Éï·Éö·Éò·É°·Éê·É°';
      newPassError.style.display = 'block';
    }
  });
  
  cancelBtn.addEventListener('click', function() {
    document.getElementById('passwordModalOverlay').remove();
  });
  
  modalOverlay.addEventListener('click', function(e) {
    if (e.target === modalOverlay) {
      modalOverlay.remove();
    }
  });
}

function renderMistakesList() {
  if (!currentUser || !currentTestType) {
    return '<div style="text-align:center; padding:20px; color:var(--muted);">·Éê·Éò·É†·É©·Éò·Éî·Éó ·Éõ·Éù·Éì·É£·Éö·Éò ·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò·É° ·É°·Éê·Éú·Éê·ÉÆ·Éê·Éï·Éê·Éì</div>';
  }
  
  const wrongQuestionIds = userProgress[currentTestType]?.wrongQuestions || [];
  
  // ·Éõ·Éù·Éì·É£·Éö·Éî·Éë·Éò·É° ·É•·Éê·É†·Éó·É£·Éö·Éò ·É°·Éê·ÉÆ·Éî·Éö·Éî·Éë·Éò
  const moduleNames = {
    // ·É†·Éî·Éñ·Éò·Éì·Éî·Éú·É¢·É£·É†·Éê
    'samkurnaloo': '·É°·Éê·Éõ·Éô·É£·É†·Éú·Éê·Éö·Éù',
    'stomatologia': '·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    
    // ·É°·Éê·Éö·Éò·É™·Éî·Éú·Éñ·Éò·Éù
    'alergologia': '·Éê·Éö·Éî·É†·Éí·Éù·Éö·Éù·Éí·Éò·Éê',
    'angiokirurgia': '·Éê·Éú·Éí·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'anesteziologia': '·Éê·Éú·Éî·É°·Éó·Éî·Éñ·Éò·Éù·Éö·Éù·Éí·Éò·Éê, ·É†·Éî·Éê·Éú·Éò·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_gadaudebeli': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò',
    'bavshvta_kardiorevmatologia': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éô·Éê·É†·Éì·Éò·Éù·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_nevrologia': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_nevrologia2': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'gadaudebeli_medicina': '·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'gastroenterologia': '·Éí·Éê·É°·É¢·É†·Éù·Éî·Éú·É¢·Éî·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'ginekologia': '·Éí·Éò·Éú·Éî·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'dermatologia': '·Éì·Éî·É†·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'endokrinologia': '·Éî·Éú·Éì·Éù·Éô·É†·Éò·Éú·Éù·Éö·Éù·Éí·Éò·Éê',
    'zogadi_kirurgia': '·Éñ·Éù·Éí·Éê·Éì·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'terapiuli_stomatologia': '·Éó·Éî·É†·Éê·Éû·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'infekciuri': '·Éò·Éú·É§·Éî·É•·É™·Éò·É£·É†·Éò',
    'kardiologia': '·Éô·Éê·É†·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê',
    'kardiokirurgia': '·Éô·Éê·É†·Éì·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'laboratoriuli_medicina': '·Éö·Éê·Éë·Éù·É†·Éê·É¢·Éù·É†·Éò·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'narkologia': '·Éú·Éê·É†·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'nevrologia': '·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'neonatologia': '·Éú·Éî·Éù·Éú·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'nefrologia': '·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'onkologia': '·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'ortodontia': '·Éù·É†·Éó·Éù·Éì·Éù·Éú·É¢·Éò·Éê',
    'ortopedia_travmatologia': '·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·Éê ·É¢·É†·Éê·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'ortopediuli_stomatologia': '·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'otorinolaringologia': '·Éù·É¢·Éù·É†·Éò·Éú·Éù·Éö·Éê·É†·Éò·Éú·Éí·Éù·Éö·Éù·Éí·Éò·Éê',
    'oftalmologia': '·Éù·É§·Éó·Éê·Éö·Éõ·Éù·Éö·Éù·Éí·Éò·Éê',
    'patologia': '·Éû·Éê·Éó·Éù·Éö·Éù·Éí·Éò·Éê',
    'pediatria': '·Éû·Éî·Éì·Éò·Éê·É¢·É†·Éò·Éê',
    'plastikuri_kirurgia': '·Éû·Éö·Éê·É°·É¢·Éò·Éô·É£·É†·Éò ·Éì·Éê ·É†·Éî·Éô·Éù·Éú·É°·É¢·É†·É£·É•·É™·Éò·É£·Éö·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'radiologia': '·É†·Éê·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê',
    'radiacioni_onkologia': '·É†·Éê·Éì·Éò·Éê·É™·Éò·É£·Éö·Éò ·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'reproduqtologia': '·É†·Éî·Éû·É†·Éù·Éì·É£·É•·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'revmatologia': '·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'saokjao_medicina': '·É°·Éê·Éù·ÉØ·Éê·ÉÆ·Éù ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'sportuli_medicina': '·É°·Éû·Éù·É†·É¢·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'toksikologia': '·É¢·Éù·É•·É°·Éò·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'urologia': '·É£·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'ftiziatria_pulmonologia': '·É§·Éó·Éò·Éñ·Éò·Éê·É¢·É†·Éò·Éê, ·Éû·É£·Éö·Éõ·Éù·Éú·Éù·Éö·Éù·Éí·Éò·Éê',
    'psikiatria': '·É§·É°·Éò·É•·Éò·Éê·É¢·É†·Éò·Éê',
    'qba_saxis_kirurgia': '·Éß·Éë·Éê-·É°·Éê·ÉÆ·Éò·É° ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'shinagani_medicina': '·É®·Éò·Éú·Éê·Éí·Éê·Éú·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'hematologia': '·É∞·Éî·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê'
  };
  
  const moduleDisplayName = moduleNames[currentTestType] || currentTestType;
  
  if (wrongQuestionIds.length === 0) {
    return `<div style="text-align:center; padding:20px; color:var(--muted);">·Éõ·Éù·Éì·É£·Éö·É®·Éò "${moduleDisplayName}" ·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò ·ÉØ·Éî·É† ·Éê·É† ·Éê·É†·Éò·É°!</div>`;
  }
  
  let html = `<div style="margin-bottom: 15px; padding: 10px; background: #f1f5f9; border-radius: 6px; text-align: center; font-weight: 600; color: var(--accent);">·Éõ·Éù·Éì·É£·Éö·Éò: ${moduleDisplayName}</div>`;
  
  wrongQuestionIds.forEach((questionId, index) => {
    const question = allTestsWithTopics[parseInt(questionId)];
    if (!question) return;
    
    const userAnswerData = userProgress[currentTestType]?.normal?.answeredQuestions[questionId] ||
                          userProgress[currentTestType]?.exam?.answeredQuestions[questionId];
    
    const userAnswerIndex = userAnswerData?.selectedAnswer;
    const userAnswerText = userAnswerIndex !== undefined ? 
      question.answers[userAnswerIndex]?.text : '·Éê·É† ·Éê·É†·Éò·É° ·É™·Éú·Éù·Éë·Éò·Éö·Éò';
    
    const correctAnswer = question.answers.find(a => a.correct);
    const correctAnswerText = correctAnswer?.text || '·Éê·É† ·Éê·É†·Éò·É° ·É™·Éú·Éù·Éë·Éò·Éö·Éò';
    
    html += `
      <div class="mistake-item">
        <div class="mistake-question">${escapeHtml(question.question)}</div>
        <div class="mistake-answers">
          <div class="mistake-user-answer">
            <strong>·Éó·É•·Éï·Éî·Éú·Éò ·Éû·Éê·É°·É£·ÉÆ·Éò:</strong> ${escapeHtml(userAnswerText || '·Éê·É†·Éê·Éê ·Éê·É†·É©·Éî·É£·Éö·Éò')}
          </div>
          <div class="mistake-correct-answer">
            <strong>·É°·É¨·Éù·É†·Éò ·Éû·Éê·É°·É£·ÉÆ·Éò:</strong> ${escapeHtml(correctAnswerText)}
          </div>
        </div>
      </div>
    `;
  });
  
  return html;
}

function printMistakes() {
  if (!currentUser || !currentTestType) {
    showNotification('·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò ·Éê·É† ·Éê·É†·Éò·É°');
    return;
  }
  
  const wrongQuestionIds = userProgress[currentTestType]?.wrongQuestions || [];
  
  if (wrongQuestionIds.length === 0) {
    showNotification('·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò ·Éê·É† ·Éê·É†·Éò·É°');
    return;
  }
  
  // ·Éõ·Éù·Éì·É£·Éö·Éî·Éë·Éò·É° ·É•·Éê·É†·Éó·É£·Éö·Éò ·É°·Éê·ÉÆ·Éî·Éö·Éî·Éë·Éò
  const moduleNames = {
    // ·É†·Éî·Éñ·Éò·Éì·Éî·Éú·É¢·É£·É†·Éê
    'samkurnaloo': '·É°·Éê·Éõ·Éô·É£·É†·Éú·Éê·Éö·Éù',
    'stomatologia': '·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    
    // ·É°·Éê·Éö·Éò·É™·Éî·Éú·Éñ·Éò·Éù
    'alergologia': '·Éê·Éö·Éî·É†·Éí·Éù·Éö·Éù·Éí·Éò·Éê',
    'angiokirurgia': '·Éê·Éú·Éí·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'anesteziologia': '·Éê·Éú·Éî·É°·Éó·Éî·Éñ·Éò·Éù·Éö·Éù·Éí·Éò·Éê, ·É†·Éî·Éê·Éú·Éò·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_gadaudebeli': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò',
    'bavshvta_kardiorevmatologia': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éô·Éê·É†·Éì·Éò·Éù·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_nevrologia': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_nevrologia2': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'gadaudebeli_medicina': '·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'gastroenterologia': '·Éí·Éê·É°·É¢·É†·Éù·Éî·Éú·É¢·Éî·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'ginekologia': '·Éí·Éò·Éú·Éî·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'dermatologia': '·Éì·Éî·É†·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'endokrinologia': '·Éî·Éú·Éì·Éù·Éô·É†·Éò·Éú·Éù·Éö·Éù·Éí·Éò·Éê',
    'zogadi_kirurgia': '·Éñ·Éù·Éí·Éê·Éì·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'terapiuli_stomatologia': '·Éó·Éî·É†·Éê·Éû·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'infekciuri': '·Éò·Éú·É§·Éî·É•·É™·Éò·É£·É†·Éò',
    'kardiologia': '·Éô·Éê·É†·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê',
    'kardiokirurgia': '·Éô·Éê·É†·Éì·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'laboratoriuli_medicina': '·Éö·Éê·Éë·Éù·É†·Éê·É¢·Éù·É†·Éò·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'narkologia': '·Éú·Éê·É†·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'nevrologia': '·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'neonatologia': '·Éú·Éî·Éù·Éú·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'nefrologia': '·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'onkologia': '·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'ortodontia': '·Éù·É†·Éó·Éù·Éì·Éù·Éú·É¢·Éò·Éê',
    'ortopedia_travmatologia': '·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·Éê ·É¢·É†·Éê·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'ortopediuli_stomatologia': '·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'otorinolaringologia': '·Éù·É¢·Éù·É†·Éò·Éú·Éù·Éö·Éê·É†·Éò·Éú·Éí·Éù·Éö·Éù·Éí·Éò·Éê',
    'oftalmologia': '·Éù·É§·Éó·Éê·Éö·Éõ·Éù·Éö·Éù·Éí·Éò·Éê',
    'patologia': '·Éû·Éê·Éó·Éù·Éö·Éù·Éí·Éò·Éê',
    'pediatria': '·Éû·Éî·Éì·Éò·Éê·É¢·É†·Éò·Éê',
    'plastikuri_kirurgia': '·Éû·Éö·Éê·É°·É¢·Éò·Éô·É£·É†·Éò ·Éì·Éê ·É†·Éî·Éô·Éù·Éú·É°·É¢·É†·É£·É•·É™·Éò·É£·Éö·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'radiologia': '·É†·Éê·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê',
    'radiacioni_onkologia': '·É†·Éê·Éì·Éò·Éê·É™·Éò·É£·Éö·Éò ·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'reproduqtologia': '·É†·Éî·Éû·É†·Éù·Éì·É£·É•·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'revmatologia': '·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'saokjao_medicina': '·É°·Éê·Éù·ÉØ·Éê·ÉÆ·Éù ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'sportuli_medicina': '·É°·Éû·Éù·É†·É¢·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'toksikologia': '·É¢·Éù·É•·É°·Éò·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'urologia': '·É£·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'ftiziatria_pulmonologia': '·É§·Éó·Éò·Éñ·Éò·Éê·É¢·É†·Éò·Éê, ·Éû·É£·Éö·Éõ·Éù·Éú·Éù·Éö·Éù·Éí·Éò·Éê',
    'psikiatria': '·É§·É°·Éò·É•·Éò·Éê·É¢·É†·Éò·Éê',
    'qba_saxis_kirurgia': '·Éß·Éë·Éê-·É°·Éê·ÉÆ·Éò·É° ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'shinagani_medicina': '·É®·Éò·Éú·Éê·Éí·Éê·Éú·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'hematologia': '·É∞·Éî·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê'
  };
  
  const moduleDisplayName = moduleNames[currentTestType] || currentTestType;
  
  let printContent = `
    <html>
    <head>
      <title>·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò·É° ·Éò·É°·É¢·Éù·É†·Éò·Éê - ${currentUser.username}</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 1cm; }
        h1 { color: #0ea5a4; text-align: left; }
        .module-name { color: #0891b2; font-size: 18px; margin: 10px 0; }
        .mistake { 
          margin-bottom: 30px; 
          padding: 20px; 
          border-left: 4px solid #dc2626;
          background: #f8fafc;
          border-radius: 8px;
        }
        .question { font-size: 16px; font-weight: 600; color: #1e293b; margin-bottom: 10px; }
        .user-answer { color: #dc2626; margin-bottom: 5px; }
        .correct-answer { color: #16a34a; }
        hr { margin: 20px 0; border: 1px solid #e2e8f0; }
        .date { color: #64748b; font-size: 12px; text-align: right; }
      </style>
    </head>
    <body>
      <h1>·É®·Éî·É™·Éì·Éù·Éõ·Éî·Éë·Éò·É° ·Éò·É°·É¢·Éù·É†·Éò·Éê</h1>
      <p style="text-align: left; color: #64748b;">·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò: ${escapeHtml(currentUser.username)}</p>
      <p style="text-align: left; color: #64748b;">·Éó·Éê·É†·Éò·É¶·Éò: ${new Date().toLocaleDateString('ka-GE')}</p>
      <div class="module-name">·Éõ·Éù·Éì·É£·Éö·Éò: ${moduleDisplayName}</div>
      <hr>
  `;
  
  wrongQuestionIds.forEach((questionId, index) => {
    const question = allTestsWithTopics[parseInt(questionId)];
    if (!question) return;
    
    const userAnswerData = userProgress[currentTestType]?.normal?.answeredQuestions[questionId] ||
                          userProgress[currentTestType]?.exam?.answeredQuestions[questionId];
    
    const userAnswerIndex = userAnswerData?.selectedAnswer;
    const userAnswerText = userAnswerIndex !== undefined ? 
      question.answers[userAnswerIndex]?.text : '·Éê·É† ·Éê·É†·Éò·É° ·É™·Éú·Éù·Éë·Éò·Éö·Éò';
    
    const correctAnswer = question.answers.find(a => a.correct);
    const correctAnswerText = correctAnswer?.text || '·Éê·É† ·Éê·É†·Éò·É° ·É™·Éú·Éù·Éë·Éò·Éö·Éò';
    
    printContent += `
      <div class="mistake">
        <div class="question">${index + 1}. ${escapeHtml(question.question)}</div>
        <div class="user-answer"><strong>·Éó·É•·Éï·Éî·Éú·Éò ·Éû·Éê·É°·É£·ÉÆ·Éò:</strong> ${escapeHtml(userAnswerText)}</div>
        <div class="correct-answer"><strong>·É°·É¨·Éù·É†·Éò ·Éû·Éê·É°·É£·ÉÆ·Éò:</strong> ${escapeHtml(correctAnswerText)}</div>
        <div class="date">${new Date(userAnswerData?.timestamp || Date.now()).toLocaleString('ka-GE')}</div>
      </div>
    `;
  });
  
  printContent += `</body></html>`;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}

function closeSettingsPage() {
  const settingsPage = document.getElementById('settingsPage');
  if (settingsPage) {
    settingsPage.remove();
  }
}

function bindUserMenuEvents() {
  const usernameBtn = document.getElementById('usernameBtn');
  const userDropdown = document.getElementById('userDropdown');
  
  if (usernameBtn) {
    usernameBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      userDropdown.classList.toggle('show');
    });
    
    document.addEventListener('click', () => {
      userDropdown.classList.remove('show');
    });
  }
  
  document.getElementById('wrongQuestionsBtn').addEventListener('click', () => {
    startWrongQuestionsMode();
    userDropdown.classList.remove('show');
  });
  
  document.getElementById('settingsBtn').addEventListener('click', () => {
    showSettingsPage();
    userDropdown.classList.remove('show');
  });
  
  document.getElementById('signOutBtn').addEventListener('click', () => {
    saveUserProgress();
    currentUser = null;
    location.reload();
  });
}

function checkAllQuestionsAnswered() {
  if (!examMode) return false;
  
  const allAnswered = sessionTests.every(q => 
    q.selectedAnswers && q.selectedAnswers.length > 0
  );
  
  const examFinishBtn = document.getElementById('examFinishBtn');
  
  if (examFinishBtn) {
    if (allAnswered) {
      examFinishBtn.style.display = 'flex';
    } else {
      examFinishBtn.style.display = 'flex';
    }
  }
  
  if (examTestBoxes) {
    const testBoxes = examTestBoxes.querySelectorAll('.test-box');
    testBoxes.forEach((box, index) => {
      if (sessionTests[index] && sessionTests[index].selectedAnswers && sessionTests[index].selectedAnswers.length > 0) {
        box.classList.add('answered');
      } else {
        box.classList.remove('answered');
      }
    });
  }
  
  return allAnswered;
}

function completeExam() {
  clearInterval(examTimerInterval);
  
  timerElement.classList.add('hidden');
  
  const correctCount = sessionTests.filter(q => 
    q.selectedAnswers && q.selectedAnswers.some(idx => q.answers[idx]?.correct)
  ).length;
  
  const passed = correctCount >= 150;
  
  examRightPanel.classList.add('hidden');
  
  const resultsHTML = `
    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8fafc; padding: 20px;">
      <div style="max-width: 800px; width: 100%; background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); overflow: hidden;">
        <div style="padding: 30px; border-bottom: 1px solid #e2e8f0;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
            <div style="text-align: center; padding: 20px; background: #f0fdf4; border-radius: 8px;">
              <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">·É°·É¨·Éù·É†·Éò ·Éû·Éê·É°·É£·ÉÆ·Éî·Éë·Éò</div>
              <div style="font-size: 42px; font-weight: 700; color: var(--success);">${correctCount}</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px;">
              <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">·Éê·É†·Éê·É°·É¨·Éù·É†·Éò ·Éû·Éê·É°·É£·ÉÆ·Éî·Éë·Éò</div>
              <div style="font-size: 42px; font-weight: 700; color: var(--danger);">${200 - correctCount}</div>
            </div>
          </div>
          
          <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
            <div style="font-size: 16px; color: #64748b; margin-bottom: 5px;">·É®·Éî·É§·Éê·É°·Éî·Éë·Éê</div>
            <div style="font-size: 28px; font-weight: 700; color: ${passed ? 'var(--success)' : 'var(--danger)'}">
              ${passed ? '·Éí·Éê·Éõ·Éù·É™·Éì·Éê ·É©·Éê·Éë·Éê·É†·Éî·Éë·É£·Éö·Éò·Éê' : '·É©·Éê·É≠·É†·Éò·Éö·Éò·Éê!'}
            </div>
            <div style="font-size: 18px; margin-top: 10px;">
              ${passed ? '·Éí·Éò·Éö·Éù·É™·Éê·Éï·Éó! ·Éó·É•·Éï·Éî·Éú ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É©·Éê·Éê·Éë·Éê·É†·Éî·Éó ·Éí·Éê·Éõ·Éù·É™·Éì·Éê!' : '·É°·Éê·Éõ·É¨·É£·ÉÆ·Éê·É†·Éù·Éì, ·Éó·É•·Éï·Éî·Éú ·Éï·Éî·É† ·É©·Éê·Éê·Éë·Éê·É†·Éî·Éó ·Éí·Éê·Éõ·Éù·É™·Éì·Éê. ·É°·É™·Éê·Éì·Éî·Éó ·Éô·Éò·Éì·Éî·Éï.'}
            </div>
          </div>
        </div>
        
        <div style="padding: 30px;">
          <div style="font-size: 20px; font-weight: 600; color: #1e293b; margin-bottom: 20px; text-align: center;">
            ·É®·Éî·Éì·Éî·Éí·Éî·Éë·Éò·É° ·Éò·É°·É¢·Éù·É†·Éò·Éê
          </div>
          <div id="resultsHistoryContainer" style="max-height: 300px; overflow-y: auto; padding: 10px;">
          </div>
        </div>
        
        <div style="padding: 30px; background: #f8fafc; display: flex; gap: 15px; justify-content: center; border-top: 1px solid #e2e8f0;">
          <button id="viewDetailsBtn" style="padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
            ·Éì·Éî·É¢·Éê·Éö·É£·É†·Éê·Éì ·Éú·Éê·ÉÆ·Éï·Éê
          </button>
          <button id="restartBtn" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
            ·Éó·Éê·Éï·Éò·Éì·Éê·Éú ·Éì·Éê·É¨·Éß·Éî·Éë·Éê
          </button>
        </div>
      </div>
    </div>
  `;
  
  testScreen.innerHTML = resultsHTML;
  
  const historyContainer = document.getElementById('resultsHistoryContainer');
  if (historyContainer) {
    sessionTests.forEach((question, index) => {
      const selectedAnswerIndex = question.selectedAnswers ? question.selectedAnswers[0] : -1;
      const isCorrect = selectedAnswerIndex !== -1 && question.answers[selectedAnswerIndex]?.correct;
      const selectedAnswer = selectedAnswerIndex !== -1 ? question.answers[selectedAnswerIndex].text : '·Éê·É†·Éê·Éê ·Éê·É†·É©·Éî·É£·Éö·Éò';
      const correctAnswer = question.answers.find(a => a.correct)?.text || '·Éê·É† ·Éê·É†·Éò·É° ·É™·Éú·Éù·Éë·Éò·Éö·Éò';
      
      const resultItem = document.createElement('div');
      resultItem.style.cssText = 'padding: 12px; margin-bottom: 8px; background: white; border-radius: 6px; border-left: 4px solid ' + (isCorrect ? 'var(--success)' : 'var(--danger)') + ';';
      resultItem.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">
          ${index + 1}. ${escapeHtml(question.question.substring(0, 80))}${question.question.length > 80 ? '...' : ''}
        </div>
        <div style="font-size: 13px; color: ${isCorrect ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 2px;">
          <strong>·Éó·É•·Éï·Éî·Éú·Éò ·Éû·Éê·É°·É£·ÉÆ·Éò:</strong> ${escapeHtml(selectedAnswer)}
        </div>
        ${!isCorrect ? `<div style="font-size: 13px; color: var(--success);"><strong>·É°·É¨·Éù·É†·Éò ·Éû·Éê·É°·É£·ÉÆ·Éò:</strong> ${escapeHtml(correctAnswer)}</div>` : ''}
      `;
      historyContainer.appendChild(resultItem);
    });
  }
  
  setTimeout(() => {
    const restartBtn = document.getElementById('restartBtn');
    if (restartBtn) {
      restartBtn.addEventListener('click', () => {
        location.reload();
      });
    }
    
    const viewDetailsBtn = document.getElementById('viewDetailsBtn');
    if (viewDetailsBtn) {
      viewDetailsBtn.addEventListener('click', showDetailedResults);
    }
  }, 100);
}

function showDetailedResults() {
  detailedResultsContent.innerHTML = '';
  
  const table = document.createElement('table');
  table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 14px;';
  
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr style="background: #f1f5f9;">
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">#</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">·Éô·Éò·Éó·ÉÆ·Éï·Éê</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">·Éó·É•·Éï·Éî·Éú·Éò ·Éû·Éê·É°·É£·ÉÆ·Éò</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">·É°·É¨·Éù·É†·Éò ·Éû·Éê·É°·É£·ÉÆ·Éò</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">·É°·É¢·Éê·É¢·É£·É°·Éò</th>
    </tr>
  `;
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  sessionTests.forEach((question, index) => {
    const selectedAnswerIndex = question.selectedAnswers ? question.selectedAnswers[0] : -1;
    const isCorrect = selectedAnswerIndex !== -1 && question.answers[selectedAnswerIndex]?.correct;
    const selectedAnswer = selectedAnswerIndex !== -1 ? question.answers[selectedAnswerIndex].text : '·Éê·É†·Éê·Éê ·Éê·É†·É©·Éî·É£·Éö·Éò';
    const correctAnswer = question.answers.find(a => a.correct)?.text || '·Éê·É† ·Éê·É†·Éò·É° ·É™·Éú·Éù·Éë·Éò·Éö·Éò';
    
    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid #e2e8f0';
    row.innerHTML = `
      <td style="padding: 12px; font-weight: 600;">${index + 1}</td>
      <td style="padding: 12px;">${escapeHtml(question.question.substring(0, 100))}${question.question.length > 100 ? '...' : ''}</td>
      <td style="padding: 12px; color: ${isCorrect ? 'var(--success)' : 'var(--danger)'};">${escapeHtml(selectedAnswer)}</td>
      <td style="padding: 12px; color: var(--success);">${escapeHtml(correctAnswer)}</td>
      <td style="padding: 12px;">
        <span style="padding: 4px 8px; border-radius: 4px; font-weight: 600; background: ${isCorrect ? '#d1fae5' : '#fee2e2'}; color: ${isCorrect ? '#065f46' : '#991b1b'}">
          ${isCorrect ? '·É°·É¨·Éù·É†·Éò' : '·Éê·É†·Éê·É°·É¨·Éù·É†·Éò'}
        </span>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  table.appendChild(tbody);
  detailedResultsContent.appendChild(table);
  
  detailedResultsModal.classList.add('active');
}

function loadCSV() {
  loaderOverlay.style.display = 'flex';
  resetLoader();
  startBtn.disabled = true;
  
// ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî ·Éê·É†·É©·Éî·É£·Éö·Éò ·Éõ·Éù·Éì·É£·Éö·Éò checkbox-·Éî·Éë·Éò·Éì·Éê·Éú
const testType = getSelectedModule();
console.log("Loading CSV for module:", testType);

if (!testType) {
    console.error("No module selected");
    loaderOverlay.style.display = 'none';
    // showNotification ·Éê·É¶·Éê·É† ·Éí·Éï·Éò·Éú·Éì·Éê
    return;
}
  // CSV URLs ·Éß·Éï·Éî·Éö·Éê ·Éõ·Éù·Éì·É£·Éö·Éò·É°·Éó·Éï·Éò·É°
  const csvUrls = {
    // ·É†·Éî·Éñ·Éò·Éì·Éî·Éú·É¢·É£·É†·Éê
    'samkurnaloo': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=69945858&single=true&output=csv",
    'stomatologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=924975691&single=true&output=csv",
    
    // ·É°·Éê·Éö·Éò·É™·Éî·Éú·Éñ·Éò·Éù
    'alergologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1370781418&single=true&output=csv",
    'angiokirurgia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1996746758&single=true&output=csv",
    'anesteziologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=861241916&single=true&output=csv",
    'bavshvta_gadaudebeli': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=108478359&single=true&output=csv",
    'bavshvta_kardiorevmatologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=2015525913&single=true&output=csv",
    'bavshvta_nevrologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=108478359&single=true&output=csv",
    'bavshvta_nevrologia2': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=669175344&single=true&output=csv",
    'gadaudebeli_medicina': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1907712211&single=true&output=csv",
    'gastroenterologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1983098788&single=true&output=csv",
    'ginekologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1009171808&single=true&output=csv",
    'dermatologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1641023942&single=true&output=csv",
    'endokrinologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1076965777&single=true&output=csv",
    'zogadi_kirurgia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=765535552&single=true&output=csv",
    'terapiuli_stomatologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=421914421&single=true&output=csv",
    'infekciuri': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1837962766&single=true&output=csv",
    'kardiologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1823056502&single=true&output=csv",
    'kardiokirurgia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1835998784&single=true&output=csv",
    'laboratoriuli_medicina': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1614838160&single=true&output=csv",
    'narkologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1085000299&single=true&output=csv",
    'nevrologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=521902978&single=true&output=csv",
    'neonatologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=768579763&single=true&output=csv",
    'nefrologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=18090167&single=true&output=csv",
    'onkologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=879954523&single=true&output=csv",
    'ortodontia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1764512833&single=true&output=csv",
    'ortopedia_travmatologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=576676097&single=true&output=csv",
    'ortopediuli_stomatologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=154460441&single=true&output=csv",
    'otorinolaringologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1286843055&single=true&output=csv",
    'oftalmologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=374722105&single=true&output=csv",
    'patologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=150316971&single=true&output=csv",
    'pediatria': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1241882727&single=true&output=csv",
    'plastikuri_kirurgia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=958598668&single=true&output=csv",
    'radiologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1015478615&single=true&output=csv",
    'radiacioni_onkologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1716708597&single=true&output=csv",
    'reproduqtologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=2085134460&single=true&output=csv",
    'revmatologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1067720088&single=true&output=csv",
    'saokjao_medicina': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=2120691036&single=true&output=csv",
    'sportuli_medicina': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=576506020&single=true&output=csv",
    'toksikologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=515001960&single=true&output=csv",
    'urologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=954557732&single=true&output=csv",
    'ftiziatria_pulmonologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=1877716705&single=true&output=csv",
    'psikiatria': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=301196875&single=true&output=csv",
    'qba_saxis_kirurgia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=300768210&single=true&output=csv",
    'shinagani_medicina': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=779421848&single=true&output=csv",
    'hematologia': "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=66052853&single=true&output=csv"
  };
  
  let csvUrl = csvUrls[testType];
  
  // ·Éó·É£ ·Éõ·Éù·Éì·É£·Éö·Éò ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê, ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî ·É°·Éê·Éõ·Éô·É£·É†·Éú·Éê·Éö·Éù ·É†·Éù·Éí·Éù·É†·É™ default
  if (!csvUrl) {
    console.warn("Unknown test type:", testType, "using samkurnaloo as default");
    csvUrl = csvUrls['samkurnaloo'];
  }
  
  fetch(csvUrl).then(r => {
    if (!r.ok) throw new Error('Network error: ' + r.status);
    return r.text();
  }).then(txt => {
    console.log("CSV raw text length:", txt.length);
    
    const twoColRows = parseCSVTwoColumns(txt);
    console.log("Parsed rows:", twoColRows.length);
    
    allTestsWithTopics = buildTestsFromCSV(twoColRows);
    console.log("Built tests:", allTestsWithTopics.length);
    
    allTests = allTestsWithTopics;
    
    if (!allTests.length){
      showNotification('·É¢·Éî·É°·É¢·Éî·Éë·Éò ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê');
      loaderOverlay.innerHTML = '<div style="color: var(--danger); font-weight: 600; text-align: center; padding: 20px;">·É¢·Éî·É°·É¢·Éî·Éë·Éò ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê<br><small>·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éù·Éó ·Éí·Éï·Éî·É†·Éì·Éò</small></div>';
      startBtn.disabled = false;
      return;
    }
    
    totalQuestionsEl.textContent = allTests.length;
    
    extractTopics();
    console.log("Available topics:", Array.from(availableTopics));
    
    populateTopicsList();

if (currentUser && !currentUser.isGuest) {
  // ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî ·É§·Éö·Éê·Éí·Éò, ·É†·Éù·Éõ ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éî·É†·Éó·ÉÆ·Éî·Éö ·Éí·Éê·Éõ·Éù·É´·Éê·ÉÆ·Éì·Éî·É°
  if (!window._progressCheckExecuted) {
    window._progressCheckExecuted = true;
    
    // ·Éû·Éê·É¢·Éê·É†·Éê ·Éì·Éê·Éß·Éù·Éï·Éú·Éî·Éë·Éê, ·É†·Éù·Éõ ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éì·Éê·É°·É¢·Éê·Éë·Éò·Éö·É£·É†·Éì·Éî·É°
    setTimeout(() => {
      // ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éî ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·Éò·Éõ ·É®·Éî·Éõ·Éó·ÉÆ·Éï·Éî·Éï·Éê·É®·Éò ·Éó·É£ Exam Mode ·Éê·É† ·Éê·É†·Éò·É° ·É©·Éê·É†·Éó·É£·Éö·Éò
      const examModeCheckbox = document.getElementById('modeExam');
      const isExamModeChecked = examModeCheckbox && examModeCheckbox.checked;
      
      if (!isExamModeChecked) {
        console.log("Calling checkExistingProgress from loadCSV");
        checkExistingProgress();
      } else {
        console.log("Exam mode is checked - skipping progress modal");
      }
    }, 1000); // ·Éí·Éê·Éñ·Éê·É†·Éì·Éî ·Éì·Éê·Éß·Éù·Éï·Éú·Éî·Éë·Éê 800ms ‚Üí 1000ms
  }
}

    loaderOverlay.style.display = 'none';
    startBtn.disabled = false;

    if (currentUser && !currentUser.isGuest) {
      const examModeCheckbox = document.getElementById('modeExam');
      const isExamModeChecked = examModeCheckbox && examModeCheckbox.checked;
      
      if (window.pendingProgressCheck) {
        setTimeout(() => {
          if (!isExamModeChecked) {
            checkExistingProgress();
          } else {
            console.log("Exam mode is checked - skipping progress modal");
          }
          window.pendingProgressCheck = false;
        }, 500);
      } else {
        setTimeout(() => {
          if (!isExamModeChecked) {
            checkExistingProgress();
          } else {
            console.log("Exam mode is checked - skipping progress modal");
          }
        }, 500);
      }
    }
    
  }).catch(err => {
    console.error("Fetch error:", err);
    showNotification('·É®·Éî·É™·Éì·Éù·Éõ·Éê ·É§·Éê·Éò·Éö·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É°·Éê·É°: ' + err.message);
    loaderOverlay.innerHTML = `<div style="color: var(--danger); font-weight: 600; text-align: center; padding: 20px;">·É®·Éî·É™·Éì·Éù·Éõ·Éê ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É°·Éê·É°<br><small>${err.message}</small></div>`;
    startBtn.disabled = false;
  });
}

function parseCSVTwoColumns(csvText){
  if (!csvText) return [];
  
  csvText = csvText.trim();
  csvText = csvText.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  
  const rows = [];
  const lines = csvText.split('\n');
  
  for (let line of lines) {
    line = line.trim();
    if (!line) continue;
    
    let columns = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      const next = line[i + 1];
      
      if (ch === '"') {
        if (inQuotes && next === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
        continue;
      } else if (ch === ',' && !inQuotes) {
        columns.push(current.trim());
        current = '';
        continue;
      }
      current += ch;
    }
    
    columns.push(current.trim());
    
    if (columns.length === 1) {
      columns.push('');
    }
    
    rows.push({
      columnA: columns[0],
      columnB: columns[1] || ''
    });
  }
  
  return rows;
}

function buildTestsFromCSV(rawRows){
  console.log("=== BUILDING TESTS FROM 2-COLUMN CSV ===");
  
  const tests = [];
  let currentTest = null;
  let currentTopic = '·Éñ·Éù·Éí·Éê·Éì·Éò';
  
  for (let i = 0; i < rawRows.length; i++){
    const columnA = rawRows[i].columnA;
    const columnB = rawRows[i].columnB;
    
    if (!columnA && !columnB) continue;
    
    const normalizedA = normalizeLine(columnA);
    const topic = normalizeLine(columnB);
    
    if (topic && topic !== '') {
      currentTopic = topic;
    }
    
    const type = detectLineType(normalizedA);
    
    if (type === 'question'){
      if (currentTest && currentTest.answers.length > 0) {
        currentTest.topic = currentTopic;
        tests.push(currentTest);
      }
      
      currentTest = { 
        raw: normalizedA, 
        question: stripLeadingSymbol(normalizedA), 
        topic: currentTopic,
        answers: [], 
        sourceIndex: i 
      };
      
    } else if ((type === 'correct' || type === 'incorrect') && currentTest){
      const isCorrect = (type === 'correct');
      const txt = stripLeadingSymbol(normalizedA);
      if (txt.length > 0) {
        currentTest.answers.push({ 
          text: txt, 
          correct: isCorrect,
          originalText: txt
        });
      }
    }
  }
  
  if (currentTest && currentTest.answers.length > 0) {
    currentTest.topic = currentTopic;
    tests.push(currentTest);
  }
  
  console.log(`Built ${tests.length} tests from CSV`);
  
  const filteredTests = tests.filter(t => Array.isArray(t.answers) && t.answers.length > 0);
  
  const topicCounts = {};
  filteredTests.forEach(test => {
    const topic = test.topic || '·Éñ·Éù·Éí·Éê·Éì·Éò';
    topicCounts[topic] = (topicCounts[topic] || 0) + 1;
  });
  
  console.log("Topic distribution:", topicCounts);
  
  return filteredTests;
}

function normalizeLine(raw){
  if (raw == null) return '';
  let s = String(raw).normalize('NFKC');
  s = s.replace(/^\uFEFF/, '');
  s = s.replace(/[\u200B-\u200F\uFEFF]/g, '');
  s = s.replace(/^"+|"+$/g, '');
  s = s.replace(/\s+/g, ' ');
  return s.trim();
}

function detectLineType(line){
  const s = line.trim();
  if (!s) return 'unknown';
  
  if (/^¬¢/.test(s)) {
    return 'question';
  }
  
  if (/^(‚úîÔ∏è|‚úî|‚úì|‚úÖ|\+)/.test(s)) {
    return 'correct';
  }
  
  if (/^(‚ùå|‚úñÔ∏è|‚úñ|‚úï|‚úó|‚úò|-)/.test(s)) {
    return 'incorrect';
  }
  
  if (/[·Éê-·É∞]/.test(s) && /\?$/.test(s)) {
    return 'question';
  }
  
  return 'unknown';
}

function stripLeadingSymbol(str) {
  if (!str) return '';
  
  let cleaned = str.replace(/^¬¢\s*(ID=\d+\s*)?/, '').trim();
  
  cleaned = cleaned.replace(/^[‚úîÔ∏è‚úî‚úì‚úÖ+‚ùå‚úñÔ∏è‚úñ‚úï‚úó‚úò\-]\s*/, '');
  
  return cleaned;
}

function extractTopics() {
  availableTopics.clear();
  
  allTestsWithTopics.forEach(test => {
    if (test.topic && test.topic.trim() !== '') {
      availableTopics.add(test.topic.trim());
    } else {
      availableTopics.add('·Éñ·Éù·Éí·Éê·Éì·Éò');
    }
  });
}

function populateTopicsList() {
  const topicsSelect = document.getElementById('topicsSelect');
  if (!topicsSelect) return;
  
  topicsSelect.innerHTML = '<option value="all" selected>·É¢·Éî·É°·É¢·Éî·Éë·Éò ·Éó·Éî·Éõ·Éî·Éë·Éò·É° ·Éõ·Éò·ÉÆ·Éî·Éì·Éï·Éò·Éó</option>';
  
  const topicCounts = {};
  allTestsWithTopics.forEach(test => {
    const topic = test.topic && test.topic.trim() !== '' ? test.topic.trim() : '·Éñ·Éù·Éí·Éê·Éì·Éò';
    topicCounts[topic] = (topicCounts[topic] || 0) + 1;
  });
  
  const topicsInOrder = [];
  const seenTopics = new Set();
  
  allTestsWithTopics.forEach(test => {
    const topic = test.topic && test.topic.trim() !== '' ? test.topic.trim() : '·Éñ·Éù·Éí·Éê·Éì·Éò';
    if (!seenTopics.has(topic)) {
      seenTopics.add(topic);
      topicsInOrder.push(topic);
    }
  });
  
  const sortedTopics = topicsInOrder;
  
  sortedTopics.forEach(topic => {
    const count = topicCounts[topic] || 0;
    const option = document.createElement('option');
    option.value = topic;
    option.textContent = `${topic} (${count})`;
    topicsSelect.appendChild(option);
  });
  
  topicsSelect.addEventListener('change', function() {
    updateSelectedTopics();
  });
  
  toggleTopicsDropdown();
}

function updateSelectedTopics() {
  const topicsSelect = document.getElementById('topicsSelect');
  if (!topicsSelect) return;
  
  const selectedValue = topicsSelect.value;
  
  if (selectedValue === 'all') {
    selectedTopic = null;
  } else {
    selectedTopic = selectedValue;
  }
  
  const testTypeSelect = document.getElementById('testTypeSelect');
  if (testTypeSelect) {
    currentTestType = testTypeSelect.value;
  }
}

function startTest() {
  // ·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·É¨·Éê·Éõ·Éù·É¶·Éî·Éë·Éê
  const selectedModule = getSelectedModule();
  if (!selectedModule) {
    showNotification('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·Éõ·Éù·Éì·É£·Éö·Éò');
    return;
  }
  
  // ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éî currentTestType
  currentTestType = selectedModule;
  console.log("Test type set to:", currentTestType);
  
  if (!modeSequential.checked && !modeExam.checked) {
    showNotification('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·Éî·É†·Éó·Éò ·É†·Éî·Éü·Éò·Éõ·Éò ·Éõ·Éê·Éò·Éú·É™');
    return;
  }

  if (window.savedProgress && !currentTestType) {
    const testTypeSelect = document.getElementById('testTypeSelect');
    if (testTypeSelect && testTypeSelect.value) {
      currentTestType = testTypeSelect.value;
    }
  }

  console.log("startTest called with currentTestType:", currentTestType);
  console.log("examMode:", examMode);

  const progressData = window.savedProgress;

  if (modeSequential.checked && modeExam.checked) {
    showNotification('·Éî·É° ·É†·Éî·Éü·Éò·Éõ·Éî·Éë·Éò ·Éî·É†·Éó·Éê·Éì ·É®·Éî·É£·É´·Éö·Éî·Éë·Éî·Éö·Éò·Éê ·Éê·É†·É°·Éî·Éë·Éù·Éë·Éì·Éî·É°!');
    return;
  }

  if (modeSequential.checked && modeShuffleQuestions.checked) {
    showNotification('·Éî·É° ·É†·Éî·Éü·Éò·Éõ·Éî·Éë·Éò ·Éî·É†·Éó·Éê·Éì ·É®·Éî·É£·É´·Éö·Éî·Éë·Éî·Éö·Éò·Éê ·Éê·É†·É°·Éî·Éë·Éù·Éë·Éì·Éî·É°!');
    return;
  }

  const topicsSelect = document.getElementById('topicsSelect');
  if (topicsSelect) {
    const selectedValue = topicsSelect.value;
    if (!selectedValue || selectedValue === '') {
      showNotification('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·Éó·Éî·Éõ·Éê!');
      return;
    }
  }

  autoMode = false;
  isWrongQuestionsMode = false;

  examMode = modeExam.checked;

  const shuffleQuestions = modeShuffleQuestions.checked || examMode;
  const shuffleAnswers = examMode ? false : modeShuffleAnswers.checked;

  let testsToUse = allTestsWithTopics;

  if (selectedTopic && selectedTopic !== 'all') {
    testsToUse = allTestsWithTopics.filter(test => {
      const testTopic = test.topic && test.topic.trim() !== '' ? test.topic.trim() : '·Éñ·Éù·Éí·Éê·Éì·Éò';
      return testTopic === selectedTopic;
    });

    if (testsToUse.length === 0) {
      showNotification(`·Éê·É†·É©·Éî·É£·Éö ·Éó·Éî·Éõ·Éê·É° ·Éê·É† ·Éí·Éê·Éê·É©·Éú·Éò·Éê ·É¢·Éî·É°·É¢·Éî·Éë·Éò`);
      return;
    }
  }

  if (examMode) {
    const shuffledAll = [...testsToUse];
    shuffleArray(shuffledAll);

    sessionTests = shuffledAll
      .slice(0, Math.min(200, shuffledAll.length))
      .map((t) => {
        const globalIndex = allTestsWithTopics.findIndex(
          globalTest => globalTest.question === t.question
        ).toString();

        return {
          id: globalIndex,
          originalGlobalId: globalIndex,
          question: t.question,
          answers: t.answers.map(a => ({ ...a })),
          selectedAnswers: [],
          hasCorrectAnswer: false,
          isAnswerCorrect: null
        };
      });
  } else {
    sessionTests = testsToUse.map((t) => {
      const globalIndex = allTestsWithTopics.findIndex(
        globalTest => globalTest.question === t.question
      ).toString();

      return {
        id: globalIndex,
        originalGlobalId: globalIndex,
        question: t.question,
        answers: t.answers.map(a => ({ ...a })),
        selectedAnswers: [],
        hasCorrectAnswer: false,
        isAnswerCorrect: null
      };
    });
  }

  if (progressData && currentUser && !currentUser.isGuest) {
    const mode = examMode ? 'exam' : 'normal';

    console.log("Loading progress for mode:", mode);
    console.log("Progress data:", progressData[mode]);

    if (progressData[mode] && progressData[mode].answeredQuestions) {

      sessionTests.forEach(test => {
        const globalId = test.originalGlobalId;
        if (globalId && progressData[mode].answeredQuestions[globalId]) {
          const answerData = progressData[mode].answeredQuestions[globalId];
          test.selectedAnswers = [answerData.selectedAnswer];
          test.hasCorrectAnswer = answerData.isCorrect;
          test.isAnswerCorrect = answerData.isCorrect;
        }
      });

      const firstUnansweredIndex = sessionTests.findIndex(
        t => !t.selectedAnswers || t.selectedAnswers.length === 0
      );
      
      if (firstUnansweredIndex !== -1) {
        currentIndex = firstUnansweredIndex;
        console.log(`Starting from first unanswered question: ${currentIndex + 1}`);
      } else {
        currentIndex = sessionTests.length - 1;
        console.log(`All questions answered, staying at last: ${currentIndex + 1}`);
      }

      if (examMode && progressData.exam && progressData.exam.examTimeRemaining) {
        examTimeRemaining = progressData.exam.examTimeRemaining;
        lastTimerUpdate = Date.now();
      }

      showNotification(`·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É©·Éê·Éò·É¢·Éï·Éò·É†·Éó·Éê, ·Éí·É†·É´·Éî·Éö·Éì·Éî·Éë·Éê N.:${currentIndex + 1} ·Éô·Éò·Éó·ÉÆ·Éï·Éò·Éì·Éê·Éú`, false);
    }

    window.savedProgress = null;
  }

  if (shuffleQuestions && !examMode) {
    shuffleArray(sessionTests);
  }

  if (shuffleAnswers) {
    sessionTests.forEach(q => shuffleArray(q.answers));
  }

  optionsScreen.style.display = 'none';
  testScreen.classList.add('active');

  if (selectedTopic && selectedTopic !== 'all') {
    timerElement.innerHTML = `
      <span style="font-weight: 600; color: var(--accent);">
        ${currentUser ? currentUser.username : '·É°·É¢·É£·Éõ·Éê·É†·Éò'}
      </span>
      <span class="timer-separator">|</span>
      <span class="timer-time">${new Date().toLocaleTimeString('ka-GE')}</span>
      <br>
      <span class="timer-topic">·Éó·Éî·Éõ·Éê: ${selectedTopic}</span>
    `;
  }

  // Get the examCountdown element
  const examCountdown = document.getElementById('examCountdown');

  if (examMode) {
    startExamMode();
    if (examCountdown) examCountdown.style.display = 'block'; // Show in exam mode
  } else {
    normalModeContainer.classList.remove('hidden');
    examModeContainer.classList.add('hidden');
    examRightPanel.classList.add('hidden');
    
    // üî¥ FORCE HIDE COUNTDOWN IN NORMAL MODE
    if (examCountdown) examCountdown.style.display = 'none';
    
    questionCounter.classList.remove('hidden');
    currentQuestionEl.textContent = currentIndex + 1;
    totalQuestionsEl.textContent = sessionTests.length;

    timerElement.classList.remove('hidden');
  }

  renderCurrentQuestion();
}

function renderCurrentQuestion() {
  if (!sessionTests.length) return;
  
  const question = sessionTests[currentIndex];
  
  if (examMode) {
    examQuestionText.textContent = question.question;
    createExamTestBoxes();
    renderExamAnswers();
    checkAllQuestionsAnswered();
    if (examCountdown) examCountdown.style.display = 'block'; // Show in exam mode
  } else {
    questionText.textContent = question.question;
    currentQuestionEl.textContent = currentIndex + 1;
    totalQuestionsEl.textContent = sessionTests.length;
    
    // üî¥ FORCE HIDE COUNTDOWN IN NORMAL MODE
    if (examCountdown) examCountdown.style.display = 'none';
    
    if (isEditingQuestionNumber) {
      currentQuestionEl.classList.remove('editing');
      isEditingQuestionNumber = false;
    }
    
    renderNormalAnswers();
  }
}

function renderNormalAnswers() {
  const question = sessionTests[currentIndex];
  answersContainer.innerHTML = '';
  feedback.innerHTML = '';
  
  if (question.answers && question.answers.length > 0) {
    question.answers.forEach((answer, idx) => {
      const answerEl = document.createElement('div');
      answerEl.className = 'answer-item';
      
      const wasSelected = question.selectedAnswers && question.selectedAnswers.includes(idx);
      
      if (wasSelected) {
        answerEl.classList.add('selected');
        if (answer.correct) {
          answerEl.classList.add('correct');
        } else {
          answerEl.classList.add('incorrect');
        }
      }
      
      answerEl.innerHTML = `
        <span class="answer-number">${idx + 1}.</span>
        <span class="answer-text">${escapeHtml(answer.text)}</span>
      `;
      
      answerEl.addEventListener('click', () => {
        if (wasSelected) return;
        
        if (!question.selectedAnswers) {
          question.selectedAnswers = [];
        }
        
        question.selectedAnswers.push(idx);
        
        answerEl.classList.add('selected');
        
        if (answer.correct) {
          answerEl.classList.add('correct');
          if (!question.hasCorrectAnswer) {
            question.hasCorrectAnswer = true;
          }

          updateUserProgress(question.id, idx, true, false);
          
          if (autoMode && currentIndex < sessionTests.length - 1) {
            setTimeout(() => {
              currentIndex++;
              autoSaveProgress();
              renderCurrentQuestion();
            }, 500);
          }
          
        } else {
          answerEl.classList.add('incorrect');

          updateUserProgress(question.id, idx, false, false);
        }
        
        autoSaveProgress();
        renderCurrentQuestion();
      });
      
      answersContainer.appendChild(answerEl);
    });
  } else {
    answersContainer.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">·Éû·Éê·É°·É£·ÉÆ·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê</div>';
  }
  
  if (prevBtn && nextBtn) {
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex === sessionTests.length - 1;
  }
  
  updateAutoButton();
}

function handleWrongQuestionsCompletion() {
  const wrongQuestions = getWrongQuestions();
  
  if (wrongQuestions.length === 0 && sessionTests.length > 0) {
    const allCorrectInSession = sessionTests.every(q => 
      q.hasCorrectAnswer === true
    );
    
    if (allCorrectInSession) {
      showWrongQuestionsExhaustedModal();
    }
  }
}

function renderExamAnswers() {
  const question = sessionTests[currentIndex];
  examAnswersContainer.innerHTML = '';
  examFeedback.innerHTML = '';
  
  if (question.answers && question.answers.length > 0) {
    question.answers.forEach((answer, idx) => {
      const answerEl = document.createElement('div');
      answerEl.className = 'exam-answer-item';
      
      const wasSelected = question.selectedAnswers && question.selectedAnswers.includes(idx);
      
      if (wasSelected) {
        answerEl.classList.add('selected');
      }
      
      answerEl.innerHTML = `
        <span class="exam-answer-number">${idx + 1}.</span>
        <span class="answer-text">${escapeHtml(answer.text)}</span>
      `;
      
      answerEl.addEventListener('click', () => {
        if (wasSelected) return;
        
        if (!question.selectedAnswers) {
          question.selectedAnswers = [];
        }
        
        question.selectedAnswers = [idx];
        
        question.isAnswerCorrect = answer.correct;
        
        answerEl.classList.add('selected');
        examFeedback.innerHTML = '';
        
        createExamTestBoxes();
        
        updateUserProgress(question.id, idx, answer.correct, true);
        
        onAnswerSelected();
        autoSaveProgress();
        renderCurrentQuestion();
      });
      
      examAnswersContainer.appendChild(answerEl);
    });
  } else {
    examAnswersContainer.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">·Éû·Éê·É°·É£·ÉÆ·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê</div>';
  }
  
  if (examPrevBtn && examNextBtn) {
    examPrevBtn.disabled = currentIndex === 0;
    examNextBtn.disabled = currentIndex === sessionTests.length - 1;
  }
  
  updateExamAutoButton();
}

function onAnswerSelected() {
  checkAllQuestionsAnswered();
}

function autoSaveProgress() {
  if (!currentUser || currentUser.isGuest || !currentTestType) return;
  
  const mode = examMode ? 'exam' : 'normal';
  
  if (!userProgress[currentTestType]) {
    userProgress[currentTestType] = {
      normal: { answeredQuestions: {}, currentIndex: 0 },
      exam: { answeredQuestions: {}, currentIndex: 0 },
      wrongQuestions: []
    };
  }
  
  if (!userProgress[currentTestType][mode]) {
    userProgress[currentTestType][mode] = { answeredQuestions: {}, currentIndex: 0 };
  }
  
  userProgress[currentTestType][mode].currentIndex = currentIndex;
  
  if (examMode) {
    userProgress[currentTestType].exam.examTimeRemaining = examTimeRemaining;
  }
  
  saveUserProgress();
  
  console.log(`Progress saved: mode=${mode}, currentIndex=${currentIndex}`);
}

function findFirstUnansweredQuestion(tests) {
  for (let i = 0; i < tests.length; i++) {
    if (!tests[i].selectedAnswers || tests[i].selectedAnswers.length === 0) {
      return i;
    }
  }
  return 0;
}

function updateAutoButton() {
  if (!autoBtn || !nextBtn) return;
  
  if (autoMode) {
    nextBtn.classList.add('vanish-effect');
    autoBtn.textContent = '·Éí·Éê·Éõ·Éù·É†·Éó·Éî Auto';
  } else {
    nextBtn.classList.remove('vanish-effect');
    autoBtn.textContent = 'Auto';
  }
}

function updateExamAutoButton() {
  if (!examAutoBtn || !examNextBtn) return;
  
  if (autoMode) {
    examNextBtn.classList.add('vanish-effect');
    examAutoBtn.textContent = '·Éí·Éê·Éõ·Éù·É†·Éó·Éî Auto';
  } else {
    examNextBtn.classList.remove('vanish-effect');
    examAutoBtn.textContent = 'Auto';
  }
}

function bindNavigationEvents() {
  prevBtn = document.getElementById('prevBtn');
  nextBtn = document.getElementById('nextBtn');
  autoBtn = document.getElementById('autoBtn');
  
  examPrevBtn = document.getElementById('examPrevBtn');
  examNextBtn = document.getElementById('examNextBtn');
  examAutoBtn = document.getElementById('examAutoBtn');
  examFinishBtn = document.getElementById('examFinishBtn');
  
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        autoSaveProgress();
        renderCurrentQuestion();
      }
    });
  }
  
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      if (currentIndex < sessionTests.length - 1) {
        currentIndex++;
        autoSaveProgress();
        renderCurrentQuestion();
      } else if (examMode) {
        completeExam();
      } else {
        showCompletionScreen();
      }
    });
  }
  
  if (autoBtn) {
    autoBtn.addEventListener('click', () => {
      autoMode = !autoMode;
      updateAutoButton();
      updateExamAutoButton();
    });
  }
  
  if (examPrevBtn) {
    examPrevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        autoSaveProgress();
        renderCurrentQuestion();
      }
    });
  }
  
  if (examNextBtn) {
    examNextBtn.addEventListener('click', () => {
      if (currentIndex < sessionTests.length - 1) {
        currentIndex++;
        autoSaveProgress();
        renderCurrentQuestion();
      } else {
        if (checkAllQuestionsAnswered()) {
          completeExam();
        } else {
          showNotification('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É£·Éû·Éê·É°·É£·ÉÆ·Éù·Éó ·Éß·Éï·Éî·Éö·Éê ·Éô·Éò·Éó·ÉÆ·Éï·Éê·É° ·Éí·Éê·Éõ·Éù·É™·Éì·Éò·É° ·Éì·Éê·É°·É†·É£·Éö·Éî·Éë·Éê·Éõ·Éì·Éî');
        }
      }
    });
  }
  
  if (examAutoBtn) {
    examAutoBtn.addEventListener('click', () => {
      autoMode = !autoMode;
      updateAutoButton();
      updateExamAutoButton();
    });
  }
  
  if (examFinishBtn) {
    examFinishBtn.addEventListener('click', () => {
      if (examMode) {
        if (checkAllQuestionsAnswered()) {
          completeExam();
        } else {
          showNotification('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É£·Éû·Éê·É°·É£·ÉÆ·Éù·Éó ·Éß·Éï·Éî·Éö·Éê ·Éô·Éò·Éó·ÉÆ·Éï·Éê·É° ·Éí·Éê·Éõ·Éù·É™·Éì·Éò·É° ·Éì·Éê·É°·É†·É£·Éö·Éî·Éë·Éê·Éõ·Éì·Éî');
        }
      }
    });
  }
  
  const closeDetailsBtn = document.getElementById('closeDetailsBtn');
  if (closeDetailsBtn) {
    closeDetailsBtn.addEventListener('click', () => {
      detailedResultsModal.classList.remove('active');
    });
  }
}

function bindQuestionCounterEvent() {
  if (!currentQuestionEl) return;
  
  currentQuestionEl.addEventListener('click', (e) => {
    e.stopPropagation();
    
    if (isEditingQuestionNumber || examMode) return;
    
    isEditingQuestionNumber = true;
    currentQuestionEl.classList.add('editing');
    
    const originalValue = currentQuestionEl.textContent;
    
    const input = document.createElement('input');
    input.type = 'number';
    input.value = originalValue;
    input.min = 1;
    input.max = sessionTests.length;
    input.style.cssText = `
      width: 60px;
      height: 40px;
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      border: none;
      background: transparent;
      color: var(--success);
      outline: none;
      padding: 0;
      margin: 0;
      -moz-appearance: textfield;
    `;
    
    input.style.webkitAppearance = 'none';
    input.style.margin = '0';
    
    const originalDisplay = currentQuestionEl.style.display;
    currentQuestionEl.style.display = 'none';
    
    const inputContainer = document.createElement('div');
    inputContainer.style.cssText = `
      display: inline-block;
      min-width: 50px;
      text-align: center;
    `;
    inputContainer.appendChild(input);
    
    currentQuestionEl.parentNode.insertBefore(inputContainer, currentQuestionEl.nextSibling);
    
    input.focus();
    input.select();
    
    const handleInputComplete = () => {
      const value = parseInt(input.value);
      if (value >= 1 && value <= sessionTests.length) {
        currentIndex = value - 1;
        
        inputContainer.remove();
        currentQuestionEl.style.display = originalDisplay;
        currentQuestionEl.textContent = value;
        currentQuestionEl.classList.remove('editing');
        isEditingQuestionNumber = false;
        
        autoSaveProgress();
        renderCurrentQuestion();
      } else {
        inputContainer.remove();
        currentQuestionEl.style.display = originalDisplay;
        currentQuestionEl.classList.remove('editing');
        isEditingQuestionNumber = false;
        
        showNotification('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·Éú·Éù·Éõ·Éî·É†·Éò 1-·Éì·Éê·Éú ' + sessionTests.length + '-·Éõ·Éì·Éî');
      }
    };
    
    input.addEventListener('blur', handleInputComplete);
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleInputComplete();
      }
    });
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        inputContainer.remove();
        currentQuestionEl.style.display = originalDisplay;
        currentQuestionEl.classList.remove('editing');
        isEditingQuestionNumber = false;
      }
    });
  });
}

// ==================== FIXED: checkExistingProgress with debounce ====================
function checkExistingProgress() {
  // ·Éó·É£ ·É£·Éô·Éï·Éî ·Éõ·Éù·Éì·Éê·Éö·Éò ·É©·Éê·Éú·É°, ·Éê·É¶·Éê·É† ·Éí·Éê·Éï·É£·É®·Éï·Éê·Éó
  if (isProgressModalShowing) {
    console.log("Progress modal already showing, skipping");
    return;
  }
  
  // ·Éó·É£ ·Éë·Éù·Éö·Éù 2 ·É¨·Éê·Éõ·É®·Éò ·É£·Éô·Éï·Éî ·É®·Éî·Éï·Éê·Éõ·Éù·É¨·Éõ·Éî·Éó, ·Éê·É¶·Éê·É† ·Éí·Éê·Éï·É£·É®·Éï·Éê·Éó
  const now = Date.now();
  if (now - lastProgressCheckTime < 2000) {
    console.log("Progress check too frequent, skipping");
    return;
  }
  lastProgressCheckTime = now;
  
  if (document.getElementById('modeExam') && document.getElementById('modeExam').checked) {
    console.log("Exam mode is active - skipping progress modal");
    return;
  }
  
  if (!currentUser || currentUser.isGuest || !allTestsWithTopics.length) {
    console.log("User not logged in or no tests loaded");
    return;
  }
  
  // ·Éõ·Éò·Éõ·Éì·Éò·Éú·Éê·É†·Éî ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·É¨·Éê·Éõ·Éù·É¶·Éî·Éë·Éê checkbox-·Éî·Éë·Éò·Éì·Éê·Éú
  const selectedModule = getSelectedModule();
  console.log("Checking progress for module:", selectedModule);
  
  if (!selectedModule) {
    console.log("No module selected");
    return;
  }
  
  const progress = userProgress[selectedModule];
  if (!progress) {
    console.log("No progress for module:", selectedModule);
    return;
  }
  
  const hasNormalProgress = progress.normal && 
                           Object.keys(progress.normal.answeredQuestions || {}).length > 0;
  const hasExamProgress = progress.exam && 
                         Object.keys(progress.exam.answeredQuestions || {}).length > 0;
  
  console.log("Has normal progress:", hasNormalProgress, "Has exam progress:", hasExamProgress);
  
  if (!hasNormalProgress && !hasExamProgress) {
    console.log("No progress to resume");
    return;
  }
  
  // ·É¨·Éê·Éï·É®·Éê·Éö·Éù·Éó ·É¨·Éò·Éú·Éê timeout ·Éó·É£ ·Éê·É†·É°·Éî·Éë·Éù·Éë·É°
  if (progressCheckTimeout) {
    clearTimeout(progressCheckTimeout);
  }
  
  // ·Éì·Éê·Éï·Éê·Éß·Éù·Éï·Éú·Éù·Éó 500ms ·Éì·Éê ·É®·Éî·Éï·Éê·Éõ·Éù·É¨·Éõ·Éù·Éó ·Éò·É°·Éî·Éï
  progressCheckTimeout = setTimeout(() => {
    // ·Éò·É°·Éî·Éï ·É®·Éî·Éï·Éê·Éõ·Éù·É¨·Éõ·Éù·Éó, ·Éê·É†·Éò·É° ·Éó·É£ ·Éê·É†·Éê ·É¢·Éî·É°·É¢·Éò·É° ·Éî·Éô·É†·Éê·Éú·Éò ·Éê·É•·É¢·Éò·É£·É†·Éò
    if (testScreen.classList.contains('active')) {
      console.log("Test screen is active, not showing modal");
      return;
    }
    
    // ·Éò·É°·Éî·Éï ·É®·Éî·Éï·Éê·Éõ·Éù·É¨·Éõ·Éù·Éó, ·Éê·É†·Éò·É° ·Éó·É£ ·Éê·É†·Éê Exam Mode
    if (document.getElementById('modeExam') && document.getElementById('modeExam').checked) {
      console.log("Exam mode is active - skipping progress modal");
      return;
    }
    
    // ·Éò·É°·Éî·Éï ·É®·Éî·Éï·Éê·Éõ·Éù·É¨·Éõ·Éù·Éó ·Éõ·Éù·Éì·É£·Éö·Éî·Éë·Éò
    const currentSelectedModule = getSelectedModule();
    if (currentSelectedModule !== selectedModule) {
      console.log("Module changed since check, skipping");
      return;
    }
    
    const normalCount = hasNormalProgress ? Object.keys(progress.normal.answeredQuestions || {}).length : 0;
    const examCount = hasExamProgress ? Object.keys(progress.exam.answeredQuestions || {}).length : 0;
    const totalAnswered = normalCount + examCount;
    
    showProgressResumeModal(totalAnswered, selectedModule, progress, selectedModule);
  }, 500);
}

// ·Éì·Éê·Éê·Éô·Éï·Éò·É†·Éì·Éò ·É°·Éò·É°·É¢·Éî·Éõ·É£·É† ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éî·Éë·É°
function setupForceLogoutListener() {
    if (!firebaseSyncEnabled || !database) return;
    
    database.ref('system/forceLogout').on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        
        // ·Éó·É£ ·Éî·É° ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê ·É©·Éï·Éî·Éú·É° ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·É° ·Éî·ÉÆ·Éî·Éë·Éê
        if (data.userId === currentUser?.username || 
            data.userId === localStorage.getItem('chatUserId')) {
            
            // ·Éí·Éê·Éê·É°·É£·É§·Éó·Éê·Éï·Éî localStorage
            localStorage.removeItem('currentUser');
            localStorage.removeItem('users');
            sessionStorage.clear();
            
            // ·Éí·Éê·Éõ·Éù·Éê·É©·Éò·Éú·Éî ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê
            showNotification('·Éó·É•·Éï·Éî·Éú·Éò ·Éê·Éú·Éí·Éê·É†·Éò·É®·Éò ·É¨·Éê·Éò·É®·Éê·Éö·Éê', true);
            
            // ·Éí·Éê·Éì·Éê·É¢·Éï·Éò·É†·Éó·Éî ·Éí·Éï·Éî·É†·Éì·Éò
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    });
}

function showProgressResumeModal(totalAnswered, moduleName, progress, selectedModule) {
  console.log("Showing progress resume modal for module:", moduleName, "total:", totalAnswered);
  
  // ·Éì·Éê·Éï·É°·Éî·É¢·Éù·Éó ·É§·Éö·Éê·Éí·Éò
  isProgressModalShowing = true;
  
  // ·Éõ·Éù·Éì·É£·Éö·Éî·Éë·Éò·É° ·É•·Éê·É†·Éó·É£·Éö·Éò ·É°·Éê·ÉÆ·Éî·Éö·Éî·Éë·Éò
  const moduleNames = {
    'samkurnaloo': '·É°·Éê·Éõ·Éô·É£·É†·Éú·Éê·Éö·Éù',
    'stomatologia': '·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    
    // ·É°·Éê·Éö·Éò·É™·Éî·Éú·Éñ·Éò·Éù
    'alergologia': '·Éê·Éö·Éî·É†·Éí·Éù·Éö·Éù·Éí·Éò·Éê',
    'angiokirurgia': '·Éê·Éú·Éí·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'anesteziologia': '·Éê·Éú·Éî·É°·Éó·Éî·Éñ·Éò·Éù·Éö·Éù·Éí·Éò·Éê, ·É†·Éî·Éê·Éú·Éò·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_gadaudebeli': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò',
    'bavshvta_kardiorevmatologia': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éô·Éê·É†·Éì·Éò·Éù·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_nevrologia': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'bavshvta_nevrologia2': '·Éë·Éê·Éï·É®·Éï·Éó·Éê ·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'gadaudebeli_medicina': '·Éí·Éê·Éì·Éê·É£·Éì·Éî·Éë·Éî·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'gastroenterologia': '·Éí·Éê·É°·É¢·É†·Éù·Éî·Éú·É¢·Éî·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'ginekologia': '·Éí·Éò·Éú·Éî·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'dermatologia': '·Éì·Éî·É†·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'endokrinologia': '·Éî·Éú·Éì·Éù·Éô·É†·Éò·Éú·Éù·Éö·Éù·Éí·Éò·Éê',
    'zogadi_kirurgia': '·Éñ·Éù·Éí·Éê·Éì·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'terapiuli_stomatologia': '·Éó·Éî·É†·Éê·Éû·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'infekciuri': '·Éò·Éú·É§·Éî·É•·É™·Éò·É£·É†·Éò',
    'kardiologia': '·Éô·Éê·É†·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê',
    'kardiokirurgia': '·Éô·Éê·É†·Éì·Éò·Éù·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'laboratoriuli_medicina': '·Éö·Éê·Éë·Éù·É†·Éê·É¢·Éù·É†·Éò·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'narkologia': '·Éú·Éê·É†·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'nevrologia': '·Éú·Éî·Éï·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'neonatologia': '·Éú·Éî·Éù·Éú·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'nefrologia': '·Éú·Éî·É§·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'onkologia': '·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'ortodontia': '·Éù·É†·Éó·Éù·Éì·Éù·Éú·É¢·Éò·Éê',
    'ortopedia_travmatologia': '·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·Éê ·É¢·É†·Éê·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'ortopediuli_stomatologia': '·Éù·É†·Éó·Éù·Éû·Éî·Éì·Éò·É£·Éö·Éò ·É°·É¢·Éù·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'otorinolaringologia': '·Éù·É¢·Éù·É†·Éò·Éú·Éù·Éö·Éê·É†·Éò·Éú·Éí·Éù·Éö·Éù·Éí·Éò·Éê',
    'oftalmologia': '·Éù·É§·Éó·Éê·Éö·Éõ·Éù·Éö·Éù·Éí·Éò·Éê',
    'patologia': '·Éû·Éê·Éó·Éù·Éö·Éù·Éí·Éò·Éê',
    'pediatria': '·Éû·Éî·Éì·Éò·Éê·É¢·É†·Éò·Éê',
    'plastikuri_kirurgia': '·Éû·Éö·Éê·É°·É¢·Éò·Éô·É£·É†·Éò ·Éì·Éê ·É†·Éî·Éô·Éù·Éú·É°·É¢·É†·É£·É•·É™·Éò·É£·Éö·Éò ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'radiologia': '·É†·Éê·Éì·Éò·Éù·Éö·Éù·Éí·Éò·Éê',
    'radiacioni_onkologia': '·É†·Éê·Éì·Éò·Éê·É™·Éò·É£·Éö·Éò ·Éù·Éú·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'reproduqtologia': '·É†·Éî·Éû·É†·Éù·Éì·É£·É•·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'revmatologia': '·É†·Éî·Éï·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê',
    'saokjao_medicina': '·É°·Éê·Éù·ÉØ·Éê·ÉÆ·Éù ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'sportuli_medicina': '·É°·Éû·Éù·É†·É¢·É£·Éö·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'toksikologia': '·É¢·Éù·É•·É°·Éò·Éô·Éù·Éö·Éù·Éí·Éò·Éê',
    'urologia': '·É£·É†·Éù·Éö·Éù·Éí·Éò·Éê',
    'ftiziatria_pulmonologia': '·É§·Éó·Éò·Éñ·Éò·Éê·É¢·É†·Éò·Éê, ·Éû·É£·Éö·Éõ·Éù·Éú·Éù·Éö·Éù·Éí·Éò·Éê',
    'psikiatria': '·É§·É°·Éò·É•·Éò·Éê·É¢·É†·Éò·Éê',
    'qba_saxis_kirurgia': '·Éß·Éë·Éê-·É°·Éê·ÉÆ·Éò·É° ·É•·Éò·É†·É£·É†·Éí·Éò·Éê',
    'shinagani_medicina': '·É®·Éò·Éú·Éê·Éí·Éê·Éú·Éò ·Éõ·Éî·Éì·Éò·É™·Éò·Éú·Éê',
    'hematologia': '·É∞·Éî·Éõ·Éê·É¢·Éù·Éö·Éù·Éí·Éò·Éê'
  };
  
  const moduleDisplayName = moduleNames[selectedModule] || selectedModule;
  
  // ·É¨·Éê·Éï·É®·Éê·Éö·Éù·Éó ·Éß·Éï·Éî·Éö·Éê ·Éê·É†·É°·Éî·Éë·É£·Éö·Éò ·Éõ·Éù·Éì·Éê·Éö·Éò
  const existingModals = document.querySelectorAll('.modal-overlay[data-type="progress-resume"]');
  existingModals.forEach(modal => modal.remove());
  
  // ·É®·Éî·Éï·Éê·Éõ·Éù·É¨·Éõ·Éù·Éó, ·Éê·É†·Éò·É° ·Éó·É£ ·Éê·É†·Éê ·É¢·Éî·É°·É¢·Éò·É° ·Éî·Éô·É†·Éê·Éú·Éò ·Éê·É•·É¢·Éò·É£·É†·Éò
  if (testScreen.classList.contains('active')) {
    console.log("Test screen is active, not showing modal");
    isProgressModalShowing = false;
    return;
  }
  
  const modalOverlay = document.createElement('div');
  modalOverlay.className = 'modal-overlay active';
  modalOverlay.setAttribute('data-type', 'progress-resume');
  modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;';
  
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.cssText = 'background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
  
  const header = document.createElement('div');
  header.className = 'modal-header';
  header.style.cssText = 'font-size: 24px; font-weight: 600; color: #1e293b; margin-bottom: 20px; text-align: center;';
  header.textContent = '·Éí·É°·É£·É†·Éó ·Éí·Éê·Éí·É†·É´·Éî·Éö·Éî·Éë·Éê?';
  
  const content = document.createElement('div');
  content.className = 'modal-content';
  content.style.cssText = 'margin-bottom: 30px; text-align: center;';
  
  const p1 = document.createElement('p');
  p1.style.cssText = 'margin-bottom: 15px; font-size: 16px;';
  p1.innerHTML = `·Éó·É•·Éï·Éî·Éú ·É£·Éô·Éï·Éî ·Éì·Éê·É¨·Éî·É†·Éò·Éó <strong style="color: var(--accent);">${totalAnswered} ·É¢·Éî·É°·É¢·Éò</strong> ·Éõ·Éù·Éì·É£·Éö·É®·Éò: <strong style="color: var(--accent);">${moduleDisplayName}</strong>`;
  
  const p2 = document.createElement('p');
  p2.style.cssText = 'margin-bottom: 20px; color: #64748b;';
  p2.textContent = '·Éí·É°·É£·É†·Éó ·Éí·Éê·Éê·Éí·É†·É´·Éî·Éö·Éù·Éó ·Éë·Éù·Éö·Éù ·É¢·Éî·É°·É¢·Éò·Éì·Éê·Éú ·Éó·É£ ·Éó·Éê·Éï·Éò·Éì·Éê·Éú ·Éì·Éê·Éò·É¨·Éß·Éù·Éó?';
  
  content.appendChild(p1);
  content.appendChild(p2);
  
  const buttons = document.createElement('div');
  buttons.style.cssText = 'display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;';
  
  const continueBtn = document.createElement('button');
  continueBtn.id = 'continueProgressBtn';
  continueBtn.style.cssText = 'padding: 12px 20px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; min-width: 120px; flex: 1 1 auto;';
  continueBtn.textContent = '·Éí·Éê·Éí·É†·É´·Éî·Éö·Éî·Éë·Éê';
  
  const restartBtn = document.createElement('button');
  restartBtn.id = 'restartProgressBtn';
  restartBtn.style.cssText = 'padding: 12px 20px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; min-width: 120px; flex: 1 1 auto;';
  restartBtn.textContent = '·Éó·Éê·Éï·Éò·Éì·Éê·Éú ·Éì·Éê·É¨·Éß·Éî·Éë·Éê';
  
  const closeBtn = document.createElement('button');
  closeBtn.id = 'closeProgressBtn';
  closeBtn.style.cssText = 'padding: 12px 20px; background: var(--danger); color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; min-width: 120px; flex: 1 1 auto;';
  closeBtn.textContent = '·Éì·Éê·ÉÆ·É£·É†·Éï·Éê';
  
  buttons.appendChild(continueBtn);
  buttons.appendChild(restartBtn);
  buttons.appendChild(closeBtn);
  
  modal.appendChild(header);
  modal.appendChild(content);
  modal.appendChild(buttons);
  modalOverlay.appendChild(modal);
  
  document.body.appendChild(modalOverlay);
  
  continueBtn.addEventListener('click', function() {
    modalOverlay.remove();
    isProgressModalShowing = false;
    
    console.log("Continue clicked. Progress object:", progress);
    console.log("Selected module:", selectedModule);
    
    currentTestType = selectedModule;
    
    const modeExam = document.getElementById('modeExam');
    const modeSequential = document.getElementById('modeSequential');
    const modeShuffleQuestions = document.getElementById('modeShuffleQuestions');
    const modeShuffleAnswers = document.getElementById('modeShuffleAnswers');
    
    const testTypeSelect = document.getElementById('testTypeSelect');
    if (testTypeSelect) {
      testTypeSelect.value = selectedModule;
      toggleTopicsDropdown();
    }
    
    const topicsSelect = document.getElementById('topicsSelect');
    if (topicsSelect) {
      topicsSelect.value = 'all';
      selectedTopic = null;
    }
    
    const hasNormalProgress = progress.normal && Object.keys(progress.normal.answeredQuestions || {}).length > 0;
    const hasExamProgress = progress.exam && Object.keys(progress.exam.answeredQuestions || {}).length > 0;
    
    console.log("Has normal progress:", hasNormalProgress, "Has exam progress:", hasExamProgress);
    
    if (hasExamProgress && !hasNormalProgress) {
      if (modeExam) modeExam.checked = true;
      if (modeSequential) modeSequential.checked = false;
      if (modeShuffleQuestions) modeShuffleQuestions.checked = true;
      if (modeShuffleAnswers) modeShuffleAnswers.checked = false;
      console.log("Selected exam mode");
    } else {
      if (modeExam) modeExam.checked = false;
      if (modeSequential) modeSequential.checked = true;
      console.log("Selected normal mode");
    }
    
    window.savedProgress = progress;
    
    setTimeout(() => {
      if (allTestsWithTopics.length > 0) {
        startTest();
      } else {
        loadCSV();
      }
    }, 300);
    
    showNotification('·Éû·É†·Éù·Éí·É†·Éî·É°·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É©·Éê·Éò·É¢·Éï·Éò·É†·Éó·Éê', false);
  });
  
  restartBtn.addEventListener('click', async function() {
    modalOverlay.remove();
    isProgressModalShowing = false;
    
    console.log("Restart clicked. Clearing progress for module:", selectedModule);
    
    if (currentUser && currentUser.username && !currentUser.isGuest) {
      try {
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        if (users[currentUser.username] && users[currentUser.username].progress) {
          if (users[currentUser.username].progress[selectedModule]) {
            users[currentUser.username].progress[selectedModule] = {
              normal: { answeredQuestions: {}, currentIndex: 0 },
              exam: { answeredQuestions: {}, currentIndex: 0 },
              wrongQuestions: []
            };
            users[currentUser.username].lastUpdated = Date.now();
            localStorage.setItem('users', JSON.stringify(users));
            
            if (firebaseSyncEnabled && database) {
              await saveUserToFirebase(currentUser.username, users[currentUser.username]);
            }
            
            userProgress[selectedModule] = {
              normal: { answeredQuestions: {}, currentIndex: 0 },
              exam: { answeredQuestions: {}, currentIndex: 0 },
              wrongQuestions: []
            };
            
            console.log("Progress cleared for module:", selectedModule);
          }
        }
      } catch (error) {
        console.error('Error clearing progress:', error);
      }
    }
    
    const modeExam = document.getElementById('modeExam');
    const modeSequential = document.getElementById('modeSequential');
    const modeShuffleQuestions = document.getElementById('modeShuffleQuestions');
    const modeShuffleAnswers = document.getElementById('modeShuffleAnswers');
    
    const testTypeSelect = document.getElementById('testTypeSelect');
    if (testTypeSelect) {
      testTypeSelect.value = selectedModule;
      currentTestType = selectedModule;
      toggleTopicsDropdown();
    }
    
    const topicsSelect = document.getElementById('topicsSelect');
    if (topicsSelect) {
      topicsSelect.value = 'all';
      selectedTopic = null;
    }
    
    const hasNormalProgress = progress.normal && Object.keys(progress.normal.answeredQuestions || {}).length > 0;
    const hasExamProgress = progress.exam && Object.keys(progress.exam.answeredQuestions || {}).length > 0;
    
    if (hasExamProgress && !hasNormalProgress) {
      if (modeExam) modeExam.checked = true;
      if (modeSequential) modeSequential.checked = false;
      if (modeShuffleQuestions) modeShuffleQuestions.checked = true;
      if (modeShuffleAnswers) modeShuffleAnswers.checked = false;
    } else {
      if (modeExam) modeExam.checked = false;
      if (modeSequential) modeSequential.checked = true;
    }
    
    window.savedProgress = null;
    
    setTimeout(() => {
      if (allTestsWithTopics.length > 0) {
        startTest();
      } else {
        loadCSV();
      }
    }, 300);
    
    showNotification('·Éû·É†·Éù·Éí·É†·Éî·É°·Éò ·Éí·Éê·É°·É£·É§·Éó·Éê·Éï·Éì·Éê. ·É¢·Éî·É°·É¢·Éò ·Éò·É¨·Éß·Éî·Éë·Éê ·Éû·Éò·É†·Éï·Éî·Éö·Éò ·Éô·Éò·Éó·ÉÆ·Éï·Éò·Éì·Éê·Éú', false);
  });
  
  closeBtn.addEventListener('click', function() {
    modalOverlay.remove();
    isProgressModalShowing = false;
  });
  
  modalOverlay.addEventListener('click', function(e) {
    if (e.target === modalOverlay) {
      modalOverlay.remove();
      isProgressModalShowing = false;
    }
  });
}

function onModuleSelected(moduleValue) {
  // ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éî dropdown ·É¢·Éî·É•·É°·É¢·Éò
  updateDropdownText(moduleValue);
  
  // ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éî currentTestType
  currentTestType = moduleValue;
  
  // ·Éó·Éî·Éõ·Éî·Éë·Éò·É° dropdown-·Éò·É° ·É©·Éï·Éî·Éú·Éî·Éë·Éê/·Éì·Éê·Éõ·Éê·Éö·Éï·Éê
  const topicsContainer = document.getElementById('topicsDropdownContainer');
  if (moduleValue === 'samkurnaloo') {
    topicsContainer.style.display = 'flex';
  } else {
    topicsContainer.style.display = 'none';
    const topicsSelect = document.getElementById('topicsSelect');
    if (topicsSelect) topicsSelect.value = 'all';
    selectedTopic = null;
  }
  
  // üî• ·Éì·Éê·Éò·ÉÆ·É£·É†·Éù·É° ·Éõ·Éù·Éì·É£·Éö·Éî·Éë·Éò·É° ·É°·Éò·Éê
  const container = document.getElementById('modulesContainer');
  if (container) {
    container.style.display = 'none';
  }
  
  // ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éî ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò
  loadCSV();
}

function showCompletionScreen() {
  const totalQuestions = sessionTests.length;
  const correctCount = sessionTests.filter(q => q.hasCorrectAnswer).length;
  const percentage = Math.round((correctCount / totalQuestions) * 100);
  
  timerElement.classList.remove('hidden');
  
  const completionHTML = `
    <div style="text-align:center; padding:40px 20px; width:100%;">
      <div style="font-size:24px; font-weight:600; color:#1e293b; margin-bottom:20px;">
        ·É¢·Éî·É°·É¢·Éò ·Éì·Éê·É°·É†·É£·Éö·Éì·Éê! 
      </div>
      <div style="font-size:18px; color:#64748b; margin-bottom:30px;">
        ·Éó·É•·Éï·Éî·Éú ·Éì·Éê·É¨·Éî·É†·Éî·Éó ${totalQuestions} ·Éô·Éò·Éó·ÉÆ·Éï·Éò·Éì·Éê·Éú ${correctCount} ·É°·É¨·Éù·É†·Éê·Éì (${percentage}%)
      </div>
      <button id="restartBtn" style="padding:14px 40px; background:var(--accent); color:white; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s;">
        ·Éó·Éê·Éï·Éò·Éì·Éê·Éú ·Éì·Éê·É¨·Éß·Éî·Éë·Éê
      </button>
    </div>
  `;
  
  const questionContainer = document.querySelector('.question-container');
  if (questionContainer) {
    questionContainer.innerHTML = completionHTML;
  }
  examRightPanel.classList.add('hidden');
  questionCounter.classList.add('hidden');
  
  document.getElementById('restartBtn')?.addEventListener('click', () => {
    location.reload();
  });
}

startBtn.addEventListener('click', function() {
  console.log("Start button clicked");
  
  if (!allTests || allTests.length === 0) { 
    showNotification('·Éê·Éò·É†·É©·Éò·Éî·Éó ·Éõ·Éù·Éì·É£·Éö·Éò ·Éì·Éê·É°·Éê·É¨·Éß·Éî·Éë·Éê·Éì');
    return; 
  }
  
  // ·Éõ·Éù·Éú·Éò·É®·Éú·É£·Éö·Éò ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·É®·Éî·Éõ·Éù·É¨·Éõ·Éî·Éë·Éê
  const selectedModule = getSelectedModule();
  if (!selectedModule) {
    showNotification('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·Éõ·Éù·Éì·É£·Éö·Éò');
    return;
  }
  
  currentTestType = selectedModule;
  console.log("Test type set to:", currentTestType);
  
  // ·Éó·Éî·Éõ·Éî·Éë·Éò·É° ·É®·Éî·Éõ·Éù·É¨·Éõ·Éî·Éë·Éê ·Éõ·ÉÆ·Éù·Éö·Éù·Éì ·É°·Éê·Éõ·Éô·É£·É†·Éú·Éê·Éö·Éù·É°·Éó·Éï·Éò·É°
  if (currentTestType === 'samkurnaloo') {
    const topicsSelect = document.getElementById('topicsSelect');
    if (topicsSelect && (!topicsSelect.value || topicsSelect.value === '')) {
      showNotification('·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·Éó·Éî·Éõ·Éê!');
      return;
    }
  }
  
  startTest();
});

window.addEventListener('DOMContentLoaded', () => {
  console.log("DOM loaded, initializing app...");
  
  chatButton = document.getElementById('chatButton');
  chatWindow = document.getElementById('chatWindow');
  closeChat = document.querySelector('.close-chat');
  chatMessagesEl = document.getElementById('chatMessages');
  onlineCount = document.getElementById('onlineCount');
  chatInput = document.getElementById('chatInput');
  sendBtn = document.getElementById('sendBtn');
  
  prevBtn = document.getElementById('prevBtn');
  nextBtn = document.getElementById('nextBtn');
  autoBtn = document.getElementById('autoBtn');
  
  examPrevBtn = document.getElementById('examPrevBtn');
  examNextBtn = document.getElementById('examNextBtn');
  examAutoBtn = document.getElementById('examAutoBtn');
  examFinishBtn = document.getElementById('examFinishBtn');
  
  detailedResultsModal = document.getElementById('detailedResultsModal');
  detailedResultsContent = document.getElementById('detailedResultsContent');
  
  initAuth();
  
  bindNavigationEvents();
  bindQuestionCounterEvent();
  bindTestTypeEvents();
  
  const testTypeSelect = document.getElementById('testTypeSelect');
  if (testTypeSelect) {
    testTypeSelect.addEventListener('change', function() {
      currentTestType = this.value;
      console.log("Test type changed to:", currentTestType);
    });
  }
  
  document.addEventListener('click', (e) => {
    if (isEditingQuestionNumber && currentQuestionEl && !currentQuestionEl.contains(e.target)) {
      isEditingQuestionNumber = false;
      renderCurrentQuestion();
    }
  });
  
  setInterval(updateTimer, 1000);
  updateTimer();
  
  window.addEventListener('beforeunload', () => {
    if (currentUser && !currentUser.isGuest && currentTestType) {
      saveUserProgress();
    }
  });
  
  if (modeSequential) {
    modeSequential.addEventListener('change', () => {
      if (modeSequential.checked && modeExam.checked) {
        modeExam.checked = false;
      }
    });
  }
  
  if (modeShuffleQuestions) {
    modeShuffleQuestions.addEventListener('change', () => {
      if (modeShuffleQuestions.checked && modeSequential.checked) {
        showNotification('·Éî·É° ·É†·Éî·Éü·Éò·Éõ·Éî·Éë·Éò ·Éî·É†·Éó·Éê·Éì ·É®·Éî·É£·É´·Éö·Éî·Éë·Éî·Éö·Éò·Éê ·Éê·É†·É°·Éî·Éë·Éù·Éë·Éì·Éî·É°!');
        modeShuffleQuestions.checked = false;
      }
    });
  }
  
  if (modeExam) {
    modeExam.addEventListener('change', () => {
      if (modeExam.checked) {
        if (modeSequential) modeSequential.checked = false;
        if (modeShuffleQuestions) modeShuffleQuestions.checked = true;
        if (modeShuffleAnswers) modeShuffleAnswers.checked = false;
      } else {
        if (!modeSequential.checked) {
          modeSequential.checked = true;
        }
      }
    });
  }
  
  setTimeout(() => {
    toggleTopicsDropdown();
  }, 100);
  
  window.closeSettingsPage = closeSettingsPage;
  window.enableUsernameEdit = enableUsernameEdit;
  window.togglePasswordVisibility = togglePasswordVisibility;
  window.showPasswordChangeFromSettings = showPasswordChangeFromSettings;
  window.printMistakes = printMistakes;
  window.showPasswordChangeModal = showPasswordChangeModal;


  // ========== Modules-·Éò·É° ·Éì·Éê·ÉÆ·É£·É†·Éï·Éê ·Éí·Éê·É†·Éî·Éì·Éê·Éú ·Éì·Éê·É≠·Éî·É†·Éò·É°·Éê·É° ==========
  document.addEventListener('click', function(event) {
    const container = document.getElementById('modulesContainer');
    const dropdown = document.getElementById('testTypeSelect');
    
    if (container && dropdown && 
        container.style.display === 'flex' && 
        !container.contains(event.target) && 
        !dropdown.contains(event.target)) {
      container.style.display = 'none';
    }
  });

  // Checkbox-·Éî·Éë·Éò·É° event listeners
  document.querySelectorAll('.module-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
      handleModuleCheckboxClick(this);
    });
  });

// ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí
const originalContinueAsGuest = document.getElementById('continueAsGuest').onclick;
document.getElementById('continueAsGuest').addEventListener('click', function() {
  if (originalContinueAsGuest) originalContinueAsGuest.call(this);
  // ·É°·É¢·É£·Éõ·É†·Éò·É°·Éó·Éï·Éò·É° ·Éê·É† ·Éí·Éï·Éò·Éú·Éì·Éê ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê Firebase-·Éì·Éê·Éú
  console.log("Guest user - skipping module load from Firebase");
});

const originalLoginBtn = document.getElementById('loginBtn').onclick;
document.getElementById('loginBtn').addEventListener('click', function() {
  if (originalLoginBtn) originalLoginBtn.call(this);
  // loadSelectedModule ·É£·Éô·Éï·Éî ·Éí·Éê·Éõ·Éù·É´·Éê·ÉÆ·Éî·Éë·É£·Éö·Éò·Éê handleLogin-·Éò·É° ·Éë·Éù·Éö·Éù·É°
  // ·Éê·É• ·Éê·É¶·Éê·É† ·Éí·Éï·É≠·Éò·É†·Éì·Éî·Éë·Éê ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·Éí·Éê·Éõ·Éù·É´·Éê·ÉÆ·Éî·Éë·Éê
});

const originalSignupBtn = document.getElementById('signupBtn').onclick;
document.getElementById('signupBtn').addEventListener('click', function() {
  if (originalSignupBtn) originalSignupBtn.call(this);
  // ·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·ÉØ·Éî·É† ·Éê·É† ·Éê·É†·Éò·É° ·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éî·Éë·É£·Éö·Éò
  // ·Éõ·Éù·Éì·É£·Éö·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê ·Éõ·Éù·ÉÆ·Éì·Éî·Éë·Éê ·É®·Éî·É°·Éï·Éö·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí
});

  // ·Éû·Éî·É†·Éò·Éù·Éì·É£·Éö·Éê·Éì ·Éí·Éê·Éï·Éê·É°·É£·É§·Éó·Éê·Éù·Éó ·É§·Éö·Éê·Éí·Éî·Éë·Éò
  setInterval(() => {
    if (!document.querySelector('.modal-overlay.active')) {
      isProgressModalShowing = false;
    }
  }, 1000);

  // ========== ·Éê·É• ·Éõ·Éó·Éê·Éï·É†·Éì·Éî·Éë·Éê ·Éê·ÉÆ·Éê·Éö·Éò ·Éô·Éù·Éì·Éò ==========

});
</script>
</body>
</html>
