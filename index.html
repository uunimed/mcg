<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>რეზიდენტურის ტესტები</title>
<style>
:root{
  --bg:#f6f8fb; --muted:#6b7280; --accent:#0ea5a4;
  --success:#16a34a; --danger:#dc2626;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
html,body{
  height:100%;
  font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: #f8fafc;
}
body{
  display: flex;
  flex-direction: column;
  padding: 20px;
  position: relative;
}

/* ==================== TOPIC DROPDOWN STYLES ==================== */
.topic-dropdown-wrapper {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  margin-bottom: 20px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.topic-select {
  width: 100%;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 14px;
  font-family: inherit;
  background: white;
  color: #334155;
  outline: none;
  transition: border-color 0.2s;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 36px;
}

.topic-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.1);
}

/* ==================== AUTH MODAL - ENHANCED ==================== */
.auth-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(5px);
}

.auth-modal {
  background: white;
  border-radius: 16px;
  width: 90%;
  max-width: 50%;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
  animation: modalAppear 0.4s ease;
}

@keyframes modalAppear {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.auth-header {
  background: linear-gradient(135deg, var(--accent), #0891b2);
  color: white;
  padding: 10px 30px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.auth-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
  animation: shimmer 8s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-30%) translateY(-30%) rotate(0deg); opacity: 0.3; }
  50% { transform: translateX(30%) translateY(30%) rotate(10deg); opacity: 0.6; }
  100% { transform: translateX(-30%) translateY(-30%) rotate(0deg); opacity: 0.3; }
}

.auth-header h2 {
  font-size: 42px;
  font-weight: 900;
  letter-spacing: -1px;
  text-transform: uppercase;
  margin: 0;
  padding: 0;
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(145deg, 
    #ffffff 0%,
    #f0f9ff 25%,
    #b8e1ff 50%,
    #f0f9ff 75%,
    #ffffff 100%
  );
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 
    0 1px 0 rgba(255,255,255,0.4),
    0 2px 0 rgba(14,165,164,0.1),
    0 3px 0 rgba(14,165,164,0.1),
    0 4px 0 rgba(14,165,164,0.1),
    0 5px 10px rgba(0,0,0,0.3),
    0 8px 20px rgba(14,165,164,0.3),
    0 12px 30px rgba(0,0,0,0.2);
  transition: letter-spacing 0.3s ease, text-shadow 0.3s ease;
}

.auth-header h2:hover {
  letter-spacing: 2px;
  text-shadow: 
    0 1px 0 rgba(255,255,255,0.4),
    0 2px 0 rgba(14,165,164,0.15),
    0 3px 0 rgba(14,165,164,0.15),
    0 4px 0 rgba(14,165,164,0.15),
    0 6px 15px rgba(0,0,0,0.4),
    0 10px 25px rgba(14,165,164,0.4),
    0 15px 35px rgba(0,0,0,0.25);
}

.auth-header h2::before {
  content: 'UniMed';
  position: absolute;
  top: 0;
  left: 0;
  z-index: -1;
  background: linear-gradient(145deg, #0ea5a4, #0284c7);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: blur(12px);
  opacity: 0.5;
  animation: glowPulse 3s infinite;
}

@keyframes glowPulse {
  0% { opacity: 0.4; filter: blur(10px); }
  50% { opacity: 0.7; filter: blur(15px); }
  100% { opacity: 0.4; filter: blur(10px); }
}

.auth-header h2 .medical-symbol {
  font-size: 42px;
  font-weight: 400;
  background: linear-gradient(135deg, #ffffff, #b8e1ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  display: inline-block;
  animation: pulseSymbol 2s infinite;
  text-shadow: 0 0 15px rgba(14,165,164,0.5);
  line-height: 1;
  margin-left: 4px;
}

@keyframes pulseSymbol {
  0% { transform: scale(1); opacity: 0.8; }
  50% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); opacity: 0.8; }
}

.auth-tabs {
  display: flex;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
}

.auth-tab {
  flex: 1;
  padding: 11px;
  background: none;
  border: none;
  font-size: 15px;
  font-weight: bold;
  color: #64748b;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.auth-tab::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 0;
  height: 3px;
  background: var(--accent);
  transition: all 0.3s;
  transform: translateX(-50%);
}

.auth-tab.active {
  color: var(--accent);
  background: white;
}

.auth-tab.active::after {
  width: 100%;
}

.auth-tab:hover:not(.active) {
  background: #f1f5f9;
  color: #475569;
}

.auth-content {
  padding: 30px;
}

.auth-tab-content {
  display: none;
}

.auth-tab-content.active {
  display: block;
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 0px;
}

#signupTab .auth-form {
  gap: 20px;
}

#loginTab .auth-form {
  gap: 15px;
}

#loginTab .form-group {
  position: relative;
  display: block;
  width: 100%;
  margin-bottom: 0;
}

#signupTab .form-group {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
}

#signupTab .form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 6px;
  margin-left: 2px;
  width: 100%;
}

#signupTab .auth-input {
  width: 100%;
  padding: 14px 16px;
  padding-right: 45px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

#signupTab .form-error {
  margin-top: 4px;
  margin-bottom: 0;
  padding-left: 2px;
  display: none;
  width: 100%;
}

#loginTab .form-group {
  position: relative;
  display: block;
  width: 100%;
  margin-bottom: 0;
}

#loginTab .auth-input {
  width: 100%;
  padding: 14px 45px 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

#loginTab .form-error {
  color: var(--danger);
  font-size: 13px;
  margin-top: 5px;
  margin-bottom: 0;
  padding-left: 2px;
  display: none;
  width: 100%;
}

#loginTab .password-toggle {
  position: absolute;
  right: 12px;
  top: 14px;
  transform: none;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  opacity: 0.7;
  transition: opacity 0.2s;
}

#signupTab .form-group {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
}

#signupTab .form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 6px;
  margin-left: 2px;
  width: 100%;
}

#signupTab .auth-input {
  width: 100%;
  padding: 14px 45px 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

#signupTab .password-toggle {
  position: absolute;
  right: 12px;
  top: 42px;
  transform: none;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  opacity: 0.7;
  transition: opacity 0.2s;
}

#signupTab .form-error {
  margin-top: 4px;
  margin-bottom: 0;
  padding-left: 2px;
  display: none;
  width: 100%;
}

#guestTab .auth-form {
  gap: 15px;
}

.auth-input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  font-family: inherit;
  transition: all 0.3s;
  background: #f8fafc;
}

.auth-input:focus {
  outline: none;
  border-color: var(--accent);
  background: white;
  box-shadow: 0 0 0 4px rgba(14, 165, 164, 0.15);
}

.auth-btn {
  padding: 16px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 10px;
}

#loginTab .auth-input {
  width: 100%;
  padding: 14px 45px 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

#loginTab .form-error {
  color: var(--danger);
  font-size: 13px;
  margin-top: 5px;
  margin-bottom: 0;
  padding-left: 2px;
  display: none;
  width: 100%;
  position: relative;
  top: 0;
}

#signupTab .auth-form {
  gap: 20px;
}

#signupTab .form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 6px;
  margin-left: 2px;
  width: 100%;
}

#signupTab .auth-input {
  width: 100%;
  padding: 14px 45px 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s;
  background: #f8fafc;
}

.guest-btn {
  background: linear-gradient(135deg, var(--accent), #0891b2);
  color: white;
}

.guest-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(14, 165, 164, 0.3);
}

.login-btn {
  background: linear-gradient(135deg, var(--success), #059669);
  color: white;
}

.login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(22, 163, 74, 0.3);
}

.signup-btn {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
}

.signup-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
}

.auth-divider {
  text-align: center;
  margin: 25px 0;
  position: relative;
}

.auth-divider::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 1px;
  background: #e2e8f0;
}

.auth-divider span {
  background: white;
  padding: 0 15px;
  color: #64748b;
  font-size: 14px;
  position: relative;
  z-index: 1;
}

.auth-switch-btn {
  background: none;
  border: none;
  color: var(--accent);
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  text-decoration: underline;
  margin-top: 20px;
  width: 100%;
  padding: 12px;
  transition: color 0.3s;
}

.auth-switch-btn:hover {
  color: #0891b2;
}

.form-error {
  color: var(--danger);
  font-size: 13px;
  margin-top: 5px;
  display: none;
}

/* ==================== TIMER & USER INFO ==================== */
.timer-user-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 999;
  display: flex;
  align-items: center;
  gap: 25px;
  font-family: inherit;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.user-menu {
  position: relative;
}

.username-btn {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 10px 18px;
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.username-btn:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(14, 165, 164, 0.15);
}

.user-dropdown {
  position: absolute;
  top: calc(100% + 10px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.15);
  min-width: 220px;
  display: none;
  z-index: 1001;
  overflow: hidden;
  border: 1px solid #e2e8f0;
}

.user-dropdown.show {
  display: block;
  animation: dropdownAppear 0.3s ease;
}

@keyframes dropdownAppear {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.user-dropdown-item {
  width: 100%;
  padding: 14px 20px;
  text-align: left;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  color: #334155;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #f1f5f9;
}

.user-dropdown-item:last-child {
  border-bottom: none;
  color: var(--danger);
}

.user-dropdown-item:hover {
  background: #f8fafc;
}

.user-dropdown-item i {
  font-size: 16px;
  width: 20px;
  text-align: center;
}

#timer {
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  background: transparent;
  padding: 0;
  box-shadow: none;
  text-align: right;
  line-height: 1.4;
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
  font-family: inherit;
}

.timer-time {
  font-family: inherit;
  font-weight: 600;
  color: inherit;
}

.timer-topic {
  font-size: 14px;
  color: var(--accent);
  font-weight: 600;
  display: inline-block;
}

.timer-separator {
  color: #cbd5e1;
  margin: 0 5px;
}

#timer.hidden {
  display: none;
}

/* ==================== TWO-COLUMN LAYOUT FOR OPTIONS ==================== */
.option-row {
  display: flex;
  gap: 15px;
  margin-bottom: 18px;
  width: 100%;
}

.option-item-half {
  flex: 1;
  min-width: 0;
  margin-bottom: 0 !important;
}

@media (max-width: 768px) {
  .option-row {
    flex-direction: column;
    gap: 12px;
  }
  
  .option-item-half {
    width: 100%;
  }
  
  .timer-user-container {
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
    top: 15px;
    right: 15px;
  }
  
  .username-btn {
    padding: 8px 14px;
    font-size: 14px;
  }
  
  #timer {
    padding: 8px 15px;
    font-size: 22px;
    min-width: 120px;
  }
}

/* ==================== CHAT NOTIFICATION BADGE ==================== */
.chat-notification {
  position: absolute;
  top: -5px;
  right: 0px;
  background: var(--danger);
  color: white;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  font-size: 11px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1002;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.chat-button {
  position: relative;
}

@media (max-width: 768px) {
  body {
    padding: 10px;
  }
  
  .exam-question-text {
    font-size: 16px !important;
    max-height: none !important;
    min-height: 10px;
    overflow: visible !important;
  }
  
  .normal-mode-container .navigation {
    position: fixed !important;
    bottom: 60px !important;
    left: 10px !important;
    right: 10px !important;
    top: auto !important;
    width: auto !important;
    padding: 10px !important;
    background: transparent !important;
    z-index: 1000 !important;
    border-top: none !important;
    margin-top: 0 !important;
    margin-bottom: 0 !important;
  }
  
  .normal-mode-container {
    padding-top: 10px !important;
    padding-bottom: 130px !important;
  }
  
  .exam-mode-container {
    flex-direction: column !important;
    height: auto !important;
    min-height: calc(100vh - 20px) !important;
    position: relative !important;
    padding-bottom: 180px !important;
  }
  
  .question-left-panel {
    order: 1 !important;
    padding-right: 0 !important;
    width: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    text-align: center !important;
  }
  
  .exam-question-text {
    text-align: center !important;
    width: 100% !important;
    padding: 0 10px !important;
  }
  
  .exam-answers-container {
    width: 100% !important;
    max-width: 600px !important;
    margin: 0 auto !important;
  }
  
  .exam-answer-item {
    text-align: left !important;
    width: 100% !important;
  }
  
  .exam-right-panel {
    width: 100% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    order: 2 !important;
    padding-left: 0 !important;
    border-left: none !important;
    border-top: 1px solid #e2e8f0 !important;
    margin-top: 20px !important;
    margin-bottom: 0 !important;
    position: static !important;
    height: auto !important;
  }
  
  .exam-right-panel.hidden {
    display: none !important;
  }
  
  .exam-right-panel:not(.hidden) {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
  }
  
  .exam-test-boxes {
    grid-template-columns: repeat(5, 45px) !important;
    justify-content: center !important;
    gap: 8px !important;
    max-height: 300px !important;
    padding: 15px !important;
    overflow-y: auto !important;
    width: 100% !important;
    background: #f8fafc !important;
    border-radius: 8px !important;
    margin-bottom: 0 !important;
  }
  
  .exam-navigation-container {
    order: 3 !important;
    position: fixed !important;
    bottom: 70px !important;
    left: 10px !important;
    right: 10px !important;
    width: auto !important;
    padding: 15px !important;
    background: white !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    z-index: 1000 !important;
    margin-top: 0 !important;
    border-top: 1px solid #e2e8f0 !important;
  }
  
  .nav-center {
    display: flex !important;
    gap: 8px !important;
    width: 100% !important;
  }
  
  .nav-btn {
    padding: 8px 12px !important;
    font-size: 14px !important;
    min-width: 0 !important;
    flex: 1 !important;
  }
  
  .bottom-left-container {
    position: fixed !important;
    bottom: 10px !important;
    left: 10px !important;
    right: 10px !important;
    flex-direction: row !important;
    justify-content: space-between !important;
    align-items: center !important;
    background: rgba(255, 255, 255, 0.95) !important;
    padding: 10px 12px !important;
    border-radius: 8px !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    display: flex !important;
    z-index: 1001 !important;
  }
  
  .question-counter {
    position: static !important;
    bottom: auto !important;
    right: auto !important;
    font-size: 5px !important;
    padding: 0 !important;
    background: transparent !important;
    margin: 0 !important;
    flex: 1 !important;
    text-align: center !important;
    order: 2 !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
  }
  
  .question-counter .current-question,
  .question-counter .counter-separator,
  .question-counter .total-questions {
    font-size: 20px !important;
  }
  
  .bottom-left-container .question-counter .counter-separator,
  .bottom-left-container .question-counter .total-questions {
    font-size: 20px !important;
    color: #64748b !important;
  }
  
  .chat-button {
    padding: 6px 12px !important;
    font-size: 12px !important;
    order: 1 !important;
    flex: 1 !important;
    text-align: left !important;
    min-width: 70px !important;
  }
  
  .online-status {
    font-size: 12px !important;
    order: 3 !important;
    flex: 1 !important;
    text-align: right !important;
    display: flex !important;
    justify-content: flex-end !important;
    align-items: center !important;
    min-width: 100px !important;
  }
  
  .exam-mode-container {
    padding-top: 10px !important;
    padding-bottom: 180px !important;
  }
  
  .exam-countdown {
    width: 100% !important;
    text-align: center !important;
    margin-bottom: 10px !important;
    font-size: 16px !important;
  }
  
  #questionCounter.hidden {
    display: none !important;
  }
  
  .bottom-left-container .question-counter {
    display: flex !important;
    justify-content: center !important;
  }
  
  .online-status {
    gap: 5px !important;
  }
  
  .online-text {
    white-space: nowrap !important;
  }
  
  .exam-right-panel .question-counter {
    display: none !important;
  }
  
  .test-box {
    width: 45px !important;
    height: 45px !important;
  }
  
  .question-text {
    font-size: 17px !important;
    margin-top: 0 !important;
  }
  
  .chat-window {
    width: calc(100% - 20px) !important;
    left: 10px !important;
    bottom: 130px !important;
    height: 50vh !important;
  }
  
  #questionCounter.hidden {
    display: none !important;
  }
  
  .bottom-left-container .question-counter {
    display: flex !important;
    justify-content: center !important;
  }
  
  .online-status {
    gap: 5px !important;
  }
  
  .online-text {
    white-space: nowrap !important;
  }
}

.notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--danger);
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
  z-index: 1000;
  animation: slideIn 0.3s ease, fadeOut 0.3s ease 3.7s;
  max-width: 600px;
  text-align: center;
}

@keyframes slideIn {
  from {
    top: -60px;
    opacity: 0;
  }
  to {
    top: 20px;
    opacity: 1;
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
    visibility: hidden;
  }
}

.container{
  width: 100%;
  margin: 0 auto;
  flex: 1;
}

.options-screen {
  background: white;
  border-radius: 10px;
  padding: 30px 40px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.06);
  margin: 0 auto;
  width: 100%;
  max-width: 800px;
  position: relative;
}

@media (max-width: 768px) {
  .options-screen {
    padding: 15px 20px !important;
  }
  
  .option-item {
    padding: 6px 10px !important;
    min-height: 40px !important;
    margin-bottom: 8px !important;
    gap: 8px !important;
  }
  
  .option-item span {
    font-size: 13px !important;
  }
  
  .option-item input[type="checkbox"] {
    width: 14px !important;
    height: 14px !important;
  }
  
  .mode-label {
    font-size: 18px !important;
    margin-bottom: 15px !important;
  }
  
  .start-btn {
    width: 130px !important;
    padding: 8px !important;
    font-size: 13px !important;
    margin: 20px auto 0 !important;
  }
}

.loader-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10;
  border-radius: 10px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #e2e8f0;
  border-top: 4px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loader-text {
  color: var(--muted);
  font-size: 14px;
  font-weight: 500;
}

.start-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.start-btn:disabled:hover {
  transform: none;
  box-shadow: none;
}

.mode-label{
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 30px;
  text-align: center;
  color: #1e293b;
}
.option-item{
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 14px 18px;
  border-radius: 8px;
  transition: all 0.2s;
  cursor: pointer;
  border: 1px solid #e2e8f0;
}
.option-item:hover{
  background-color: #f1f5f9;
  border-color: var(--accent);
  transform: translateY(-2px);
}
.option-item input[type="checkbox"]{
  width: 18px;
  height: 18px;
  cursor: pointer;
}
.option-item span{
  font-size: 16px;
  color: #334155;
  flex: 1;
}
.mode-separator {
  text-align: center;
  margin: 30px 0;
  color: var(--muted);
  font-weight: 600;
  position: relative;
}
.mode-separator::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 1px;
  background: #e2e8f0;
  z-index: 1;
}
.mode-separator span {
  background: white;
  padding: 0 20px;
  position: relative;
  z-index: 2;
}
.start-btn{
  display: block;
  width: 180px;
  margin: 35px auto 0;
  padding: 14px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.start-btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(14, 165, 164, 0.25);
}

.test-screen{
  display: none;
  width: 100%;
  height: 100%;
}
.test-screen.active{
  display: flex;
  flex-direction: column;
}

.vector-arrow {
  display: inline-block;
  vertical-align: middle;
  transition: transform 0.2s;
}

.vector-arrow.prev {
  margin-right: 8px;
}

.vector-arrow.next {
  margin-left: 8px;
}

.nav-btn:hover .vector-arrow.prev {
  transform: translateX(-3px);
}

.nav-btn:hover .vector-arrow.next {
  transform: translateX(3px);
}

@keyframes vanish {
  0% {
    opacity: 1;
    transform: translateX(0);
  }
  100% {
    opacity: 0;
    transform: translateX(100px);
  }
}

.vanish-effect {
  animation: vanish 0.5s ease forwards !important;
}

.question-counter {
  position: fixed;
  bottom: 20px;
  right: 20px;
  font-size: 28px;
  font-weight: 600;
  color: var(--accent);
  z-index: 998;
  display: flex;
  align-items: baseline;
  gap: 2px;
  background: transparent;
  padding: 0;
  cursor: pointer;
}

.question-counter .counter-separator {
  font-size: 28px;
  color: #64748b;
  font-weight: 600;
  margin: 0 2px;
}

.question-counter .total-questions {
  font-size: 28px;
  color: #64748b;
  font-weight: 600;
}

.question-counter .current-question {
  font-size: 28px;
  font-weight: 600;
  color: var(--accent);
  transition: all 0.2s;
  min-width: 50px;
  text-align: center;
}

.question-counter .current-question:hover {
  color: var(--success);
  transform: scale(1.05);
}

.question-counter .current-question.editing {
  color: var(--success);
  transform: scale(1.3);
  font-weight: 700;
  animation: pulse 0.3s ease;
}

.question-counter .counter-separator,
.question-counter .total-questions {
  transform: none !important;
  font-size: 28px !important;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.4); }
  100% { transform: scale(1.3); }
}

.question-container{
  width: 100%;
  flex: 1;
}

.normal-mode-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.question-text{
  font-size: 25px;
  font-weight: 600;
  line-height: 1.5;
  color: #0f172a;
  text-align: center;
  margin-bottom: 25px;
  padding: 0;
  width: 100%;
  margin-top: 0;
}

.username-text {
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
  cursor: pointer;
  padding: 5px 8px;
  transition: all 0.2s;
  display: inline-block;
}

.username-text:hover {
  color: #0891b2;
  text-decoration: underline;
}

/* Remove or comment out the old .username-btn styles */
.username-btn {
  display: none;
}

.answers-container{
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
  margin-bottom: 25px;
  flex: 1;
}

.answer-item{
  padding: 16px 20px;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #e2e8f0;
  font-size: 16px;
  line-height: 1.5;
  width: 100%;
}

.answer-item:hover{
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border-color: var(--accent);
  background-color: #f8fafc;
}

.answer-item.correct{
  background: linear-gradient(135deg, #d1fae5, #f0fdf4);
  border-color: var(--success);
  color: #065f46;
}

.answer-item.incorrect{
  background: linear-gradient(135deg, #fee2e2, #fef2f2);
  border-color: var(--danger);
  color: #991b1b;
}

.answer-item.selected {
  background-color: #677588;
  border-color: #474E57;
}

.answer-item.correct:hover,
.answer-item.incorrect:hover,
.answer-item.selected:hover {
  transform: none;
  cursor: default;
}

.answer-number{
  font-weight: 600;
  margin-right: 10px;
  color: var(--accent);
  font-size: 16px;
}

.feedback{
  padding: 0 10px;
  margin-bottom: 20px;
  text-align: center;
  min-height: 30px;
}

.navigation {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 15px 10px;
  border-top: 1px solid #e2e8f0;
  width: 100%;
  margin-top: auto;
}

.nav-center {
  display: flex;
  gap: 12px;
}

.nav-btn {
  padding: 10px 24px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 100px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.auto-btn{
  background: #f59e0b;
}

.auto-btn:hover{
  background: #d97706;
}

.nav-btn:disabled{
  opacity: 0.5;
  cursor: not-allowed;
}

.nav-btn:hover:not(:disabled){
  opacity: 0.9;
  transform: translateY(-2px);
}

.exam-mode-container {
  width: 100%;
  flex: 1;
  display: flex;
  overflow: hidden;
}

.question-left-panel {
  flex: 1;
  min-width: 0;
  padding-right: 20px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.exam-question-text{
  font-size: 20px;
  font-weight: 600;
  line-height: 1.4;
  color: #0f172a;
  margin-bottom: 15px;
  padding: 0;
  width: 100%;
  max-height: none;
  overflow-y: auto;
}

.exam-answers-container{
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
  margin-bottom: 10px;
  flex: 1;
}

.exam-answer-item{
  padding: 12px 16px;
  border-radius: 6px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #e2e8f0;
  font-size: 15px;
  line-height: 1.4;
  width: 100%;
  min-height: 50px;
  display: flex;
  align-items: center;
}

.exam-answer-item:hover{
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-color: var(--accent);
  background-color: #f8fafc;
}

.exam-answer-item.selected {
  background-color: #CFD8E0;
  border-color: #5B6777;
}

.exam-answer-number{
  font-weight: 600;
  margin-right: 10px;
  color: var(--accent);
  font-size: 15px;
  min-width: 25px;
}

.exam-feedback{
  padding: 0 10px;
  margin-bottom: 15px;
  text-align: center;
  min-height: 25px;
}

.exam-right-panel {
  width: 25%;
  min-width: 300px;
  max-width: 350px;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-left: 20px;
  border-left: 1px solid #e2e8f0;
  height: 100%;
  flex-shrink: 0;
}

.exam-countdown {
  width: 100%;
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: var(--danger);
  margin-bottom: 15px;
  padding: 8px;
  background: #fee2e2;
  border-radius: 6px;
}

.exam-test-boxes {
  display: grid;
  grid-template-columns: repeat(5, 45px);
  justify-content: center;
  gap: 8px;
  width: 100%;
  max-height: calc(100vh - 150px);
  padding: 15px 0;
  overflow-y: auto;
  background: #f8fafc;
  border-radius: 8px;
  grid-auto-rows: 45px;
}

.test-box {
  width: 45px;
  height: 45px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
  background: white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  flex-shrink: 0;
}

.test-box:hover {
  transform: scale(1.1);
  border-color: var(--accent);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.test-box.answered {
  background: #BEEDCF;
  color: #64748b;
  border-color: #94a3b8;
}

.test-box.current {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
  transform: scale(1.1);
}

.exam-navigation-container {
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: auto;
  padding: 15px 0;
  border-top: 1px solid #e2e8f0;
}

.results-history {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 20px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  max-height: 400px;
  overflow-y: auto;
}

.result-item {
  padding: 15px;
  border-radius: 6px;
  border-left: 4px solid;
  background: #f8fafc;
}

.result-item.correct {
  border-left-color: var(--success);
}

.result-item.incorrect {
  border-left-color: var(--danger);
}

.timer-user-container {
  display: flex;
  align-items: center;
  gap: 2px; /* Reduce gap between username and separator */
}

.user-info {
  margin-right: 0; /* Remove any margin */
}

.username-text {
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
  cursor: pointer;
  padding: 5px 0 5px 0; /* Remove right padding, keep left padding for click area */
  transition: all 0.2s;
  display: inline-block;
  direction: rtl; /* Right-to-left text direction */
  text-align: right; /* Align text to the right */
}

#timer {
  display: flex;
  align-items: center;
  gap: 2px; /* Minimal gap between separator and time */
  margin-left: 0; /* Remove any margin */
}

.timer-separator {
  color: #cbd5e1;
  margin: 0; /* Remove all margins */
  padding: 0; /* Remove all padding */
}

.timer-time {
  margin-left: 0; /* Remove left margin */
}

.result-question {
  font-weight: 600;
  margin-bottom: 8px;
  font-size: 14px;
}

.result-answer {
  font-size: 13px;
  color: #64748b;
  margin-bottom: 5px;
}

.result-status {
  font-size: 12px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 4px;
  display: inline-block;
}

.result-status.correct {
  background: #d1fae5;
  color: #065f46;
}

.result-status.incorrect {
  background: #fee2e2;
  color: #991b1b;
}

.bottom-left-container {
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 15px;
}

.bottom-left-container .question-counter {
  display: none;
}

#questionCounter:not(.hidden) {
  display: flex !important;
}

.online-status {
  display: flex;
  align-items: center;
  gap: 8px;
}

.online-dot {
  width: 8px;
  height: 8px;
  background: var(--success);
  border-radius: 50%;
  animation: pulse-online 2s infinite;
}

.online-text {
  font-size: 14px;
  color: #64748b;
}

#onlineCount {
  font-weight: 600;
  color: var(--accent);
}

@keyframes pulse-online {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.chat-button {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(14, 165, 164, 0.3);
  transition: all 0.3s;
  position: relative;
}

.chat-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(14, 165, 164, 0.4);
}

.chat-window {
  position: absolute;
  bottom: 70px;
  left: 0;
  width: 600px;
  height: 80vh;
  max-height: 800px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  display: none;
  flex-direction: column;
  overflow: hidden;
}

.chat-window.active {
  display: flex;
}

.chat-header {
  padding: 12px 16px;
  background: var(--accent);
  color: white;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  flex-shrink: 0;
}

.close-chat {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-messages {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-height: 0;
}

.message {
  max-width: 85%;
  display: flex;
  flex-direction: column;
}

.message.received {
  align-self: flex-start;
}

.message.sent {
  align-self: flex-end;
}

.message-author {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 2px;
  padding: 0 4px;
}

.message-time {
  font-size: 10px;
  color: #94a3b8;
  margin-bottom: 4px;
  padding: 0 4px;
}

.message-content {
  padding: 10px 12px;
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.4;
}

.message.received .message-content {
  background: #f1f5f9;
  color: #1e293b;
}

.message.sent .message-content {
  background: var(--accent);
  color: white;
}

.chat-input-area {
  padding: 12px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

.chat-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #e2e8f0;
  border-radius: 20px;
  font-size: 13px;
}

.send-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: white;
  border-radius: 12px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}

.modal-header {
  font-size: 20px;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 20px;
  text-align: center;
}

.modal-content {
  font-size: 16px;
  color: #64748b;
  margin-bottom: 30px;
  text-align: center;
}

.modal-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.modal-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  min-width: 120px;
}

.modal-btn.confirm {
  background: var(--success);
  color: white;
}

.modal-btn.cancel {
  background: var(--danger);
  color: white;
}

.hidden{
  display: none;
}
</style>
</head>
<body>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
<!-- Enhanced Login/Signup Modal -->
<div id="authModal" class="auth-modal-overlay">
  <div class="auth-modal">
<div class="auth-header">
  <h2>
    UniMed
    <span class="medical-symbol">⚕</span>
  </h2>
</div>
    
    <div id="authTabs" class="auth-tabs">
      <button class="auth-tab active" data-tab="guest">სტუმარი</button>
      <button class="auth-tab" data-tab="login">ავტორიზაცია</button>
      <button class="auth-tab" data-tab="signup">რეგისტრაცია</button>
    </div>
    
    <div id="authContent" class="auth-content">
      <!-- Guest Tab (Default) -->
      <div id="guestTab" class="auth-tab-content active">
        <div class="auth-form">
          <div class="form-group">
          </div>
<button id="continueAsGuest" class="auth-btn guest-btn" style="display: flex; align-items: center; justify-content: center;">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="white"/>
  </svg>
  გაგრძელება, როგორც სტუმარი
</button>
          <div class="auth-divider">
            <span>ან</span>
          </div>
          <button id="showLoginFromGuest" class="auth-switch-btn" style="text-decoration: none;">შესვლა</button>
        </div>
      </div>
      
      <!-- Login Tab -->
      <div id="loginTab" class="auth-tab-content">
        <div class="auth-form">
          <div class="form-group">
            <input type="text" id="loginUsername" class="auth-input" placeholder="მომხმარებლის სახელი">
            <div id="loginUsernameError" class="form-error"></div>
          </div>
          <div class="form-group">
            <input type="password" id="loginPassword" class="auth-input" placeholder="პაროლი">
            <button type="button" class="password-toggle" data-target="loginPassword">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="loginPasswordError" class="form-error"></div>
          </div>
<button id="loginBtn" class="auth-btn login-btn" style="display: flex; align-items: center; justify-content: center;">
  შესვლა
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-left: 8px; display: block;">
    <path d="M13 16l4-4m0 0l-4-4m4 4H3m5 4v1a3 3 0 003 3h7a3 3 0 003-3V7a3 3 0 00-3-3h-7a3 3 0 00-3 3v1" stroke="white" stroke-width="2"/>
  </svg>
</button>
          <button id="showSignupFromLogin" class="auth-switch-btn" style="text-decoration: none;">რეგისტრაცია</button>
        </div>
      </div>
      
      <!-- Signup Tab -->
      <div id="signupTab" class="auth-tab-content">
        <div class="auth-form">
          <div class="form-group">
            <label class="form-label">მომხმარებლის სახელი</label>
            <input type="text" id="signupUsername" class="auth-input" placeholder="მომხმარებელი">
            <div id="signupUsernameError" class="form-error"></div>
          </div>
          <div class="form-group">
            <label class="form-label">პაროლი (მინიმუმ 6 სიმბოლო)</label>
            <input type="password" id="signupPassword" class="auth-input" placeholder="შეიტანეთ პაროლი">
            <button type="button" class="password-toggle" data-target="signupPassword">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="signupPasswordError" class="form-error"></div>
          </div>
          <div class="form-group">
            <label class="form-label">გაიმეორეთ პაროლი</label>
            <input type="password" id="signupConfirmPassword" class="auth-input" placeholder="პაროლი">
            <button type="button" class="password-toggle" data-target="signupConfirmPassword">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="signupConfirmError" class="form-error"></div>
          </div>
<button id="signupBtn" class="auth-btn signup-btn" style="display: flex; align-items: center; justify-content: center;">
  რეგისტრაცია
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-left: 8px; display: block;">
    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke="white" stroke-width="2"/>
  </svg>
</button>
          <button id="showLoginFromSignup" class="auth-switch-btn" style="text-decoration: none;">შესვლა</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Timer and User Info Container -->
<div class="timer-user-container">
  <div id="userInfo" class="user-info" style="display: none;">
    <div class="user-menu">
      <span id="usernameBtn" class="username-text">
        <span id="usernameDisplay"></span>
      </span>
      <div id="userDropdown" class="user-dropdown">
        <button class="user-dropdown-item" id="changePasswordBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
            <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke="currentColor" stroke-width="2"/>
          </svg>
          პაროლის შეცვლა
        </button>
        <button class="user-dropdown-item" id="settingsBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
            <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
          </svg>
          პარამეტრები
        </button>
        <button class="user-dropdown-item" id="wrongQuestionsBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          შეცდომების გაკეთება
        </button>
        <button class="user-dropdown-item" id="signOutBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          გასვლა
        </button>
      </div>
    </div>
  </div>
  
  <div id="timer"></div>
</div>

<!-- Chat and Online Status Container -->
<div class="bottom-left-container">
  <!-- Chat Button -->
<button id="chatButton" class="chat-button">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="white"/>
  </svg>
  ჩატი
  <div id="chatNotification" class="chat-notification" style="display: none;"></div>
</button>
  
  <!-- Question Counter - Bottom Right Corner (Visible in normal mode) -->
<div id="questionCounter" class="question-counter hidden">
  <div id="currentQuestion" class="current-question">1</div>
  <div class="counter-separator">/</div>
  <div id="totalQuestions" class="total-questions">0</div>
</div>

  <!-- Online Status - Next to chat button -->
  <div class="online-status">
    <div class="online-dot"></div>
    <span class="online-text">ონლაინ: <span id="onlineCount">1</span></span>
  </div>
  
  <!-- Chat Window - 80% height -->
  <div id="chatWindow" class="chat-window">
    <div class="chat-header">
      <span>ჩატი</span>
<button class="close-chat">
  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M18 6L6 18M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>
</div>
    <div id="chatMessages" class="chat-messages">
      <!-- Messages will be inserted here -->
    </div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" class="chat-input" placeholder="დაწერეთ...">
      <button id="sendBtn" class="send-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="white"/>
        </svg>
      </button>
    </div>
  </div>
</div>
  
  <!-- Modal for Detailed Results -->
  <div id="detailedResultsModal" class="modal-overlay">
    <div class="modal" style="max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header" style="margin-bottom: 20px;">დეტალური შედეგები</div>
      <div id="detailedResultsContent" style="flex: 1; overflow-y: auto; padding-right: 10px;">
        <!-- Detailed results will be inserted here -->
      </div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button id="closeDetailsBtn" class="modal-btn confirm">დახურვა</button>
      </div>
    </div>
  </div>
  
<div class="container">
    <!-- Options Screen -->
    <div id="optionsScreen" class="options-screen">
      <div class="mode-label">აირჩიეთ რეჟიმი:</div>
      
      <!-- Test Type Selection -->
      <div class="option-row">
        <div class="option-item-half" style="display: flex; flex-direction: column;">
          <label style="font-size: 14px; color: #64748b; margin-bottom: 5px;">მოდული:</label>
          <select id="testTypeSelect" class="topic-select">
            <option value="" selected disabled hidden>აირჩიეთ</option>
            <option value="rezidentura">რეზიდენტურა</option>
            <option value="cardiology" disabled>სალიცენზიო კარდიოლოგია (მალე)</option>
            <option value="neurology" disabled>სალიცენზიო ნევროლოგია (მალე)</option>
          </select>
        </div>
      </div>
      
      <!-- Two-column layout for sequential and topic filter -->
<div class="option-row">
  <label class="option-item option-item-half">
    <input type="checkbox" id="modeSequential" checked>
    <span>ტესტების ჩვენება თანმიმდევრობით</span>
  </label>
  
  <div id="topicsDropdownContainer" class="option-item-half" style="display: flex; flex-direction: column;">
    <select id="topicsSelect" class="topic-select">
      <option value="all" selected>ტესტები თემების მიხედვით</option>
    </select>
  </div>
</div>
      
      <label class="option-item">
        <input type="checkbox" id="modeShuffleQuestions">
        <span>ტესტების არევა</span>
      </label>
      
      <label class="option-item">
        <input type="checkbox" id="modeShuffleAnswers">
        <span>პასუხების არევა</span>
      </label>
      
      <div class="mode-separator">
        <span>საგამოცდო რეჟიმი</span>
      </div>
      
      <label class="option-item">
        <input type="checkbox" id="modeExam">
        <span>საგამოცდო რეჟიმი (200 შემთხვევითი ტესტი, დრო 3 საათი)</span>
      </label>
      
      <div id="loaderOverlay" class="loader-overlay">
        <div class="spinner"></div>
        <div class="loader-text">იტვირთება...</div>
      </div>
      
      <button id="startBtn" class="start-btn" disabled>დაწყება</button>
    </div>

    <div id="testScreen" class="test-screen">
      <div id="normalModeContainer" class="normal-mode-container hidden">
        <div id="questionText" class="question-text">იტვირთება...</div>
        
        <div id="answersContainer" class="answers-container"></div>
        
        <div id="feedback" class="feedback"></div>
        
        <div class="navigation">
          <div class="nav-center">
            <button id="prevBtn" class="nav-btn">
              <svg class="vector-arrow prev" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              წინა
            </button>
            <button id="nextBtn" class="nav-btn">
              შემდეგი
              <svg class="vector-arrow next" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button id="autoBtn" class="nav-btn auto-btn">Auto</button>
          </div>
        </div>
      </div>
      
      <div id="examModeContainer" class="exam-mode-container hidden">
        <div class="question-left-panel">
          <div id="examQuestionText" class="exam-question-text">იტვირთება...</div>
          
          <div id="examAnswersContainer" class="exam-answers-container"></div>
          
          <div id="examFeedback" class="exam-feedback"></div>
          
          <div class="exam-navigation-container">
            <div class="nav-center">
              <button id="examPrevBtn" class="nav-btn">
                <svg class="vector-arrow prev" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                წინა
              </button>
              <button id="examFinishBtn" class="nav-btn" style="background: var(--danger);">
                გამოცდის დასრულება
              </button>
              <button id="examNextBtn" class="nav-btn">
                შემდეგი
                <svg class="vector-arrow next" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button id="examAutoBtn" class="nav-btn auto-btn">Auto</button>
            </div>
          </div>
        </div>
        
        <div id="examRightPanel" class="exam-right-panel hidden">
          <div id="examCountdown" class="exam-countdown">03:00:00</div>
          
          <div id="examTestBoxes" class="exam-test-boxes"></div>
        </div>
      </div>
    </div>
  </div>

<script>
// ==================== FIREBASE INITIALIZATION ====================
let database = null;
let firebaseInitialized = false;

try {
  const firebaseConfig = {
    apiKey: "AIzaSyAOyV8LZWBkU5W8UbTF082l1ft1T2Rj1Yc",
    authDomain: "rezidentura-7bfd5.firebaseapp.com",
    databaseURL: "https://rezidentura-7bfd5-default-rtdb.firebaseio.com",
    projectId: "rezidentura-7bfd5",
    storageBucket: "rezidentura-7bfd5.firebasestorage.app",
    messagingSenderId: "1005787481414",
    appId: "1:1005787481414:web:7c5a31471a3d1c1a159147",
    measurementId: "G-VPECPS9CEP"
  };

  if (typeof firebase !== 'undefined') {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    database = firebase.database();
    firebaseInitialized = true;
    console.log("Firebase initialized successfully");
  }
} catch (error) {
  console.warn("Firebase initialization failed, chat will work in local mode:", error);
}

// ==================== ENHANCED USER MANAGEMENT ====================
let currentUser = null;
let currentTestType = null;
let userProgress = {
  rezidentura: {
    normal: {},
    exam: {},
    wrongQuestions: []
  }
};

// ==================== GLOBAL VARIABLES ====================
let allTests = [];
let sessionTests = [];
let currentIndex = 0;
let autoMode = false;
let examMode = false;
let examTimeRemaining = 3 * 60 * 60;
let examTimerInterval = null;
let isEditingQuestionNumber = false;
let allTestsWithTopics = [];
let availableTopics = new Set();
let selectedTopic = null;

// Chat global variables
let chatMessages = [];
let onlineUsers = 1;
let userName = localStorage.getItem('chatUserName') || ('სტუმარი ' + Math.floor(Math.random() * 1000));
let userId = localStorage.getItem('chatUserId');
let isOnline = false;
let displayedMessageKeys = new Set();
let unreadMessagesCount = 0;
let isChatOpen = false;
let lastSeenMessageTime = Date.now();

if (!userId) {
  userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('chatUserId', userId);
}

if (!localStorage.getItem('chatUserName')) {
  localStorage.setItem('chatUserName', userName);
}

// ==================== DOM ELEMENTS ====================
const optionsScreen = document.getElementById('optionsScreen');
const testScreen = document.getElementById('testScreen');
const questionText = document.getElementById('questionText');
const answersContainer = document.getElementById('answersContainer');
const feedback = document.getElementById('feedback');
const startBtn = document.getElementById('startBtn');
const timerElement = document.getElementById('timer');
const examRightPanel = document.getElementById('examRightPanel');
const examCountdown = document.getElementById('examCountdown');
const examTestBoxes = document.getElementById('examTestBoxes');
const questionCounter = document.getElementById('questionCounter');
const currentQuestionEl = document.getElementById('currentQuestion');
const totalQuestionsEl = document.getElementById('totalQuestions');
const loaderOverlay = document.getElementById('loaderOverlay');

// Chat elements - will be assigned in DOMContentLoaded
let chatButton, chatWindow, closeChat, chatMessagesEl, onlineCount, chatInput, sendBtn;

const modeSequential = document.getElementById('modeSequential');
const modeShuffleQuestions = document.getElementById('modeShuffleQuestions');
const modeShuffleAnswers = document.getElementById('modeShuffleAnswers');
const modeExam = document.getElementById('modeExam');

const normalModeContainer = document.getElementById('normalModeContainer');
const examModeContainer = document.getElementById('examModeContainer');
const examQuestionText = document.getElementById('examQuestionText');
const examAnswersContainer = document.getElementById('examAnswersContainer');
const examFeedback = document.getElementById('examFeedback');

// Navigation button declarations
let prevBtn, nextBtn, autoBtn;
let examPrevBtn, examNextBtn, examAutoBtn, examFinishBtn;
let detailedResultsModal = document.getElementById('detailedResultsModal');
let detailedResultsContent = document.getElementById('detailedResultsContent');

// ==================== USER PROGRESS FUNCTIONS ====================
function saveUserProgress() {
  if (currentUser && currentUser.username && currentTestType && !currentUser.isGuest) {
    try {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (users[currentUser.username]) {
        users[currentUser.username].progress = userProgress;
        localStorage.setItem('users', JSON.stringify(users));
        console.log('Progress saved for', currentUser.username);
      }
    } catch (error) {
      console.error('Error saving user progress:', error);
    }
  }
}

function loadUserProgress() {
  if (currentUser && currentUser.username) {
    try {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (users[currentUser.username] && users[currentUser.username].progress) {
        userProgress = users[currentUser.username].progress;
        console.log('Progress loaded for', currentUser.username);
      }
    } catch (error) {
      console.error('Error loading user progress:', error);
    }
  }
}

function updateUserProgress(questionId, selectedAnswer, isCorrect, isExamMode = false) {
  if (!currentUser || currentUser.isGuest || !currentTestType) return;
  
  const mode = isExamMode ? 'exam' : 'normal';
  
  if (!userProgress[currentTestType]) {
    userProgress[currentTestType] = {
      normal: { answeredQuestions: {}, currentIndex: 0 },
      exam: { answeredQuestions: {}, currentIndex: 0 },
      wrongQuestions: []
    };
  }
  
  if (!userProgress[currentTestType][mode]) {
    userProgress[currentTestType][mode] = { answeredQuestions: {}, currentIndex: 0 };
  }
  
  userProgress[currentTestType][mode].answeredQuestions[questionId] = {
    selectedAnswer: selectedAnswer,
    isCorrect: isCorrect,
    timestamp: Date.now()
  };
  
  if (!isCorrect) {
    if (!userProgress[currentTestType].wrongQuestions.includes(questionId)) {
      userProgress[currentTestType].wrongQuestions.push(questionId);
    }
  } else {
    const index = userProgress[currentTestType].wrongQuestions.indexOf(questionId);
    if (index > -1) {
      userProgress[currentTestType].wrongQuestions.splice(index, 1);
    }
  }
  
  saveUserProgress();
}

function getWrongQuestions() {
  if (!currentUser || currentUser.isGuest || !currentTestType) return [];
  return userProgress[currentTestType]?.wrongQuestions || [];
}

function startWrongQuestionsMode() {
  if (!currentUser || currentUser.isGuest) {
    showNotification('მხოლოდ რეგისტრირებულ მომხმარებლებს შეუძლიათ შეცდომების გაკეთება');
    return;
  }
  
  const wrongQuestions = getWrongQuestions();
  if (wrongQuestions.length === 0) {
    showNotification('თქვენ არ გაქვთ შეცდომები გასასწორებლად!', false);
    return;
  }
  
  const wrongTests = allTestsWithTopics.filter((test, index) => 
    wrongQuestions.includes(index.toString())
  );
  
  if (wrongTests.length === 0) {
    showNotification('შეცდომები ვერ მოიძებნა');
    return;
  }
  
  sessionTests = wrongTests.map((t, idx) => ({ 
    id: idx.toString(),
    question: t.question, 
    answers: t.answers.map(a => ({...a})),
    selectedAnswers: [],
    hasCorrectAnswer: false,
    isComplete: false,
    isAnswerCorrect: null
  }));
  
  currentIndex = 0;
  examMode = false;
  
  optionsScreen.style.display = 'none';
  testScreen.classList.add('active');
  normalModeContainer.classList.remove('hidden');
  examModeContainer.classList.add('hidden');
  examRightPanel.classList.add('hidden');
  
  questionCounter.classList.remove('hidden');
  currentQuestionEl.textContent = currentIndex + 1;
  totalQuestionsEl.textContent = sessionTests.length;
  
  timerElement.classList.remove('hidden');
  
  showNotification(`დაწყებულია შეცდომების გაკეთების რეჟიმი: ${wrongTests.length} კითხვა`);
  
  renderCurrentQuestion();
}

// ==================== AUTH FUNCTIONS ====================
function initAuth() {
  document.getElementById('authModal').style.display = 'flex';
  
  document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      document.querySelectorAll('.auth-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + 'Tab').classList.add('active');
    });
  });
  
  document.querySelectorAll('.password-toggle').forEach(btn => {
    btn.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const input = document.getElementById(targetId);
      if (input.type === 'password') {
        input.type = 'text';
        this.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="1" y1="1" x2="23" y2="23" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
      } else {
        input.type = 'password';
        this.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
      }
    });
  });
  
  document.getElementById('continueAsGuest').addEventListener('click', () => {
    currentUser = { 
      username: 'სტუმარი ' + Math.floor(Math.random() * 1000), 
      isGuest: true,
      progress: {}
    };
    
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('usernameDisplay').textContent = currentUser.username;
    
    userName = currentUser.username;
    localStorage.setItem('chatUserName', userName);
    
    loadCSV();
    initChat();
    updateTimerDisplay();
    
    showNotification('კეთილი იყოს თქვენი მობრძანება!', false);
  });
  
  document.getElementById('showLoginFromGuest').addEventListener('click', () => {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
    
    const loginTab = document.querySelector('[data-tab="login"]');
    if (loginTab) {
      loginTab.classList.add('active');
      document.getElementById('loginTab').classList.add('active');
    }
  });
  
  document.getElementById('loginBtn').addEventListener('click', handleLogin);
  document.getElementById('signupBtn').addEventListener('click', handleSignup);
  
  document.getElementById('showSignupFromLogin').addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
    
    const signupTab = document.querySelector('[data-tab="signup"]');
    if (signupTab) {
      signupTab.classList.add('active');
      document.getElementById('signupTab').classList.add('active');
    }
  });
  
  document.getElementById('showLoginFromSignup').addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
    
    const loginTab = document.querySelector('[data-tab="login"]');
    if (loginTab) {
      loginTab.classList.add('active');
      document.getElementById('loginTab').classList.add('active');
    }
  });
}

// ==================== AUTH FUNCTIONS ====================
function handleLogin() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  document.getElementById('loginUsernameError').style.display = 'none';
  document.getElementById('loginPasswordError').style.display = 'none';
  
  if (!username) {
    document.getElementById('loginUsernameError').textContent = 'მომხმარებლის სახელი აუცილებელია';
    document.getElementById('loginUsernameError').style.display = 'block';
    return;
  }
  
  if (!password) {
    document.getElementById('loginPasswordError').textContent = 'პაროლი აუცილებელია';
    document.getElementById('loginPasswordError').style.display = 'block';
    return;
  }
  
  try {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    
    if (!users[username]) {
      document.getElementById('loginUsernameError').textContent = 'ასეთი მომხმარებელი არ არსებობს';
      document.getElementById('loginUsernameError').style.display = 'block';
      return;
    }
    
    if (users[username].password !== password) {
      document.getElementById('loginPasswordError').textContent = 'პაროლი არასწორია';
      document.getElementById('loginPasswordError').style.display = 'block';
      return;
    }
    
    // FIX: Properly set currentUser with correct structure
    currentUser = { 
      username: username, 
      isGuest: false,
      progress: users[username].progress || {
        rezidentura: {
          normal: { answeredQuestions: {}, currentIndex: 0 },
          exam: { answeredQuestions: {}, currentIndex: 0 },
          wrongQuestions: []
        }
      }
    };
    
    // FIX: Load progress after setting currentUser
    loadUserProgress();
    
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    
    // FIX: Close modal and start app
    document.getElementById('authModal').style.display = 'none';
    
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('usernameDisplay').textContent = currentUser.username;
    
    userName = currentUser.username;
    localStorage.setItem('chatUserName', userName);
    
    showNotification('წარმატებით შეხვედით სისტემაში!', false);
    
    // FIX: Load CSV and enable start button
    loadCSV();
    initChat();
    bindUserMenuEvents();
    updateTimerDisplay();
    
  } catch (error) {
    console.error('Login error:', error);
    showNotification('შეცდომა შესვლის დროს. სცადეთ მოგვიანებით');
  }
}

// FIX: Update startBtn event listener
startBtn.addEventListener('click', () => {
  if (!allTests.length){ 
    showNotification('ტესტები არ იძებნება');
    return; 
  }
  
  const testTypeSelect = document.getElementById('testTypeSelect');
  if (!testTypeSelect || testTypeSelect.value === '') {
    showNotification('გთხოვთ აირჩიოთ მოდული');
    return;
  }
  
  // FIX: Store test type properly
  currentTestType = testTypeSelect.value;
  
  if (currentTestType === 'rezidentura') {
    const topicsSelect = document.getElementById('topicsSelect');
    if (topicsSelect && (!topicsSelect.value || topicsSelect.value === '')) {
      showNotification('გთხოვთ აირჩიოთ თემა!');
      return;
    }
  }
  
  // FIX: Check if user is logged in correctly
  if (currentUser && !currentUser.isGuest && currentTestType) {
    console.log("User logged in, starting test...", currentUser);
    // Load the progress first
    loadUserProgress();
    
    const progress = userProgress[currentTestType];
    const hasProgress = progress && (
      (progress.normal && Object.keys(progress.normal.answeredQuestions || {}).length > 0) ||
      (progress.exam && Object.keys(progress.exam.answeredQuestions || {}).length > 0)
    );
    
    if (hasProgress && !window.savedProgress) {
      showContinueOrRestartModal(progress);
      return;
    } else {
      // If no progress or already handled, start the test
      startTest();
    }
  } else {
    // Guest user - just start
    console.log("Guest user, starting test...");
    startTest();
  }
});

// FIX: Update startApp function
function startApp() {
  document.getElementById('authModal').style.display = 'none';
  
  if (!currentUser.isGuest) {
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('usernameDisplay').textContent = currentUser.username;
    loadUserProgress();
    userName = currentUser.username;
    localStorage.setItem('chatUserName', userName);
  }
  
  loadCSV();
  initChat();
  bindUserMenuEvents();
  updateTimerDisplay();
}

// FIX: Add this function to ensure test type is properly set
function updateCurrentTestType() {
  const testTypeSelect = document.getElementById('testTypeSelect');
  if (testTypeSelect && testTypeSelect.value) {
    currentTestType = testTypeSelect.value;
    console.log("Test type updated:", currentTestType);
  }
}

// FIX: Add event listener for test type change
document.addEventListener('DOMContentLoaded', () => {
  const testTypeSelect = document.getElementById('testTypeSelect');
  if (testTypeSelect) {
    testTypeSelect.addEventListener('change', function() {
      currentTestType = this.value;
      console.log("Test type changed to:", currentTestType);
    });
  }
});

function handleSignup() {
  const username = document.getElementById('signupUsername').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupConfirmPassword').value;
  
  document.getElementById('signupUsernameError').style.display = 'none';
  document.getElementById('signupPasswordError').style.display = 'none';
  document.getElementById('signupConfirmError').style.display = 'none';
  
  if (!username) {
    document.getElementById('signupUsernameError').textContent = 'მომხმარებლის სახელი აუცილებელია';
    document.getElementById('signupUsernameError').style.display = 'block';
    return;
  }
  
  if (username.length < 3) {
    document.getElementById('signupUsernameError').textContent = 'აუცილებელია მინიმუმ 3 სიმბოლო';
    document.getElementById('signupUsernameError').style.display = 'block';
    return;
  }
  
  if (/[^a-zA-Z0-9ა-ჰ_]/.test(username)) {
    document.getElementById('signupUsernameError').textContent = 'მომხმარებლის სახელი უნდა შეიცავდეს მხოლოდ ასოებს, ციფრებს და ქართულ ასოებს';
    document.getElementById('signupUsernameError').style.display = 'block';
    return;
  }
  
  if (!password) {
    document.getElementById('signupPasswordError').textContent = 'პაროლი აუცილებელია';
    document.getElementById('signupPasswordError').style.display = 'block';
    return;
  }
  
  if (password.length < 6) {
    document.getElementById('signupPasswordError').textContent = 'პაროლი უნდა იყოს მინიმუმ 6 სიმბოლო';
    document.getElementById('signupPasswordError').style.display = 'block';
    return;
  }
  
  if (!confirmPassword) {
    document.getElementById('signupConfirmError').textContent = 'გაიმეორეთ პაროლი!';
    document.getElementById('signupConfirmError').style.display = 'block';
    return;
  }
  
  if (password !== confirmPassword) {
    document.getElementById('signupConfirmError').textContent = 'პაროლი არ ემთხვევა';
    document.getElementById('signupConfirmError').style.display = 'block';
    return;
  }
  
  try {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    
    if (users[username]) {
      document.getElementById('signupUsernameError').textContent = 'მსგავსი მომხმარებელი უკვე არსებობს';
      document.getElementById('signupUsernameError').style.display = 'block';
      return;
    }
    
    users[username] = {
      password: password,
      progress: {
        rezidentura: {
          normal: { answeredQuestions: {}, currentIndex: 0 },
          exam: { answeredQuestions: {}, currentIndex: 0 },
          wrongQuestions: []
        }
      }
    };
    
    localStorage.setItem('users', JSON.stringify(users));
    
    document.getElementById('signupUsername').value = '';
    document.getElementById('signupPassword').value = '';
    document.getElementById('signupConfirmPassword').value = '';
    
    showNotification('რეგისტრაცია წარმატებულია! შეგიძლიათ შეხვიდეთ', false);
    
    setTimeout(() => {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
      
      const loginTab = document.querySelector('[data-tab="login"]');
      if (loginTab) {
        loginTab.classList.add('active');
        document.getElementById('loginTab').classList.add('active');
      }
      
      document.getElementById('loginUsername').value = username;
      document.getElementById('loginPassword').focus();
    }, 1000);
    
  } catch (error) {
    console.error('Signup error:', error);
    showNotification('შეცდომა რეგისტრაციის დროს. სცადეთ მოგვიანებით');
  }
}

function startApp() {
  document.getElementById('authModal').style.display = 'none';
  
  if (!currentUser.isGuest) {
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('usernameDisplay').textContent = currentUser.username;
    loadUserProgress();
  }
  
  loadCSV();
  initChat();
  bindUserMenuEvents();
  updateTimerDisplay();
}

function bindUserMenuEvents() {
  const usernameBtn = document.getElementById('usernameBtn');
  const userDropdown = document.getElementById('userDropdown');
  
  if (usernameBtn) {
    usernameBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      userDropdown.classList.toggle('show');
    });
    
    document.addEventListener('click', () => {
      userDropdown.classList.remove('show');
    });
  }
  
  document.getElementById('wrongQuestionsBtn').addEventListener('click', () => {
    startWrongQuestionsMode();
    userDropdown.classList.remove('show');
  });
  
  document.getElementById('changePasswordBtn').addEventListener('click', () => {
    showPasswordChangeModal();
    userDropdown.classList.remove('show');
  });
  
  document.getElementById('settingsBtn').addEventListener('click', () => {
    showNotification('პარამეტრები მალე იქნება ხელმისაწვდომი', false);
    userDropdown.classList.remove('show');
  });
  
  document.getElementById('signOutBtn').addEventListener('click', () => {
    saveUserProgress();
    currentUser = null;
    location.reload();
  });
}

function showPasswordChangeModal() {
  const modalHTML = `
    <div class="modal-overlay active">
      <div class="modal">
        <div class="modal-header">პაროლის შეცვლა</div>
        <div class="modal-content">
          <div style="margin-bottom: 20px;">
            <input type="password" id="currentPassword" placeholder="მიმდინარე პაროლი" class="auth-input" style="margin-bottom: 10px;">
            <input type="password" id="newPassword" placeholder="ახალი პაროლი (მინიმუმ 6 სიმბოლო)" class="auth-input" style="margin-bottom: 10px;">
            <input type="password" id="confirmNewPassword" placeholder="გაიმეორეთ ახალი პაროლი" class="auth-input">
          </div>
        </div>
        <div class="modal-buttons">
          <button id="savePasswordBtn" class="modal-btn confirm">შენახვა</button>
          <button id="cancelPasswordBtn" class="modal-btn cancel">გაუქმება</button>
        </div>
      </div>
    </div>
  `;
  
  const modalContainer = document.createElement('div');
  modalContainer.innerHTML = modalHTML;
  document.body.appendChild(modalContainer.firstChild);
  
  document.getElementById('savePasswordBtn').addEventListener('click', () => {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
      showNotification('გთხოვთ შეავსოთ ყველა ველი');
      return;
    }
    
    if (newPassword.length < 6) {
      showNotification('ახალი პაროლი უნდა იყოს მინიმუმ 6 სიმბოლო');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      showNotification('ახალი პაროლები არ ემთხვევა');
      return;
    }
    
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    if (users[currentUser.username]?.password !== currentPassword) {
      showNotification('მიმდინარე პაროლი არასწორია');
      return;
    }
    
    users[currentUser.username].password = newPassword;
    localStorage.setItem('users', JSON.stringify(users));
    showNotification('პაროლი წარმატებით შეიცვალა', false);
    modalContainer.remove();
  });
  
  document.getElementById('cancelPasswordBtn').addEventListener('click', () => {
    modalContainer.remove();
  });
}

function showContinueOrRestartModal(progress) {
  const hasNormal = progress.normal && Object.keys(progress.normal.answeredQuestions || {}).length > 0;
  const hasExam = progress.exam && Object.keys(progress.exam.answeredQuestions || {}).length > 0;
  
  let message = '';
  if (hasNormal && hasExam) {
    message = 'თქვენ გაქვთ შენახული პროგრესი როგორც ნორმალურ, ასევე საგამოცდო რეჟიმში.';
  } else if (hasNormal) {
    message = 'თქვენ გაქვთ შენახული პროგრესი ნორმალურ რეჟიმში.';
  } else if (hasExam) {
    message = 'თქვენ გაქვთ შენახული პროგრესი საგამოცდო რეჟიმში.';
  }
  
  const modalHTML = `
    <div class="modal-overlay active">
      <div class="modal">
        <div class="modal-header">გაგრძელება</div>
        <div class="modal-content">
          <p>${message}</p>
          <p>როგორ გსურთ გააგრძელოთ?</p>
          <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>ნორმალური რეჟიმი:</span>
              <span style="font-weight: 600;">${hasNormal ? Object.keys(progress.normal.answeredQuestions || {}).length + ' კითხვა უპასუხია' : 'არ არის დაწყებული'}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>საგამოცდო რეჟიმი:</span>
              <span style="font-weight: 600;">${hasExam ? Object.keys(progress.exam.answeredQuestions || {}).length + ' კითხვა უპასუხია' : 'არ არის დაწყებული'}</span>
            </div>
          </div>
        </div>
        <div class="modal-buttons">
          <button id="continueBtn" class="modal-btn confirm">გაგრძელება</button>
          <button id="restartBtnModal" class="modal-btn cancel">ახლიდან დაწყება</button>
        </div>
      </div>
    </div>
  `;
  
  const modalContainer = document.createElement('div');
  modalContainer.innerHTML = modalHTML;
  document.body.appendChild(modalContainer.firstChild);
  
  document.getElementById('continueBtn').addEventListener('click', () => {
    window.savedProgress = progress;
    modalContainer.remove();
    if (typeof startTest === 'function') {
      startTest();
    }
  });
  
  document.getElementById('restartBtnModal').addEventListener('click', () => {
    if (currentUser && currentUser.username) {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (users[currentUser.username] && users[currentUser.username].progress) {
        delete users[currentUser.username].progress[currentTestType];
        localStorage.setItem('users', JSON.stringify(users));
        userProgress[currentTestType] = {
          normal: { answeredQuestions: {}, currentIndex: 0 },
          exam: { answeredQuestions: {}, currentIndex: 0 },
          wrongQuestions: []
        };
      }
    }
    modalContainer.remove();
    showNotification('პროგრესი წაიშალა. შეგიძლიათ ახლიდან დაიწყოთ.', false);
    if (typeof startTest === 'function') {
      startTest();
    }
  });
}

// ==================== CHAT FUNCTIONS ====================
function initChat() {
  console.log("Initializing chat...");
  
  if (!chatMessagesEl || !chatButton || !chatWindow) {
    console.error("Chat elements not initialized yet");
    return;
  }
  
  chatMessagesEl.innerHTML = '';
  onlineCount.textContent = '1';
  
  if (currentUser && currentUser.username) {
    userName = currentUser.username;
    localStorage.setItem('chatUserName', userName);
  }
  
  if (firebaseInitialized && database) {
    console.log("Setting up Firebase chat...");
    setupFirebaseListeners();
  } else {
    console.log("Using local chat mode");
    loadLocalMessagesAsFallback();
  }
  
  // Remove existing listeners before adding new ones
  chatButton.replaceWith(chatButton.cloneNode(true));
  closeChat.replaceWith(closeChat.cloneNode(true));
  sendBtn.replaceWith(sendBtn.cloneNode(true));
  
  // Re-get the elements after cloning
  chatButton = document.getElementById('chatButton');
  closeChat = document.querySelector('.close-chat');
  sendBtn = document.getElementById('sendBtn');
  chatInput = document.getElementById('chatInput');
  
  chatButton.addEventListener('click', () => {
    chatWindow.classList.toggle('active');
    if (chatWindow.classList.contains('active')) {
      isChatOpen = true;
      unreadMessagesCount = 0;
      updateChatNotification();
      chatInput.focus();
      
      setTimeout(() => {
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      }, 100);
    } else {
      isChatOpen = false;
    }
  });
  
  closeChat.addEventListener('click', () => {
    chatWindow.classList.remove('active');
    isChatOpen = false;
  });
  
  sendBtn.addEventListener('click', sendMessageToFirebase);
  
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessageToFirebase();
  });
}

function setupFirebaseListeners() {
  try {
    displayedMessageKeys.clear();
    
    database.ref('chat/messages').limitToLast(50).once('value').then((snapshot) => {
      if (snapshot.exists()) {
        const messages = [];
        
        snapshot.forEach((childSnapshot) => {
          const message = childSnapshot.val();
          const messageKey = childSnapshot.key;
          messages.push({ ...message, key: messageKey });
        });
        
        messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        
        messages.forEach(msg => {
          displayedMessageKeys.add(msg.key);
          const isMyMessage = msg.userId === userId;
          addMessageToChat(msg.author, msg.text, isMyMessage, new Date(msg.timestamp));
          lastSeenMessageTime = Math.max(lastSeenMessageTime, msg.timestamp || 0);
        });
        
        setTimeout(() => {
          if (isChatOpen) {
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
          }
        }, 200);
      }
    }).catch(error => {
      console.error('Error loading initial messages:', error);
      loadLocalMessagesAsFallback();
    });
    
    database.ref('chat/messages').limitToLast(1).on('child_added', (snapshot) => {
      const message = snapshot.val();
      const messageKey = snapshot.key;
      
      if (displayedMessageKeys.has(messageKey)) {
        return;
      }
      
      displayedMessageKeys.add(messageKey);
      const isMyMessage = message.userId === userId;
      
      if (!isMyMessage) {
        const messageTime = message.timestamp || Date.now();
        addMessageToChat(message.author, message.text, false, new Date(messageTime));
        lastSeenMessageTime = Math.max(lastSeenMessageTime, messageTime);
      }
    });
    
    database.ref('chat/onlineUsers').on('value', (snapshot) => {
      if (snapshot.exists()) {
        const users = snapshot.val();
        const now = Date.now();
        let activeUsers = 1;
        
        Object.keys(users).forEach(key => {
          if (users[key]?.userId !== userId && 
              users[key]?.lastSeen && 
              (now - users[key].lastSeen) < 30000) {
            activeUsers++;
          }
        });
        
        onlineCount.textContent = activeUsers.toString();
      } else {
        onlineCount.textContent = '1';
      }
    });
    
    setUserOnline();
    
  } catch (error) {
    console.error("Firebase listener error:", error);
    loadLocalMessagesAsFallback();
  }
}

function loadLocalMessagesAsFallback() {
  console.log("Loading local messages as fallback...");
  try {
    let localMessages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
    
    localMessages.sort((a, b) => {
      const timeA = new Date(a.timestamp).getTime();
      const timeB = new Date(b.timestamp).getTime();
      return timeA - timeB;
    });
    
    if (localMessages.length > 0) {
      localMessages.forEach(msg => {
        const isSent = msg.userId === userId;
        addMessageToChat(msg.author, msg.text, isSent, new Date(msg.timestamp));
      });
    }
    addMessageToChat('სისტემა', 'კეთილი იყოს თქვენი მობრძანება! (ლოკალური რეჟიმი)', false, new Date());
  } catch (e) {
    console.error('Error loading local messages:', e);
    addMessageToChat('სისტემა', 'კეთილი იყოს თქვენი მობრძანება!', false, new Date());
  }
}

function setUserOnline() {
  if (!firebaseInitialized || !database) return;
  
  try {
    const userRef = database.ref('chat/onlineUsers/' + userId);
    
    database.ref('chat/onlineUsers').once('value').then((snapshot) => {
      if (snapshot.exists()) {
        const users = snapshot.val();
        const now = Date.now();
        const updates = {};
        
        Object.keys(users).forEach(key => {
          if (users[key]?.lastSeen && (now - users[key].lastSeen) > 60000) {
            updates[key] = null;
          }
        });
        
        if (Object.keys(updates).length > 0) {
          database.ref('chat/onlineUsers').update(updates);
        }
      }
    });
    
    userRef.set({
      name: userName,
      userId: userId,
      lastSeen: Date.now()
    });
    
    isOnline = true;
    
    setInterval(() => {
      if (isOnline && firebaseInitialized) {
        userRef.update({ lastSeen: Date.now() });
      }
    }, 10000);
    
    window.addEventListener('beforeunload', () => {
      if (firebaseInitialized) {
        userRef.remove();
      }
      isOnline = false;
    });
  } catch (error) {
    console.error("Error setting user online:", error);
  }
}

function sendMessageToFirebase() {
  if (!chatInput) return;
  
  const message = chatInput.value.trim();
  if (!message) return;
  
  if (!userName) {
    if (currentUser && currentUser.username) {
      userName = currentUser.username;
    } else {
      userName = 'სტუმარი ' + Math.floor(Math.random() * 1000);
    }
    localStorage.setItem('chatUserName', userName);
  }
  
  const messageData = {
    text: message,
    author: userName,
    userId: userId,
    timestamp: Date.now()
  };
  
  chatInput.value = '';
  
  addMessageToChat(userName, message, true, new Date());
  
  saveMessageToLocalStorage(messageData);
  
  if (firebaseInitialized && database) {
    const newMessageRef = database.ref('chat/messages').push();
    const messageKey = newMessageRef.key;
    
    displayedMessageKeys.add(messageKey);
    
    newMessageRef.set(messageData)
      .catch((error) => {
        console.error('Error sending message to Firebase:', error);
        showNotification('შეტყობინება შენახულია მხოლოდ ლოკალურად', false);
      });
  } else {
    showNotification('შეტყობინება შენახულია ლოკალურად', false);
  }
}

function saveMessageToLocalStorage(messageData) {
  try {
    let localMessages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
    localMessages.push({
      ...messageData,
      timestamp: new Date().toISOString()
    });
    
    if (localMessages.length > 100) {
      localMessages = localMessages.slice(-100);
    }
    
    localStorage.setItem('chatMessages', JSON.stringify(localMessages));
  } catch (e) {
    console.error('Error saving to localStorage:', e);
  }
}

function addMessageToChat(author, message, isSent, timestamp) {
  if (!chatMessagesEl) return;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
  
  const time = timestamp.toLocaleTimeString('ka-GE', {
    hour: '2-digit',
    minute: '2-digit'
  });
  
  messageDiv.innerHTML = `
    <div class="message-author">${escapeHtml(author)}</div>
    <div class="message-time">${time}</div>
    <div class="message-content">${escapeHtml(message)}</div>
  `;
  
  chatMessagesEl.appendChild(messageDiv);
  
  if (!isChatOpen && !isSent) {
    unreadMessagesCount++;
    updateChatNotification();
  }
  
  lastSeenMessageTime = Math.max(lastSeenMessageTime, timestamp.getTime());
  
  if (isChatOpen) {
    setTimeout(() => {
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }, 100);
  }
}

function updateChatNotification() {
  const notification = document.getElementById('chatNotification');
  if (notification) {
    if (unreadMessagesCount > 0) {
      notification.style.display = 'flex';
      notification.textContent = unreadMessagesCount > 99 ? '99+' : unreadMessagesCount.toString();
    } else {
      notification.style.display = 'none';
    }
  }
}

// ==================== TOPIC FUNCTIONS ====================
function toggleTopicsDropdown() {
  const testTypeSelect = document.getElementById('testTypeSelect');
  const topicsContainer = document.getElementById('topicsDropdownContainer');
  
  if (!testTypeSelect || !topicsContainer) return;
  
  if (testTypeSelect.value === 'rezidentura') {
    topicsContainer.style.display = 'flex';
  } else {
    topicsContainer.style.display = 'none';
    const topicsSelect = document.getElementById('topicsSelect');
    if (topicsSelect) topicsSelect.value = 'all';
    selectedTopic = null;
  }
}

function bindTestTypeEvents() {
  const testTypeSelect = document.getElementById('testTypeSelect');
  if (testTypeSelect) {
    testTypeSelect.addEventListener('change', function() {
      toggleTopicsDropdown();
      const startBtn = document.getElementById('startBtn');
      if (startBtn) {
        startBtn.disabled = !this.value;
      }
    });
  }
}

// ==================== UTILITY FUNCTIONS ====================
function escapeHtml(s){ 
  if(!s) return ''; 
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#039;'
  }[m])); 
}

function shuffleArray(a){ 
  for(let i=a.length-1;i>0;i--){ 
    const j=Math.floor(Math.random()*(i+1)); 
    [a[i],a[j]]=[a[j],a[i]]; 
  } 
}

function showNotification(message, isError = true) {
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();
  
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.textContent = message;
  notification.style.background = isError ? 'var(--danger)' : 'var(--success)';
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 4000);
}

function resetLoader() {
  loaderOverlay.innerHTML = `
    <div class="spinner"></div>
    <div class="loader-text">იტვირთება...</div>
  `;
}

function updateTimerDisplay() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('ka-GE');
  
  // Show only the clock with separator
  timerElement.innerHTML = `
    <span class="timer-separator">|</span>
    <span class="timer-time">${timeStr}</span>
  `;
}

function updateTimer() {
  updateTimerDisplay();
  if (examMode) {
    updateExamTimer();
  }
}

function updateExamTimer() {
  if (!examMode) return;
  
  const hours = Math.floor(examTimeRemaining / 3600);
  const minutes = Math.floor((examTimeRemaining % 3600) / 60);
  const seconds = examTimeRemaining % 60;
  
  examCountdown.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  
  if (examTimeRemaining <= 0) {
    clearInterval(examTimerInterval);
    completeExam();
  } else {
    examTimeRemaining--;
  }
}

// ==================== EXAM MODE FUNCTIONS ====================
function createExamTestBoxes() {
  if (!examTestBoxes) return;
  
  examTestBoxes.innerHTML = '';
  
  for (let i = 0; i < 200; i++) {
    const testBox = document.createElement('div');
    testBox.className = 'test-box';
    testBox.textContent = i + 1;
    testBox.dataset.index = i;
    
    if (i === currentIndex) {
      testBox.classList.add('current');
    }
    
    if (sessionTests[i] && sessionTests[i].selectedAnswers && sessionTests[i].selectedAnswers.length > 0) {
      testBox.classList.add('answered');
    }
    
    testBox.addEventListener('click', () => {
      currentIndex = i;
      renderCurrentQuestion();
    });
    
    examTestBoxes.appendChild(testBox);
  }
}

function startExamMode() {
  examMode = true;
  examTimeRemaining = 3 * 60 * 60;
  
  timerElement.classList.add('hidden');
  normalModeContainer.classList.add('hidden');
  examModeContainer.classList.remove('hidden');
  examRightPanel.classList.remove('hidden');
  questionCounter.classList.add('hidden');
  examFinishBtn.style.display = 'none';
  
  createExamTestBoxes();
  
  clearInterval(examTimerInterval);
  examTimerInterval = setInterval(updateExamTimer, 1000);
  updateExamTimer();
}

function checkAllQuestionsAnswered() {
  if (!examMode) return false;
  
  const allAnswered = sessionTests.every(q => 
    q.selectedAnswers && q.selectedAnswers.length > 0
  );
  
  const examFinishBtn = document.getElementById('examFinishBtn');
  
  if (examFinishBtn) {
    if (allAnswered) {
      examFinishBtn.style.display = 'flex';
    } else {
      examFinishBtn.style.display = 'none';
    }
  }
  
  if (examTestBoxes) {
    const testBoxes = examTestBoxes.querySelectorAll('.test-box');
    testBoxes.forEach((box, index) => {
      if (sessionTests[index] && sessionTests[index].selectedAnswers && sessionTests[index].selectedAnswers.length > 0) {
        box.classList.add('answered');
      } else {
        box.classList.remove('answered');
      }
    });
  }
  
  return allAnswered;
}

function completeExam() {
  clearInterval(examTimerInterval);
  
  timerElement.classList.add('hidden');
  
  const correctCount = sessionTests.filter(q => 
    q.selectedAnswers && q.selectedAnswers.some(idx => q.answers[idx]?.correct)
  ).length;
  
  const passed = correctCount >= 150;
  
  examRightPanel.classList.add('hidden');
  
  const resultsHTML = `
    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8fafc; padding: 20px;">
      <div style="max-width: 800px; width: 100%; background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); overflow: hidden;">
        <div style="padding: 30px; border-bottom: 1px solid #e2e8f0;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
            <div style="text-align: center; padding: 20px; background: #f0fdf4; border-radius: 8px;">
              <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">სწორი პასუხები</div>
              <div style="font-size: 42px; font-weight: 700; color: var(--success);">${correctCount}</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px;">
              <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">არასწორი პასუხები</div>
              <div style="font-size: 42px; font-weight: 700; color: var(--danger);">${200 - correctCount}</div>
            </div>
          </div>
          
          <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
            <div style="font-size: 16px; color: #64748b; margin-bottom: 5px;">შეფასება</div>
            <div style="font-size: 28px; font-weight: 700; color: ${passed ? 'var(--success)' : 'var(--danger)'}">
              ${passed ? 'გამოცდა ჩაბარებულია' : 'ჩაჭრილია!'}
            </div>
            <div style="font-size: 18px; margin-top: 10px;">
              ${passed ? 'გილოცავთ! თქვენ წარმატებით ჩააბარეთ გამოცდა!' : 'სამწუხაროდ, თქვენ ვერ ჩააბარეთ გამოცდა. სცადეთ კიდევ.'}
            </div>
          </div>
        </div>
        
        <div style="padding: 30px;">
          <div style="font-size: 20px; font-weight: 600; color: #1e293b; margin-bottom: 20px; text-align: center;">
            შედეგების ისტორია
          </div>
          <div id="resultsHistoryContainer" style="max-height: 300px; overflow-y: auto; padding: 10px;">
          </div>
        </div>
        
        <div style="padding: 30px; background: #f8fafc; display: flex; gap: 15px; justify-content: center; border-top: 1px solid #e2e8f0;">
          <button id="viewDetailsBtn" style="padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
            დეტალურად ნახვა
          </button>
          <button id="restartBtn" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
            თავიდან დაწყება
          </button>
        </div>
      </div>
    </div>
  `;
  
  testScreen.innerHTML = resultsHTML;
  
  const historyContainer = document.getElementById('resultsHistoryContainer');
  if (historyContainer) {
    sessionTests.forEach((question, index) => {
      const selectedAnswerIndex = question.selectedAnswers ? question.selectedAnswers[0] : -1;
      const isCorrect = selectedAnswerIndex !== -1 && question.answers[selectedAnswerIndex]?.correct;
      const selectedAnswer = selectedAnswerIndex !== -1 ? question.answers[selectedAnswerIndex].text : 'არაა არჩეული';
      const correctAnswer = question.answers.find(a => a.correct)?.text || 'არ არის ცნობილი';
      
      const resultItem = document.createElement('div');
      resultItem.style.cssText = 'padding: 12px; margin-bottom: 8px; background: white; border-radius: 6px; border-left: 4px solid ' + (isCorrect ? 'var(--success)' : 'var(--danger)') + ';';
      resultItem.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">
          ${index + 1}. ${escapeHtml(question.question.substring(0, 80))}${question.question.length > 80 ? '...' : ''}
        </div>
        <div style="font-size: 13px; color: ${isCorrect ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 2px;">
          <strong>თქვენი პასუხი:</strong> ${escapeHtml(selectedAnswer)}
        </div>
        ${!isCorrect ? `<div style="font-size: 13px; color: var(--success);"><strong>სწორი პასუხი:</strong> ${escapeHtml(correctAnswer)}</div>` : ''}
      `;
      historyContainer.appendChild(resultItem);
    });
  }
  
  setTimeout(() => {
    const restartBtn = document.getElementById('restartBtn');
    if (restartBtn) {
      restartBtn.addEventListener('click', () => {
        location.reload();
      });
    }
    
    const viewDetailsBtn = document.getElementById('viewDetailsBtn');
    if (viewDetailsBtn) {
      viewDetailsBtn.addEventListener('click', showDetailedResults);
    }
  }, 100);
}

function showDetailedResults() {
  detailedResultsContent.innerHTML = '';
  
  const table = document.createElement('table');
  table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 14px;';
  
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr style="background: #f1f5f9;">
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">#</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">კითხვა</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">თქვენი პასუხი</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">სწორი პასუხი</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">სტატუსი</th>
    </tr>
  `;
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  sessionTests.forEach((question, index) => {
    const selectedAnswerIndex = question.selectedAnswers ? question.selectedAnswers[0] : -1;
    const isCorrect = selectedAnswerIndex !== -1 && question.answers[selectedAnswerIndex]?.correct;
    const selectedAnswer = selectedAnswerIndex !== -1 ? question.answers[selectedAnswerIndex].text : 'არაა არჩეული';
    const correctAnswer = question.answers.find(a => a.correct)?.text || 'არ არის ცნობილი';
    
    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid #e2e8f0';
    row.innerHTML = `
      <td style="padding: 12px; font-weight: 600;">${index + 1}</td>
      <td style="padding: 12px;">${escapeHtml(question.question.substring(0, 100))}${question.question.length > 100 ? '...' : ''}</td>
      <td style="padding: 12px; color: ${isCorrect ? 'var(--success)' : 'var(--danger)'};">${escapeHtml(selectedAnswer)}</td>
      <td style="padding: 12px; color: var(--success);">${escapeHtml(correctAnswer)}</td>
      <td style="padding: 12px;">
        <span style="padding: 4px 8px; border-radius: 4px; font-weight: 600; background: ${isCorrect ? '#d1fae5' : '#fee2e2'}; color: ${isCorrect ? '#065f46' : '#991b1b'}">
          ${isCorrect ? 'სწორი' : 'არასწორი'}
        </span>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  table.appendChild(tbody);
  detailedResultsContent.appendChild(table);
  
  detailedResultsModal.classList.add('active');
}

// ==================== CSV LOADING FUNCTIONS ====================
function loadCSV() {
  loaderOverlay.style.display = 'flex';
  resetLoader();
  startBtn.disabled = true;
  
  const defaultUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=69945858&single=true&output=csv";
  
  fetch(defaultUrl).then(r => {
    if (!r.ok) throw new Error('Network error: ' + r.status);
    return r.text();
  }).then(txt => {
    console.log("CSV raw text length:", txt.length);
    
    const twoColRows = parseCSVTwoColumns(txt);
    console.log("Parsed rows:", twoColRows.length);
    
    allTestsWithTopics = buildTestsFromCSV(twoColRows);
    console.log("Built tests:", allTestsWithTopics.length);
    
    allTests = allTestsWithTopics;
    
    if (!allTests.length){
      showNotification('ვერ მოიძებნა ტესტები. შეამოწმეთ ფაილი.');
      loaderOverlay.innerHTML = '<div style="color: var(--danger); font-weight: 600; text-align: center; padding: 20px;">ტესტები ვერ მოიძებნა<br><small>გთხოვთ განაახლოთ გვერდი</small></div>';
      startBtn.disabled = false;
      return;
    }
    
    totalQuestionsEl.textContent = allTests.length;
    
    extractTopics();
    console.log("Available topics:", Array.from(availableTopics));
    
    populateTopicsList();
    
    loaderOverlay.style.display = 'none';
    startBtn.disabled = false;
    
  }).catch(err => {
    console.error("Fetch error:", err);
    showNotification('შეცდომა ფაილის ჩატვირთვისას: ' + err.message);
    loaderOverlay.innerHTML = `<div style="color: var(--danger); font-weight: 600; text-align: center; padding: 20px;">შეცდომა ჩატვირთვისას<br><small>${err.message}</small></div>`;
    startBtn.disabled = false;
  });
}

function parseCSVTwoColumns(csvText){
  if (!csvText) return [];
  
  csvText = csvText.trim();
  csvText = csvText.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  
  const rows = [];
  const lines = csvText.split('\n');
  
  for (let line of lines) {
    line = line.trim();
    if (!line) continue;
    
    let columns = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      const next = line[i + 1];
      
      if (ch === '"') {
        if (inQuotes && next === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
        continue;
      } else if (ch === ',' && !inQuotes) {
        columns.push(current.trim());
        current = '';
        continue;
      }
      current += ch;
    }
    
    columns.push(current.trim());
    
    if (columns.length === 1) {
      columns.push('');
    }
    
    rows.push({
      columnA: columns[0],
      columnB: columns[1] || ''
    });
  }
  
  return rows;
}

function buildTestsFromCSV(rawRows){
  console.log("=== BUILDING TESTS FROM 2-COLUMN CSV ===");
  
  const tests = [];
  let currentTest = null;
  let currentTopic = 'ზოგადი';
  
  for (let i = 0; i < rawRows.length; i++){
    const columnA = rawRows[i].columnA;
    const columnB = rawRows[i].columnB;
    
    if (!columnA && !columnB) continue;
    
    const normalizedA = normalizeLine(columnA);
    const topic = normalizeLine(columnB);
    
    if (topic && topic !== '') {
      currentTopic = topic;
    }
    
    const type = detectLineType(normalizedA);
    
    if (type === 'question'){
      if (currentTest && currentTest.answers.length > 0) {
        currentTest.topic = currentTopic;
        tests.push(currentTest);
      }
      
      currentTest = { 
        raw: normalizedA, 
        question: stripLeadingSymbol(normalizedA), 
        topic: currentTopic,
        answers: [], 
        sourceIndex: i 
      };
      
    } else if ((type === 'correct' || type === 'incorrect') && currentTest){
      const isCorrect = (type === 'correct');
      const txt = stripLeadingSymbol(normalizedA);
      if (txt.length > 0) {
        currentTest.answers.push({ 
          text: txt, 
          correct: isCorrect,
          originalText: txt
        });
      }
    }
  }
  
  if (currentTest && currentTest.answers.length > 0) {
    currentTest.topic = currentTopic;
    tests.push(currentTest);
  }
  
  console.log(`Built ${tests.length} tests from CSV`);
  
  const filteredTests = tests.filter(t => Array.isArray(t.answers) && t.answers.length > 0);
  
  const topicCounts = {};
  filteredTests.forEach(test => {
    const topic = test.topic || 'ზოგადი';
    topicCounts[topic] = (topicCounts[topic] || 0) + 1;
  });
  
  console.log("Topic distribution:", topicCounts);
  
  return filteredTests;
}

function normalizeLine(raw){
  if (raw == null) return '';
  let s = String(raw).normalize('NFKC');
  s = s.replace(/^\uFEFF/, '');
  s = s.replace(/[\u200B-\u200F\uFEFF]/g, '');
  s = s.replace(/^"+|"+$/g, '');
  s = s.replace(/\s+/g, ' ');
  return s.trim();
}

function detectLineType(line){
  const s = line.trim();
  if (!s) return 'unknown';
  
  if (/^¢/.test(s)) {
    return 'question';
  }
  
  if (/^(✔️|✔|✓|✅|\+)/.test(s)) {
    return 'correct';
  }
  
  if (/^(❌|✖️|✖|✕|✗|✘|-)/.test(s)) {
    return 'incorrect';
  }
  
  if (/[ა-ჰ]/.test(s) && /\?$/.test(s)) {
    return 'question';
  }
  
  return 'unknown';
}

function stripLeadingSymbol(str) {
  if (!str) return '';
  
  let cleaned = str.replace(/^¢\s*(ID=\d+\s*)?/, '').trim();
  
  cleaned = cleaned.replace(/^[✔️✔✓✅+❌✖️✖✕✗✘\-]\s*/, '');
  
  return cleaned;
}

function extractTopics() {
  availableTopics.clear();
  
  allTestsWithTopics.forEach(test => {
    if (test.topic && test.topic.trim() !== '') {
      availableTopics.add(test.topic.trim());
    } else {
      availableTopics.add('ზოგადი');
    }
  });
}

function populateTopicsList() {
  const topicsSelect = document.getElementById('topicsSelect');
  if (!topicsSelect) return;
  
  topicsSelect.innerHTML = '<option value="all" selected>ტესტები თემების მიხედვით</option>';
  
  const topicCounts = {};
  allTestsWithTopics.forEach(test => {
    const topic = test.topic && test.topic.trim() !== '' ? test.topic.trim() : 'ზოგადი';
    topicCounts[topic] = (topicCounts[topic] || 0) + 1;
  });
  
  const topicsInOrder = [];
  const seenTopics = new Set();
  
  allTestsWithTopics.forEach(test => {
    const topic = test.topic && test.topic.trim() !== '' ? test.topic.trim() : 'ზოგადი';
    if (!seenTopics.has(topic)) {
      seenTopics.add(topic);
      topicsInOrder.push(topic);
    }
  });
  
  const sortedTopics = topicsInOrder;
  
  sortedTopics.forEach(topic => {
    const count = topicCounts[topic] || 0;
    const option = document.createElement('option');
    option.value = topic;
    option.textContent = `${topic} (${count})`;
    topicsSelect.appendChild(option);
  });
  
  topicsSelect.addEventListener('change', function() {
    updateSelectedTopics();
  });
  
  toggleTopicsDropdown();
}

function updateSelectedTopics() {
  const topicsSelect = document.getElementById('topicsSelect');
  if (!topicsSelect) return;
  
  const selectedValue = topicsSelect.value;
  
  if (selectedValue === 'all') {
    selectedTopic = null;
  } else {
    selectedTopic = selectedValue;
  }
}

// ==================== TEST FUNCTIONS ====================
function startTest() {
  // Clear saved progress flag
  window.savedProgress = null;
  
  if (modeSequential.checked && modeShuffleQuestions.checked) {
    showNotification('ეს რეჟიმები ერთად შეუძლებელია არსებობდეს!');
    return;
  }
  
  const topicsSelect = document.getElementById('topicsSelect');
  if (topicsSelect) {
    const selectedValue = topicsSelect.value;
    
    if (!selectedValue || selectedValue === '') {
      showNotification('გთხოვთ აირჩიოთ თემა!');
      return;
    }
  }
  
  if (!modeSequential.checked && !modeShuffleQuestions.checked && 
      !modeShuffleAnswers.checked && !modeExam.checked) {
    showNotification('აირჩიეთ რეჟიმი დასაწყებად!');
    return;
  }
  
  autoMode = false;
  
  examMode = modeExam.checked;
  const shuffleQuestions = modeShuffleQuestions.checked || examMode;
  const shuffleAnswers = modeShuffleAnswers.checked;
  
  let testsToUse = allTestsWithTopics;
  
  if (selectedTopic && selectedTopic !== 'all') {
    testsToUse = allTestsWithTopics.filter(test => {
      const testTopic = test.topic && test.topic.trim() !== '' ? test.topic.trim() : 'ზოგადი';
      return testTopic === selectedTopic;
    });
    
    if (testsToUse.length === 0) {
      showNotification(`არჩეულ თემას არ გააჩნია ტესტები`);
      return;
    }
  }
  
  if (examMode) {
    const shuffledAll = [...testsToUse];
    shuffleArray(shuffledAll);
    sessionTests = shuffledAll.slice(0, Math.min(200, shuffledAll.length)).map((t, idx) => ({ 
      id: idx.toString(),
      question: t.question, 
      answers: t.answers.map(a => ({...a})),
      selectedAnswers: [],
      hasCorrectAnswer: false,
      isComplete: false,
      isAnswerCorrect: null
    }));
  } else {
    sessionTests = testsToUse.map((t, idx) => ({ 
      id: idx.toString(),
      question: t.question, 
      answers: t.answers.map(a => ({...a})),
      selectedAnswers: [],
      hasCorrectAnswer: false,
      isComplete: false,
      isAnswerCorrect: null
    }));
  }
  
  if (window.savedProgress && currentUser && !currentUser.isGuest) {
    const progress = window.savedProgress;
    const mode = examMode ? 'exam' : 'normal';
    
    if (progress[mode] && progress[mode].answeredQuestions) {
      Object.keys(progress[mode].answeredQuestions).forEach(questionId => {
        const idx = parseInt(questionId);
        if (idx < sessionTests.length) {
          const answerData = progress[mode].answeredQuestions[questionId];
          sessionTests[idx].selectedAnswers = [answerData.selectedAnswer];
          sessionTests[idx].hasCorrectAnswer = answerData.isCorrect;
          sessionTests[idx].isAnswerCorrect = answerData.isCorrect;
        }
      });
      
      currentIndex = progress[mode].currentIndex || 0;
      
      if (examMode && progress.exam && progress.exam.examTimeRemaining) {
        examTimeRemaining = progress.exam.examTimeRemaining;
      }
      
      showNotification('პროგრესი წარმატებით ჩაიტვირთა', false);
    }
    window.savedProgress = null;
  }
  
  if (shuffleQuestions && !examMode) {
    shuffleArray(sessionTests);
  }

  if (shuffleAnswers) {
    sessionTests.forEach(q => shuffleArray(q.answers));
  }
  
  optionsScreen.style.display = 'none';
  testScreen.classList.add('active');
  
  if (selectedTopic && selectedTopic !== 'all') {
    timerElement.innerHTML = `
      <span style="font-weight: 600; color: var(--accent);">${currentUser ? currentUser.username : 'სტუმარი'}</span>
      <span class="timer-separator">|</span>
      <span class="timer-time">${new Date().toLocaleTimeString('ka-GE')}</span>
      <br>
      <span class="timer-topic">თემა: ${selectedTopic}</span>
    `;
  }
  
  if (examMode) {
    startExamMode();
  } else {
    normalModeContainer.classList.remove('hidden');
    examModeContainer.classList.add('hidden');
    examRightPanel.classList.add('hidden');
    
    questionCounter.classList.remove('hidden');
    currentQuestionEl.textContent = currentIndex + 1;
    totalQuestionsEl.textContent = sessionTests.length;
    
    timerElement.classList.remove('hidden');
  }
  
  renderCurrentQuestion();
}

function renderCurrentQuestion() {
  if (!sessionTests.length) return;
  
  const question = sessionTests[currentIndex];
  
  if (examMode) {
    examQuestionText.textContent = question.question;
    
    createExamTestBoxes();
    
    renderExamAnswers();
    
    checkAllQuestionsAnswered();
  } else {
    questionText.textContent = question.question;
    
    currentQuestionEl.textContent = currentIndex + 1;
    totalQuestionsEl.textContent = sessionTests.length;
    
    if (isEditingQuestionNumber) {
      currentQuestionEl.classList.remove('editing');
      isEditingQuestionNumber = false;
    }
    
    renderNormalAnswers();
  }
}

function renderNormalAnswers() {
  const question = sessionTests[currentIndex];
  answersContainer.innerHTML = '';
  feedback.innerHTML = '';
  
  if (question.answers && question.answers.length > 0) {
    question.answers.forEach((answer, idx) => {
      const answerEl = document.createElement('div');
      answerEl.className = 'answer-item';
      
      const wasSelected = question.selectedAnswers && question.selectedAnswers.includes(idx);
      
      if (wasSelected) {
        answerEl.classList.add('selected');
        if (answer.correct) {
          answerEl.classList.add('correct');
        } else {
          answerEl.classList.add('incorrect');
        }
      }
      
      answerEl.innerHTML = `
        <span class="answer-number">${idx + 1}.</span>
        <span class="answer-text">${escapeHtml(answer.text)}</span>
      `;
      
      answerEl.addEventListener('click', () => {
        if (wasSelected) return;
        
        if (!question.selectedAnswers) {
          question.selectedAnswers = [];
        }
        
        question.selectedAnswers.push(idx);
        
        answerEl.classList.add('selected');
        
        if (answer.correct) {
          answerEl.classList.add('correct');
          if (!question.hasCorrectAnswer) {
            question.hasCorrectAnswer = true;
          }
          feedback.innerHTML = `<div style="color:var(--success); font-size:16px; font-weight:600;">✓ სწორი პასუხი!</div>`;
          
          updateUserProgress(question.id, idx, true, false);
          
          if (autoMode && currentIndex < sessionTests.length - 1) {
            setTimeout(() => {
              currentIndex++;
              autoSaveProgress();
              renderCurrentQuestion();
            }, 500);
          }
        } else {
          answerEl.classList.add('incorrect');
          feedback.innerHTML = `<div style="color:var(--danger); font-size:16px; font-weight:600;">✗ არასწორი პასუხი</div>`;
          
          updateUserProgress(question.id, idx, false, false);
        }
        
        autoSaveProgress();
        renderCurrentQuestion();
      });
      
      answersContainer.appendChild(answerEl);
    });
  } else {
    answersContainer.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">პასუხები არ მოიძებნა</div>';
  }
  
  if (prevBtn && nextBtn) {
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex === sessionTests.length - 1;
  }
  
  updateAutoButton();
}

function renderExamAnswers() {
  const question = sessionTests[currentIndex];
  examAnswersContainer.innerHTML = '';
  examFeedback.innerHTML = '';
  
  if (question.answers && question.answers.length > 0) {
    question.answers.forEach((answer, idx) => {
      const answerEl = document.createElement('div');
      answerEl.className = 'exam-answer-item';
      
      const wasSelected = question.selectedAnswers && question.selectedAnswers.includes(idx);
      
      if (wasSelected) {
        answerEl.classList.add('selected');
      }
      
      answerEl.innerHTML = `
        <span class="exam-answer-number">${idx + 1}.</span>
        <span class="answer-text">${escapeHtml(answer.text)}</span>
      `;
      
      answerEl.addEventListener('click', () => {
        if (wasSelected) return;
        
        if (!question.selectedAnswers) {
          question.selectedAnswers = [];
        }
        
        question.selectedAnswers = [idx];
        
        question.isAnswerCorrect = answer.correct;
        
        answerEl.classList.add('selected');
        examFeedback.innerHTML = '';
        
        createExamTestBoxes();
        
        updateUserProgress(question.id, idx, answer.correct, true);
        
        onAnswerSelected();
        autoSaveProgress();
        renderCurrentQuestion();
      });
      
      examAnswersContainer.appendChild(answerEl);
    });
  } else {
    examAnswersContainer.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">პასუხები არ მოიძებნა</div>';
  }
  
  if (examPrevBtn && examNextBtn) {
    examPrevBtn.disabled = currentIndex === 0;
    examNextBtn.disabled = currentIndex === sessionTests.length - 1;
  }
  
  updateExamAutoButton();
}

function onAnswerSelected() {
  const allAnswered = sessionTests.every(q => 
    q.selectedAnswers && q.selectedAnswers.length > 0
  );
  
  const examFinishBtn = document.getElementById('examFinishBtn');
  if (examFinishBtn) {
    if (allAnswered) {
      examFinishBtn.style.display = 'flex';
    } else {
      examFinishBtn.style.display = 'none';
    }
  }
}

function autoSaveProgress() {
  if (!currentUser || currentUser.isGuest || !currentTestType) return;
  
  const mode = examMode ? 'exam' : 'normal';
  
  if (!userProgress[currentTestType]) {
    userProgress[currentTestType] = {
      normal: { answeredQuestions: {}, currentIndex: 0 },
      exam: { answeredQuestions: {}, currentIndex: 0 },
      wrongQuestions: []
    };
  }
  
  if (!userProgress[currentTestType][mode]) {
    userProgress[currentTestType][mode] = { answeredQuestions: {}, currentIndex: 0 };
  }
  
  userProgress[currentTestType][mode].currentIndex = currentIndex;
  
  if (examMode) {
    userProgress[currentTestType].exam.examTimeRemaining = examTimeRemaining;
  }
  
  saveUserProgress();
}

function updateAutoButton() {
  if (!autoBtn || !nextBtn) return;
  
  if (autoMode) {
    nextBtn.classList.add('vanish-effect');
    autoBtn.textContent = 'გამორთე Auto';
  } else {
    nextBtn.classList.remove('vanish-effect');
    autoBtn.textContent = 'Auto';
  }
}

function updateExamAutoButton() {
  if (!examAutoBtn || !examNextBtn) return;
  
  if (autoMode) {
    examNextBtn.classList.add('vanish-effect');
    examAutoBtn.textContent = 'გამორთე Auto';
  } else {
    examNextBtn.classList.remove('vanish-effect');
    examAutoBtn.textContent = 'Auto';
  }
}

function bindNavigationEvents() {
  prevBtn = document.getElementById('prevBtn');
  nextBtn = document.getElementById('nextBtn');
  autoBtn = document.getElementById('autoBtn');
  
  examPrevBtn = document.getElementById('examPrevBtn');
  examNextBtn = document.getElementById('examNextBtn');
  examAutoBtn = document.getElementById('examAutoBtn');
  examFinishBtn = document.getElementById('examFinishBtn');
  
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        autoSaveProgress();
        renderCurrentQuestion();
      }
    });
  }
  
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      if (currentIndex < sessionTests.length - 1) {
        currentIndex++;
        autoSaveProgress();
        renderCurrentQuestion();
      } else if (examMode) {
        completeExam();
      } else {
        showCompletionScreen();
      }
    });
  }
  
  if (autoBtn) {
    autoBtn.addEventListener('click', () => {
      autoMode = !autoMode;
      updateAutoButton();
      updateExamAutoButton();
    });
  }
  
  if (examPrevBtn) {
    examPrevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        autoSaveProgress();
        renderCurrentQuestion();
      }
    });
  }
  
  if (examNextBtn) {
    examNextBtn.addEventListener('click', () => {
      if (currentIndex < sessionTests.length - 1) {
        currentIndex++;
        autoSaveProgress();
        renderCurrentQuestion();
      } else {
        if (checkAllQuestionsAnswered()) {
          completeExam();
        } else {
          showNotification('გთხოვთ უპასუხოთ ყველა კითხვას გამოცდის დასრულებამდე');
        }
      }
    });
  }
  
  if (examAutoBtn) {
    examAutoBtn.addEventListener('click', () => {
      autoMode = !autoMode;
      updateAutoButton();
      updateExamAutoButton();
    });
  }
  
  if (examFinishBtn) {
    examFinishBtn.addEventListener('click', () => {
      if (examMode) {
        if (checkAllQuestionsAnswered()) {
          completeExam();
        } else {
          showNotification('გთხოვთ უპასუხოთ ყველა კითხვას გამოცდის დასრულებამდე');
        }
      }
    });
  }
  
  const closeDetailsBtn = document.getElementById('closeDetailsBtn');
  if (closeDetailsBtn) {
    closeDetailsBtn.addEventListener('click', () => {
      detailedResultsModal.classList.remove('active');
    });
  }
}

function bindQuestionCounterEvent() {
  if (!currentQuestionEl) return;
  
  currentQuestionEl.addEventListener('click', (e) => {
    e.stopPropagation();
    
    if (isEditingQuestionNumber || examMode) return;
    
    isEditingQuestionNumber = true;
    currentQuestionEl.classList.add('editing');
    
    const originalValue = currentQuestionEl.textContent;
    
    const input = document.createElement('input');
    input.type = 'number';
    input.value = originalValue;
    input.min = 1;
    input.max = sessionTests.length;
    input.style.cssText = `
      width: 60px;
      height: 40px;
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      border: none;
      background: transparent;
      color: var(--success);
      outline: none;
      padding: 0;
      margin: 0;
      -moz-appearance: textfield;
    `;
    
    input.style.webkitAppearance = 'none';
    input.style.margin = '0';
    
    const originalDisplay = currentQuestionEl.style.display;
    currentQuestionEl.style.display = 'none';
    
    const inputContainer = document.createElement('div');
    inputContainer.style.cssText = `
      display: inline-block;
      min-width: 50px;
      text-align: center;
    `;
    inputContainer.appendChild(input);
    
    currentQuestionEl.parentNode.insertBefore(inputContainer, currentQuestionEl.nextSibling);
    
    input.focus();
    input.select();
    
    const handleInputComplete = () => {
      const value = parseInt(input.value);
      if (value >= 1 && value <= sessionTests.length) {
        currentIndex = value - 1;
        
        inputContainer.remove();
        currentQuestionEl.style.display = originalDisplay;
        currentQuestionEl.textContent = value;
        currentQuestionEl.classList.remove('editing');
        isEditingQuestionNumber = false;
        
        autoSaveProgress();
        renderCurrentQuestion();
      } else {
        inputContainer.remove();
        currentQuestionEl.style.display = originalDisplay;
        currentQuestionEl.classList.remove('editing');
        isEditingQuestionNumber = false;
        
        showNotification('გთხოვთ შეიყვანოთ ნომერი 1-დან ' + sessionTests.length + '-მდე');
      }
    };
    
    input.addEventListener('blur', handleInputComplete);
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleInputComplete();
      }
    });
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        inputContainer.remove();
        currentQuestionEl.style.display = originalDisplay;
        currentQuestionEl.classList.remove('editing');
        isEditingQuestionNumber = false;
      }
    });
  });
}

function showCompletionScreen() {
  const totalQuestions = sessionTests.length;
  const correctCount = sessionTests.filter(q => q.hasCorrectAnswer).length;
  const percentage = Math.round((correctCount / totalQuestions) * 100);
  
  timerElement.classList.remove('hidden');
  
  const completionHTML = `
    <div style="text-align:center; padding:40px 20px; width:100%;">
      <div style="font-size:24px; font-weight:600; color:#1e293b; margin-bottom:20px;">
        ტესტი დასრულდა! 🎉
      </div>
      <div style="font-size:18px; color:#64748b; margin-bottom:30px;">
        თქვენ მიიღეთ ${totalQuestions} კითხვიდან ${correctCount} სწორად (${percentage}%)
      </div>
      <button id="restartBtn" style="padding:14px 40px; background:var(--accent); color:white; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s;">
        თავიდან დაწყება
      </button>
    </div>
  `;
  
  const questionContainer = document.querySelector('.question-container');
  questionContainer.innerHTML = completionHTML;
  examRightPanel.classList.add('hidden');
  questionCounter.classList.add('hidden');
  
  document.getElementById('restartBtn').addEventListener('click', () => {
    location.reload();
  });
}

startBtn.addEventListener('click', () => {
  if (!allTests.length){ 
    showNotification('ტესტები არ იძებნება');
    return; 
  }
  
  const testTypeSelect = document.getElementById('testTypeSelect');
  if (!testTypeSelect || testTypeSelect.value === '') {
    showNotification('გთხოვთ აირჩიოთ მოდული');
    return;
  }
  
  currentTestType = testTypeSelect.value;
  
  if (currentTestType === 'rezidentura') {
    const topicsSelect = document.getElementById('topicsSelect');
    if (topicsSelect && (!topicsSelect.value || topicsSelect.value === '')) {
      showNotification('გთხოვთ აირჩიოთ თემა!');
      return;
    }
  }
  
  if (currentUser && !currentUser.isGuest && currentTestType) {
    // Load the progress first
    loadUserProgress();
    
    const progress = userProgress[currentTestType];
    const hasProgress = progress && (
      (progress.normal && Object.keys(progress.normal.answeredQuestions || {}).length > 0) ||
      (progress.exam && Object.keys(progress.exam.answeredQuestions || {}).length > 0)
    );
    
    if (hasProgress && !window.savedProgress) {
      showContinueOrRestartModal(progress);
      return;
    } else {
      // If no progress or already handled, start the test
      startTest();
    }
  } else {
    // Guest user - just start
    startTest();
  }
});

window.addEventListener('DOMContentLoaded', () => {
  console.log("DOM loaded, initializing app...");
  
  // Initialize chat elements
  chatButton = document.getElementById('chatButton');
  chatWindow = document.getElementById('chatWindow');
  closeChat = document.querySelector('.close-chat');
  chatMessagesEl = document.getElementById('chatMessages');
  onlineCount = document.getElementById('onlineCount');
  chatInput = document.getElementById('chatInput');
  sendBtn = document.getElementById('sendBtn');
  
  // Initialize navigation buttons
  prevBtn = document.getElementById('prevBtn');
  nextBtn = document.getElementById('nextBtn');
  autoBtn = document.getElementById('autoBtn');
  
  examPrevBtn = document.getElementById('examPrevBtn');
  examNextBtn = document.getElementById('examNextBtn');
  examAutoBtn = document.getElementById('examAutoBtn');
  examFinishBtn = document.getElementById('examFinishBtn');
  
  detailedResultsModal = document.getElementById('detailedResultsModal');
  detailedResultsContent = document.getElementById('detailedResultsContent');
  
  // Initialize auth
  initAuth();
  
  // Bind events
  bindNavigationEvents();
  bindQuestionCounterEvent();
  bindTestTypeEvents();
  
  document.addEventListener('click', (e) => {
    if (isEditingQuestionNumber && currentQuestionEl && !currentQuestionEl.contains(e.target)) {
      isEditingQuestionNumber = false;
      renderCurrentQuestion();
    }
  });
  
  setInterval(updateTimer, 1000);
  updateTimer();
  
  window.addEventListener('beforeunload', () => {
    if (currentUser && !currentUser.isGuest && currentTestType) {
      saveUserProgress();
    }
  });
  
  if (modeSequential) {
    modeSequential.addEventListener('change', () => {
      if (modeSequential.checked && modeShuffleQuestions.checked) {
        showNotification('ეს რეჟიმები ერთად შეუძლებელია არსებობდეს!');
        modeSequential.checked = false;
      }
    });
  }
  
  if (modeShuffleQuestions) {
    modeShuffleQuestions.addEventListener('change', () => {
      if (modeShuffleQuestions.checked && modeSequential.checked) {
        showNotification('ეს რეჟიმები ერთად შეუძლებელია არსებობდეს!');
        modeShuffleQuestions.checked = false;
      }
    });
  }
  
  if (modeExam) {
    modeExam.addEventListener('change', () => {
      if (modeExam.checked) {
        if (modeSequential) modeSequential.checked = false;
        if (modeShuffleQuestions) modeShuffleQuestions.checked = true;
        if (modeShuffleAnswers) modeShuffleAnswers.checked = true;
      }
    });
  }
  
  setTimeout(() => {
    toggleTopicsDropdown();
  }, 100);
});
</script>
</body>
</html>
