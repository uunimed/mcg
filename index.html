<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes" />
<title>რეზიდენტურის ტესტები – სრული გამართვა</title>
<style>
:root{
  --bg:#f6f8fb; --muted:#6b7280; --accent:#0ea5a4;
  --success:#16a34a; --danger:#dc2626;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
html,body{
  height:100%;
  font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: #f8fafc;
}
body{
  display: flex;
  flex-direction: column;
  padding: 20px;
  position: relative;
}

/* ==================== TOPIC DROPDOWN ==================== */
.topic-dropdown-wrapper {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  margin-bottom: 20px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  animation: slideDown 0.3s ease;
}
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.topic-select {
  width: 100%;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 14px;
  font-family: inherit;
  background: white;
  color: #334155;
  outline: none;
  transition: border-color 0.2s;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 36px;
}
.topic-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(14,165,164,0.1);
}

/* ==================== AUTH MODAL ==================== */
.auth-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(5px);
}
.auth-modal {
  background: white;
  border-radius: 16px;
  width: 90%;
  max-width: 50%;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3);
  animation: modalAppear 0.4s ease;
}
@keyframes modalAppear {
  from { opacity: 0; transform: scale(0.9) translateY(20px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}
.auth-header {
  background: linear-gradient(135deg, var(--accent), #0891b2);
  color: white;
  padding: 10px 30px;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.auth-header h2 {
  font-size: 42px;
  font-weight: 900;
  letter-spacing: -1px;
  text-transform: uppercase;
  margin: 0;
  padding: 0;
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  font-family: 'Inter', 'SF Pro Display', sans-serif;
  background: linear-gradient(145deg, #ffffff 0%, #f0f9ff 25%, #b8e1ff 50%, #f0f9ff 75%, #ffffff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 2px 0 rgba(14,165,164,0.1), 0 3px 0 rgba(14,165,164,0.1), 0 4px 0 rgba(14,165,164,0.1), 0 5px 10px rgba(0,0,0,0.3), 0 8px 20px rgba(14,165,164,0.3), 0 12px 30px rgba(0,0,0,0.2);
}
.auth-header h2 .medical-symbol {
  font-size: 42px;
  font-weight: 400;
  background: linear-gradient(135deg, #ffffff, #b8e1ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: pulseSymbol 2s infinite;
  line-height: 1;
}
@keyframes pulseSymbol {
  0% { transform: scale(1); opacity: 0.8; }
  50% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); opacity: 0.8; }
}
.auth-tabs {
  display: flex;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
}
.auth-tab {
  flex: 1;
  padding: 11px;
  background: none;
  border: none;
  font-size: 15px;
  font-weight: bold;
  color: #64748b;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}
.auth-tab.active { color: var(--accent); background: white; }
.auth-tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 100%;
  height: 3px;
  background: var(--accent);
  transform: translateX(-50%);
}
.auth-content { padding: 30px; }
.auth-tab-content { display: none; }
.auth-tab-content.active { display: block; animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.auth-form { display: flex; flex-direction: column; gap: 20px; }
.form-group { position: relative; width: 100%; }
.form-label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 6px; }
.auth-input {
  width: 100%;
  padding: 14px 45px 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  background: #f8fafc;
  transition: all 0.3s;
}
.auth-input:focus {
  outline: none;
  border-color: var(--accent);
  background: white;
  box-shadow: 0 0 0 4px rgba(14,165,164,0.15);
}
.password-toggle {
  position: absolute;
  right: 12px;
  top: 14px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  opacity: 0.7;
}
.auth-btn {
  padding: 16px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.guest-btn { background: linear-gradient(135deg, var(--accent), #0891b2); color: white; }
.login-btn { background: linear-gradient(135deg, var(--success), #059669); color: white; }
.signup-btn { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
.auth-divider {
  text-align: center;
  margin: 25px 0;
  position: relative;
}
.auth-divider::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 1px;
  background: #e2e8f0;
}
.auth-divider span {
  background: white;
  padding: 0 15px;
  color: #64748b;
  font-size: 14px;
  position: relative;
  z-index: 1;
}
.auth-switch-btn {
  background: none;
  border: none;
  color: var(--accent);
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  text-decoration: underline;
  margin-top: 10px;
}
.form-error { color: var(--danger); font-size: 13px; margin-top: 5px; display: none; }

/* ==================== TIMER & USER INFO ==================== */
.timer-user-container {
  position: fixed;
  top: 2px;
  right: 10px;
  z-index: 999;
  display: flex;
  align-items: center;
  gap: 15px;
  background: transparent;
}
.user-info { display: flex; align-items: center; }
.user-menu { position: relative; }
.username-text {
  font-size: 13px;
  font-weight: 700;
  color: var(--accent);
  cursor: pointer;
  padding: 2px 0;
  display: inline-block;
  direction: rtl;
  text-align: right;
}
.user-dropdown {
  position: absolute;
  top: calc(100% + 10px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.15);
  min-width: 220px;
  display: none;
  z-index: 1001;
  overflow: hidden;
  border: 1px solid #e2e8f0;
}
.user-dropdown.show { display: block; animation: dropdownAppear 0.3s ease; }
@keyframes dropdownAppear {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.user-dropdown-item {
  width: 100%;
  padding: 14px 20px;
  text-align: left;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  color: #334155;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #f1f5f9;
}
.user-dropdown-item:last-child { border-bottom: none; color: var(--danger); }
.user-dropdown-item:hover { background: #f8fafc; }
.wrong-count-badge {
  background: var(--danger);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 11px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: auto;
}
#timer {
  font-size: 13px;
  font-weight: 500;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}
.timer-separator { color: #cbd5e1; margin: 0; padding: 0; }

/* ==================== SETTINGS PAGE – 80% WIDTH, 90% HEIGHT ==================== */
.settings-page {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(248, 250, 252, 0.95);
  backdrop-filter: blur(4px);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}
.settings-container {
  width: 80vw;
  max-width: 1200px;
  height: 90vh;
  background: white;
  border-radius: 24px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
  padding: 30px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 25px;
  flex-shrink: 0;
}
.settings-header h2 {
  font-size: 28px;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
  background: linear-gradient(135deg, var(--accent), #0891b2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.settings-close-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  color: #64748b;
  transition: color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.settings-close-btn:hover { color: var(--danger); }
.settings-close-btn svg { width: 24px; height: 24px; }
#settingsContent {
  flex: 1;
  overflow-y: auto;
  padding-right: 10px;
}
.settings-section {
  margin-bottom: 30px;
  padding-bottom: 30px;
  border-bottom: 1px solid #e2e8f0;
}
.settings-section:last-child { border-bottom: none; padding-bottom: 0; }
.settings-section-title {
  font-size: 18px;
  font-weight: 600;
  color: #334155;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.settings-field { margin-bottom: 20px; }
.settings-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 8px;
}
.settings-input-group {
  display: flex;
  align-items: center;
  gap: 10px;
}
.settings-input {
  flex: 1;
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  background: #f8fafc;
}
.settings-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(14,165,164,0.15);
}
.settings-input:disabled { background: #f1f5f9; color: #64748b; }
.settings-eye-btn, .settings-edit-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  display: flex;
  align-items: center;
  color: #64748b;
}
.settings-edit-btn { color: var(--accent); font-weight: 600; gap: 5px; }
.settings-edit-btn:hover { background: #f0f9ff; border-radius: 6px; }
.mistakes-container {
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
  background: #f8fafc;
  border-radius: 12px;
  margin-top: 15px;
}
.mistake-item {
  padding: 16px;
  background: white;
  border-radius: 8px;
  margin-bottom: 12px;
  border-left: 4px solid var(--danger);
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.mistake-question { font-weight: 600; color: #1e293b; margin-bottom: 8px; font-size: 15px; }
.mistake-answers { display: flex; gap: 15px; font-size: 13px; }
.mistake-user-answer { color: var(--danger); }
.mistake-correct-answer { color: var(--success); }
.settings-print-btn {
  padding: 12px 24px;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 15px;
}
.settings-back-btn {
  padding: 12px 24px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
}
.settings-actions { display: flex; justify-content: flex-end; margin-top: 20px; }

/* ==================== OPTIONS SCREEN ==================== */
.container{ width: 100%; margin: 0 auto; flex: 1; }
.options-screen {
  background: white;
  border-radius: 10px;
  padding: 30px 40px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.06);
  margin: 0 auto;
  width: 100%;
  max-width: 800px;
  position: relative;
}
.mode-label{ font-size: 24px; font-weight: 600; margin-bottom: 30px; text-align: center; color: #1e293b; }
.option-row { display: flex; gap: 15px; margin-bottom: 18px; width: 100%; }
.option-item-half { flex: 1; min-width: 0; }
.option-item {
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 14px 18px;
  border-radius: 8px;
  transition: all 0.2s;
  cursor: pointer;
  border: 1px solid #e2e8f0;
}
.option-item:hover { background-color: #f1f5f9; border-color: var(--accent); transform: translateY(-2px); }
.option-item input[type="checkbox"]{ width: 18px; height: 18px; cursor: pointer; }
.option-item span{ font-size: 16px; color: #334155; flex: 1; }
.mode-separator {
  text-align: center;
  margin: 30px 0;
  color: var(--muted);
  font-weight: 600;
  position: relative;
}
.mode-separator::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 1px;
  background: #e2e8f0;
  z-index: 1;
}
.mode-separator span { background: white; padding: 0 20px; position: relative; z-index: 2; }
.start-btn{
  display: block;
  width: 180px;
  margin: 35px auto 0;
  padding: 14px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.start-btn:hover{ transform: translateY(-2px); box-shadow: 0 6px 18px rgba(14,165,164,0.25); }
.start-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ==================== TEST SCREENS ==================== */
.test-screen{ display: none; width: 100%; height: 100%; }
.test-screen.active{ display: flex; flex-direction: column; }

/* NORMAL MODE */
.normal-mode-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  padding-top: 0.5cm;
}
.question-text{
  font-size: 25px;
  font-weight: 600;
  line-height: 1.5;
  color: #0f172a;
  text-align: center;
  margin-bottom: 25px;
}
.answers-container{
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
  margin-bottom: 25px;
  flex: 1;
}
.answer-item{
  padding: 16px 20px;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #e2e8f0;
  font-size: 16px;
  line-height: 1.5;
}
.answer-item:hover{
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border-color: var(--accent);
  background-color: #f8fafc;
}
.answer-item.correct{ background: linear-gradient(135deg, #d1fae5, #f0fdf4); border-color: var(--success); color: #065f46; }
.answer-item.incorrect{ background: linear-gradient(135deg, #fee2e2, #fef2f2); border-color: var(--danger); color: #991b1b; }
.answer-item.selected { background-color: #e2e8f0; border-color: #94a3b8; }
.answer-number{ font-weight: 600; margin-right: 10px; color: var(--accent); }
.feedback{ padding: 0 10px; margin-bottom: 20px; text-align: center; min-height: 30px; }
.navigation {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 15px 10px;
  border-top: 1px solid #e2e8f0;
  width: 100%;
  margin-top: auto;
}
.nav-center { display: flex; gap: 12px; }
.nav-btn {
  padding: 10px 24px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.auto-btn{ background: #f59e0b; }
.auto-btn:hover{ background: #d97706; }
.nav-btn:disabled{ opacity: 0.5; cursor: not-allowed; }
.nav-btn:hover:not(:disabled){ opacity: 0.9; transform: translateY(-2px); }

/* EXAM MODE – default layout */
.exam-mode-container {
  width: 100%;
  flex: 1;
  display: flex;
  overflow: hidden;
}
.exam-mode-container.hidden { display: none !important; } /* strong override */
.question-left-panel {
  flex: 1;
  min-width: 0;
  padding-right: 20px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.exam-question-text{
  font-size: 20px;
  font-weight: 600;
  line-height: 1.4;
  color: #0f172a;
  margin-bottom: 15px;
  padding: 0;
  overflow-y: auto;
}
.exam-answers-container{
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
  margin-bottom: 10px;
  flex: 1;
}
.exam-answer-item{
  padding: 12px 16px;
  border-radius: 6px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #e2e8f0;
  font-size: 15px;
  display: flex;
  align-items: center;
}
.exam-answer-item:hover{
  transform: translateY(-2px);
  border-color: var(--accent);
  background-color: #f8fafc;
}
.exam-answer-item.selected { background-color: #e2e8f0; border-color: #94a3b8; }
.exam-answer-number{ font-weight: 600; margin-right: 10px; color: var(--accent); }
.exam-feedback{ padding: 0 10px; margin-bottom: 15px; text-align: center; }
.exam-right-panel {
  width: 25%;
  min-width: 300px;
  max-width: 350px;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-left: 20px;
  border-left: 1px solid #e2e8f0;
  height: 100%;
  flex-shrink: 0;
}
.exam-right-panel.hidden { display: none; }
.exam-countdown {
  width: 100%;
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: var(--danger);
  margin-bottom: 15px;
  padding: 8px;
  background: #fee2e2;
  border-radius: 6px;
}
.exam-test-boxes {
  display: grid;
  grid-template-columns: repeat(5, 45px);
  justify-content: center;
  gap: 8px;
  width: 100%;
  max-height: calc(100vh - 150px);
  padding: 15px 0;
  overflow-y: auto;
  background: #f8fafc;
  border-radius: 8px;
  grid-auto-rows: 45px;
}
.test-box {
  width: 45px;
  height: 45px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  background: white;
  transition: all 0.2s;
}
.test-box:hover { transform: scale(1.1); border-color: var(--accent); }
.test-box.answered { background: #BEEDCF; color: #64748b; border-color: #94a3b8; }
.test-box.current { background: var(--accent); color: white; border-color: var(--accent); transform: scale(1.1); }
.exam-navigation-container {
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: auto;
  padding: 15px 0;
  border-top: 1px solid #e2e8f0;
}
#examFinishBtn { display: none; } /* initially hidden, shown when all answered */

/* ==================== QUESTION COUNTER ==================== */
.question-counter {
  position: fixed;
  bottom: 20px;
  right: 20px;
  font-size: 28px;
  font-weight: 600;
  color: var(--accent);
  z-index: 998;
  display: flex;
  align-items: baseline;
  gap: 2px;
  cursor: pointer;
}
.question-counter .counter-separator,
.question-counter .total-questions {
  font-size: 28px;
  color: #64748b;
  font-weight: 600;
}
.question-counter .current-question {
  font-size: 28px;
  font-weight: 600;
  color: var(--accent);
  transition: all 0.2s;
  min-width: 50px;
  text-align: center;
}
.current-question.editing { color: var(--success); transform: scale(1.3); animation: pulse 0.3s ease; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1.3); } }
.hidden{ display: none !important; }

/* ==================== CHAT & ONLINE ==================== */
.bottom-left-container {
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 15px;
}
.chat-button {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(14,165,164,0.3);
  transition: all 0.3s;
  position: relative;
}
.chat-notification {
  position: absolute;
  top: -5px;
  right: -5px;
  background: var(--danger);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.chat-window {
  position: absolute;
  bottom: 70px;
  left: 0;
  width: 600px;
  height: 80vh;
  max-height: 800px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  display: none;
  flex-direction: column;
  overflow: hidden;
}
.chat-window.active { display: flex; }
.chat-header {
  padding: 12px 16px;
  background: var(--accent);
  color: white;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.close-chat { background: none; border: none; color: white; cursor: pointer; display: flex; }
.chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
.message { max-width: 85%; display: flex; flex-direction: column; }
.message.received { align-self: flex-start; }
.message.sent { align-self: flex-end; }
.message-author { font-size: 11px; font-weight: 600; color: #64748b; }
.message-time { font-size: 10px; color: #94a3b8; }
.message-content {
  padding: 10px 12px;
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.4;
}
.message.received .message-content { background: #f1f5f9; color: #1e293b; }
.message.sent .message-content { background: var(--accent); color: white; }
.chat-input-area {
  padding: 12px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 8px;
}
.chat-input { flex: 1; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 20px; }
.send-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.online-status {
  display: flex;
  align-items: center;
  gap: 8px;
}
.online-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse-online 2s infinite; }
.online-text { font-size: 14px; color: #64748b; }
#onlineCount { font-weight: 600; color: var(--accent); }
@keyframes pulse-online { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

/* ==================== MODAL ==================== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
.modal-overlay.active { display: flex; }
.modal {
  background: white;
  border-radius: 12px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}
.modal-header { font-size: 20px; font-weight: 600; color: #1e293b; margin-bottom: 20px; text-align: center; }
.modal-content { font-size: 16px; color: #64748b; margin-bottom: 30px; text-align: center; }
.modal-buttons { display: flex; gap: 15px; justify-content: center; }
.modal-btn { padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; min-width: 120px; }
.modal-btn.confirm { background: var(--success); color: white; }
.modal-btn.cancel { background: var(--danger); color: white; }

/* ==================== PRINT STYLES – 1cm MARGINS ==================== */
@media print {
  body { padding: 0 !important; margin: 0 !important; background: white !important; }
  .print-wrapper {
    margin: 0 1cm !important;
    width: calc(100% - 2cm) !important;
  }
  .settings-page { position: relative !important; display: block !important; background: white !important; }
  .settings-container { max-width: 100% !important; margin: 0 !important; box-shadow: none !important; }
  .mistake-item { page-break-inside: avoid; margin-bottom: 0.5cm !important; }
  .settings-print-btn, .settings-back-btn, .settings-close-btn, .settings-eye-btn, .settings-edit-btn, #saveUsernameBtn { display: none !important; }
}

/* ==================== MOBILE FIXES – iPhone 14 & similar ==================== */
@media (max-width: 768px) {
  body { padding: 10px; }
  .timer-user-container { flex-direction: row; top: 5px; right: 10px; gap: 5px; }
  #timer { font-size: 12px; }
  .username-text { font-size: 12px; }
  .options-screen { padding: 20px !important; max-width: 100%; }
  .option-row { flex-direction: column; gap: 12px; }
  .mode-label { font-size: 20px; }
  .start-btn { width: 100%; }
  .auth-modal { max-width: 95%; }
  .auth-header h2 { font-size: 32px; }
  
  /* Normal mode navigation – only წინა, შემდეგი, Auto */
  .normal-mode-container .navigation {
    position: fixed !important;
    bottom: 70px !important;
    left: 10px !important;
    right: 10px !important;
    background: white !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    padding: 12px !important;
    z-index: 1000 !important;
    border-top: none !important;
  }
  .normal-mode-container .navigation .nav-center {
    display: flex !important;
    justify-content: space-around !important;
    width: 100% !important;
  }
  .normal-mode-container .nav-btn {
    flex: 1 !important;
    padding: 12px 6px !important;
    font-size: 14px !important;
    min-width: 0 !important;
  }
  
  /* Exam mode navigation – წინა, გამოცდის დასრულება, შემდეგი, Auto */
  .exam-mode-container .exam-navigation-container {
    position: fixed !important;
    bottom: 70px !important;
    left: 10px !important;
    right: 10px !important;
    background: white !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    padding: 12px !important;
    z-index: 1000 !important;
    border-top: none !important;
  }
  .exam-mode-container .nav-center {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
    justify-content: center !important;
  }
  .exam-mode-container .nav-btn {
    flex: 1 1 calc(50% - 8px) !important;
    padding: 12px 6px !important;
    font-size: 14px !important;
    min-width: 0 !important;
  }
  #examFinishBtn { display: none; } /* will be set to flex when all answered */
  
  /* Adjust question counter on mobile */
  .question-counter {
    bottom: 140px !important;
    right: 10px !important;
    font-size: 22px !important;
  }
  .question-counter .current-question,
  .question-counter .counter-separator,
  .question-counter .total-questions {
    font-size: 22px !important;
  }
  
  /* Exam right panel hidden on mobile by default (can be toggled) */
  .exam-right-panel { display: none !important; }
  .exam-right-panel:not(.hidden) { display: flex !important; width: 100% !important; min-width: 100% !important; margin-top: 10px; }
  
  /* Chat window responsive */
  .chat-window { width: 90vw !important; left: 5vw !important; height: 60vh !important; }
  .bottom-left-container { bottom: 10px; left: 10px; right: 10px; flex-wrap: wrap; }
  .chat-button { padding: 10px 18px; font-size: 14px; }
  .online-status { font-size: 13px; }
  
  /* Settings page mobile */
  .settings-container { width: 95vw; height: 90vh; padding: 20px; }
  .settings-header h2 { font-size: 22px; }
}

/* Ensure exam finish button is visible when all answered (even on mobile) */
#examFinishBtn[style*="display: flex"] { display: flex !important; }
</style>
</head>
<body>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- ========== AUTH MODAL ========== -->
<div id="authModal" class="auth-modal-overlay">
  <div class="auth-modal">
    <div class="auth-header"><h2>UniMed<span class="medical-symbol">⚕</span></h2></div>
    <div id="authTabs" class="auth-tabs">
      <button class="auth-tab active" data-tab="guest">სტუმარი</button>
      <button class="auth-tab" data-tab="login">ავტორიზაცია</button>
      <button class="auth-tab" data-tab="signup">რეგისტრაცია</button>
    </div>
    <div id="authContent" class="auth-content">
      <div id="guestTab" class="auth-tab-content active">
        <div class="auth-form">
          <button id="continueAsGuest" class="auth-btn guest-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="white"/></svg>
            გაგრძელება, როგორც სტუმარი
          </button>
          <div class="auth-divider"><span>ან</span></div>
          <button id="showLoginFromGuest" class="auth-switch-btn" style="text-decoration: none;">შესვლა</button>
        </div>
      </div>
      <div id="loginTab" class="auth-tab-content">
        <div class="auth-form">
          <div class="form-group">
            <input type="text" id="loginUsername" class="auth-input" placeholder="მომხმარებლის სახელი">
            <div id="loginUsernameError" class="form-error"></div>
          </div>
          <div class="form-group">
            <input type="password" id="loginPassword" class="auth-input" placeholder="პაროლი">
            <button type="button" class="password-toggle" data-target="loginPassword">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2"/></svg>
            </button>
            <div id="loginPasswordError" class="form-error"></div>
          </div>
          <button id="loginBtn" class="auth-btn login-btn">შესვლა<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 16l4-4m0 0l-4-4m4 4H3m5 4v1a3 3 0 003 3h7a3 3 0 003-3V7a3 3 0 00-3-3h-7a3 3 0 00-3 3v1" stroke="white" stroke-width="2"/></svg></button>
          <button id="showSignupFromLogin" class="auth-switch-btn" style="text-decoration: none;">რეგისტრაცია</button>
        </div>
      </div>
      <div id="signupTab" class="auth-tab-content">
        <div class="auth-form">
          <div class="form-group">
            <label class="form-label">მომხმარებლის სახელი</label>
            <input type="text" id="signupUsername" class="auth-input" placeholder="მომხმარებელი">
            <div id="signupUsernameError" class="form-error"></div>
          </div>
          <div class="form-group">
            <label class="form-label">პაროლი (მინ. 6 სიმბოლო)</label>
            <input type="password" id="signupPassword" class="auth-input" placeholder="პაროლი">
            <button type="button" class="password-toggle" data-target="signupPassword">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2"/></svg>
            </button>
            <div id="signupPasswordError" class="form-error"></div>
          </div>
          <div class="form-group">
            <label class="form-label">გაიმეორეთ პაროლი</label>
            <input type="password" id="signupConfirmPassword" class="auth-input" placeholder="პაროლი">
            <button type="button" class="password-toggle" data-target="signupConfirmPassword">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2"/></svg>
            </button>
            <div id="signupConfirmError" class="form-error"></div>
          </div>
          <button id="signupBtn" class="auth-btn signup-btn">რეგისტრაცია<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke="white" stroke-width="2"/></svg></button>
          <button id="showLoginFromSignup" class="auth-switch-btn" style="text-decoration: none;">შესვლა</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== TIMER & USER INFO ========== -->
<div class="timer-user-container">
  <div id="userInfo" class="user-info" style="display: none;">
    <div class="user-menu">
      <span id="usernameBtn" class="username-text"><span id="usernameDisplay"></span></span>
      <div id="userDropdown" class="user-dropdown">
        <button class="user-dropdown-item" id="settingsBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/></svg>
          პარამეტრები
          <span id="wrongCountBadgeSettings" class="wrong-count-badge" style="display: none;">0</span>
        </button>
        <button class="user-dropdown-item" id="wrongQuestionsBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/></svg>
          შეცდომების გაკეთება
          <span id="wrongCountBadge" class="wrong-count-badge" style="display: none;">0</span>
        </button>
        <button class="user-dropdown-item" id="signOutBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" stroke="currentColor" stroke-width="2"/></svg>
          გასვლა
        </button>
      </div>
    </div>
  </div>
  <div id="timer"></div>
</div>

<!-- ========== CHAT & COUNTER ========== -->
<div class="bottom-left-container">
  <button id="chatButton" class="chat-button">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="white"/></svg>
    ჩატი
    <div id="chatNotification" class="chat-notification" style="display: none;"></div>
  </button>
  <div id="questionCounter" class="question-counter hidden">
    <div id="currentQuestion" class="current-question">1</div>
    <div class="counter-separator">/</div>
    <div id="totalQuestions" class="total-questions">0</div>
  </div>
  <div class="online-status">
    <div class="online-dot"></div>
    <span class="online-text">ონლაინ: <span id="onlineCount">1</span></span>
  </div>
  <div id="chatWindow" class="chat-window">
    <div class="chat-header">
      <span>ჩატი</span>
      <button class="close-chat">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6L18 18" stroke="white" stroke-width="2"/></svg>
      </button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" class="chat-input" placeholder="დაწერეთ...">
      <button id="sendBtn" class="send-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="white"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- ========== DETAILED RESULTS MODAL ========== -->
<div id="detailedResultsModal" class="modal-overlay">
  <div class="modal" style="max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
    <div class="modal-header">დეტალური შედეგები</div>
    <div id="detailedResultsContent" style="flex:1; overflow-y: auto; padding-right:10px;"></div>
    <div class="modal-buttons" style="margin-top:20px;">
      <button id="closeDetailsBtn" class="modal-btn confirm">დახურვა</button>
    </div>
  </div>
</div>

<!-- ========== MAIN CONTAINER ========== -->
<div class="container">
  <div id="optionsScreen" class="options-screen">
    <div class="mode-label">აირჩიეთ რეჟიმი:</div>
    <div class="option-row">
      <div class="option-item-half">
        <select id="testTypeSelect" class="topic-select">
          <option value="" selected disabled hidden>აირჩიეთ</option>
          <option value="rezidentura">რეზიდენტურა</option>
          <option value="cardiology" disabled>სალიცენზიო კარდიოლოგია (მალე)</option>
          <option value="neurology" disabled>სალიცენზიო ნევროლოგია (მალე)</option>
        </select>
      </div>
    </div>
    <div class="option-row">
      <label class="option-item option-item-half">
        <input type="checkbox" id="modeSequential" checked>
        <span>ტესტების ჩვენება თანმიმდევრობით</span>
      </label>
      <div id="topicsDropdownContainer" class="option-item-half" style="display: flex; flex-direction: column;">
        <select id="topicsSelect" class="topic-select">
          <option value="all" selected>ტესტები თემების მიხედვით</option>
        </select>
      </div>
    </div>
    <label class="option-item">
      <input type="checkbox" id="modeShuffleQuestions">
      <span>ტესტების არევა</span>
    </label>
    <label class="option-item">
      <input type="checkbox" id="modeShuffleAnswers">
      <span>პასუხების არევა</span>
    </label>
    <div class="mode-separator"><span>საგამოცდო რეჟიმი</span></div>
    <label class="option-item">
      <input type="checkbox" id="modeExam">
      <span>საგამოცდო რეჟიმი (200 შემთხვევითი ტესტი, დრო 3 საათი)</span>
    </label>
    <div id="loaderOverlay" class="loader-overlay">
      <div class="spinner"></div>
      <div class="loader-text">იტვირთება...</div>
    </div>
    <button id="startBtn" class="start-btn" disabled>დაწყება</button>
  </div>

  <div id="testScreen" class="test-screen">
    <!-- NORMAL MODE -->
    <div id="normalModeContainer" class="normal-mode-container hidden">
      <div id="questionText" class="question-text">იტვირთება...</div>
      <div id="answersContainer" class="answers-container"></div>
      <div id="feedback" class="feedback"></div>
      <div class="navigation">
        <div class="nav-center">
          <button id="prevBtn" class="nav-btn"><svg class="vector-arrow prev" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M15 18L9 12L15 6" stroke="white" stroke-width="2"/></svg>წინა</button>
          <button id="nextBtn" class="nav-btn">შემდეგი<svg class="vector-arrow next" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 18L15 12L9 6" stroke="white" stroke-width="2"/></svg></button>
          <button id="autoBtn" class="nav-btn auto-btn">Auto</button>
        </div>
      </div>
    </div>
    <!-- EXAM MODE -->
    <div id="examModeContainer" class="exam-mode-container hidden">
      <div class="question-left-panel">
        <div id="examQuestionText" class="exam-question-text">იტვირთება...</div>
        <div id="examAnswersContainer" class="exam-answers-container"></div>
        <div id="examFeedback" class="exam-feedback"></div>
        <div class="exam-navigation-container">
          <div class="nav-center">
            <button id="examPrevBtn" class="nav-btn"><svg class="vector-arrow prev" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M15 18L9 12L15 6" stroke="white" stroke-width="2"/></svg>წინა</button>
            <button id="examFinishBtn" class="nav-btn" style="background: var(--danger); display: none;">გამოცდის დასრულება</button>
            <button id="examNextBtn" class="nav-btn">შემდეგი<svg class="vector-arrow next" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 18L15 12L9 6" stroke="white" stroke-width="2"/></svg></button>
            <button id="examAutoBtn" class="nav-btn auto-btn">Auto</button>
          </div>
        </div>
      </div>
      <div id="examRightPanel" class="exam-right-panel hidden">
        <div id="examCountdown" class="exam-countdown">03:00:00</div>
        <div id="examTestBoxes" class="exam-test-boxes"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== FIREBASE ====================
let database = null;
let firebaseInitialized = false;
try {
  const firebaseConfig = {
    apiKey: "AIzaSyAOyV8LZWBkU5W8UbTF082l1ft1T2Rj1Yc",
    authDomain: "rezidentura-7bfd5.firebaseapp.com",
    databaseURL: "https://rezidentura-7bfd5-default-rtdb.firebaseio.com",
    projectId: "rezidentura-7bfd5",
    storageBucket: "rezidentura-7bfd5.firebasestorage.app",
    messagingSenderId: "1005787481414",
    appId: "1:1005787481414:web:7c5a31471a3d1c1a159147"
  };
  if (typeof firebase !== 'undefined' && !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    firebaseInitialized = true;
  }
} catch(e){ console.warn("Firebase init failed", e); }

// ==================== GLOBAL STATE ====================
let currentUser = null;
let currentTestType = null;
let userProgress = { rezidentura: { normal: { answeredQuestions: {}, currentIndex: 0 }, exam: { answeredQuestions: {}, currentIndex: 0 }, wrongQuestions: [] } };
let allTestsWithTopics = [];
let sessionTests = [];
let currentIndex = 0;
let autoMode = false;
let examMode = false;
let examTimeRemaining = 3 * 60 * 60;
let examTimerInterval = null;
let isEditingQuestionNumber = false;
let availableTopics = new Set();
let selectedTopic = null;

// Chat globals
let chatMessages = [];
let onlineUsers = 1;
let userName = localStorage.getItem('chatUserName') || ('სტუმარი ' + Math.floor(Math.random() * 1000));
let userId = localStorage.getItem('chatUserId') || ('user_' + Date.now() + '_' + Math.random().toString(36).substr(2,9));
localStorage.setItem('chatUserId', userId);
localStorage.setItem('chatUserName', userName);
let displayedMessageKeys = new Set();
let unreadMessagesCount = 0;
let isChatOpen = false;

// DOM elements
let optionsScreen, testScreen, questionText, answersContainer, feedback, startBtn, timerElement;
let examRightPanel, examCountdown, examTestBoxes, questionCounter, currentQuestionEl, totalQuestionsEl, loaderOverlay;
let modeSequential, modeShuffleQuestions, modeShuffleAnswers, modeExam;
let normalModeContainer, examModeContainer, examQuestionText, examAnswersContainer, examFeedback;
let prevBtn, nextBtn, autoBtn, examPrevBtn, examNextBtn, examAutoBtn, examFinishBtn, detailedResultsModal, detailedResultsContent;
let chatButton, chatWindow, closeChat, chatMessagesEl, onlineCount, chatInput, sendBtn, wrongCountBadge, wrongCountBadgeSettings;

// ==================== UTILITIES ====================
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function showNotification(msg, isError = true){
  const n = document.createElement('div'); n.className = 'notification'; n.textContent = msg; n.style.background = isError ? 'var(--danger)' : 'var(--success)';
  n.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:12px 24px; border-radius:8px; color:white; font-weight:600; z-index:1000; animation:slideIn 0.3s ease, fadeOut 0.3s ease 3.7s;';
  document.body.appendChild(n);
  setTimeout(()=> n.remove(), 4000);
}
function updateTimerDisplay(){
  const now = new Date().toLocaleTimeString('ka-GE');
  timerElement.innerHTML = `<span class="timer-separator">|</span><span class="timer-time">${now}</span>`;
}
function updateTimer(){ updateTimerDisplay(); if(examMode) updateExamTimer(); }
function updateExamTimer(){
  if(!examMode) return;
  const h = Math.floor(examTimeRemaining/3600), m = Math.floor((examTimeRemaining%3600)/60), s = examTimeRemaining%60;
  examCountdown.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  if(examTimeRemaining <= 0){ clearInterval(examTimerInterval); completeExam(); } else examTimeRemaining--;
}
function resetLoader(){ loaderOverlay.innerHTML = '<div class="spinner"></div><div class="loader-text">იტვირთება...</div>'; }

// ==================== USER PROGRESS & WRONG COUNT ====================
function saveUserProgress(){
  if(!currentUser || currentUser.isGuest || !currentTestType) return;
  try {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    if(users[currentUser.username]) {
      users[currentUser.username].progress = userProgress;
      localStorage.setItem('users', JSON.stringify(users));
    }
  } catch(e){}
}
function loadUserProgress(){
  if(!currentUser || currentUser.isGuest) return;
  try {
    const users = JSON.parse(localStorage.getItem('users') || '{}');
    if(users[currentUser.username]?.progress) userProgress = users[currentUser.username].progress;
  } catch(e){}
}
function updateUserProgress(questionId, selectedAnswer, isCorrect, isExamMode = false){
  if(!currentUser || currentUser.isGuest || !currentTestType) return;
  const mode = isExamMode ? 'exam' : 'normal';
  if(!userProgress[currentTestType]) userProgress[currentTestType] = { normal: { answeredQuestions: {}, currentIndex:0 }, exam: { answeredQuestions: {}, currentIndex:0 }, wrongQuestions: [] };
  if(!userProgress[currentTestType][mode]) userProgress[currentTestType][mode] = { answeredQuestions: {}, currentIndex:0 };
  userProgress[currentTestType][mode].answeredQuestions[questionId] = { selectedAnswer, isCorrect, timestamp: Date.now() };
  const wrongArr = userProgress[currentTestType].wrongQuestions;
  if(!isCorrect){
    if(!wrongArr.includes(questionId)) wrongArr.push(questionId);
  } else {
    const idx = wrongArr.indexOf(questionId);
    if(idx !== -1) wrongArr.splice(idx,1);
  }
  saveUserProgress();
  updateWrongQuestionsBadge();
}
function getWrongQuestions(){ return (userProgress[currentTestType]?.wrongQuestions) || []; }
function updateWrongQuestionsBadge(){
  if(!currentTestType || !currentUser || currentUser.isGuest){ 
    if(wrongCountBadge) wrongCountBadge.style.display = 'none';
    if(wrongCountBadgeSettings) wrongCountBadgeSettings.style.display = 'none';
    return;
  }
  const count = getWrongQuestions().length;
  if(wrongCountBadge){
    wrongCountBadge.textContent = count > 99 ? '99+' : count;
    wrongCountBadge.style.display = count ? 'inline-flex' : 'none';
  }
  if(wrongCountBadgeSettings){
    wrongCountBadgeSettings.textContent = count > 99 ? '99+' : count;
    wrongCountBadgeSettings.style.display = count ? 'inline-flex' : 'none';
  }
}

// ==================== AUTH ====================
function initAuth(){
  const modal = document.getElementById('authModal'); modal.style.display = 'flex';
  document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', function(){
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
    });
  });
  document.querySelectorAll('.password-toggle').forEach(btn => {
    btn.addEventListener('click', function(){
      const inp = document.getElementById(this.dataset.target);
      if(inp.type === 'password'){ inp.type = 'text'; this.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" stroke="#64748b" stroke-width="2"/><line x1="1" y1="1" x2="23" y2="23" stroke="#64748b" stroke-width="2"/></svg>'; }
      else { inp.type = 'password'; this.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#64748b" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="#64748b" stroke-width="2"/></svg>'; }
    });
  });
  document.getElementById('continueAsGuest').addEventListener('click', ()=>{
    currentUser = { username: 'სტუმარი '+Math.floor(Math.random()*1000), isGuest: true, progress: {} };
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('usernameDisplay').textContent = currentUser.username;
    userName = currentUser.username; localStorage.setItem('chatUserName', userName);
    loadCSV(); initChat(); updateTimerDisplay(); updateWrongQuestionsBadge();
    showNotification('კეთილი იყოს თქვენი მობრძანება!', false);
  });
  document.getElementById('showLoginFromGuest').addEventListener('click', ()=>{
    document.querySelectorAll('.auth-tab, .auth-tab-content').forEach(el => el.classList.remove('active'));
    document.querySelector('[data-tab="login"]').classList.add('active');
    document.getElementById('loginTab').classList.add('active');
  });
  document.getElementById('loginBtn').addEventListener('click', handleLogin);
  document.getElementById('signupBtn').addEventListener('click', handleSignup);
  document.getElementById('showSignupFromLogin').addEventListener('click', (e)=>{
    e.preventDefault();
    document.querySelectorAll('.auth-tab, .auth-tab-content').forEach(el => el.classList.remove('active'));
    document.querySelector('[data-tab="signup"]').classList.add('active');
    document.getElementById('signupTab').classList.add('active');
  });
  document.getElementById('showLoginFromSignup').addEventListener('click', (e)=>{
    e.preventDefault();
    document.querySelectorAll('.auth-tab, .auth-tab-content').forEach(el => el.classList.remove('active'));
    document.querySelector('[data-tab="login"]').classList.add('active');
    document.getElementById('loginTab').classList.add('active');
  });
}
function handleLogin(){
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  document.getElementById('loginUsernameError').style.display = 'none';
  document.getElementById('loginPasswordError').style.display = 'none';
  if(!username) { document.getElementById('loginUsernameError').textContent = 'მომხმარებლის სახელი აუცილებელია'; document.getElementById('loginUsernameError').style.display = 'block'; return; }
  if(!password) { document.getElementById('loginPasswordError').textContent = 'პაროლი აუცილებელია'; document.getElementById('loginPasswordError').style.display = 'block'; return; }
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if(!users[username]) { document.getElementById('loginUsernameError').textContent = 'ასეთი მომხმარებელი არ არსებობს'; document.getElementById('loginUsernameError').style.display = 'block'; return; }
  if(users[username].password !== password) { document.getElementById('loginPasswordError').textContent = 'პაროლი არასწორია'; document.getElementById('loginPasswordError').style.display = 'block'; return; }
  currentUser = { username, isGuest: false };
  loadUserProgress();
  document.getElementById('loginUsername').value = ''; document.getElementById('loginPassword').value = '';
  document.getElementById('authModal').style.display = 'none';
  document.getElementById('userInfo').style.display = 'flex';
  document.getElementById('usernameDisplay').textContent = currentUser.username;
  userName = currentUser.username; localStorage.setItem('chatUserName', userName);
  showNotification('წარმატებით შეხვედით სისტემაში!', false);
  if(allTestsWithTopics.length===0) loadCSV(); else startBtn.disabled = false;
  initChat(); bindUserMenuEvents(); updateTimerDisplay(); updateWrongQuestionsBadge();
}
function handleSignup(){
  const username = document.getElementById('signupUsername').value.trim();
  const pass = document.getElementById('signupPassword').value;
  const confirm = document.getElementById('signupConfirmPassword').value;
  document.getElementById('signupUsernameError').style.display = 'none';
  document.getElementById('signupPasswordError').style.display = 'none';
  document.getElementById('signupConfirmError').style.display = 'none';
  if(!username) { document.getElementById('signupUsernameError').textContent = 'მომხმარებლის სახელი აუცილებელია'; document.getElementById('signupUsernameError').style.display = 'block'; return; }
  if(username.length<3) { document.getElementById('signupUsernameError').textContent = 'მინიმუმ 3 სიმბოლო'; document.getElementById('signupUsernameError').style.display = 'block'; return; }
  if(/[^a-zA-Z0-9ა-ჰ_]/.test(username)) { document.getElementById('signupUsernameError').textContent = 'მხოლოდ ასოები, ციფრები, ქართული'; document.getElementById('signupUsernameError').style.display = 'block'; return; }
  if(!pass) { document.getElementById('signupPasswordError').textContent = 'პაროლი აუცილებელია'; document.getElementById('signupPasswordError').style.display = 'block'; return; }
  if(pass.length<6) { document.getElementById('signupPasswordError').textContent = 'მინიმუმ 6 სიმბოლო'; document.getElementById('signupPasswordError').style.display = 'block'; return; }
  if(!confirm) { document.getElementById('signupConfirmError').textContent = 'გაიმეორეთ პაროლი'; document.getElementById('signupConfirmError').style.display = 'block'; return; }
  if(pass !== confirm) { document.getElementById('signupConfirmError').textContent = 'პაროლი არ ემთხვევა'; document.getElementById('signupConfirmError').style.display = 'block'; return; }
  const users = JSON.parse(localStorage.getItem('users') || '{}');
  if(users[username]) { document.getElementById('signupUsernameError').textContent = 'მომხმარებელი უკვე არსებობს'; document.getElementById('signupUsernameError').style.display = 'block'; return; }
  users[username] = { password: pass, progress: { rezidentura: { normal: { answeredQuestions: {}, currentIndex:0 }, exam: { answeredQuestions: {}, currentIndex:0 }, wrongQuestions: [] } } };
  localStorage.setItem('users', JSON.stringify(users));
  document.getElementById('signupUsername').value = ''; document.getElementById('signupPassword').value = ''; document.getElementById('signupConfirmPassword').value = '';
  showNotification('რეგისტრაცია წარმატებულია! შედით', false);
  setTimeout(()=>{
    document.querySelectorAll('.auth-tab, .auth-tab-content').forEach(el => el.classList.remove('active'));
    document.querySelector('[data-tab="login"]').classList.add('active');
    document.getElementById('loginTab').classList.add('active');
    document.getElementById('loginUsername').value = username;
    document.getElementById('loginPassword').focus();
  }, 1000);
}

// ==================== CSV LOADING ====================
function loadCSV(){
  loaderOverlay.style.display = 'flex'; resetLoader(); startBtn.disabled = true;
  fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vTAKLvhjOkhFoadqGeDcS_T74DdtGNqLPY30zld05OjmbwwP_i-anVEF0uNNTtb29NoPKLm6XTAxIGu/pub?gid=69945858&single=true&output=csv")
  .then(r=>{ if(!r.ok) throw new Error('Network error'); return r.text(); })
  .then(txt=>{
    const rows = parseCSVTwoColumns(txt);
    allTestsWithTopics = buildTestsFromCSV(rows);
    if(!allTestsWithTopics.length){ showNotification('ტესტები ვერ მოიძებნა'); loaderOverlay.innerHTML = '<div style="color:var(--danger); padding:20px;">ტესტები ვერ მოიძებნა</div>'; startBtn.disabled = false; return; }
    totalQuestionsEl.textContent = allTestsWithTopics.length;
    extractTopics(); populateTopicsList();
    loaderOverlay.style.display = 'none'; startBtn.disabled = false;
  }).catch(err=>{ showNotification('შეცდომა ჩატვირთვისას: '+err.message); loaderOverlay.innerHTML = '<div style="color:var(--danger); padding:20px;">შეცდომა</div>'; startBtn.disabled = false; });
}
function parseCSVTwoColumns(csvText){
  if(!csvText) return [];
  csvText = csvText.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const rows = [];
  csvText.split('\n').forEach(line=>{
    line = line.trim(); if(!line) return;
    let cols = [], cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i], nxt=line[i+1];
      if(ch=='"'){ if(inQ && nxt=='"'){ cur+='"'; i++; } else inQ=!inQ; }
      else if(ch==',' && !inQ){ cols.push(cur.trim()); cur=''; }
      else cur+=ch;
    }
    cols.push(cur.trim());
    if(cols.length===1) cols.push('');
    rows.push({ columnA: cols[0], columnB: cols[1]||'' });
  });
  return rows;
}
function buildTestsFromCSV(rawRows){
  const tests = []; let current = null, topic='ზოგადი';
  rawRows.forEach(r=>{
    const a = normalizeLine(r.columnA), b = normalizeLine(r.columnB);
    if(!a && !b) return;
    if(b) topic = b;
    const type = detectLineType(a);
    if(type==='question'){
      if(current && current.answers.length) { current.topic = topic; tests.push(current); }
      current = { raw: a, question: stripLeadingSymbol(a), topic, answers: [], sourceIndex: -1 };
    } else if((type==='correct'||type==='incorrect') && current){
      const txt = stripLeadingSymbol(a);
      if(txt) current.answers.push({ text: txt, correct: type==='correct', originalText: txt });
    }
  });
  if(current && current.answers.length) { current.topic = topic; tests.push(current); }
  return tests.filter(t=>t.answers.length>0);
}
function normalizeLine(s){ if(!s) return ''; return String(s).normalize('NFKC').replace(/^\uFEFF/, '').replace(/[\u200B-\u200F\uFEFF]/g,'').replace(/^"+|"+$/g,'').replace(/\s+/g,' ').trim(); }
function detectLineType(s){
  if(!s) return 'unknown';
  if(/^¢/.test(s)) return 'question';
  if(/^(✔️|✔|✓|✅|\+)/.test(s)) return 'correct';
  if(/^(❌|✖️|✖|✕|✗|✘|-)/.test(s)) return 'incorrect';
  if(/[ა-ჰ]/.test(s) && /\?$/.test(s)) return 'question';
  return 'unknown';
}
function stripLeadingSymbol(s){ return s.replace(/^¢\s*(ID=\d+\s*)?/,'').replace(/^[✔️✔✓✅+❌✖️✖✕✗✘\-]\s*/,'').trim(); }
function extractTopics(){ availableTopics.clear(); allTestsWithTopics.forEach(t=> availableTopics.add(t.topic?.trim()||'ზოგადი')); }
function populateTopicsList(){
  const sel = document.getElementById('topicsSelect'); if(!sel) return;
  sel.innerHTML = '<option value="all" selected>ტესტები თემების მიხედვით</option>';
  const counts = {};
  allTestsWithTopics.forEach(t=>{ let top = t.topic?.trim()||'ზოგადი'; counts[top] = (counts[top]||0)+1; });
  [...new Set(allTestsWithTopics.map(t=>t.topic?.trim()||'ზოგადი'))].sort().forEach(top=>{
    let opt = document.createElement('option'); opt.value = top; opt.textContent = `${top} (${counts[top]||0})`;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', ()=> selectedTopic = sel.value==='all' ? null : sel.value);
  toggleTopicsDropdown();
}
function toggleTopicsDropdown(){
  const testTypeSelect = document.getElementById('testTypeSelect');
  const topicsContainer = document.getElementById('topicsDropdownContainer');
  if(testTypeSelect.value==='rezidentura') topicsContainer.style.display = 'flex'; else { topicsContainer.style.display = 'none'; selectedTopic = null; }
}

// ==================== START TEST & RENDERING ====================
function startTest(){
  if(!allTestsWithTopics.length) { showNotification('ტესტები ჯერ არ არის ჩატვირთული'); return; }
  if(!document.getElementById('testTypeSelect').value) { showNotification('გთხოვთ აირჩიოთ მოდული'); return; }
  currentTestType = document.getElementById('testTypeSelect').value;
  if(currentTestType==='rezidentura' && document.getElementById('topicsSelect').value==='') { showNotification('აირჩიეთ თემა!'); return; }
  examMode = modeExam.checked;
  const shuffleQuestions = modeShuffleQuestions.checked || examMode;
  const shuffleAnswers = modeShuffleAnswers.checked;
  let testsToUse = allTestsWithTopics;
  if(selectedTopic) testsToUse = allTestsWithTopics.filter(t=> (t.topic?.trim()||'ზოგადი') === selectedTopic);
  if(!testsToUse.length) { showNotification('არჩეულ თემას არ გააჩნია ტესტები'); return; }
  if(examMode){
    let shuffled = [...testsToUse]; shuffleArray(shuffled);
    sessionTests = shuffled.slice(0,200).map((t,idx)=>({
      id: idx.toString(), question: t.question, answers: t.answers.map(a=>({...a})),
      selectedAnswers: [], hasCorrectAnswer: false, isAnswerCorrect: null
    }));
  } else {
    sessionTests = testsToUse.map((t,idx)=>({
      id: idx.toString(), question: t.question, answers: t.answers.map(a=>({...a})),
      selectedAnswers: [], hasCorrectAnswer: false, isAnswerCorrect: null
    }));
  }
  if(shuffleQuestions && !examMode) shuffleArray(sessionTests);
  if(shuffleAnswers) sessionTests.forEach(q=> shuffleArray(q.answers));
  optionsScreen.style.display = 'none';
  testScreen.classList.add('active');
  if(examMode) startExamMode();
  else {
    normalModeContainer.classList.remove('hidden');
    examModeContainer.classList.add('hidden');
    examRightPanel.classList.add('hidden');
    questionCounter.classList.remove('hidden');
    currentQuestionEl.textContent = currentIndex+1;
    totalQuestionsEl.textContent = sessionTests.length;
    timerElement.classList.remove('hidden');
  }
  renderCurrentQuestion();
  updateWrongQuestionsBadge();
}
function startExamMode(){
  examMode = true;
  examTimeRemaining = 3*60*60;
  timerElement.classList.add('hidden');
  normalModeContainer.classList.add('hidden');
  examModeContainer.classList.remove('hidden');
  examRightPanel.classList.remove('hidden');
  questionCounter.classList.add('hidden');
  examFinishBtn.style.display = 'none';
  createExamTestBoxes();
  clearInterval(examTimerInterval);
  examTimerInterval = setInterval(updateExamTimer,1000);
  updateExamTimer();
}
function createExamTestBoxes(){
  examTestBoxes.innerHTML = '';
  for(let i=0;i<200;i++){
    let box = document.createElement('div');
    box.className = 'test-box'; box.textContent = i+1; box.dataset.index = i;
    if(i===currentIndex) box.classList.add('current');
    if(sessionTests[i]?.selectedAnswers?.length) box.classList.add('answered');
    box.addEventListener('click', ()=>{ currentIndex = i; renderCurrentQuestion(); });
    examTestBoxes.appendChild(box);
  }
}
function renderCurrentQuestion(){
  if(!sessionTests.length) return;
  const q = sessionTests[currentIndex];
  if(examMode){
    examQuestionText.textContent = q.question;
    renderExamAnswers();
    createExamTestBoxes();
    checkAllQuestionsAnswered();
  } else {
    questionText.textContent = q.question;
    currentQuestionEl.textContent = currentIndex+1;
    totalQuestionsEl.textContent = sessionTests.length;
    renderNormalAnswers();
  }
}
function renderNormalAnswers(){
  const q = sessionTests[currentIndex];
  answersContainer.innerHTML = ''; feedback.innerHTML = '';
  q.answers.forEach((a,idx)=>{
    let el = document.createElement('div');
    el.className = 'answer-item';
    let wasSelected = q.selectedAnswers?.includes(idx);
    if(wasSelected) { el.classList.add('selected'); if(a.correct) el.classList.add('correct'); else el.classList.add('incorrect'); }
    el.innerHTML = `<span class="answer-number">${idx+1}.</span><span class="answer-text">${escapeHtml(a.text)}</span>`;
    el.addEventListener('click', ()=>{
      if(wasSelected) return;
      if(!q.selectedAnswers) q.selectedAnswers = [];
      q.selectedAnswers.push(idx);
      el.classList.add('selected');
      if(a.correct){
        el.classList.add('correct');
        q.hasCorrectAnswer = true;
        feedback.innerHTML = '<div style="color:var(--success); font-size:16px; font-weight:600;">✓ სწორი პასუხი!</div>';
        updateUserProgress(q.id, idx, true, false);
        if(autoMode && currentIndex < sessionTests.length-1){
          setTimeout(()=>{ currentIndex++; autoSaveProgress(); renderCurrentQuestion(); }, 500);
        }
      } else {
        el.classList.add('incorrect');
        feedback.innerHTML = '<div style="color:var(--danger); font-size:16px; font-weight:600;">✗ არასწორი პასუხი</div>';
        updateUserProgress(q.id, idx, false, false);
      }
      autoSaveProgress(); renderCurrentQuestion();
    });
    answersContainer.appendChild(el);
  });
  prevBtn.disabled = currentIndex===0;
  nextBtn.disabled = currentIndex===sessionTests.length-1;
  updateAutoButton();
}
function renderExamAnswers(){
  const q = sessionTests[currentIndex];
  examAnswersContainer.innerHTML = ''; examFeedback.innerHTML = '';
  q.answers.forEach((a,idx)=>{
    let el = document.createElement('div');
    el.className = 'exam-answer-item';
    let wasSelected = q.selectedAnswers?.includes(idx);
    if(wasSelected) el.classList.add('selected');
    el.innerHTML = `<span class="exam-answer-number">${idx+1}.</span><span class="answer-text">${escapeHtml(a.text)}</span>`;
    el.addEventListener('click', ()=>{
      if(wasSelected) return;
      q.selectedAnswers = [idx];
      q.isAnswerCorrect = a.correct;
      el.classList.add('selected');
      examFeedback.innerHTML = '';
      createExamTestBoxes();
      updateUserProgress(q.id, idx, a.correct, true);
      onAnswerSelected();
      autoSaveProgress(); renderCurrentQuestion();
    });
    examAnswersContainer.appendChild(el);
  });
  examPrevBtn.disabled = currentIndex===0;
  examNextBtn.disabled = currentIndex===sessionTests.length-1;
  updateExamAutoButton();
}
function onAnswerSelected(){ checkAllQuestionsAnswered(); }
function checkAllQuestionsAnswered(){
  let all = sessionTests.every(q=> q.selectedAnswers?.length > 0);
  if(examFinishBtn) examFinishBtn.style.display = all ? 'flex' : 'none';
  if(examTestBoxes){
    let boxes = examTestBoxes.querySelectorAll('.test-box');
    boxes.forEach((b,i)=>{ if(sessionTests[i]?.selectedAnswers?.length) b.classList.add('answered'); else b.classList.remove('answered'); });
  }
  return all;
}
function autoSaveProgress(){
  if(!currentUser || currentUser.isGuest || !currentTestType) return;
  let mode = examMode ? 'exam' : 'normal';
  if(!userProgress[currentTestType]) userProgress[currentTestType] = { normal: { answeredQuestions:{}, currentIndex:0 }, exam: { answeredQuestions:{}, currentIndex:0 }, wrongQuestions:[] };
  if(!userProgress[currentTestType][mode]) userProgress[currentTestType][mode] = { answeredQuestions:{}, currentIndex:0 };
  userProgress[currentTestType][mode].currentIndex = currentIndex;
  if(examMode) userProgress[currentTestType].exam.examTimeRemaining = examTimeRemaining;
  saveUserProgress();
}
function updateAutoButton(){
  if(autoMode){ nextBtn.classList.add('vanish-effect'); autoBtn.textContent = 'გამორთე Auto'; }
  else { nextBtn.classList.remove('vanish-effect'); autoBtn.textContent = 'Auto'; }
}
function updateExamAutoButton(){
  if(autoMode){ examNextBtn.classList.add('vanish-effect'); examAutoBtn.textContent = 'გამორთე Auto'; }
  else { examNextBtn.classList.remove('vanish-effect'); examAutoBtn.textContent = 'Auto'; }
}
function completeExam(){
  clearInterval(examTimerInterval);
  timerElement.classList.remove('hidden');
  let correct = sessionTests.filter(q=> q.selectedAnswers?.some(idx=> q.answers[idx]?.correct)).length;
  examRightPanel.classList.add('hidden');
  testScreen.innerHTML = `<div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#f8fafc; padding:20px;">
    <div style="max-width:800px; width:100%; background:white; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.15); padding:30px;">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px;">
        <div style="text-align:center; padding:20px; background:#f0fdf4; border-radius:8px;">
          <div style="font-size:14px; color:#64748b;">სწორი</div>
          <div style="font-size:42px; font-weight:700; color:var(--success);">${correct}</div>
        </div>
        <div style="text-align:center; padding:20px; background:#fef2f2; border-radius:8px;">
          <div style="font-size:14px; color:#64748b;">არასწორი</div>
          <div style="font-size:42px; font-weight:700; color:var(--danger);">${200-correct}</div>
        </div>
      </div>
      <div style="text-align:center; padding:15px; background:#f8fafc; border-radius:8px;">
        <div style="font-size:16px; color:#64748b;">შეფასება</div>
        <div style="font-size:28px; font-weight:700; color:${correct>=150?'var(--success)':'var(--danger)'}">
          ${correct>=150?'გამოცდა ჩაბარებულია':'ჩაჭრილია!'}
        </div>
      </div>
      <div style="margin-top:30px; display:flex; gap:15px; justify-content:center;">
        <button id="viewDetailsBtn" class="nav-btn" style="background:var(--accent);">დეტალურად</button>
        <button id="restartBtn" class="nav-btn" style="background:#10b981;">ახლიდან</button>
      </div>
    </div>
  </div>`;
  document.getElementById('viewDetailsBtn')?.addEventListener('click', showDetailedResults);
  document.getElementById('restartBtn')?.addEventListener('click', ()=> location.reload());
}
function showDetailedResults(){
  detailedResultsContent.innerHTML = '';
  let table = document.createElement('table'); table.style.width = '100%'; table.style.borderCollapse = 'collapse';
  table.innerHTML = `<thead><tr style="background:#f1f5f9;"><th style="padding:12px; text-align:left;">#</th><th style="padding:12px;">კითხვა</th><th style="padding:12px;">თქვენი</th><th style="padding:12px;">სწორი</th><th style="padding:12px;">სტატუსი</th></tr></thead><tbody></tbody>`;
  sessionTests.forEach((q,i)=>{
    let sel = q.selectedAnswers?.[0]; let isCor = sel!==-1 && q.answers[sel]?.correct;
    let userAns = sel!==-1 ? q.answers[sel].text : 'არაა არჩეული';
    let corAns = q.answers.find(a=>a.correct)?.text || '';
    let row = table.tBodies[0].insertRow();
    row.innerHTML = `<td style="padding:12px; font-weight:600;">${i+1}</td>
      <td style="padding:12px;">${escapeHtml(q.question.substring(0,80))}...</td>
      <td style="padding:12px; color:${isCor?'var(--success)':'var(--danger)'};">${escapeHtml(userAns)}</td>
      <td style="padding:12px; color:var(--success);">${escapeHtml(corAns)}</td>
      <td style="padding:12px;"><span style="padding:4px 8px; border-radius:4px; background:${isCor?'#d1fae5':'#fee2e2'}; color:${isCor?'#065f46':'#991b1b'};">${isCor?'სწორი':'არასწორი'}</span></td>`;
  });
  detailedResultsContent.appendChild(table);
  detailedResultsModal.classList.add('active');
}

// ==================== SETTINGS PAGE ====================
function showSettingsPage(){
  if(!currentUser || currentUser.isGuest) { showNotification('მხოლოდ რეგისტრირებულ მომხმარებლებს შეუძლიათ პარამეტრების ნახვა'); return; }
  const html = `<div id="settingsPage" class="settings-page"><div class="settings-container"><div class="settings-header">
    <h2>პარამეტრები</h2>
    <button class="settings-close-btn" onclick="closeSettingsPage()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div><div id="settingsContent">
    <div class="settings-section"><div class="settings-section-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="#0ea5a4"/></svg>მომხმარებლის ინფორმაცია</div>
    <div class="settings-field"><label class="settings-label">მომხმარებლის სახელი</label><div class="settings-input-group"><input type="text" id="settingsUsername" class="settings-input" value="${escapeHtml(currentUser.username)}" disabled><button class="settings-edit-btn" onclick="enableUsernameEdit()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" stroke="currentColor" fill="currentColor"/></svg>შეცვლა</button></div></div>
    <div class="settings-field"><label class="settings-label">პაროლი</label><div class="settings-input-group"><input type="password" id="settingsPassword" class="settings-input" value="${escapeHtml(getUserPassword(currentUser.username)||'')}" disabled><button class="settings-eye-btn" onclick="togglePasswordVisibility('settingsPassword', this)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/></svg></button><button class="settings-edit-btn" onclick="showPasswordChangeFromSettings()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" stroke="currentColor" fill="currentColor"/></svg>შეცვლა</button></div></div></div>
    <div class="settings-section"><div class="settings-section-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#dc2626" stroke-width="2"/></svg>შეცდომების ისტორია</div>
    <div id="mistakesList" class="mistakes-container">${renderMistakesList()}</div>
    <button class="settings-print-btn" onclick="printMistakes()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9V3h12v6m0 4h.01M6 15h12v6H6v-6z" stroke="white" stroke-width="2"/><path d="M6 19v-4h12v4" stroke="white" stroke-width="2"/></svg>შეცდომების დაბეჭდვა</button></div>
    <div class="settings-actions"><button class="settings-back-btn" onclick="closeSettingsPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M15 18L9 12L15 6" stroke="white" stroke-width="2"/></svg>მთავარ გვერდზე დაბრუნება</button></div>
  </div></div></div>`;
  let existing = document.getElementById('settingsPage'); if(existing) existing.remove();
  document.body.insertAdjacentHTML('beforeend', html);
}
function getUserPassword(u){ try{ return JSON.parse(localStorage.getItem('users')||'{}')[u]?.password||''; }catch(e){ return ''; } }
function togglePasswordVisibility(id, btn){
  let inp = document.getElementById(id);
  if(inp.type==='password'){ inp.type='text'; btn.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" stroke="currentColor" stroke-width="2"/><line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/></svg>'; }
  else{ inp.type='password'; btn.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/></svg>'; }
}
function enableUsernameEdit(){
  let inp = document.getElementById('settingsUsername'); inp.disabled = false; inp.focus();
  if(!document.getElementById('saveUsernameBtn')){
    let btn = document.createElement('button'); btn.id='saveUsernameBtn'; btn.className='settings-edit-btn'; btn.style.color='var(--success)';
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2"/></svg>შენახვა';
    btn.onclick = saveUsername;
    inp.parentElement.appendChild(btn);
  }
}
function saveUsername(){
  let newName = document.getElementById('settingsUsername').value.trim();
  if(!newName){ showNotification('სახელი ცარიელია'); return; }
  if(newName === currentUser.username){ showNotification('ახალი სახელი ემთხვევა ძველს', false); cancelUsernameEdit(); return; }
  let users = JSON.parse(localStorage.getItem('users')||'{}');
  if(users[newName]){ showNotification('ეს სახელი უკვე გამოყენებულია'); return; }
  users[newName] = users[currentUser.username]; delete users[currentUser.username];
  localStorage.setItem('users', JSON.stringify(users));
  currentUser.username = newName;
  document.getElementById('usernameDisplay').textContent = newName;
  userName = newName; localStorage.setItem('chatUserName', userName);
  showNotification('მომხმარებლის სახელი შეიცვალა', false);
  closeSettingsPage(); setTimeout(()=> showSettingsPage(), 300);
}
function cancelUsernameEdit(){
  let inp = document.getElementById('settingsUsername'); if(inp){ inp.disabled = true; inp.value = currentUser.username; }
  let btn = document.getElementById('saveUsernameBtn'); if(btn) btn.remove();
}
function showPasswordChangeFromSettings(){ closeSettingsPage(); setTimeout(()=> showPasswordChangeModal(), 300); }
function renderMistakesList(){
  if(!currentUser || !currentTestType) return '<div style="text-align:center; padding:20px; color:var(--muted);">აირჩიეთ ტესტის ტიპი</div>';
  let wrong = getWrongQuestions();
  if(!wrong.length) return '<div style="text-align:center; padding:20px; color:var(--muted);">შეცდომები არ არის! 🎉</div>';
  let html = '';
  wrong.forEach((qid,i)=>{
    let q = allTestsWithTopics[parseInt(qid)]; if(!q) return;
    let userAnsData = userProgress[currentTestType]?.normal?.answeredQuestions[qid] || userProgress[currentTestType]?.exam?.answeredQuestions[qid];
    let userIdx = userAnsData?.selectedAnswer; let userTxt = userIdx!==undefined ? q.answers[userIdx]?.text : 'არაა ცნობილი';
    let correctAns = q.answers.find(a=>a.correct); let correctTxt = correctAns?.text || '';
    html += `<div class="mistake-item"><div class="mistake-question">${escapeHtml(q.question)}</div><div class="mistake-answers"><div class="mistake-user-answer"><strong>თქვენი:</strong> ${escapeHtml(userTxt)}</div><div class="mistake-correct-answer"><strong>სწორი:</strong> ${escapeHtml(correctTxt)}</div></div></div>`;
  });
  return html;
}
function printMistakes(){
  if(!currentUser || !currentTestType || !getWrongQuestions().length){ showNotification('შეცდომები არ არის'); return; }
  let w = getWrongQuestions();
  let content = `<html><head><title>შეცდომები - ${currentUser.username}</title><style>body{ margin:0; background:#fff; font-family:Arial; } .print-wrapper{ margin:0 1cm; } h1{ color:#0ea5a4; } .mistake{ border-left:4px solid #dc2626; padding:15px; margin-bottom:20px; background:#f8fafc; }</style></head><body><div class="print-wrapper"><h1 style="text-align:center;">შეცდომების ისტორია</h1><p style="text-align:center;">${escapeHtml(currentUser.username)} - ${new Date().toLocaleDateString('ka-GE')}</p>`;
  w.forEach((qid,i)=>{
    let q = allTestsWithTopics[parseInt(qid)]; if(!q) return;
    let ua = userProgress[currentTestType]?.normal?.answeredQuestions[qid] || userProgress[currentTestType]?.exam?.answeredQuestions[qid];
    let uans = ua?.selectedAnswer!==undefined ? q.answers[ua.selectedAnswer]?.text : 'არაა არჩეული';
    let cans = q.answers.find(a=>a.correct)?.text || '';
    content += `<div class="mistake"><h4>${i+1}. ${escapeHtml(q.question)}</h4><p style="color:#dc2626;"><strong>თქვენი:</strong> ${escapeHtml(uans)}</p><p style="color:#16a34a;"><strong>სწორი:</strong> ${escapeHtml(cans)}</p></div>`;
  });
  content += `</div></body></html>`;
  let wnd = window.open('','_blank'); wnd.document.write(content); wnd.document.close(); wnd.focus(); wnd.print(); wnd.close();
}
function closeSettingsPage(){ document.getElementById('settingsPage')?.remove(); }
function showPasswordChangeModal(){
  let modal = document.createElement('div');
  modal.innerHTML = `<div class="modal-overlay active"><div class="modal"><div class="modal-header">პაროლის შეცვლა</div><div class="modal-content"><div><input type="password" id="currentPassword" placeholder="მიმდინარე პაროლი" class="auth-input"><input type="password" id="newPassword" placeholder="ახალი პაროლი (6+)" class="auth-input"><input type="password" id="confirmNewPassword" placeholder="გაიმეორეთ" class="auth-input"></div></div><div class="modal-buttons"><button id="savePasswordBtn" class="modal-btn confirm">შენახვა</button><button id="cancelPasswordBtn" class="modal-btn cancel">გაუქმება</button></div></div></div>`;
  document.body.appendChild(modal.firstChild);
  document.getElementById('savePasswordBtn').addEventListener('click', ()=>{
    let cur = document.getElementById('currentPassword').value, newp = document.getElementById('newPassword').value, conf = document.getElementById('confirmNewPassword').value;
    if(!cur || !newp || !conf){ showNotification('შეავსეთ ყველა ველი'); return; }
    if(newp.length<6){ showNotification('ახალი პაროლი უნდა იყოს მინიმუმ 6 სიმბოლო'); return; }
    if(newp!==conf){ showNotification('ახალი პაროლები არ ემთხვევა'); return; }
    let users = JSON.parse(localStorage.getItem('users')||'{}');
    if(users[currentUser.username]?.password !== cur){ showNotification('მიმდინარე პაროლი არასწორია'); return; }
    users[currentUser.username].password = newp;
    localStorage.setItem('users', JSON.stringify(users));
    showNotification('პაროლი შეიცვალა', false);
    modal.remove();
  });
  document.getElementById('cancelPasswordBtn').addEventListener('click', ()=> modal.remove());
}

// ==================== WRONG QUESTIONS MODE ====================
function startWrongQuestionsMode(){
  if(!currentUser || currentUser.isGuest){ showNotification('მხოლოდ რეგისტრირებულ მომხმარებლებს შეუძლიათ'); return; }
  let wrong = getWrongQuestions();
  if(!wrong.length){ showNotification('შეცდომები არ არის!', false); return; }
  let wrongTests = allTestsWithTopics.filter((t,i)=> wrong.includes(i.toString()));
  if(!wrongTests.length){ showNotification('შეცდომები ვერ მოიძებნა'); return; }
  sessionTests = wrongTests.map((t,i)=>({ id: i.toString(), question: t.question, answers: t.answers.map(a=>({...a})), selectedAnswers: [], hasCorrectAnswer: false, isAnswerCorrect: null }));
  currentIndex = 0; examMode = false;
  optionsScreen.style.display = 'none'; testScreen.classList.add('active');
  normalModeContainer.classList.remove('hidden'); examModeContainer.classList.add('hidden'); examRightPanel.classList.add('hidden');
  questionCounter.classList.remove('hidden');
  currentQuestionEl.textContent = currentIndex+1; totalQuestionsEl.textContent = sessionTests.length;
  timerElement.classList.remove('hidden');
  showNotification(`შეცდომების გამეორება: ${wrongTests.length} კითხვა`, false);
  renderCurrentQuestion();
}

// ==================== CHAT ====================
function initChat(){
  chatButton = document.getElementById('chatButton'); chatWindow = document.getElementById('chatWindow');
  closeChat = document.querySelector('.close-chat'); chatMessagesEl = document.getElementById('chatMessages');
  onlineCount = document.getElementById('onlineCount'); chatInput = document.getElementById('chatInput'); sendBtn = document.getElementById('sendBtn');
  if(!chatButton) return;
  chatMessagesEl.innerHTML = ''; onlineCount.textContent = '1';
  if(currentUser?.username) userName = currentUser.username;
  if(firebaseInitialized && database) setupFirebaseListeners(); else loadLocalMessagesAsFallback();
  chatButton.onclick = ()=>{ chatWindow.classList.toggle('active'); isChatOpen = chatWindow.classList.contains('active'); if(isChatOpen){ unreadMessagesCount=0; updateChatNotification(); chatInput.focus(); setTimeout(()=> chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight,100); } };
  closeChat.onclick = ()=> { chatWindow.classList.remove('active'); isChatOpen = false; };
  sendBtn.onclick = sendMessageToFirebase;
  chatInput.onkeypress = (e)=> { if(e.key==='Enter') sendMessageToFirebase(); };
}
function setupFirebaseListeners(){
  displayedMessageKeys.clear();
  database.ref('chat/messages').limitToLast(50).once('value', snap=>{
    if(snap.exists()){
      let msgs = []; snap.forEach(c=> msgs.push({ ...c.val(), key:c.key }));
      msgs.sort((a,b)=> (a.timestamp||0) - (b.timestamp||0)).forEach(m=>{
        displayedMessageKeys.add(m.key);
        addMessageToChat(m.author, m.text, m.userId===userId, new Date(m.timestamp));
      });
      setTimeout(()=>{ if(isChatOpen) chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; },200);
    }
  }).catch(()=> loadLocalMessagesAsFallback());
  database.ref('chat/messages').limitToLast(1).on('child_added', snap=>{
    let m = snap.val(), key = snap.key;
    if(displayedMessageKeys.has(key)) return;
    displayedMessageKeys.add(key);
    if(m.userId !== userId) addMessageToChat(m.author, m.text, false, new Date(m.timestamp));
  });
  database.ref('chat/onlineUsers').on('value', snap=>{
    let cnt=1, now=Date.now();
    if(snap.exists()) Object.values(snap.val()).forEach(u=> { if(u.userId!==userId && u.lastSeen && (now-u.lastSeen)<30000) cnt++; });
    onlineCount.textContent = cnt;
  });
  setUserOnline();
}
function loadLocalMessagesAsFallback(){
  try {
    let local = JSON.parse(localStorage.getItem('chatMessages')||'[]');
    local.sort((a,b)=> new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()).forEach(m=> addMessageToChat(m.author, m.text, m.userId===userId, new Date(m.timestamp)));
  } catch(e){}
  addMessageToChat('სისტემა','კეთილი იყოს თქვენი მობრძანება! (ლოკალური)',false,new Date());
}
function setUserOnline(){
  if(!firebaseInitialized || !database) return;
  let userRef = database.ref('chat/onlineUsers/'+userId);
  userRef.set({ name: userName, userId, lastSeen: Date.now() });
  isOnline = true;
  setInterval(()=>{ if(isOnline) userRef.update({ lastSeen: Date.now() }); },10000);
  window.addEventListener('beforeunload', ()=>{ userRef.remove(); isOnline=false; });
}
function sendMessageToFirebase(){
  if(!chatInput) return;
  let msg = chatInput.value.trim(); if(!msg) return;
  let data = { text: msg, author: userName, userId, timestamp: Date.now() };
  chatInput.value = '';
  addMessageToChat(userName, msg, true, new Date());
  saveMessageToLocalStorage(data);
  if(firebaseInitialized && database){
    let ref = database.ref('chat/messages').push();
    displayedMessageKeys.add(ref.key);
    ref.set(data).catch(()=> showNotification('შეტყობინება შენახულია ლოკალურად', false));
  } else showNotification('შეტყობინება შენახულია ლოკალურად', false);
}
function saveMessageToLocalStorage(m){
  try {
    let arr = JSON.parse(localStorage.getItem('chatMessages')||'[]');
    arr.push({...m, timestamp: new Date().toISOString()});
    if(arr.length>100) arr = arr.slice(-100);
    localStorage.setItem('chatMessages', JSON.stringify(arr));
  } catch(e){}
}
function addMessageToChat(author, text, isSent, timestamp){
  if(!chatMessagesEl) return;
  let d = document.createElement('div'); d.className = `message ${isSent?'sent':'received'}`;
  let time = timestamp.toLocaleTimeString('ka-GE', { hour:'2-digit', minute:'2-digit' });
  d.innerHTML = `<div class="message-author">${escapeHtml(author)}</div><div class="message-time">${time}</div><div class="message-content">${escapeHtml(text)}</div>`;
  chatMessagesEl.appendChild(d);
  if(!isChatOpen && !isSent){ unreadMessagesCount++; updateChatNotification(); }
  if(isChatOpen) setTimeout(()=> chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight, 100);
}
function updateChatNotification(){
  let n = document.getElementById('chatNotification');
  if(n){ if(unreadMessagesCount>0){ n.style.display='flex'; n.textContent = unreadMessagesCount>99?'99+':unreadMessagesCount; } else n.style.display='none'; }
}

// ==================== BINDINGS ====================
function bindNavigationEvents(){
  prevBtn = document.getElementById('prevBtn'); nextBtn = document.getElementById('nextBtn'); autoBtn = document.getElementById('autoBtn');
  examPrevBtn = document.getElementById('examPrevBtn'); examNextBtn = document.getElementById('examNextBtn'); examAutoBtn = document.getElementById('examAutoBtn'); examFinishBtn = document.getElementById('examFinishBtn');
  if(prevBtn) prevBtn.onclick = ()=>{ if(currentIndex>0){ currentIndex--; autoSaveProgress(); renderCurrentQuestion(); } };
  if(nextBtn) nextBtn.onclick = ()=>{ if(currentIndex<sessionTests.length-1){ currentIndex++; autoSaveProgress(); renderCurrentQuestion(); } else if(!examMode) showCompletionScreen(); };
  if(autoBtn) autoBtn.onclick = ()=>{ autoMode = !autoMode; updateAutoButton(); updateExamAutoButton(); };
  if(examPrevBtn) examPrevBtn.onclick = ()=>{ if(currentIndex>0){ currentIndex--; autoSaveProgress(); renderCurrentQuestion(); } };
  if(examNextBtn) examNextBtn.onclick = ()=>{ if(currentIndex<sessionTests.length-1){ currentIndex++; autoSaveProgress(); renderCurrentQuestion(); } else if(checkAllQuestionsAnswered()) completeExam(); else showNotification('უპასუხეთ ყველა კითხვას'); };
  if(examAutoBtn) examAutoBtn.onclick = ()=>{ autoMode = !autoMode; updateAutoButton(); updateExamAutoButton(); };
  if(examFinishBtn) examFinishBtn.onclick = ()=>{ if(checkAllQuestionsAnswered()) completeExam(); else showNotification('უპასუხეთ ყველა კითხვას'); };
  document.getElementById('closeDetailsBtn')?.addEventListener('click', ()=> detailedResultsModal.classList.remove('active'));
}
function bindQuestionCounterEvent(){
  currentQuestionEl = document.getElementById('currentQuestion');
  if(!currentQuestionEl) return;
  currentQuestionEl.onclick = (e)=>{
    e.stopPropagation(); if(isEditingQuestionNumber || examMode) return;
    isEditingQuestionNumber = true; currentQuestionEl.classList.add('editing');
    let orig = currentQuestionEl.textContent;
    let inp = document.createElement('input'); inp.type = 'number'; inp.value = orig; inp.min = 1; inp.max = sessionTests.length;
    inp.style.cssText = 'width:60px; height:40px; font-size:28px; font-weight:700; text-align:center; border:none; background:transparent; color:var(--success); outline:none;';
    let container = document.createElement('div'); container.style.cssText = 'display:inline-block; min-width:50px; text-align:center;';
    container.appendChild(inp);
    currentQuestionEl.style.display = 'none';
    currentQuestionEl.parentNode.insertBefore(container, currentQuestionEl.nextSibling);
    inp.focus(); inp.select();
    let done = ()=>{
      let v = parseInt(inp.value);
      if(v>=1 && v<=sessionTests.length){ currentIndex = v-1; container.remove(); currentQuestionEl.style.display = 'inline'; currentQuestionEl.textContent = v; currentQuestionEl.classList.remove('editing'); isEditingQuestionNumber = false; autoSaveProgress(); renderCurrentQuestion(); }
      else { container.remove(); currentQuestionEl.style.display = 'inline'; currentQuestionEl.classList.remove('editing'); isEditingQuestionNumber = false; showNotification('შეიყვანეთ 1-'+sessionTests.length); }
    };
    inp.addEventListener('blur', done);
    inp.addEventListener('keypress', e=> { if(e.key==='Enter') done(); });
    inp.addEventListener('keydown', e=> { if(e.key==='Escape'){ container.remove(); currentQuestionEl.style.display = 'inline'; currentQuestionEl.classList.remove('editing'); isEditingQuestionNumber = false; } });
  };
}
function bindUserMenuEvents(){
  let btn = document.getElementById('usernameBtn'), drop = document.getElementById('userDropdown');
  if(btn) btn.addEventListener('click', (e)=>{ e.stopPropagation(); drop.classList.toggle('show'); });
  document.addEventListener('click', ()=> drop.classList.remove('show'));
  document.getElementById('wrongQuestionsBtn').addEventListener('click', ()=>{ startWrongQuestionsMode(); drop.classList.remove('show'); });
  document.getElementById('settingsBtn').addEventListener('click', ()=>{ showSettingsPage(); drop.classList.remove('show'); });
  document.getElementById('signOutBtn').addEventListener('click', ()=>{ saveUserProgress(); currentUser = null; location.reload(); });
}
function bindTestTypeEvents(){
  document.getElementById('testTypeSelect').addEventListener('change', function(){ toggleTopicsDropdown(); startBtn.disabled = !this.value; if(this.value) currentTestType = this.value; });
}
function showCompletionScreen(){
  let correct = sessionTests.filter(q=>q.hasCorrectAnswer).length;
  let percent = Math.round((correct/sessionTests.length)*100);
  timerElement.classList.remove('hidden');
  let html = `<div style="text-align:center; padding:40px;"><div style="font-size:24px; font-weight:600; color:#1e293b;">ტესტი დასრულდა! 🎉</div><div style="font-size:18px; color:#64748b; margin:20px;">სწორი: ${correct}/${sessionTests.length} (${percent}%)</div><button id="restartBtn" class="nav-btn" style="background:var(--accent); margin:auto;">თავიდან დაწყება</button></div>`;
  normalModeContainer.innerHTML = html;
  examRightPanel.classList.add('hidden'); questionCounter.classList.add('hidden');
  document.getElementById('restartBtn')?.addEventListener('click', ()=> location.reload());
}

// ==================== DOMContentLoaded ====================
window.addEventListener('DOMContentLoaded', ()=>{
  optionsScreen = document.getElementById('optionsScreen'); testScreen = document.getElementById('testScreen');
  questionText = document.getElementById('questionText'); answersContainer = document.getElementById('answersContainer');
  feedback = document.getElementById('feedback'); startBtn = document.getElementById('startBtn');
  timerElement = document.getElementById('timer'); examRightPanel = document.getElementById('examRightPanel');
  examCountdown = document.getElementById('examCountdown'); examTestBoxes = document.getElementById('examTestBoxes');
  questionCounter = document.getElementById('questionCounter'); currentQuestionEl = document.getElementById('currentQuestion');
  totalQuestionsEl = document.getElementById('totalQuestions'); loaderOverlay = document.getElementById('loaderOverlay');
  modeSequential = document.getElementById('modeSequential'); modeShuffleQuestions = document.getElementById('modeShuffleQuestions');
  modeShuffleAnswers = document.getElementById('modeShuffleAnswers'); modeExam = document.getElementById('modeExam');
  normalModeContainer = document.getElementById('normalModeContainer'); examModeContainer = document.getElementById('examModeContainer');
  examQuestionText = document.getElementById('examQuestionText'); examAnswersContainer = document.getElementById('examAnswersContainer');
  examFeedback = document.getElementById('examFeedback'); detailedResultsModal = document.getElementById('detailedResultsModal');
  detailedResultsContent = document.getElementById('detailedResultsContent');
  wrongCountBadge = document.getElementById('wrongCountBadge'); wrongCountBadgeSettings = document.getElementById('wrongCountBadgeSettings');

  initAuth(); bindNavigationEvents(); bindQuestionCounterEvent(); bindTestTypeEvents(); updateTimerDisplay(); setInterval(updateTimer,1000);
  startBtn.addEventListener('click', startTest);
  window.addEventListener('beforeunload', ()=>{ if(currentUser && !currentUser.isGuest && currentTestType) saveUserProgress(); });
  modeSequential.addEventListener('change', ()=>{ if(modeSequential.checked && modeShuffleQuestions.checked){ showNotification('ეს რეჟიმები ერთად შეუძლებელია!'); modeSequential.checked = false; } });
  modeShuffleQuestions.addEventListener('change', ()=>{ if(modeShuffleQuestions.checked && modeSequential.checked){ showNotification('ეს რეჟიმები ერთად შეუძლებელია!'); modeShuffleQuestions.checked = false; } });
  modeExam.addEventListener('change', ()=>{ if(modeExam.checked){ modeSequential.checked = false; modeShuffleQuestions.checked = true; modeShuffleAnswers.checked = true; } });
  setTimeout(toggleTopicsDropdown, 100);
  // expose some functions for inline onclick
  window.closeSettingsPage = closeSettingsPage; window.enableUsernameEdit = enableUsernameEdit; window.togglePasswordVisibility = togglePasswordVisibility;
  window.showPasswordChangeFromSettings = showPasswordChangeFromSettings; window.printMistakes = printMistakes;
});
</script>
</body>
</html>
